<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>公有雲kubernetes pull unssl container image registry - Meng Ze&#39;s Blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<meta property="og:title" content="公有雲kubernetes pull unssl container image registry" />
<meta property="og:description" content="記錄一下之前在工作上遇到的 Gitlab domain 沒有簽憑證，但是外部服務(Azure Kubernetes Service)又需要存取 Gitlab Container Registry 會遇到的問題。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.jjmengze.website/post/kubernetes/private-image/" />
<meta property="article:published_time" content="2020-05-26T15:07:18+08:00" />
<meta property="article:modified_time" content="2020-05-26T15:07:18+08:00" />

	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="Meng Ze&#39;s Blog" rel="home">
				<div class="logo__title">Meng Ze&#39;s Blog</div>
				<div class="logo__tagline">Record my learning process</div>
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/post/">
				
				<span class="menu__text">Home</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About Me</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">公有雲kubernetes pull unssl container image registry</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2020-05-26T15:07:18&#43;08:00">2020-05-26</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/kubernetes/" rel="category">kubernetes</a>
	</span>
</div></div>
		</header>
<div class="post__toc toc">
	<div class="toc__title">Page content</div>
	<div class="toc__menu">
		<nav id="TableOfContents">
  <ul>
    <li><a href="#發生了什麼">發生了什麼？</a>
      <ul>
        <li><a href="#檢視各項問題">檢視各項問題</a></li>
      </ul>
    </li>
  </ul>
</nav>
	</div>
</div>
<div class="content post__content clearfix">
			<p>記錄一下之前在工作上遇到的 Gitlab domain 沒有簽憑證，但是外部服務(Azure Kubernetes Service)又需要存取 Gitlab Container Registry 會遇到的問題。</p>
<h2 id="發生了什麼">發生了什麼？</h2>
<ol>
<li>
<p>Gitlab 的 domain 沒有買 SSL （由於政策問題也不能用 letsencrypt)</p>
</li>
<li>
<p>Kubernetes 拉取 Gitlab Container Registry 需要帳密</p>
</li>
<li>
<p>Kubernetes 拉取 Gitlab Container Registry 憑證不被信任</p>
</li>
</ol>
<h3 id="檢視各項問題">檢視各項問題</h3>
<h4 id="gitlab-domain-沒有ssl">Gitlab domain 沒有ssl</h4>
<p><img src="https://i.imgur.com/LrElzFn.png" alt=""></p>
<p>如果我們在 host 上透過 docker 拉取該 Container Registry 的 image 可能會出現的狀況。</p>
<p>先看一下我使用的 docker 測試環境</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$docker</span> version
Client:
 Version:           19.03.6
 API version:       1.40
 Go version:        go1.12.17
 Git commit:        369ce74a3c
 Built:             Fri Feb <span style="color:#cd00cd">28</span> 23:45:43 <span style="color:#cd00cd">2020</span>
 OS/Arch:           linux/amd64
 Experimental:      <span style="color:#cd00cd">false</span>

Server:
 Engine:
  Version:          19.03.6
  API version:      1.40 <span style="color:#39c">(</span>minimum version 1.12<span style="color:#39c">)</span>
  Go version:       go1.12.17
  Git commit:       369ce74a3c
  Built:            Wed Feb <span style="color:#cd00cd">19</span> 01:06:16 <span style="color:#cd00cd">2020</span>
  OS/Arch:          linux/amd64
  Experimental:     <span style="color:#cd00cd">false</span>
 containerd:
  Version:          1.3.3-0ubuntu1~18.04.2
  GitCommit:
 runc:
  Version:          spec: 1.0.1-dev
  GitCommit:
 docker-init:
  Version:          0.18.0
  GitCommit:
</code></pre></div><p>接著我透過 Docker CLI 去拉 Gitlab Container Registry  上的 private image，由於&hellip;一些公司政策問題我把公司的位置替換掉了請見諒。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$docker</span> pull registry-gitlab.com.tw/repo/image-cli:v4.4.0
Error response from daemon: Get registry-gitlab.com.tw/v2/: x509: certificate is not authorized to sign other certificates
</code></pre></div><p>直接垃取會出現 x509: certificate is not authorized to sign other certificates，這個部分非常容易解決 Google 一下就可以很快的拿到解，只要docker login 一下就沒問題了。</p>
<p>在那之前我們先來看一下相關的 docker 設定檔</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">$cat /lib/systemd/system/docker.service
[Unit]
Description=Docker Application Container Engine
Documentation=https://docs.docker.com
BindsTo=containerd.service
After=network-online.target firewalld.service containerd.service
Wants=network-online.target
Requires=docker.socket

[Service]
Type=notify
# the default is not to use systemd for cgroups because the delegate issues still
# exists and systemd currently does not support the cgroup feature set required
# for containers run by docker
ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
ExecReload=/bin/kill -s HUP $MAINPID
TimeoutSec=0
RestartSec=2
Restart=always

# Note that StartLimit* options were moved from &#34;Service&#34; to &#34;Unit&#34; in systemd 229.
# Both the old, and new location are accepted by systemd 229 and up, so using the old location
# to make them work for either version of systemd.
StartLimitBurst=3

# Note that StartLimitInterval was renamed to StartLimitIntervalSec in systemd 230.
# Both the old, and new name are accepted by systemd 230 and up, so using the old name to make
# this option work for either version of systemd.
StartLimitInterval=60s

# Having non-zero Limit*s causes performance problems due to accounting overhead
# in the kernel. We recommend using cgroups to do container-local accounting.
LimitNOFILE=infinity
LimitNPROC=infinity
LimitCORE=infinity

# Comment TasksMax if your systemd version does not support it.
# Only systemd 226 and above support this option.
TasksMax=infinity

# set delegate yes so that systemd does not reset the cgroups of docker containers
Delegate=yes

# kill only the docker process, not all processes in the cgroup
KillMode=process

[Install]
WantedBy=multi-user.target
</code></pre></div><p>上面可以看到 Docker systemD 的相關設定 ，看起來都相當的簡單而且沒有任何繞過 insecure 的選項。</p>
<p>也同時在 /etc 底下看看 Docker 的設定</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$ls</span> /etc/docker/
key.json
</code></pre></div><p>這邊我們可以看到 Docker 完全沒有設定任何繞過 insecure 的選項後，使用docker login 後再看看有沒有任何的改變。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker login registry-gitlab.com.tw
Username <span style="color:#39c">(</span><span style="color:#cd00cd">test</span><span style="color:#39c">)</span>:        
Password: 
Error response from daemon: Get https://registry-gitlab.com.tw/v2/: x509: certificate is not authorized to sign other certificates
</code></pre></div><p>這時候我們又觀察到新的問題了，在 login 的時候發現我們的Gitlab Registry 的憑證有問題，在繼續 Google 會看到原來要把憑證有問題的 domain 設定到 /etc/docker/daemon.json 下面，這邊我很快的設定起來，並且重啟dockerd。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat &lt;&lt;EOF | &gt;&gt; /etc/docker/daemon.json
<span style="color:#39c">{</span>
    <span style="color:#cd0000">&#34;insecure-registries&#34;</span>:<span style="color:#39c">[</span><span style="color:#cd0000">&#34;registry-gitlab.com.tw&#34;</span><span style="color:#39c">]</span>
<span style="color:#39c">}</span>
systemctl restart docker
</code></pre></div><p>接著再嘗試透過docker login 登入並且拉取 Gitlab container registry 的 image。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$docker</span> login registry-gitlab.com.tw
Username <span style="color:#39c">(</span><span style="color:#cd00cd">test</span><span style="color:#39c">)</span>:        
Password: 
WARNING! Your password will be stored unencrypted in /root/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded

<span style="color:#00cdcd">$docker</span> pull registry-gitlab.com.tw/repo/image-cli:v4.4.0

v4.4.0: Pulling from registry-gitlab.com.tw/repo/image-cli:v4.4.0
23302e52b49d: Pulling fs layer
cf5693de4d3c: Download <span style="color:#cd00cd">complete</span>
0bdf97977791: Downloading <span style="color:#39c">[=</span>&gt;                                                 <span style="color:#39c">]</span>  110.1kB/3.493MB
8b8c7ad8f3fb: Waiting
40eb930bd6b2: Waiting
</code></pre></div><p>到這邊我們終於解決在 <strong>docker</strong> 拉取沒有 SSL Container registry 上的 private image 了，接著我們要來看在公有雲(Azure Kubernetes Service)上出了什麼問題。</p>
<h4 id="kubernetes-pull-image-og-gitlab-container-registry">Kubernetes pull image og Gitlab Container Registry</h4>
<p>接著來看看在公有雲環境中( Azure Kubernetes Service , AKS )會出現的問題，我在 AKS 部署一個三個節點的環境，Kubernetes 版本為 1.15.11。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">bash-5.0# kubectl get node
NAME                                STATUS   ROLES   AGE   VERSION
aks-agentpool-20139558-vmss000000   Ready    agent   11m   v1.15.11
aks-agentpool-20139558-vmss000001   Ready    agent   11m   v1.15.11
aks-agentpool-20139558-vmss000002   Ready    agent   11m   v1.15.11

bash-5.0# kubectl get pod --all-namespaces
NAMESPACE     NAME                                    READY   STATUS    RESTARTS   AGE
kube-system   coredns-698c77c5d7-69rch                1/1     Running   <span style="color:#cd00cd">0</span>          11m
kube-system   coredns-698c77c5d7-vsrzb                1/1     Running   <span style="color:#cd00cd">0</span>          14m
kube-system   coredns-autoscaler-5bd7c6759b-jx9dt     1/1     Running   <span style="color:#cd00cd">0</span>          14m
kube-system   kube-proxy-46phd                        1/1     Running   <span style="color:#cd00cd">0</span>          11m
kube-system   kube-proxy-fgb6f                        1/1     Running   <span style="color:#cd00cd">0</span>          11m
kube-system   kube-proxy-gxck8                        1/1     Running   <span style="color:#cd00cd">0</span>          11m
kube-system   kubernetes-dashboard-74d8c675bc-j25fz   1/1     Running   <span style="color:#cd00cd">0</span>          14m
kube-system   metrics-server-7d654ddc8b-bljdd         1/1     Running   <span style="color:#cd00cd">0</span>          14m
kube-system   omsagent-rs-c45c944df-5crtb             1/1     Running   <span style="color:#cd00cd">0</span>          14m
kube-system   omsagent-w5b8l                          1/1     Running   <span style="color:#cd00cd">1</span>          11m
kube-system   omsagent-xfndn                          1/1     Running   <span style="color:#cd00cd">1</span>          11m
kube-system   omsagent-xhnbv                          1/1     Running   <span style="color:#cd00cd">0</span>          11m
kube-system   tunnelfront-98c8b5dc6-b56d5             1/1     Running   <span style="color:#cd00cd">0</span>          14m
</code></pre></div><p>在AKS的環境上我直接透過kubectl CLI 建立一個非常簡單的Deployment Resource，測試拉取 Container registry 上的 private image 會有什麼問題。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">bash-5.0# kubectl run -ti --rm  <span style="color:#cd00cd">test</span> --image registry-gitlab.com.tw/repo/image-cli:v4.4.0 bash
</code></pre></div><p>接著觀察 pod 是否有成功被建立起起來。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">bash-5.0# kubectl get pod
NAME READY STATUS RESTARTS AGE
<span style="color:#cd00cd">test</span> 0/1 ErrImagePull <span style="color:#cd00cd">0</span> 12s
</code></pre></div><p>可以看到 pod 出現 ErrImagePull 的 status 此時，需要更進步一分析出現ErrImagePull的原因。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">bash-5.0# kubectl describe pod <span style="color:#cd00cd">test</span>

...
  Normal   BackOff    16s <span style="color:#39c">(</span>x3 over 45s<span style="color:#39c">)</span>  kubelet, aks-agentpool-20139558-vmss000000  Back-off pulling image <span style="color:#cd0000">&#34;registry-gitlab.com.tw/repo/image-cli:v4.4.0&#34;</span>
  Warning  Failed     16s <span style="color:#39c">(</span>x3 over 45s<span style="color:#39c">)</span>  kubelet, aks-agentpool-20139558-vmss000000  Error: ImagePullBackOff
  Normal   Pulling    4s <span style="color:#39c">(</span>x3 over 46s<span style="color:#39c">)</span>   kubelet, aks-agentpool-20139558-vmss000000  Pulling image <span style="color:#cd0000">&#34;registry-gitlab.com.tw/repo/image-cli:v4.4.0&#34;</span>
  Warning  Failed     4s <span style="color:#39c">(</span>x3 over 45s<span style="color:#39c">)</span>   kubelet, aks-agentpool-20139558-vmss000000  Failed to pull image <span style="color:#cd0000">&#34;registry-gitlab.com.tw/repo/image-cli:v4.4.0&#34;</span>: rpc error: <span style="color:#00cdcd">code</span> <span style="color:#39c">=</span> Unknown <span style="color:#00cdcd">desc</span> <span style="color:#39c">=</span> Error response from daemon: Get https://registry-gitlab.com.tw/v2/: x509: certificate is not authorized to sign other certificates
  Warning  Failed     4s <span style="color:#39c">(</span>x3 over 45s<span style="color:#39c">)</span>   kubelet, aks-agentpool-20139558-vmss000000  Error: ErrImagePull
</code></pre></div><p>這邊可以觀察到問題</p>
<p>Pulling image &ldquo;registry-gitlab.com.tw/repo/image-cli:v4.4.0&rdquo; 時發生
x509: certificate is not authorized to sign other certificates</p>
<hr>
<p>Google 可以搜尋到很多 Kubernetes pull private 的解決方法，這邊直接使用看看還會遇到什麼問題。大致上就是設定 kubernetes 的某個 namespace 如果要拉某一個位置上的 private image 可以透過這一個使用者帳密去執行。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">kubectl create secret docker-registry gitlab-registry \
    --docker-username=jason \
    --docker-password=RmgmeG4K-1oD4j3XW5A- \
    --docker-email=jason@hello.com.tw \
    --docker-server=registry-gitlab.com.tw
    
secret/gitlab-registry created
</code></pre></div><p>這一步做完我們可以再來看看是不是可以成功pull到image，我們先把原本的 pod delete 再重新 執行一個。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">bash-5.0# kubectl delete pod <span style="color:#cd00cd">test</span>
pod <span style="color:#cd0000">&#34;test&#34;</span> deleted

kubectl run -ti --rm  <span style="color:#cd00cd">test</span> --image registry-gitlab.com.tw/repo/image-cli:v4.4.0 bash
...
</code></pre></div><p>這時候持續觀察 pod 的狀態是不是running</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">bash-5.0# kubectl get pod
NAME   READY   STATUS         RESTARTS   AGE
<span style="color:#cd00cd">test</span>   0/1     ErrImagePull   <span style="color:#cd00cd">0</span>          12s
</code></pre></div><p>什麼竟然還不是 running 那我們繼續順藤摸瓜看看 pod 到底錯了什麼。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">bash-5.0# kubectl describe pod <span style="color:#cd00cd">test</span>

...
  Normal   BackOff    16s <span style="color:#39c">(</span>x3 over 45s<span style="color:#39c">)</span>  kubelet, aks-agentpool-20139558-vmss000000  Back-off pulling image <span style="color:#cd0000">&#34;registry-gitlab.com.tw/repo/image-cli:v4.4.0&#34;</span>
  Warning  Failed     16s <span style="color:#39c">(</span>x3 over 45s<span style="color:#39c">)</span>  kubelet, aks-agentpool-20139558-vmss000000  Error: ImagePullBackOff
  Normal   Pulling    4s <span style="color:#39c">(</span>x3 over 46s<span style="color:#39c">)</span>   kubelet, aks-agentpool-20139558-vmss000000  Pulling image <span style="color:#cd0000">&#34;registry-gitlab.com.tw/repo/image-cli:v4.4.0&#34;</span>
  Warning  Failed     4s <span style="color:#39c">(</span>x3 over 45s<span style="color:#39c">)</span>   kubelet, aks-agentpool-20139558-vmss000000  Failed to pull image <span style="color:#cd0000">&#34;registry-gitlab.com.tw/repo/image-cli:v4.4.0&#34;</span>: rpc error: <span style="color:#00cdcd">code</span> <span style="color:#39c">=</span> Unknown <span style="color:#00cdcd">desc</span> <span style="color:#39c">=</span> Error response from daemon: Get https://registry-gitlab.com.tw/v2/: x509: certificate is not authorized to sign other certificates
  Warning  Failed     4s <span style="color:#39c">(</span>x3 over 45s<span style="color:#39c">)</span>   kubelet, aks-agentpool-20139558-vmss000000  Error: ErrImagePull
</code></pre></div><p>怎麼還是樣的錯，這時候不得不去看看 pod 的 spec 到底定義了什麼有沒有使用我們指定的 image pull secret 。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">bash-5.0# kubectl get pod <span style="color:#cd00cd">test</span> -o yaml
...
      name: default-token-wvgsq
      readOnly: <span style="color:#cd00cd">true</span>
  dnsPolicy: ClusterFirst
  enableServiceLinks: <span style="color:#cd00cd">true</span>
  nodeName: aks-agentpool-20139558-vmss000000
  nodeSelector:
    node-role.kubernetes.io/agent: <span style="color:#cd0000">&#34;&#34;</span>
  priority: <span style="color:#cd00cd">0</span>
...
</code></pre></div><p>怎麼沒有 image pull secret 呢&hellip;，找了一下文件 pod 再啟動時都會去用 default service account 的一些設定。</p>
<p>ref:https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#add-imagepullsecrets-to-a-service-account</p>
<p>這邊就偷懶讓 default namesapce 都用同一個 image pull secret 吧 xDD</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">kubectl patch serviceaccount default -p &#39;{&#34;imagePullSecrets&#34;: [{&#34;name&#34;: &#34;gitlab-registry&#34;}]}&#39;
</code></pre></div><p>這邊再把 Pod 刪掉再重新測試一次看看 image 能不能正確的拉取到。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">bash-5.0# kubectl delete pod <span style="color:#cd00cd">test</span>
pod <span style="color:#cd0000">&#34;test&#34;</span> deleted

kubectl run -ti --rm  <span style="color:#cd00cd">test</span> --image registry-gitlab.com.tw/repo/image-cli:v4.4.0 bash
...
</code></pre></div><p>這時候持續觀察 pod 的狀態是不是running</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">bash-5.0# kubectl get pod
NAME   READY   STATUS         RESTARTS   AGE
<span style="color:#cd00cd">test</span>   0/1     ErrImagePull   <span style="color:#cd00cd">0</span>          12s
</code></pre></div><p>還是不行啊，繼續透過kubectl CLI 找尋錯誤的原因。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">bash-5.0# kubectl describe pod test

...
  Normal   BackOff    21s                kubelet, aks-agentpool-20139558-vmss000002  Back-off pulling image &#34;registry-gitlab.com.tw/repo/image-cli:v4.4.0&#34;
  Warning  Failed     21s                kubelet, aks-agentpool-20139558-vmss000002  Error: ImagePullBackOff
  Normal   Pulling    10s (x2 over 23s)  kubelet, aks-agentpool-20139558-vmss000002  Pulling image &#34;registry-gitlab.com.tw/repo/image-cli:v4.4.0&#34;
  Warning  Failed     10s (x2 over 22s)  kubelet, aks-agentpool-20139558-vmss000002  Failed to pull image &#34;registry-gitlab.com.tw/repo/image-cli:v4.4.0&#34;: rpc error: code = Unknown desc = Error response from daemon: Get https://registry-gitlab.com.tw/v2/: x509: certificate is not authorized to sign other certificates
  Warning  Failed     10s (x2 over 22s)  kubelet, aks-agentpool-20139558-vmss000002  Error: ErrImagePull
</code></pre></div><p>這次看到一樣的錯誤資訊，這時候想到 unssl 的 image registry 不是要去設定 docker/daemon.json ，這樣 docker 去拉 image 的時候才不會認證他的憑證。</p>
<p>因為在公有雲(Azure Kubernetes Server,AKS)上碰不到這幾台worker 主機，只好用奇門遁甲的方式 mount 他的 filesystem 了。</p>
<p>這邊我解決的方法透過 daemonset 讓 pod 部署到所有的 node 上，該 pod 把 host 的 /etc mount 出來。讓我可以觀察AKS host docker 的 config。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#cdcd00">apiVersion</span>: apps/v1
<span style="color:#cdcd00">kind</span>: DaemonSet
<span style="color:#cdcd00">metadata</span>:
  <span style="color:#cdcd00">name</span>: registry-ca
  <span style="color:#cdcd00">namespace</span>: kube-system
  <span style="color:#cdcd00">labels</span>:
    <span style="color:#cdcd00">k8s-app</span>: config-docker
<span style="color:#cdcd00">spec</span>:
  <span style="color:#cdcd00">selector</span>:
    <span style="color:#cdcd00">matchLabels</span>:
      <span style="color:#cdcd00">name</span>: config-docker
  <span style="color:#cdcd00">template</span>:
    <span style="color:#cdcd00">metadata</span>:
      <span style="color:#cdcd00">labels</span>:
        <span style="color:#cdcd00">name</span>: config-docker
    <span style="color:#cdcd00">spec</span>:
      <span style="color:#cdcd00">containers</span>:
      - <span style="color:#cdcd00">name</span>: config-docker
        <span style="color:#cdcd00">image</span>: nginx:<span style="color:#cd00cd">1.18</span>
        <span style="color:#cdcd00">command</span>: [ <span style="color:#cd0000">&#39;sh&#39;</span> ]
        <span style="color:#cdcd00">args</span>: [ <span style="color:#cd0000">&#39;-c&#39;</span> , <span style="color:#cd0000">&#39;tail -f /dev/null&#39;</span>]
        <span style="color:#cdcd00">volumeMounts</span>:
        - <span style="color:#cdcd00">name</span>: etc-docker
          <span style="color:#cdcd00">mountPath</span>: /etc/docker
        <span style="color:#cdcd00">securityContext</span>:
          <span style="color:#cdcd00">privileged</span>: <span style="color:#cdcd00">true</span>
      <span style="color:#cdcd00">terminationGracePeriodSeconds</span>: <span style="color:#cd00cd">30</span>
      <span style="color:#cdcd00">hostPID</span>: <span style="color:#cdcd00">true</span>
      <span style="color:#cdcd00">volumes</span>:
      - <span style="color:#cdcd00">name</span>: etc-docker
        <span style="color:#cdcd00">hostPath</span>:
          <span style="color:#cdcd00">path</span>: /etc/docker
</code></pre></div><p>這邊眼尖得觀眾可能會發現為什麼我用了，securityContext以及hostPID這邊後續會講為什麼我要這樣做。</p>
<p>好的廢話不多說，部署完這個 daemset 後直接進入 pod 裡面看他的設定。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">root@registry-ca-rdzbv:/# cat /etc/docker/daemon.json
{
   &#34;live-restore&#34;: true,
   &#34;log-driver&#34;: &#34;json-file&#34;,
   &#34;log-opts&#34;:  {
      &#34;max-size&#34;: &#34;50m&#34;,
      &#34;max-file&#34;: &#34;5&#34;
   }
}
</code></pre></div><p>發現！他竟然沒有設定 insecure-registries 這邊我只好手動幫他做設定，設定完後直接送給 host pid reload dockerd。這邊你會好奇說為什麼可動到 host 上的 pid ，因為上面的 yaml 有設定  securityContext 以及 hostPID ，所以 container 可以直皆碰到 host 的 process 並且可以下一些需要 security 的指令。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@registry-ca-rdzbv:/#pidof dockerd
<span style="color:#cd00cd">3322</span>
root@registry-ca-rdzbv:/#kill -1 <span style="color:#cd00cd">3322</span>
</code></pre></div><p>這邊完成後，直接delete test pod 看看重新 run 一個能不能成功pull 到 private image 。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">bash-5.0# kubectl delete pod <span style="color:#cd00cd">test</span>
pod <span style="color:#cd0000">&#34;test&#34;</span> deleted

kubectl run -ti --rm  <span style="color:#cd00cd">test</span> --image registry-gitlab.com.tw/repo/image-cli:v4.4.0 bash
...
</code></pre></div><p>這時候持續觀察 pod 的狀態是不是running</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">bash-5.0# kubectl get pod
NAME   READY   STATUS         RESTARTS   AGE
<span style="color:#cd00cd">test</span>   1/1     Running        <span style="color:#cd00cd">0</span>          30s
</code></pre></div><p>此時還有一個問題，剛剛只有修改一個節點如果 Pod 今天部署到其他節點上，還是會出現<code>x509: certificate is not authorized to sign other certificates</code>的問題。有沒有方式可以一勞永逸呢？我這邊直接沿用剛剛的daemset 並且修改一下 yaml file讓這個 pod 可以處理這個問題。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#cdcd00">apiVersion</span>: apps/v1
<span style="color:#cdcd00">kind</span>: DaemonSet
<span style="color:#cdcd00">metadata</span>:
  <span style="color:#cdcd00">name</span>: registry-ca
  <span style="color:#cdcd00">namespace</span>: kube-system
  <span style="color:#cdcd00">labels</span>:
    <span style="color:#cdcd00">k8s-app</span>: config-docker
<span style="color:#cdcd00">spec</span>:
  <span style="color:#cdcd00">selector</span>:
    <span style="color:#cdcd00">matchLabels</span>:
      <span style="color:#cdcd00">name</span>: config-docker
  <span style="color:#cdcd00">template</span>:
    <span style="color:#cdcd00">metadata</span>:
      <span style="color:#cdcd00">labels</span>:
        <span style="color:#cdcd00">name</span>: config-docker
    <span style="color:#cdcd00">spec</span>:
      <span style="color:#cdcd00">containers</span>:
      - <span style="color:#cdcd00">name</span>: config-docker
        <span style="color:#cdcd00">image</span>: nginx:<span style="color:#cd00cd">1.18</span>
        <span style="color:#cdcd00">command</span>: [ <span style="color:#cd0000">&#39;sh&#39;</span> ]
        <span style="color:#cdcd00">args</span>: [ <span style="color:#cd0000">&#39;-c&#39;</span>, <span style="color:#cd0000">&#39;cp --remove-destination /home/core/daemon.json /etc/docker/daemon.json &amp;&amp; kill -1  $(pidof dockerd) &amp;&amp; tail -f /dev/null&#39;</span>]
        <span style="color:#cdcd00">volumeMounts</span>:
        - <span style="color:#cdcd00">name</span>: etc-docker
          <span style="color:#cdcd00">mountPath</span>: /etc/docker
        - <span style="color:#cdcd00">name</span>: docker-config
          <span style="color:#cdcd00">mountPath</span>: /home/core
        <span style="color:#cdcd00">securityContext</span>:
          <span style="color:#cdcd00">privileged</span>: <span style="color:#cdcd00">true</span>
      <span style="color:#cdcd00">terminationGracePeriodSeconds</span>: <span style="color:#cd00cd">30</span>
      <span style="color:#cdcd00">hostPID</span>: <span style="color:#cdcd00">true</span>
      <span style="color:#cdcd00">volumes</span>:
      - <span style="color:#cdcd00">name</span>: etc-docker
        <span style="color:#cdcd00">hostPath</span>:
          <span style="color:#cdcd00">path</span>: /etc/docker
      - <span style="color:#cdcd00">name</span>: docker-config
        <span style="color:#cdcd00">configMap</span>:
          <span style="color:#cdcd00">name</span>: docker-insecure
</code></pre></div><p>這邊可以看到直接套了一個 configmap 以及透過 runtime 的 args  把configmap 的資料複製到 /etc/docker/daemon.json 最後重啟了 dockerd 的 process。</p>
<p>以上是解決在Azure Kubernetes Service 遇到的 unssl image registry 的思路與解決方法。</p>
		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/kubernetes/" rel="tag">kubernetes</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Meng Ze avatar" src="/img/apple.jpg" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Meng Ze</span>
	</div>
	<div class="authorbox__description">
		Meng 專注於雲端世界的耕耘者，喜歡潛水健身等休閒運動。
	</div>
</div>

<nav class="post-nav flex">
	<div class="post-nav__item post-nav__item--prev">
		<a class="post-nav__link" href="/post/devops/gitlab-ocp/" rel="prev">
			<span class="post-nav__caption">«&thinsp;Previous</span>
			<p class="post-nav__post-title">OpenShift 燈紅酒綠與 Gitlab identity</p>
		</a>
	</div>
	<div class="post-nav__item post-nav__item--next">
		<a class="post-nav__link" href="/post/cicd/github-action-2/" rel="next">
			<span class="post-nav__caption">Next&thinsp;»</span>
			<p class="post-nav__post-title">Github Action 妳各位，注意 Heroku ！</p>
		</a>
	</div>
</nav>

<section class="comments">
	<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "meng-ze" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2020 Meng Ze&#39;s Blog.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>