<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>初嚐kubeless的滋味 - Meng Ze&#39;s Blog</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
	<meta property="og:title" content="初嚐kubeless的滋味" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.jjmengze.website/post/kubernetes/kubeless/" />
<meta property="article:published_time" content="2018-08-04T17:39:26+08:00" />
<meta property="article:modified_time" content="2018-08-04T17:39:26+08:00" />

	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container">
		<div class="logo">
			<a class="logo__link" href="/" title="Meng Ze&#39;s Blog" rel="home">
				<div class="logo__title">Meng Ze&#39;s Blog</div>
				<div class="logo__tagline">Record my learning process</div>
			</a>
		</div>
		
<nav class="menu">
	<button class="menu__btn" aria-haspopup="true" aria-expanded="false" tabindex="0">
		<span class="menu__btn-title" tabindex="-1">Menu</span>
	</button>
	<ul class="menu__list">
		<li class="menu__item">
			<a class="menu__link" href="/post/">
				
				<span class="menu__text">Home</span>
				
			</a>
		</li>
		<li class="menu__item">
			<a class="menu__link" href="/about/">
				
				<span class="menu__text">About Me</span>
				
			</a>
		</li>
	</ul>
</nav>

	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">初嚐kubeless的滋味</h1>
			<div class="post__meta meta">
<div class="meta__item-datetime meta__item">
	<svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class="meta__text" datetime="2018-08-04T17:39:26&#43;08:00">2018-08-04</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg><span class="meta__text"><a class="meta__link" href="/categories/servicemesh/" rel="category">servicemesh</a>, <a class="meta__link" href="/categories/kubernetes/" rel="category">kubernetes</a>, <a class="meta__link" href="/categories/serverless/" rel="category">serverless</a>
	</span>
</div></div>
		</header>
<div class="post__toc toc">
	<div class="toc__title">Page content</div>
	<div class="toc__menu">
		<nav id="TableOfContents">
  <ul>
    <li><a href="#serverless">Serverless</a></li>
    <li><a href="#kubeless-簡介">Kubeless 簡介</a></li>
    <li><a href="#環境配置">環境配置</a></li>
    <li><a href="#部署kubernetes">部署kubernetes</a>
      <ul>
        <li><a href="#安裝套件">安裝套件</a></li>
        <li><a href="#關閉swap">關閉Swap</a></li>
        <li><a href="#重啟docker">重啟Docker</a></li>
        <li><a href="#ipv4-forward設定">IPv4 forward設定</a></li>
        <li><a href="#cluster-初始化">Cluster 初始化</a></li>
        <li><a href="#安裝calico-cni">安裝Calico CNI</a></li>
        <li><a href="#檢查環境">檢查環境</a></li>
      </ul>
    </li>
    <li><a href="#安裝kubeless">安裝Kubeless</a>
      <ul>
        <li><a href="#安裝cli">安裝CLI</a></li>
        <li><a href="#安裝kubeless-1">安裝Kubeless</a></li>
      </ul>
    </li>
    <li><a href="#建立及測試function">建立及測試Function</a>
      <ul>
        <li><a href="#ui操作kubeless">UI操作Kubeless</a></li>
        <li><a href="#cli操作kubeless">CLI操作Kubeless</a></li>
      </ul>
    </li>
  </ul>
</nav>
	</div>
</div>
<div class="content post__content clearfix">
			<p><img src="https://s3-us-west-2.amazonaws.com/assets.site.serverless.com/blog/kubeless.png" alt=""></p>
<h2 id="serverless">Serverless</h2>
<p>在進入<strong>Kubeless</strong>之前先科普一下什麼是<strong>Serverless</strong>。
就字面上的意思來說就是沒有<strong>Server</strong>，那沒有Server又是什麼意思？</p>
<p>先從設計開發到部署開始！</p>
<p>我們想要做出一套系統軟體，勢必會經歷設計開發部署&hellip;等流程。
最後總會部署到單台或是多台的<strong>Server</strong>上面，當把服務架設到<strong>Server</strong>上時有許多方案可以提供我們參考。</p>
<p>例如: <strong>Google</strong> 所提供的 <strong>GKE</strong>，<strong>AWS</strong> 所提供的 <strong>EC2</strong> 亦或是 <strong>Microsoft</strong> 所提供的 <strong>Azure</strong>。</p>
<p>選擇完使用哪個雲服務商所提供的<strong>Cloud</strong>後，還要考慮這套系統究竟需要多少台<strong>Server</strong>、多大空間<strong>Stroage</strong>&hellip;等問題。</p>
<p>在微服務的架構之下，我們的每個服務會運行在各個<strong>Server</strong>上（先不考慮Container XD）</p>
<p>在你的業務擴展後，我們就需要更多更多的資源，也就是更多更多的<strong>Server</strong>。
很多微服務事實上被call到的機會很少，但他還是佔了一台<strong>Server</strong>的資源及空間。同時這些很少被使用到的微服務也一點一滴的花掉你的錢（開Server可是要錢的啊！！！）</p>
<p>有了<code>Serverless</code>又或是稱為<code>FaaS</code>的出現後，我們再也不需要去關心那些<strong>Server</strong>，只要把微服務<strong>source code</strong>提交給雲服務商，雲服務商能提供一個運行的環境給你，總而言之就是開發者不需要再去關心底下Infrastructure Layer。</p>
<h2 id="kubeless-簡介">Kubeless 簡介</h2>
<p><code>Kubeless</code>是一個<code>Kubernetes-native</code> 無伺服器(<code>Serverless</code>)框架，只要撰寫程式（Function），而不需要了解底層基礎建設（Infrastructure Layer）。<strong>Kubeless</strong>利用<strong>Kubernetes</strong>資源提供自動擴展，API路由，監控，故障排除&hellip;等功能。</p>
<h2 id="環境配置">環境配置</h2>
<p>本次安裝是使用OpenStack上的三台虛擬機器去作部署，作業系統採用的是Ubuntu 16.04 LTS版。</p>
<table>
<thead>
<tr>
<th>Kubernetes Role</th>
<th>RAM</th>
<th>CPUs</th>
<th>IP Address</th>
</tr>
</thead>
<tbody>
<tr>
<td>Master</td>
<td>8G</td>
<td>4Cores</td>
<td>172.24.0.2</td>
</tr>
<tr>
<td>Node1</td>
<td>8G</td>
<td>4Cores</td>
<td>172.24.0.2</td>
</tr>
<tr>
<td>Node2</td>
<td>8G</td>
<td>4Cores</td>
<td>172.24.0.4</td>
</tr>
</tbody>
</table>
<h2 id="部署kubernetes">部署kubernetes</h2>
<p>這邊利用的是kubeadm進行kubernetes的安裝『版本是Kubernetes1.10』，可以參考<a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/">官方網站</a>的部屬方式。</p>
<h3 id="安裝套件">安裝套件</h3>
<p>安裝 Kubernetes latest version  and other dependencies:
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$curl</span> -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -
<span style="color:#00cdcd">$cat</span> <span style="color:#cd0000">&lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list
</span><span style="color:#cd0000">deb http://apt.kubernetes.io/ kubernetes-xenial main
</span><span style="color:#cd0000">EOF</span>

<span style="color:#00cdcd">$sudo</span> apt-get update
<span style="color:#00cdcd">$sudo</span> apt-get install -y docker.io kubelet kubeadm kubectl</code></pre></div></p>
<h3 id="關閉swap">關閉Swap</h3>
<p>Kubernetes v1.8+ 要求關閉系統 Swap，如果不想關閉系統的Swap需要修改 kubelet 設定參數，我們利用以下指令關閉系統Swap：
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$swapoff</span> -a <span style="color:#39c">&amp;&amp;</span> sysctl -w vm.swappiness<span style="color:#39c">=</span><span style="color:#cd00cd">0</span></code></pre></div></p>
<h3 id="重啟docker">重啟Docker</h3>
<p>透過以下指令啟動Docker Daemon。
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$systemctl</span> <span style="color:#cd00cd">enable</span> docker <span style="color:#39c">&amp;&amp;</span> systemctl start docker</code></pre></div></p>
<h3 id="ipv4-forward設定">IPv4 forward設定</h3>
<p>將橋接的IPv4流量傳遞給iptables
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$cat</span> <span style="color:#cd0000">&lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf
</span><span style="color:#cd0000">net.ipv4.ip_forward = 1
</span><span style="color:#cd0000">net.bridge.bridge-nf-call-ip6tables = 1
</span><span style="color:#cd0000">net.bridge.bridge-nf-call-iptables = 1
</span><span style="color:#cd0000">EOF</span>
<span style="color:#00cdcd">$sysctl</span> -p /etc/sysctl.d/k8s.conf</code></pre></div></p>
<h3 id="cluster-初始化">Cluster 初始化</h3>
<p>在master節點上使用kubeadm進行kubernetes叢集的初始化</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#00cdcd">$sudo</span> kubeadm init --pod-network-cidr<span style="color:#39c">=</span>192.168.0.0/16
</code></pre></div><div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$sudo</span> kubeadm init --pod-network-cidr<span style="color:#39c">=</span>192.168.0.0/16</code></pre></div>
<p>會得到下列輸出，我們利用下列輸出的資訊將其他節點加入叢集。
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">...
You can now join any number of machines by running the following on each node
as root:

kubeadm join 172.24.0.2:6443 --token i67sjb.0nvjxbldwuh342of --discovery-token-ca-cert-hash sha256:aa23e1e7a4d55d06fbdf34fa2a1c703dd7e7cfff735b0b0fe800b4335aff68b5</code></pre></div></p>
<p>在其他節點上我們可以利用以下指令加入叢集。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$kubeadm</span> join 172.24.0.2:6443 --token i67sjb.0nvjxbldwuh342of --discovery-token-ca-cert-hash sha256:aa23e1e7a4d55d06fbdf34fa2a1c703dd7e7cfff735b0b0fe800b4335aff68b5</code></pre></div>
<p>在master節點設定kube config。
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$mkdir</span> -p <span style="color:#00cdcd">$HOME</span>/.kube
<span style="color:#00cdcd">$sudo</span> -H cp /etc/kubernetes/admin.conf <span style="color:#00cdcd">$HOME</span>/.kube/config
<span style="color:#00cdcd">$sudo</span> -H chown <span style="color:#cdcd00">$(</span>id -u<span style="color:#cdcd00">)</span>:<span style="color:#cdcd00">$(</span>id -g<span style="color:#cdcd00">)</span> <span style="color:#00cdcd">$HOME</span>/.kube/config</code></pre></div></p>
<h3 id="安裝calico-cni">安裝Calico CNI</h3>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$kubectl</span> apply -f https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/rbac-kdd.yaml
<span style="color:#00cdcd">$kubectl</span> apply -f https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/kubernetes-datastore/calico-networking/1.7/calico.yaml</code></pre></div>
<h3 id="檢查環境">檢查環境</h3>
<p>在master上操作kubectl指令即可看到所有node呈現ready的狀態
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$kubectl</span> get pod -n kube-system
NAME                             READY     STATUS    RESTARTS   AGE
calico-node-cgtxh                2/2       Running   <span style="color:#cd00cd">0</span>          1m
calico-node-qjrbm                2/2       Running   <span style="color:#cd00cd">0</span>          1m
calico-node-v59b2                2/2       Running   <span style="color:#cd00cd">0</span>          2m
coredns-78fcdf6894-dz9fs         1/1       Running   <span style="color:#cd00cd">0</span>          4m
coredns-78fcdf6894-mn6k8         1/1       Running   <span style="color:#cd00cd">0</span>          4m
etcd-master                      1/1       Running   <span style="color:#cd00cd">0</span>          3m
kube-apiserver-master            1/1       Running   <span style="color:#cd00cd">0</span>          3m
kube-controller-manager-master   1/1       Running   <span style="color:#cd00cd">0</span>          3m
kube-proxy-5xj2l                 1/1       Running   <span style="color:#cd00cd">0</span>          4m
kube-proxy-bh7wb                 1/1       Running   <span style="color:#cd00cd">0</span>          1m
kube-proxy-jqpqg                 1/1       Running   <span style="color:#cd00cd">0</span>          1m
kube-scheduler-master            1/1       Running   <span style="color:#cd00cd">0</span>          3m
<span style="color:#00cdcd">$kubectl</span> get node
NAME      STATUS    ROLES     AGE       VERSION
master    Ready     master    4m        v1.10.0
node-1    Ready     &lt;none&gt;    2m        v1.10.0
node-2    Ready     &lt;none&gt;    2m        v1.10.0</code></pre></div></p>
<h2 id="安裝kubeless">安裝Kubeless</h2>
<h3 id="安裝cli">安裝CLI</h3>
<p>安裝操作 Kubeless 的 CLI
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$wget</span> https://github.com/kubeless/kubeless/releases/download/v1.0.0-alpha.7/kubeless_linux-amd64.zip
apt install -y unzip
unzip kubeless_linux-amd64.zip
<span style="color:#00cdcd">$sudo</span> mv ~/bundles/kubeless_linux-amd64 /usr/local/bin/</code></pre></div></p>
<p>檢查CLI是否安裝完成
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Serverless framework <span style="color:#cdcd00">for</span> Kubernetes

Usage:
  kubeless <span style="color:#39c">[</span>command<span style="color:#39c">]</span>

Available Commands:
  autoscale         manage autoscale to <span style="color:#cdcd00">function</span> on Kubeless
  completion        Output shell completion code <span style="color:#cdcd00">for</span> the specified shell.
  <span style="color:#cdcd00">function</span>          <span style="color:#cdcd00">function</span> specific operations
  get-server-config Print the current configuration of the controller
  <span style="color:#cd00cd">help</span>              Help about any <span style="color:#cd00cd">command</span>
  topic             manage message topics in Kubeless
  trigger           trigger specific operations
  version           Print the version of Kubeless

Flags:
  -h, --help   <span style="color:#cd00cd">help</span> <span style="color:#cdcd00">for</span> kubeless

Use <span style="color:#cd0000">&#34;kubeless [command] --help&#34;</span> <span style="color:#cdcd00">for</span> more information about a command.</code></pre></div></p>
<h3 id="安裝kubeless-1">安裝Kubeless</h3>
<p><a href="https://github.com/kubeless/kubeless/releases">Kubeless官方</a>針對不同Kubernetes環境提供了多種腳本（非RBAC，RBAC和openshift），這邊我採用的是有<code>RBAC</code>的部署。
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$kubectl</span> create ns kubeless
namespace/kubeless created

<span style="color:#00cdcd">$kubectl</span> create -f https://github.com/kubeless/kubeless/releases/download/v1.0.0-alpha.8/kubeless-v1.0.0-alpha.8.yaml

configmap/kubeless-config created
deployment.apps/kubeless-controller-manager created
serviceaccount/controller-acct created
clusterrole.rbac.authorization.k8s.io/kubeless-controller-deployer created
clusterrolebinding.rbac.authorization.k8s.io/kubeless-controller-deployer created
customresourcedefinition.apiextensions.k8s.io/functions.kubeless.io created
customresourcedefinition.apiextensions.k8s.io/httptriggers.kubeless.io created
customresourcedefinition.apiextensions.k8s.io/cronjobtriggers.kubeless.io created</code></pre></div></p>
<p>可以透過<code>kubetl</code>指令觀察kubeless是否有被部署起來</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl get pods -n kubeless
NAME                                           READY     STATUS    RESTARTS   AGE
kubeless-controller-manager-66868fb689-77fkp   3/3       Running   <span style="color:#cd00cd">0</span>          1m
<span style="color:#00cdcd">$kubectl</span> get deployment -n kubeless
NAME                          DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
kubeless-controller-manager   <span style="color:#cd00cd">1</span>         <span style="color:#cd00cd">1</span>         <span style="color:#cd00cd">1</span>            <span style="color:#cd00cd">1</span>           2m

<span style="color:#00cdcd">$kubectl</span> get crd
NAME                                          CREATED AT
cronjobtriggers.kubeless.io                   2018-08-24T12:44:57Z
functions.kubeless.io                         2018-08-24T12:44:57Z
httptriggers.kubeless.io                      2018-08-24T12:44:57Z</code></pre></div>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">### 安裝Kubeless UI

官方提供了操作Kubeless的Dashboard，可以透過該介面操作。
```bash
$kubectl create -f https://raw.githubusercontent.com/kubeless/kubeless-ui/master/k8s.yaml
</code></pre></div><p>可以透過<code>kubetl</code>指令觀察Kubeless的Dashboard是否有被部署起來</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl -n kubeless get pod,svc
NAME                                               READY     STATUS    RESTARTS   AGE
pod/kubeless-controller-manager-66868fb689-77fkp   3/3       Running   <span style="color:#cd00cd">0</span>          39m
pod/ui-6d868664c5-kr99m                            2/2       Running   <span style="color:#cd00cd">0</span>          1m

NAME         TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span style="color:#39c">(</span>S<span style="color:#39c">)</span>          AGE
service/ui   NodePort   10.100.15.46   &lt;none&gt;        3000:30722/TCP   1m
</code></pre></div><p>可以透Browser瀏覽 Kubeless UI(172.24.0.2:30722)
<figure>
    <img src="/images/post/kubeless-ui.png"
         alt="Kubeless Dashboard"/> <figcaption>
            <p>Kubeless Dashboard</p>
        </figcaption>
</figure>
</p>
<h2 id="建立及測試function">建立及測試Function</h2>
<p>這邊示範一個簡單的質數判斷的Function，以Go為例。</p>
<p>這邊會示範從UI上操作以及使用CLI操作</p>
<h3 id="ui操作kubeless">UI操作Kubeless</h3>
<p>透過Browser連進Kubeless Dashboard 後點選 <strong>Create Function</strong>
<figure>
    <img src="/images/post/kubeless-create-function.png"
         alt="建立一個Function"/> <figcaption>
            <p>建立一個Function</p>
        </figcaption>
</figure>
</p>
<p>按下Create後，就可以撰寫我們判斷質數的程式碼。</p>
<p>程式的撰寫畫面會如下圖所示
<figure>
    <img src="/images/post/kubeless-create-function-1.png"
         alt="在function內撰寫我們想要的功能"/> <figcaption>
            <p>在function內撰寫我們想要的功能</p>
        </figcaption>
</figure>
</p>
<p>撰寫完，質數判斷的function大致上是這個樣子
<figure>
    <img src="/images/post/kubeless-create-function2.png"
         alt="質數判斷的function"/> <figcaption>
            <p>質數判斷的function</p>
        </figcaption>
</figure>
</p>
<h4 id="測試function">測試Function</h4>
<p>接著可以輸入右側的<strong>Request</strong>，填入你想要判斷的數值。如：177,9487&hellip;等數值。</p>
<p>填完數值後按下<strong>Run fuction</strong>，發現底下會沒有輸出！！！</p>
<blockquote>
<p>因為<strong>kubeless UI</strong>有<strong>RBAC</strong>的問題，這邊偷懶直接給<strong>cluster-admin</strong>。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"></code></pre></div></blockquote>
<p>$cat &laquo;EOF | kubectl create -f -
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
name: kubeless-ui-default
roleRef:
apiGroup: rbac.authorization.k8s.io
kind: ClusterRole
name: cluster-admin
subjects:</p>
<ul>
<li>kind: User
name: system:serviceaccount:kubeless:ui-acct
apiGroup: rbac.authorization.k8s.io
EOF</li>
</ul>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">

---

&gt;這邊還會產生另外一個問題，在Kubeless UI 所產生的Request只能是**String**型態的。
在這個範例之中會看到以下輸出。

<figure>
    <img src="/images/post/kubeless-create-function3.png"
         alt="只能得到must be a positive integer的回應"/> <figcaption>
            <p>只能得到must be a positive integer的回應</p>
        </figcaption>
</figure>


要解決這個問題我們可以藉由**Kubeless CLI**發送請求給特定的function。
```bash
$kubeless function call checkprime  --data 9487
非質數
$kubeless function call checkprime  --data 177
非質數
$kubeless function call checkprime  --data 7
質數
</code></pre></div><p>結束實驗後我們可以透過Kubeless UI刪除掉剛剛建立的<strong>checkprime function</strong></p>
<h3 id="cli操作kubeless">CLI操作Kubeless</h3>
<p>建立一個<code>checkprime.go</code>，並且撰寫質數判斷的function。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">
<span style="color:#cd00cd">package</span> kubeless

<span style="color:#cd00cd">import</span> (
    <span style="color:#cd0000">&#34;strconv&#34;</span>
    <span style="color:#cd0000">&#34;fmt&#34;</span>
	<span style="color:#cd0000">&#34;github.com/kubeless/kubeless/pkg/functions&#34;</span>
)

<span style="color:#00cd00">func</span> IsPrime(event functions.Event, context functions.Context) (<span style="color:#00cd00">string</span>, <span style="color:#00cd00">error</span>) {
	num, err <span style="color:#39c">:=</span> strconv.Atoi(event.Data)
    <span style="color:#cdcd00">if</span> err <span style="color:#39c">!=</span> <span style="color:#cdcd00">nil</span> {
        fmt.Println(err)
		<span style="color:#cdcd00">return</span> <span style="color:#cd0000">&#34;must be a positive integer&#34;</span>, <span style="color:#cdcd00">nil</span>
	}
    <span style="color:#cdcd00">if</span> num <span style="color:#39c">&lt;=</span> <span style="color:#cd00cd">1</span> {
	    <span style="color:#cdcd00">return</span> <span style="color:#cd0000">&#34;must be a positive integer&#34;</span>,  <span style="color:#cdcd00">nil</span>
	}
    <span style="color:#cdcd00">for</span> i <span style="color:#39c">:=</span> <span style="color:#cd00cd">2</span>; i &lt; num; i<span style="color:#39c">++</span> {
		<span style="color:#cdcd00">if</span> num<span style="color:#39c">%</span>i <span style="color:#39c">==</span> <span style="color:#cd00cd">0</span> {
			<span style="color:#cdcd00">return</span> <span style="color:#cd0000">&#34;非質數&#34;</span>, <span style="color:#cdcd00">nil</span>
			<span style="color:#cdcd00">break</span>
		}
	}
    <span style="color:#cdcd00">return</span> <span style="color:#cd0000">&#34;質數&#34;</span>, <span style="color:#cdcd00">nil</span>
}
</code></pre></div><p>透過<strong>kubeless CLI</strong>幫我們建立Function到環境上</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$kubeless</span> <span style="color:#cdcd00">function</span> deploy checkprime --runtime go1.10 --from-file checkprime.go --handler checkprime.IsPrime
INFO<span style="color:#39c">[</span>0000<span style="color:#39c">]</span> Deploying <span style="color:#cdcd00">function</span>...
INFO<span style="color:#39c">[</span>0000<span style="color:#39c">]</span> Function checkprime submitted <span style="color:#cdcd00">for</span> deployment
INFO<span style="color:#39c">[</span>0000<span style="color:#39c">]</span> Check the deployment status executing <span style="color:#cd0000">&#39;kubeless function ls checkprime&#39;</span>
</code></pre></div><p>透過<strong>Kubeless CLI</strong> 、 <strong>Kubectl</strong> 去確認Function 有沒有成功的被建立到環境上：</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$kubectl</span> get functions
NAME         AGE
checkprime   1m

<span style="color:#00cdcd">$kubeless</span> <span style="color:#cdcd00">function</span> ls
NAME      	NAMESPACE	HANDLER           	RUNTIME	DEPENDENCIES	STATUS
checkprime	default  	checkprime.IsPrime	go1.10 	            	1/1 READY

<span style="color:#00cdcd">$kubectl</span> get po
NAME                                   READY     STATUS      RESTARTS   AGE
checkprime-7d4f<span style="color:#00cdcd">$b7b64c</span>-k47w9            1/1       Running     <span style="color:#cd00cd">0</span>          37s
</code></pre></div><h4 id="測試function-1">測試Function</h4>
<p>透過<strong>Kubeless CLI</strong>去測試剛剛撰寫的質數判斷是否正確</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$kubeless</span> <span style="color:#cdcd00">function</span> call checkprime  --data <span style="color:#cd00cd">9487</span>
非質數
<span style="color:#00cdcd">$kubeless</span> <span style="color:#cdcd00">function</span> call checkprime  --data <span style="color:#cd00cd">177</span>
非質數
<span style="color:#00cdcd">$kubeless</span> <span style="color:#cdcd00">function</span> call checkprime  --data <span style="color:#cd00cd">7</span>
質數
</code></pre></div><p>另外也能透過kubernetes把該function proxy 出來進行測試</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$kubectl</span> proxy -p <span style="color:#cd00cd">34567</span> &amp;
<span style="color:#39c">[</span>1<span style="color:#39c">]</span> <span style="color:#cd00cd">3533</span>
Starting to serve on 127.0.0.1:34567


<span style="color:#00cdcd">$curl</span> --data 9487<span style="color:#cd0000">\
</span><span style="color:#cd0000"></span>    --header <span style="color:#cd0000">&#34;Content-Type:application/json&#34;</span> <span style="color:#cd0000">\
</span><span style="color:#cd0000"></span>    localhost:34567/api/v1/namespaces/default/services/checkprime:8080/proxy/
非質數
</code></pre></div><p>結束實驗後我們可以透過Kubeless CLI刪除掉剛剛建立的<strong>checkprime function</strong></p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$kubeless</span> <span style="color:#cdcd00">function</span> delete checkprime

<span style="color:#00cdcd">$kubeless</span> <span style="color:#cdcd00">function</span> ls
NAME	NAMESPACE	HANDLER	RUNTIME	DEPENDENCIES	STATUS

</code></pre></div>
		</div>
		<footer class="post__footer">
			
<div class="post__tags tags clearfix">
	<svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5 0 11V3C0 1.5.8.8.8.8S1.5 0 3 0h8c1.5 0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/></svg>
	<ul class="tags__list">
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/kubeless/" rel="tag">kubeless</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/kubernetes/" rel="tag">kubernetes</a>
		</li>
		<li class="tags__item">
			<a class="tags__link btn" href="/tags/serverless/" rel="tag">serverless</a>
		</li>
	</ul>
</div>
		</footer>
	</article>
</main>

<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Meng Ze avatar" src="/img/apple.jpg" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Meng Ze</span>
	</div>
	<div class="authorbox__description">
		Meng 專注於雲端世界的耕耘者，喜歡潛水健身等休閒運動。
	</div>
</div>

<nav class="post-nav flex">
	<div class="post-nav__item post-nav__item--prev">
		<a class="post-nav__link" href="/post/kubernetes/minkube-mount/" rel="prev">
			<span class="post-nav__caption">«&thinsp;Previous</span>
			<p class="post-nav__post-title">minikube 在掛載本機遇到的神奇問題</p>
		</a>
	</div>
	<div class="post-nav__item post-nav__item--next">
		<a class="post-nav__link" href="/post/kubernetes/istio/istio1.0-install/" rel="next">
			<span class="post-nav__caption">Next&thinsp;»</span>
			<p class="post-nav__post-title">Istio1.0 安裝及簡易操作</p>
		</a>
	</div>
</nav>

<section class="comments">
	<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "meng-ze" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2020 Meng Ze&#39;s Blog.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>