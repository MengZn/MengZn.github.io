<!DOCTYPE html>
<html lang="zh-tw">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>透過kolla-ansible部署OpenStack</title>
	<meta name="description" content="">
	<meta name="generator" content="Hugo 0.47.1" />
	<meta property="og:title" content="透過kolla-ansible部署OpenStack" />
<meta property="og:description" content="

" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://mengzn.github.io/post/openstack/kolla-ansible/" /><meta property="article:published_time" content="2018-05-21T23:25:20&#43;08:00"/>
<meta property="article:modified_time" content="2018-05-21T23:25:20&#43;08:00"/>
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	<script type="text/javascript" src="/js/scripts.js"></script>
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container-outer">
		<header class="header">
			<div class="container container-inner">
				<div class="logo" role="banner">
					<a class="logo__link" href="/" title="Meng Ze&#39;s Blog" rel="home">
						<div class="logo__title">Meng Ze&#39;s Blog</div>
						<div class="logo__tagline">Record my learning process</div>
					</a>
				</div>
			</div>
			
<nav class="menu">
	<ul class="menu__list">
		<li class="menu__item"><a class="menu__link" href="/post/">HOME</a></li>
		<li class="menu__item"><a class="menu__link" href="/about/">ABOUT ME</a></li>
	</ul>
</nav>

		</header>
		<div class="wrapper flex">

<main class="main content">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">透過kolla-ansible部署OpenStack</h1><div class="post__meta meta">
<svg class="icon icon-time" width="16" height="14" viewBox="0 0 16 16"><path d="m8-.0000003c-4.4 0-8 3.6-8 8 0 4.4000003 3.6 8.0000003 8 8.0000003 4.4 0 8-3.6 8-8.0000003 0-4.4-3.6-8-8-8zm0 14.4000003c-3.52 0-6.4-2.88-6.4-6.4000003 0-3.52 2.88-6.4 6.4-6.4 3.52 0 6.4 2.88 6.4 6.4 0 3.5200003-2.88 6.4000003-6.4 6.4000003zm.4-10.4000003h-1.2v4.8l4.16 2.5600003.64-1.04-3.6-2.1600003z"/></svg>
<time class="post__meta-date meta-date" datetime="2018-05-21T23:25:20">May 21, 2018</time>
<span class="post__meta-categories meta-categories">
	<svg class="icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
	<span class="meta-categories__list"><a class="meta-categories__link" href="/categories/kolla" rel="category">kolla</a>, <a class="meta-categories__link" href="/categories/ansible" rel="category">ansible</a>, <a class="meta-categories__link" href="/categories/openstack" rel="category">openstack</a></span>
</span></div>
		</header>
<div class="post__toc toc">
	<div class="toc__title">Page content</div>
	<div class="toc__menu">
		<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#環境配置">環境配置</a>
<ul>
<li><a href="#架構">架構</a></li>
</ul></li>
<li><a href="#事前準備">事前準備</a></li>
<li><a href="#部署">部署</a>
<ul>
<li><a href="#設定options">設定Options</a>
<ul>
<li><a href="#kolla-options">kolla Options</a></li>
<li><a href="#openstack-option">OpenStack Option</a>
<ul>
<li><a href="#ceph">ceph</a></li>
<li><a href="#cinder">cinder</a></li>
<li><a href="#glance">glance</a></li>
<li><a href="#nova">nova</a></li>
</ul></li>
<li><a href="#network-option">network Option</a>
<ul>
<li><a href="#neutron-options">neutron Options</a></li>
</ul></li>
</ul></li>
<li><a href="#設定ansible-inventory">設定Ansible Inventory</a></li>
<li><a href="#設定外接的ceph">設定外接的ceph</a>
<ul>
<li><a href="#glance-1">glance</a></li>
<li><a href="#cinder-1">cinder</a></li>
<li><a href="#nova-1">nova</a></li>
</ul></li>
</ul></li>
<li><a href="#部署-1">部署</a>
<ul>
<li><a href="#generate-passwords">generate_passwords</a></li>
<li><a href="#bootstrap-servers">bootstrap-servers</a></li>
<li><a href="#prechecks">prechecks</a></li>
<li><a href="#deploy">deploy</a></li>
<li><a href="#post-deploy">post-deploy</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
	</div>
</div>
<div class="post__content clearfix">
			<p><img src="http://blog.inkubate.io/content/images/2018/03/kolla-1-1.png" alt="" /></p>

<p></p>

<p>還記得OpenStack在Mitaka版本的時候，跟著官方的教學部署一步一步部署。踩了非常多的坑，問了很多學長及前輩才把最基本的環境部署了起來。</p>

<p>隨著DevOps在雲端世界裡活絡起來後，OpenStack的社群也出現了透過Ansible去部署OpenStack的方式。可以讓許多複雜的地方透過自動化部部署去解決。隨後Container更是在整個IT產業鬧得沸沸揚揚的，再OpenStack的社群隨之興起了Kolla這個專案，透過Container的方式將OpenStack的元件進行打包。</p>

<p>Kolla-ansible結合了Container以及DevOps的兩大領域，透過Kolla幫助我們去建立出容器化OpenStack的image（如：Nova、Neutron、Keystone⋯⋯等）藉由kolla-ansible所提供的playbook去部署及管理這些Container。</p>

<!-- 本篇文章將會介紹如何透過這個專案快速部署一個 Production Ready, High-availability 的 OpenStack 環境（目前版本為 Queens） -->

<h2 id="環境配置">環境配置</h2>

<p>這邊環境配置上，大家可能會覺得很奇怪&hellip;，因為我手邊的實體機器規格非常的不一致，中間IP還穿插了共用這個網段的小夥伴xD</p>

<table>
<thead>
<tr>
<th>OpenStack Role</th>
<th>RAM</th>
<th>CPUs</th>
<th>IP Address(Manger)</th>
<th>IP Address(Tunnel)</th>
</tr>
</thead>

<tbody>
<tr>
<td>VIP</td>
<td>&mdash;-</td>
<td>&mdash;&ndash;</td>
<td>10.0.0.7</td>
<td>&mdash;&mdash;&ndash;</td>
</tr>

<tr>
<td>deploy node</td>
<td>8G</td>
<td>4Cores</td>
<td>10.0.0.8</td>
<td>&mdash;&mdash;&ndash;</td>
</tr>

<tr>
<td>controller,network1</td>
<td>16G</td>
<td>8Cores</td>
<td>10.0.0.9</td>
<td>192.168.0.9</td>
</tr>

<tr>
<td>network2</td>
<td>8G</td>
<td>4Cores</td>
<td>10.0.0.10</td>
<td>192.168.0.10</td>
</tr>

<tr>
<td>network3</td>
<td>8G</td>
<td>4Cores</td>
<td>10.0.0.11</td>
<td>192.168.0.11</td>
</tr>

<tr>
<td>compute1</td>
<td>40G</td>
<td>24Cores</td>
<td>10.0.0.12</td>
<td>192.168.0.12</td>
</tr>

<tr>
<td>compute2</td>
<td>18G</td>
<td>16Cores</td>
<td>10.0.0.13</td>
<td>192.168.0.13</td>
</tr>

<tr>
<td>compute3</td>
<td>24G</td>
<td>24Cores</td>
<td>10.0.0.14</td>
<td>192.168.0.14</td>
</tr>

<tr>
<td>compute4</td>
<td>32G</td>
<td>24Cores</td>
<td>10.0.0.18</td>
<td>192.168.0.15</td>
</tr>
</tbody>
</table>

<h3 id="架構">架構</h3>

<p>說明本次部署OpenStack環境的基本架構</p>

<p>controller因為機器規格問題不做HA</p>

<p>network的部分大致上分為:</p>

<p>Neutron External Interface  :為本次 OpenStack 環境對外的網段(floating IP)</p>

<p>API interface ：10.0.0.0/24 為本次 OpenStack 環境內部個元件互相溝通的網段</p>

<p>Storage Interface：192.168.3.0/24 為本次 OpenStack 環境儲存的網段（外接到小夥伴的ceph上</p>

<p>Tunnel Interface： 192.168.0.0/24 為本次 OpenStack 環境 instance 通走的網段</p>

<h2 id="事前準備">事前準備</h2>

<ul>
<li>每個節點上都需要安裝python</li>
<li>部署節點 ssh 至各節點上不需要密碼登入</li>
<li>部署節點需要安裝Ansible</li>
<li>Tunnel 的網路要拉好（設好IP</li>
<li>Manger 的網路要拉好(設好IP</li>
<li>Storage 的網路要拉好(可以達到小夥伴的ceph monitor 上</li>
</ul>

<h2 id="部署">部署</h2>

<p>首先我們需要再部署節點上安裝ansible，clone kolla-ansible的repo下來。</p>

<blockquote>
<p><strong>以下操作皆在部署節點上，並且使用root進行操作</strong></p>
</blockquote>

<p>透過pip安裝的Ansible，並且將kolla-ansible專案clone下來最後把預設的設定檔複製下來。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$apt</span> update
<span style="color:#00cdcd">$apt</span> install python python-pip git -y
<span style="color:#00cdcd">$pip</span> install ansible
<span style="color:#00cdcd">$git</span> clone https://github.com/openstack/kolla-ansible -b stable/queens
<span style="color:#00cdcd">$pip</span> install -r kolla-ansible/requirements.txt
<span style="color:#00cdcd">$pip</span> install ./kolla-ansible
<span style="color:#00cdcd">$cp</span> kolla-ansible/etc/kolla/ /etc/kolla
<span style="color:#00cdcd">$cp</span> kolla-ansible/ansible/inventory/multinode ./</code></pre></div>
<p>可以透過<code>ansible</code>指令去驗證，ansible是否安裝成功。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$ansible</span>
ansible
Usage: ansible &lt;host-pattern&gt; <span style="color:#39c">[</span>options<span style="color:#39c">]</span>

Define and run a single task <span style="color:#cd0000">&#39;playbook&#39;</span> against a <span style="color:#cd00cd">set</span> of hosts

Options:
  -a MODULE_ARGS, --args<span style="color:#39c">=</span>MODULE_ARGS
                        module arguments
  --ask-vault-pass      ask <span style="color:#cdcd00">for</span> vault password
...</code></pre></div>
<p>可以透過<code>kolla-ansible</code>指令去驗證，kolla-ansible是否安裝成功。（唸起來好繞口啊xD</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$kolla</span>-ansible
Usage: /usr/local/bin/kolla-ansible COMMAND <span style="color:#39c">[</span>options<span style="color:#39c">]</span>

Options:
    --inventory, -i &lt;inventory_path&gt;   Specify path to ansible inventory file
    --playbook, -p &lt;playbook_path&gt;     Specify path to ansible playbook file
    --configdir &lt;config_path&gt;          Specify path to directory with globals.yml
    --key -k &lt;key_path&gt;                Specify path to ansible vault keyfile
    --help, -h                         Show this usage information
    --tags, -t &lt;tags&gt;                  Only run plays and tasks tagged with these values
    --skip-tags &lt;tags&gt;                 Only run plays and tasks whose tags <span style="color:#cdcd00">do</span> not match these values
...</code></pre></div>
<h3 id="設定options">設定Options</h3>

<p>在<code>/etc/kolla/globals.yml</code>內放置了所有kolla-ansible的設定檔案，我們可以針對我們的需求去進行修改，這邊拿幾個我有進行修改的出來說明。</p>

<h4 id="kolla-options">kolla Options</h4>

<p>這邊我們可以去選擇使用這個image的os，這次部署採用的是ubuntu為基底的image。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#000080"># Valid options are [ centos, oraclelinux, ubuntu ]</span>
kolla_base_distro: <span style="color:#cd0000">&#34;ubuntu&#34;</span></code></pre></div>
<p>這邊我們可以去選擇使用發行版本所包好的binary，或是使用source code所build出的 ，來當image使用。這次部署所採用的是<code>source</code>。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#000080"># Valid options are [ binary, source ]</span>
kolla_install_type：source</code></pre></div>
<p>這次部署OpenStack的版本採用的是<code>queens</code>版，也可以採用<code>pike</code>。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#000080"># Valid option is Docker repository tag</span>
openstack_release: <span style="color:#cd0000">&#34;queens&#34;</span></code></pre></div>
<p><code>kolla_internal_vip_address</code> 與 <code>kolla_internal_fqdn</code> 是內部元件溝通用的IP與FQDN，這邊填入我們的<code>VIP</code>。</p>

<blockquote>
<p>VIP 必須是一個未被使用的IP，同時要跟API interface 在同一個網段。</p>
</blockquote>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#000080"># This should be a VIP, an unused IP on your network that will float between</span>
<span style="color:#000080"># the hosts running keepalived for high-availability. If you want to run an</span>
<span style="color:#000080"># All-In-One without haproxy and keepalived, you can set enable_haproxy to no</span>
<span style="color:#000080"># in &#34;OpenStack options&#34; section, and set this value to the IP of your</span>
<span style="color:#000080"># &#39;network_interface&#39; as set in the Networking section below.</span>
kolla_internal_vip_address: <span style="color:#cd0000">&#34;10.0.0.7&#34;</span>

<span style="color:#000080"># This is the DNS name that maps to the kolla_internal_vip_address VIP. By</span>
<span style="color:#000080"># default it is the same as kolla_internal_vip_address.</span>
kolla_internal_fqdn: <span style="color:#cd0000">&#34;{{ kolla_internal_vip_address }}&#34;</span></code></pre></div>
<h4 id="openstack-option">OpenStack Option</h4>

<p>這邊可以選擇要啟用或是不啟用的OpenStack服務，會針對我修改過的部分進行說明。</p>

<h5 id="ceph">ceph</h5>

<p>這邊我們要外接ceph，不希望OpenStack起來的時候自帶ceph。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">enable_ceph: <span style="color:#cd0000">&#34;no&#34;</span></code></pre></div>
<h5 id="cinder">cinder</h5>

<p>Cinder Volume 跟 Cinder Backup 也是會由 Ceph 提供，同樣將 backend 改成 Ceph</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">enable_cinder: <span style="color:#cd0000">&#34;yes&#34;</span>
enable_cinder_backup: <span style="color:#cd0000">&#34;yes&#34;</span>
cinder_backend_ceph: <span style="color:#cd0000">&#34;yes&#34;</span>
cinder_backup_driver: <span style="color:#cd0000">&#34;ceph&#34;</span></code></pre></div>
<h5 id="glance">glance</h5>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">glance_backend_file: <span style="color:#cd0000">&#34;yes&#34;</span>
glance_backend_ceph: <span style="color:#cd0000">&#34;yes&#34;</span></code></pre></div>
<h5 id="nova">nova</h5>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">nova_backend_ceph: <span style="color:#cd0000">&#34;yes&#34;</span>
nova_compute_virt_type: <span style="color:#cd0000">&#34;kvm&#34;</span></code></pre></div>
<p>到這邊我們的Option都已經設定完成，在不同的需求之下我們可以針對這個檔案進行一些調整。</p>

<p>如果要針對各別的服務進行修改調整的話，可以參考<a href="https://docs.openstack.org/kolla-ansible/latest/admin/advanced-configuration.html">官方</a>的這篇說明。</p>

<h4 id="network-option">network Option</h4>

<h5 id="neutron-options">neutron Options</h5>

<p>網路是OpenStack至關重要的一環，這邊要設定的是個節點上內部溝通、外部溝通、儲存溝通⋯⋯等的<code>interface</code>名稱，因為我們機器上的網卡名稱都不一樣所以我們在Ansible Inventory （multinode）做 <code>override</code>的動作。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#000080">#kolla_external_vip_interface: &#34;eth0&#34;</span>
<span style="color:#000080">#api_interface: &#34;{{ network_interface }}&#34;</span>
<span style="color:#000080">#storage_interface: &#34;enp2s0f0&#34;</span>
<span style="color:#000080">#cluster_interface: &#34;enp2s0f1&#34;</span>
<span style="color:#000080">#tunnel_interface: &#34;{{ network_interface }}&#34;</span>
<span style="color:#000080">#dns_interface: &#34;{{ network_interface }}&#34;</span>
neutron_plugin_agent: <span style="color:#cd0000">&#34;openvswitch&#34;</span></code></pre></div>
<h3 id="設定ansible-inventory">設定Ansible Inventory</h3>

<p>依照本次需求及上述提到的<code>neutron Options</code>需要<code>override</code>的部分，我將<code>inventory</code>設置如下所示：一台controller、三台network、四台compute</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#39c">[</span>all:vars<span style="color:#39c">]</span>
<span style="color:#00cdcd">ansible_user</span><span style="color:#39c">=</span>root
<span style="color:#39c">[</span>control<span style="color:#39c">]</span>
controller1 <span style="color:#00cdcd">neutron_external_interface</span><span style="color:#39c">=</span>enp1s0 <span style="color:#00cdcd">api_interface</span><span style="color:#39c">=</span>eno1 <span style="color:#00cdcd">network_interface</span><span style="color:#39c">=</span>eno1 <span style="color:#00cdcd">tunnel_interface</span><span style="color:#39c">=</span>enp6s0

<span style="color:#39c">[</span>network<span style="color:#39c">]</span>
controller1 <span style="color:#00cdcd">neutron_external_interface</span><span style="color:#39c">=</span>enp1s0 <span style="color:#00cdcd">api_interface</span><span style="color:#39c">=</span>eno1 <span style="color:#00cdcd">network_interface</span><span style="color:#39c">=</span>eno1 <span style="color:#00cdcd">tunnel_interface</span><span style="color:#39c">=</span>enp6s0
controller2 <span style="color:#00cdcd">neutron_external_interface</span><span style="color:#39c">=</span>enp1s0 <span style="color:#00cdcd">api_interface</span><span style="color:#39c">=</span>enp3s0 <span style="color:#00cdcd">network_interface</span><span style="color:#39c">=</span>enp3s0 <span style="color:#00cdcd">tunnel_interface</span><span style="color:#39c">=</span>enp2s0
controller3 <span style="color:#00cdcd">neutron_external_interface</span><span style="color:#39c">=</span>enp2s0 <span style="color:#00cdcd">api_interface</span><span style="color:#39c">=</span>enp1s0 <span style="color:#00cdcd">network_interface</span><span style="color:#39c">=</span>enp1s0 <span style="color:#00cdcd">tunnel_interface</span><span style="color:#39c">=</span>enp3s0

<span style="color:#39c">[</span>external-compute<span style="color:#39c">]</span>
compute4 <span style="color:#00cdcd">network_interface</span><span style="color:#39c">=</span>eno1 <span style="color:#00cdcd">storage_interface</span><span style="color:#39c">=</span>eno4 <span style="color:#00cdcd">tunnel_interface</span><span style="color:#39c">=</span>eno2
compute3 <span style="color:#00cdcd">network_interface</span><span style="color:#39c">=</span>eno1 <span style="color:#00cdcd">tunnel_interface</span><span style="color:#39c">=</span>eno2 <span style="color:#00cdcd">storage_interface</span><span style="color:#39c">=</span>rename5
compute2 <span style="color:#00cdcd">network_interface</span><span style="color:#39c">=</span>enp11s0f0 <span style="color:#00cdcd">tunnel_interface</span><span style="color:#39c">=</span>enp11s0f1
compute1 <span style="color:#00cdcd">network_interface</span><span style="color:#39c">=</span>eno3 <span style="color:#00cdcd">tunnel_interface</span><span style="color:#39c">=</span>eno4

<span style="color:#39c">[</span>storage<span style="color:#39c">]</span>
compute4 <span style="color:#00cdcd">network_interface</span><span style="color:#39c">=</span>eno1 <span style="color:#00cdcd">storage_interface</span><span style="color:#39c">=</span>eno4 <span style="color:#00cdcd">tunnel_interface</span><span style="color:#39c">=</span>eno2
compute3 <span style="color:#00cdcd">network_interface</span><span style="color:#39c">=</span>eno1 <span style="color:#00cdcd">tunnel_interface</span><span style="color:#39c">=</span>eno2 <span style="color:#00cdcd">storage_interface</span><span style="color:#39c">=</span>rename5</code></pre></div>
<h3 id="設定外接的ceph">設定外接的ceph</h3>

<p>可以參考<a href="https://docs.openstack.org/kolla-ansible/latest/reference/external-ceph-guide.html">官方</a>的這篇文章。</p>

<h4 id="glance-1">glance</h4>

<p>建立RBD back end<code>/etc/kolla/config/glance/glance-api.conf</code></p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml">[DEFAULT]
show_image_direct_url = True

[glance_store]
stores = rbd
default_store = rbd
rbd_store_pool = openstak<span style="">-</span>image
rbd_store_user = glance
rbd_store_ceph_conf = <span style="">/</span>etc<span style="">/</span>ceph<span style="">/</span>ceph.conf</code></pre></div>
<p>建立 Ceph configuration <code>/etc/kolla/config/glance/ceph.conf</code></p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml">[global]
fsid = <span style="">&lt;</span>fs<span style="">-</span>id<span style="">&gt;</span>
mon_initial_members = <span style="">&lt;</span>ceph monitor members<span style="">&gt;</span>
mon_host = <span style="">&lt;</span>ceph monitor<span style="">&gt;</span>
auth_cluster_required = <span style="">&lt;</span>ceph auth<span style="">&gt;</span>
auth_service_required = <span style="">&lt;</span>ceph auth<span style="">&gt;</span>
auth_client_required = <span style="">&lt;</span>ceph auth<span style="">&gt;</span></code></pre></div>
<p>建立 Ceph keyring <code>/etc/kolla/config/glance/ceph.client.&lt;username&gt;.keyring</code>(注意上面的<code>rbd_store_user</code>跟這個username要是一樣的)</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml">[client.glance]
        key = AQAObCZawGRdDBAAn1k1aryvzx6YYY5XR4hBxQ==</code></pre></div>
<h4 id="cinder-1">cinder</h4>

<p>建立RBD back end<code>/etc/kolla/config/cinder/cinder-volume.conf</code></p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml">[DEFAULT]
enabled_backends=rbd<span style="color:#cd00cd">-1</span>

[rbd<span style="color:#cd00cd">-1</span>]
rbd_ceph_conf=<span style="">/</span>etc<span style="">/</span>ceph<span style="">/</span>ceph.conf
rbd_user=cinder
backend_host=rbd<span style="">:</span>volumes
rbd_pool=openstack<span style="">-</span>volume
volume_backend_name=rbd<span style="color:#cd00cd">-1</span>
volume_driver=cinder.volume.drivers.rbd.RBDDriver
rbd_secret_uuid =<span style="">{{</span> cinder_rbd_secret_uuid <span style="">}}</span></code></pre></div>
<p>建立 cinder-backup configuration <code>/etc/kolla/config/cinder/cinder-backup.conf</code></p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml">[DEFAULT]
backup_ceph_conf=<span style="">/</span>etc<span style="">/</span>ceph<span style="">/</span>ceph.conf
backup_ceph_user=cinder<span style="">-</span>backup
backup_ceph_chunk_size = <span style="color:#cd00cd">134217728</span>
backup_ceph_pool=openstack<span style="">-</span>backup
backup_driver = cinder.backup.drivers.ceph
backup_ceph_stripe_unit = <span style="color:#cd00cd">0</span>
backup_ceph_stripe_count = <span style="color:#cd00cd">0</span>
restore_discard_excess_bytes = <span style="color:#cdcd00">true</span></code></pre></div>
<p>建立 Ceph configuration <code>/etc/kolla/config/cinder/ceph.conf</code></p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml">[global]
fsid = <span style="">&lt;</span>fs<span style="">-</span>id<span style="">&gt;</span>
mon_initial_members = <span style="">&lt;</span>ceph monitor members<span style="">&gt;</span>
mon_host = <span style="">&lt;</span>ceph monitor<span style="">&gt;</span>
auth_cluster_required = <span style="">&lt;</span>ceph auth<span style="">&gt;</span>
auth_service_required = <span style="">&lt;</span>ceph auth<span style="">&gt;</span>
auth_client_required = <span style="">&lt;</span>ceph auth<span style="">&gt;</span></code></pre></div>
<h4 id="nova-1">nova</h4>

<p>建立nova-compute onfiguration <code>/etc/kolla/config/nova/nova-compute.conf</code></p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-toml" data-lang="toml">[libvirt]
images_rbd_pool=openstak<span style="">-</span>rbd
images_type=rbd
images_rbd_ceph_conf=<span style="">/</span>etc<span style="">/</span>ceph<span style="">/</span>ceph.conf
rbd_user=nova</code></pre></div>
<p>將ceph管理員給你的<code>ceph.conf</code> 、 <code>nova client keyring</code> 、 <code>cinder client keyring</code>全部都放到/etc/kolla/config/nova/</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$ls</span> /etc/kolla/config/nova/
ceph.client.cinder.keyring  ceph.client.nova.keyring  ceph.conf</code></pre></div>
<p>這邊就配置完成，Openstack <code>cinder</code> 、 <code>nova</code> 、 <code>glance</code>外接ceph了。</p>

<h2 id="部署-1">部署</h2>

<p>使用kolla-ansible部署環境非常的簡單只要幾個步驟就可輕鬆的完成。</p>

<h3 id="generate-passwords">generate_passwords</h3>

<p>幫你產生OpenStack每個服務的密碼，並放在<code>/etc/kolla/passwords.yml</code>中。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$kolla</span>-genpwd</code></pre></div>
<h3 id="bootstrap-servers">bootstrap-servers</h3>

<p>幫你在要部署的機器上安裝<code>docker</code>、<code>git</code>⋯⋯等等需要用到的套件。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$kolla</span>-ansible -i ./multinode bootstrap-servers</code></pre></div>
<h3 id="prechecks">prechecks</h3>

<p>幫你在要部署的機器上根據你的設定檔案，去確認<code>port</code>是否被佔用⋯⋯等情況。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$kolla</span>-ansible -i ./multinode prechecks</code></pre></div>
<h3 id="deploy">deploy</h3>

<p>會實際去部署OpenStack環境，包含build pull run config ⋯⋯等動作，所有要啟動或是設定的動作都會在這個stage被完成。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$kolla</span>-ansible -i ./multinode deploy</code></pre></div>
<p>這個<code>playbook</code>跑完後沒有問題的話，恭喜這個OpenStack環境基本上就已經建好了。</p>

<p>可以透過瀏覽器 連接到 <code>kolla_internal_vip_address</code>(本篇<code>VIP</code>為10.0.0.7 )就可以看到 OpenStack 的 dashboard了。</p>

<h3 id="post-deploy">post-deploy</h3>

<p>這邊會幫你產生一個<code>/etc/kolla/admin-openrc.sh</code>，裡面放了openstack admin的一些基本的資訊。</p>
<div class="highlight"><pre style="color:#ccc;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#00cdcd">$kolla</span>-ansible -i ./multinode post-deploy
Post-Deploying Playbooks : ansible-playbook -i multinode -e @/etc/kolla/globals.yml -e @/etc/kolla/passwords.yml -e <span style="color:#00cdcd">CONFIG_DIR</span><span style="color:#39c">=</span>/etc/kolla  /usr/local/share/kolla-ansible/ansible/post-deploy.yml

PLAY <span style="color:#39c">[</span>Creating admin openrc file on the deploy node<span style="color:#39c">]</span> ********************************************

TASK <span style="color:#39c">[</span>Gathering Facts<span style="color:#39c">]</span> **************************************************************************
ok: <span style="color:#39c">[</span>localhost<span style="color:#39c">]</span>

TASK <span style="color:#39c">[</span>template<span style="color:#39c">]</span> *********************************************************************************
changed: <span style="color:#39c">[</span>localhost<span style="color:#39c">]</span>

PLAY RECAP **************************************************************************************
localhost                  : <span style="color:#00cdcd">ok</span><span style="color:#39c">=</span><span style="color:#cd00cd">2</span>    <span style="color:#00cdcd">changed</span><span style="color:#39c">=</span><span style="color:#cd00cd">1</span>    <span style="color:#00cdcd">unreachable</span><span style="color:#39c">=</span><span style="color:#cd00cd">0</span>    <span style="color:#00cdcd">failed</span><span style="color:#39c">=</span><span style="color:#cd00cd">0</span></code></pre></div>
<p>可以透過<code>/etc/kolla/admin-openrc.sh</code>內的帳號密碼進行登入。</p>
		</div>
		
<div class="post__tags tags clearfix">
	<svg class="icon icon-tag" width="16" height="16" viewBox="0 0 16 16"><path d="M16 9.5c0 .373-.24.74-.5 1l-5 5c-.275.26-.634.5-1 .5-.373 0-.74-.24-1-.5L1 8a2.853 2.853 0 0 1-.7-1C.113 6.55 0 5.973 0 5.6V1.4C0 1.034.134.669.401.401.67.134 1.034 0 1.4 0h4.2c.373 0 .95.113 1.4.3.45.187.732.432 1 .7l7.5 7.502c.26.274.5.632.5.998zM3.5 5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/></svg>
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link btn" href="/tags/kolla/" rel="tag">kolla</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/ansible/" rel="tag">ansible</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/openstack/" rel="tag">openstack</a></li>
	</ul>
</div>
	</article>
	
<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Meng Ze avatar" src="/img/apple.jpg" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Meng Ze</span>
	</div>
	<div class="authorbox__description">
		Meng 專注於雲端世界的耕耘者，喜歡潛水慢跑等休閒運動。
	</div>
</div>
	
<nav class="post-nav flex">
	<div class="post-nav__item post-nav__item--prev">
		<a class="post-nav__link" href="/post/golang/pointer/" rel="prev"><span class="post-nav__caption">«&thinsp;Previous</span><p class="post-nav__post-title">簡單介紹一下golang的指標</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next">
		<a class="post-nav__link" href="/post/openstack/kolla-kubernetes/" rel="next"><span class="post-nav__caption">Next&thinsp;»</span><p class="post-nav__post-title">Kolla Kubernetes</p></a>
	</div>
</nav>
	
<section class="comments">
	<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "meng-ze" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

</main>


<aside class="sidebar">
	
	
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/post/kubernetes/istio/istio1.0-install/">Istio1.0 安裝及簡易操作</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/kubernetes/kubeless/">初嚐kubeless的滋味</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/kubernetes/minkube-mount/">minikube 在掛載本機遇到的神奇問題</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/openstack/kolla-kubernetes/">Kolla Kubernetes</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/openstack/kolla-ansible/">透過kolla-ansible部署OpenStack</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/golang/pointer/">簡單介紹一下golang的指標</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/grpc/proto/">初嚐Protocol Buffer</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/sdn/ovs-commonly-command/">OVS Commonly Command</a></li>
		</ul>
	</div>
</div>
	
<div class="widget-categories widget">
	<h4 class="widget__title">Categories</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/categories/ansible">Ansible</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/golang">Golang</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/grpc">Grpc</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/istio">Istio</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/kolla">Kolla</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/kubernetes">Kubernetes</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/networking">Networking</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/openstack">Openstack</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/serverless">Serverless</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/servicemesh">Servicemesh</a></li>
		</ul>
	</div>
</div>
	
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">Social</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Facebook" rel="noopener noreferrer" href="https://facebook.com/ameng0330" target="_blank">
				<svg class="widget-social__link-icon icon-facebook" viewBox="0 0 352 352" width="24" height="24" fill="#fff"><path d="m0 32v288c0 17.5 14.5 32 32 32h288c17.5 0 32-14.5 32-32v-288c0-17.5-14.5-32-32-32h-288c-17.5 0-32 14.5-32 32zm320 0v288h-83v-108h41.5l6-48h-47.5v-31c0-14 3.5-23.5 23.5-23.5h26v-43.5c-4.4-.6-19.8-1.5-37.5-1.5-36.9 0-62 22.2-62 63.5v36h-42v48h42v108h-155v-288z"/></svg>
				<span>Facebook</span>
			</a>
		</div>
		
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="LinkedIn" rel="noopener noreferrer" href="https://linkedin.com/in/meng-ze-li-0330" target="_blank">
				<svg class="widget-social__link-icon icon-linkedin" viewBox="0 0 352 352" width="24" height="24" fill="#fff"><path d="M0,40v272c0,21.9,18.1,40,40,40h272c21.9,0,40-18.1,40-40V40c0-21.9-18.1-40-40-40H40C18.1,0,0,18.1,0,40z M312,32 c4.6,0,8,3.4,8,8v272c0,4.6-3.4,8-8,8H40c-4.6,0-8-3.4-8-8V40c0-4.6,3.4-8,8-8H312z M59.5,87c0,15.2,12.3,27.5,27.5,27.5 c15.2,0,27.5-12.3,27.5-27.5c0-15.2-12.3-27.5-27.5-27.5C71.8,59.5,59.5,71.8,59.5,87z M187,157h-1v-21h-45v152h47v-75 c0-19.8,3.9-39,28.5-39c24.2,0,24.5,22.4,24.5,40v74h47v-83.5c0-40.9-8.7-72-56.5-72C208.5,132.5,193.3,145.1,187,157z M64,288h47.5 V136H64V288z"/></svg>
				<span>LinkedIn</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Telegram" rel="noopener noreferrer" href="https://t.me/Jason0330" target="_blank">
				<svg class="widget-social__link-icon icon-telegram" viewBox="0 0 132 110" width="24" height="24"><path fill="#ddd" d="M50 103c-4 0-3-1-5-5L34 60l88-52"/><path fill="#aaa" d="M50 103c3 0 4-1 6-3l16-16-20-12"/><path fill="#fff" d="M52 72l48 36c6 3 10 2 11-5l20-93c2-8-3-11-8-9L7 45c-8 4-8 8-1 10l29 9 69-43c3-2 6-1 4 1"/></svg>
				<span>Telegram</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="GitHub" rel="noopener noreferrer" href="https://github.com/MengZn" target="_blank">
				<svg class="widget-social__link-icon icon-github" viewBox="0 0 384 374" width="24" height="24" fill="#fff"><path d="m192 0c-106.1 0-192 85.8-192 191.7 0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2 0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8 0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7 0 0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4 0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5 0 25.6-.2 46.3-.2 52.6 0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg>
				<span>GitHub</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Email" href="mailto:jason.meng.lee@gmail.com">
				<svg class="widget-social__link-icon icon-mail" viewBox="0 0 416 288" width="24" height="24" fill="#fff"><path d="m0 16v256 16h16 384 16v-16-256-16h-16-384-16zm347 16-139 92.5-139-92.5zm-148 125.5 9 5.5 9-5.5 167-111.5v210h-352v-210z"/></svg>
				<span>jason.meng.lee@gmail.com</span>
			</a>
		</div>
	</div>
</div>
	
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget-taglist__link widget__link btn" href="/tags/ansible" title="Ansible">Ansible</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/golang" title="Golang">Golang</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/grpc" title="Grpc">Grpc</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/istio" title="Istio">Istio</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/kolla" title="Kolla">Kolla</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/kubeless" title="Kubeless">Kubeless</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/kubernetes" title="Kubernetes">Kubernetes</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/minikube" title="Minikube">Minikube</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/openstack" title="Openstack">Openstack</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/ovs" title="Ovs">Ovs</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/proto" title="Proto">Proto</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/sdn" title="Sdn">Sdn</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/serverless" title="Serverless">Serverless</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/servicemesh" title="Servicemesh">Servicemesh</a>
	</div>
</div>
</aside>
	</div>
		<footer class="footer">
			<div class="container container-inner">
				<div class="footer__copyright">&copy; 2018 Meng Ze&#39;s Blog. <span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span></div>
			</div>
		</footer>
	</div>

<script>
	var navigation = responsiveNav(".menu", {
		navClass: "menu--collapse",
		label: "Menu",
	});
</script></body>
</html>