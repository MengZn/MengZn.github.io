<!DOCTYPE html>
<html lang="zh-tw">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Kolla Kubernetes</title>
	<meta name="description" content="">
	<meta name="generator" content="Hugo 0.47.1" />
	<meta property="og:title" content="Kolla Kubernetes" />
<meta property="og:description" content="kolla是為了提供production-ready的 OpenStack Cloud 之container和deployment tools。
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mengzn.github.io/post/openstack/kolla-kubernetes/" /><meta property="article:published_time" content="2018-05-21T23:25:20&#43;08:00"/>
<meta property="article:modified_time" content="2018-05-21T23:25:20&#43;08:00"/>
	
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">
	<link rel="stylesheet" href="/css/style.css">
	<script type="text/javascript" src="/js/scripts.js"></script>
	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container-outer">
		<header class="header">
			<div class="container container-inner">
				<div class="logo" role="banner">
					<a class="logo__link" href="/" title="Meng Ze&#39;s Blog" rel="home">
						<div class="logo__title">Meng Ze&#39;s Blog</div>
						<div class="logo__tagline">Record my learning process</div>
					</a>
				</div>
			</div>
			
<nav class="menu">
	<ul class="menu__list">
		<li class="menu__item"><a class="menu__link" href="/post/">HOME</a></li>
		<li class="menu__item"><a class="menu__link" href="/about/">ABOUT ME</a></li>
	</ul>
</nav>

		</header>
		<div class="wrapper flex">

<main class="main content">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kolla Kubernetes</h1><div class="post__meta meta">
<svg class="icon icon-time" width="16" height="14" viewBox="0 0 16 16"><path d="m8-.0000003c-4.4 0-8 3.6-8 8 0 4.4000003 3.6 8.0000003 8 8.0000003 4.4 0 8-3.6 8-8.0000003 0-4.4-3.6-8-8-8zm0 14.4000003c-3.52 0-6.4-2.88-6.4-6.4000003 0-3.52 2.88-6.4 6.4-6.4 3.52 0 6.4 2.88 6.4 6.4 0 3.5200003-2.88 6.4000003-6.4 6.4000003zm.4-10.4000003h-1.2v4.8l4.16 2.5600003.64-1.04-3.6-2.1600003z"/></svg>
<time class="post__meta-date meta-date" datetime="2018-05-21T23:25:20">May 21, 2018</time>
<span class="post__meta-categories meta-categories">
	<svg class="icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2l1 2h8v11h-16v-13z"/></svg>
	<span class="meta-categories__list"><a class="meta-categories__link" href="/categories/openstack" rel="category">OpenStack</a></span>
</span></div>
		</header>
<div class="post__toc toc">
	<div class="toc__title">Page content</div>
	<div class="toc__menu">
		<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#環境配置">環境配置</a></li>
<li><a href="#部署kubernetes">部署kubernetes</a></li>
<li><a href="#如果需要拆除你的openstack-kolla-kubernetes環境">如果需要拆除你的OpenStack Kolla Kubernetes環境</a></li>
</ul></li>
</ul>
</nav>
	</div>
</div>
<div class="post__content clearfix">
			<p>kolla是為了提供production-ready的 OpenStack Cloud 之container和deployment tools。
</p>

<h2 id="環境配置">環境配置</h2>

<p>本次安裝是使用三台Bare Metal去作部署，作業系統採用的是Ubuntu 16.04 LTS版。</p>

<table>
<thead>
<tr>
<th>Kubernetes Role</th>
<th>OpeStack Role</th>
<th>RAM</th>
<th>CPUs</th>
<th>IP Address</th>
</tr>
</thead>

<tbody>
<tr>
<td>Master</td>
<td>Controller</td>
<td>16G</td>
<td>8Cores</td>
<td>10.0.0.190</td>
</tr>

<tr>
<td>Node1</td>
<td>Compute1</td>
<td>16G</td>
<td>8Cores</td>
<td>10.0.0.191</td>
</tr>

<tr>
<td>Node2</td>
<td>Compute2</td>
<td>16G</td>
<td>8Cores</td>
<td>10.0.0.192</td>
</tr>
</tbody>
</table>

<h2 id="部署kubernetes">部署kubernetes</h2>

<p>這邊利用的是kubeadm進行kubernetes的安裝『版本是Kubernetes1.10』，可以參考<a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/">官方網站</a>的部屬方式。</p>

<p>安裝 Kubernetes latest version  and other dependencies:</p>

<pre><code class="language-bash">$curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo -E apt-key add -
$cat &lt;&lt;EOF &gt; kubernetes.list
deb http://apt.kubernetes.io/ kubernetes-xenial main
EOF

$sudo cp -aR kubernetes.list /etc/apt/sources.list.d/kubernetes.list

$sudo apt-get update
$sudo apt-get install -y docker.io kubelet kubeadm kubectl
</code></pre>

<p>Kubernetes v1.8+ 要求關閉系統 Swap，如果不想關閉系統的Swap需要修改 kubelet 設定參數，我們利用以下指令關閉系統Swap：</p>

<pre><code class="language-bash">$swapoff -a &amp;&amp; sysctl -w vm.swappiness=0
</code></pre>

<p>透過以下指令啟動Docker Daemon。</p>

<pre><code class="language-bash">$systemctl enable docker &amp;&amp; systemctl start docker
</code></pre>

<p>確認Docker是否支援Cgroup Driver或是Systemd Driver，進一步修改 kubelet 設定參數。</p>

<pre><code class="language-bash">$CGROUP_DRIVER=$(sudo docker info | grep &quot;Cgroup Driver&quot; | awk '{print $3}')
$sudo sed -i &quot;s|KUBELET_KUBECONFIG_ARGS=|KUBELET_KUBECONFIG_ARGS=--cgroup-driver=$CGROUP_DRIVER |g&quot; /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
</code></pre>

<p>將橋接的IPv4流量傳遞給iptables</p>

<pre><code class="language-bash">$cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
$sysctl -p /etc/sysctl.d/k8s.conf
</code></pre>

<p>設置Kubernetes Server CIDR的DNS位置。</p>

<pre><code class="language-bash">$sudo sed -i 's/10.96.0.10/10.3.3.10/g' /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
</code></pre>

<p>利用以下重新載入kubelet相關的啟動參數</p>

<pre><code class="language-bash">$sudo systemctl daemon-reload
$sudo systemctl stop kubelet
$sudo systemctl enable kubelet
$sudo systemctl start kubelet
</code></pre>

<p>在master節點上使用kubeadm進行kubernetes 叢集的初始化</p>

<pre><code class="language-bash">$sudo kubeadm init --feature-gates CoreDNS=true --pod-network-cidr=10.1.0.0/16 --service-cidr=10.3.3.0/24
</code></pre>

<p>會得到下列輸出，我們利用下列輸出的資訊將其他節點加入叢集。</p>

<pre><code class="language-bash">You can now join any number of machines by running the following on each node
as root:

  kubeadm join 10.0.0.181:6443 --token pieol0.2kfzpwhosxuqhe6t --discovery-token-ca-cert-hash sha256:e55b423135642404ffc60bcae4793732f18b4ce2866a8419c87b7dd92724a481
</code></pre>

<p>在其他節點上我們可以利用以下指令加入叢集。</p>

<pre><code class="language-bash">$kubeadm join 10.0.0.181:6443 --token pieol0.2kfzpwhosxuqhe6t --discovery-token-ca-cert-hash sha256:e55b423135642404ffc60bcae4793732f18b4ce2866a8419c87b7dd92724a481
</code></pre>

<p>在master節點設定kube config。</p>

<pre><code class="language-bash">$mkdir -p $HOME/.kube
$sudo -H cp /etc/kubernetes/admin.conf $HOME/.kube/config
$sudo -H chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre>

<p>在master 安裝Kubernetes CNI，這邊採用的是Canal。</p>

<pre><code class="language-bash">$wget https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/canal/rbac.yaml
$kubectl apply -f rbac.yaml
$wget https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/canal/canal.yaml
$sed -i &quot;s@10.244.0.0/16@10.1.0.0/16@&quot; canal.yaml
$kubectl apply -f canal.yaml
</code></pre>

<p>因為我們要把kubernetes master當作openstack controller的角色，我們將kubernetes master 的節點污染拿掉。</p>

<pre><code class="language-bash">$kubectl taint nodes --all=true  node-role.kubernetes.io/master:NoSchedule-
</code></pre>

<p>在CNI安裝完成後可透過下列指令來檢查，Node &amp; Pod是否都準備好了。</p>

<pre><code class="language-bash">$kubectl get pod,node -o wide --all-namespaces

NAMESPACE     NAME                                READY     STATUS    RESTARTS   AGE
kube-system   pod/canal-297sw                     3/3       Running   0          2m
kube-system   pod/canal-f82qj                     3/3       Running   0          2m
kube-system   pod/canal-zxfbk                     3/3       Running   0          2m
kube-system   pod/coredns-7997f8864c-cglcr        1/1       Running   0          9m
kube-system   pod/coredns-7997f8864c-sxf2c        1/1       Running   0          9m
kube-system   pod/etcd-node1                      1/1       Running   0          8m
kube-system   pod/kube-apiserver-node1            1/1       Running   0          8m
kube-system   pod/kube-controller-manager-node1   1/1       Running   0          8m
kube-system   pod/kube-proxy-6gwws                1/1       Running   0          6m
kube-system   pod/kube-proxy-9xbdq                1/1       Running   0          6m
kube-system   pod/kube-proxy-z54k4                1/1       Running   0          9m
kube-system   pod/kube-scheduler-node1            1/1       Running   0          8m

NAME      STATUS     ROLES     AGE       VERSION
node1     Ready   master    8m        v1.10.3
node2     Ready   master    8m        v1.10.3
node3     Ready   master    8m        v1.10.3
</code></pre>

<p>利用BusyBox ，驗證Kubernetes 環境例如DNS 是否有通。</p>

<pre><code class="language-bash">$kubectl run -i -t $(uuidgen) --image=busybox --restart=Never
$nslookup kubernetes


Server:    10.3.3.10
Address 1: 10.3.3.10 kube-dns.kube-system.svc.cluster.local

Name:      kubernetes
Address 1: 10.3.3.1 kubernetes.default.svc.cluster.local
</code></pre>

<p>為kubernetes Helm 建立Tiller Service Account以及綁定Cluster-Admin Role</p>

<pre><code class="language-bash">$kubectl create serviceaccount tiller --namespace kube-system
$cat &lt;&lt;EOF | kubectl create -f -
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: tiller-clusterrolebinding
subjects:
- kind: ServiceAccount
  name: tiller
  namespace: kube-system
roleRef:
  kind: ClusterRole
  name: cluster-admin
  apiGroup: &quot;&quot;
EOF
</code></pre>

<p>接著我們安裝Kubernetes Helm，用來管理Helm package的元件。</p>

<pre><code class="language-bash">$curl -L https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get &gt; get_helm.sh
$chmod 700 get_helm.sh
$./get_helm.sh
$helm init --service-account tiller
</code></pre>

<p>由於kolla kubernetes 需要用到ansible git ，我們在master的節點需要安裝ansible ，其他節點需安裝python。</p>

<pre><code class="language-bash">$sudo apt-get update &amp;&amp; sudo apt-get install -y software-properties-common git python python-pip
$sudo apt-add-repository -y ppa:ansible/ansible
$sudo apt-get update &amp;&amp;  sudo apt-get install -y ansible
</code></pre>

<p>建立一個資料夾方便我們接下來的步驟</p>

<pre><code class="language-bash">$mkdir kolla-bringup
$cd kolla-bringup
</code></pre>

<p>下載 kolla-kubernetes &amp; kolla ansible</p>

<pre><code class="language-bash">$git clone http://github.com/openstack/kolla-ansible
$git clone http://github.com/openstack/kolla-kubernetes
$cd kolla-kubernetes
$git checkout 22ed0c232d7666afb6e288001b8814deea664992
$cd ../kolla-ansible
$git checkout origin/stable/pike
$cd ..
</code></pre>

<p>使用pip 安裝kolla-kubernetes &amp; kolla-ansible所需要的套件</p>

<pre><code class="language-bash">$sudo pip install -U kolla-ansible/ kolla-kubernetes
</code></pre>

<p>把相關設定檔製到/etc底下</p>

<pre><code class="language-bash">$cp -Ra  kolla-kubernetes/etc/kolla/ /etc
$cp -Ra  kolla-kubernetes/etc/kolla-kubernetes/ /etc
</code></pre>

<p>pip剛剛安裝的項目這時候可以幫我們生成default passwords</p>

<pre><code class="language-bash">$sudo kolla-kubernetes-genpwd
</code></pre>

<p>建立一個Kubernetes namespaces來隔離Kolla deployment</p>

<pre><code class="language-bash">$kubectl create namespace kolla
</code></pre>

<p>使用Label標記要成為Controller及Compute的節點，我們這邊將node1當成Controller，node2 node3當成Compute</p>

<pre><code class="language-bash">$kubectl label node node1 kolla_controller=true
$kubectl label node node2 kolla_compute=true
$kubectl label node node3 kolla_compute=true
</code></pre>

<p>將/etc/kolla/globals.yml設定檔，修改成與自己環境相符</p>

<p>將/etc/kolla/globals.yml中的network_interface設置為Management interface name。例如：eth1</p>

<p>將/etc/kolla/globals.yml中的neutron_external_interface設置為neutron external interface name。例如：eth2</p>

<p>將相關的openstack設定加入/etc/kolla/globals.yml</p>

<pre><code class="language-bash">$cat &lt;&lt;EOF &gt; add-to-globals.yml
kolla_install_type: &quot;source&quot;
tempest_image_alt_id: &quot;{{ tempest_image_id }}&quot;
tempest_flavor_ref_alt_id: &quot;{{ tempest_flavor_ref_id }}&quot;

neutron_plugin_agent: &quot;openvswitch&quot;
api_interface_address: 0.0.0.0
tunnel_interface_address: 0.0.0.0
orchestration_engine: KUBERNETES
memcached_servers: &quot;memcached&quot;
keystone_admin_url: &quot;http://keystone-admin:35357/v3&quot;
keystone_internal_url: &quot;http://keystone-internal:5000/v3&quot;
keystone_public_url: &quot;http://keystone-public:5000/v3&quot;
glance_registry_host: &quot;glance-registry&quot;
neutron_host: &quot;neutron&quot;
keystone_database_address: &quot;mariadb&quot;
glance_database_address: &quot;mariadb&quot;
nova_database_address: &quot;mariadb&quot;
nova_api_database_address: &quot;mariadb&quot;
neutron_database_address: &quot;mariadb&quot;
cinder_database_address: &quot;mariadb&quot;
ironic_database_address: &quot;mariadb&quot;
placement_database_address: &quot;mariadb&quot;
rabbitmq_servers: &quot;rabbitmq&quot;
openstack_logging_debug: &quot;True&quot;
enable_heat: &quot;no&quot;
enable_cinder: &quot;yes&quot;
enable_cinder_backend_lvm: &quot;yes&quot;
enable_cinder_backend_iscsi: &quot;yes&quot;
enable_cinder_backend_rbd: &quot;no&quot;
enable_ceph: &quot;no&quot;
enable_elasticsearch: &quot;no&quot;
enable_kibana: &quot;no&quot;
glance_backend_ceph: &quot;no&quot;
cinder_backend_ceph: &quot;no&quot;
nova_backend_ceph: &quot;no&quot;
EOF
$cat ./add-to-globals.yml | sudo tee -a /etc/kolla/globals.yml
</code></pre>

<p>接下來透過ansible幫我們產生OpneStack設定檔</p>

<pre><code class="language-bash">$ansible-playbook -e @/etc/kolla/globals.yml -e @/etc/kolla/passwords.yml -e CONFIG_DIR=/etc/kolla kolla-kubernetes/ansible/site.yml
</code></pre>

<p>使用官方提供的腳本幫助我們快速的把OpenStack的password，加到Kubernetes secrets</p>

<pre><code class="language-bash">$kolla-kubernetes/tools/secret-generator.py create
</code></pre>

<p>使用之前在pip安裝的檔案，快速的把OpenStack的設定檔，加入Kubernetes config maps裡</p>

<pre><code class="language-bash">$kollakube res create configmap \
    mariadb keystone horizon rabbitmq memcached nova-api nova-conductor \
    nova-scheduler glance-api-haproxy glance-registry-haproxy glance-api \
    glance-registry neutron-server neutron-dhcp-agent neutron-l3-agent \
    neutron-metadata-agent neutron-openvswitch-agent openvswitch-db-server \
    openvswitch-vswitchd nova-libvirt nova-compute nova-consoleauth \
    nova-novncproxy nova-novncproxy-haproxy neutron-server-haproxy \
    nova-api-haproxy cinder-api cinder-api-haproxy cinder-backup \
    cinder-scheduler cinder-volume iscsid tgtd keepalived \
    placement-api placement-api-haproxy
</code></pre>

<p>透過官方提供的腳本建立Kolla Helm Chart</p>

<pre><code class="language-bash">$kolla-kubernetes/tools/helm_build_all.sh .
</code></pre>

<pre><code class="language-bash">$cat &lt;&lt;EOF &gt; cloud.yaml
global:
   kolla:
     all:
       docker_registry: docker.io
       image_tag: &quot;4.0.0&quot;
       kube_logger: false
       external_vip: &quot;192.168.7.105&quot;
       base_distro: &quot;centos&quot;
       install_type: &quot;source&quot;
       tunnel_interface: &quot;docker0&quot;
     keystone:
       all:
         admin_port_external: &quot;true&quot;
         dns_name: &quot;192.168.7.105&quot;
       public:
         all:
           port_external: &quot;true&quot;
     rabbitmq:
       all:
         cookie: 67
     glance:
       api:
         all:
           port_external: &quot;true&quot;
     cinder:
       api:
         all:
           port_external: &quot;true&quot;
       volume_lvm:
         all:
           element_name: cinder-volume
         daemonset:
           lvm_backends:
           - '192.168.7.105': 'cinder-volumes'
     ironic:
       conductor:
         daemonset:
           selector_key: &quot;kolla_conductor&quot;
     nova:
       placement_api:
         all:
           port_external: true
       novncproxy:
         all:
           port: 6080
           port_external: true
     openvswitch:
       all:
         add_port: true
         ext_bridge_name: br-ex
         ext_interface_name: enp1s0f1
         setup_bridge: true
     horizon:
       all:
         port_external: true
EOF
</code></pre>

<p>將該數值修改成環境上Management interface的IP。例如10.0.0.178</p>

<pre><code class="language-bash">$sed -i &quot;s@192.168.7.105@10.0.0.178@g&quot; ./cloud.yaml
</code></pre>

<p>將該數值修改成環境上ext_interface_name的interface。例如：eth1</p>

<pre><code class="language-bash">$sed -i &quot;s@enp1s0f1@eth1@g&quot; ./cloud.yaml
</code></pre>

<p>將該數值修改成環境上Management interface。例如：eth2</p>

<pre><code class="language-bash">$sed -i &quot;s@docker0@eth2@g&quot; ./cloud.yaml
</code></pre>

<p>在這邊建立一個給Openstack rbac ，讓後來helm啟動的元件去取得Kubernetes資源不會有權限問題（OpenStack官方RBAC這一點還沒修正&hellip;）</p>

<pre><code class="language-bash">$cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  name: admin-user
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: default
  namespace: kolla
EOF
</code></pre>

<p>一個一個把openstack的服務使用helm啟動起來。（例如mariadb,rabbitmq,memcached&hellip;等)</p>

<pre><code class="language-bash">$helm install --debug kolla-kubernetes/helm/service/mariadb --namespace kolla --name mariadb --values ./cloud.yaml
$helm install --debug kolla-kubernetes/helm/service/rabbitmq --namespace kolla --name rabbitmq --values ./cloud.yaml
$helm install --debug kolla-kubernetes/helm/service/memcached --namespace kolla --name memcached --values ./cloud.yaml
$helm install --debug kolla-kubernetes/helm/service/keystone --namespace kolla --name keystone --values ./cloud.yaml
$helm install --debug kolla-kubernetes/helm/service/glance --namespace kolla --name glance --values ./cloud.yaml
$helm install --debug kolla-kubernetes/helm/service/cinder-control --namespace kolla --name cinder-control --values ./cloud.yaml
$helm install --debug kolla-kubernetes/helm/service/horizon --namespace kolla --name horizon --values ./cloud.yaml
$helm install --debug kolla-kubernetes/helm/service/openvswitch --namespace kolla --name openvswitch --values ./cloud.yaml
$helm install --debug kolla-kubernetes/helm/service/neutron --namespace kolla --name neutron --values ./cloud.yaml
$helm install --debug kolla-kubernetes/helm/service/nova-control --namespace kolla --name nova-control --values ./cloud.yaml
$helm install --debug kolla-kubernetes/helm/service/nova-compute --namespace kolla --name nova-compute --values ./cloud.yaml
</code></pre>

<p>這邊有可能遇到第一個問題，也就是nova-compute init 會卡在這個畫面。</p>

<pre><code class="language-bash">nova-api-create-cell-r288q  0/1    Init:2/3  0         5min
</code></pre>

<p>這邊發生了一些問題，官方沒有去修正他。先把這個helm chart 刪除掉，我在這邊修正了helm的設定檔案，去修改keystone的url。</p>

<pre><code class="language-bash">$helm delete --purge nova-compute
$vim kolla-bringup/kolla-kubernetes/helm/microservice/nova-api-create-simple-cell-job/templates/nova-api-create-cell.yaml

{{- $keystonePort := include &quot;kolla_val_get_str&quot; (dict &quot;key&quot; &quot;port&quot; &quot;searchPath&quot; $keystoneSearchPath &quot;Values&quot; .Values )| default &quot;5000&quot; }}
</code></pre>

<p>再重新build一次helm chart</p>

<pre><code class="language-bash">$kolla-kubernetes/tools/helm_build_all.sh .
</code></pre>

<p>再重新run一次修正過後的chart.</p>

<pre><code class="language-bash">helm install --debug kolla-kubernetes/helm/service/nova-compute --namespace kolla --name nova-compute --values ./cloud.yaml
</code></pre>

<p>確認所有服務運作正常</p>

<pre><code class="language-bash">$ kubectl get pod -n kolla
NAME                                                    READY     STATUS      RESTARTS   AGE
cinder-api-5d6fd874b5-tzwlr                             3/3       Running     0          11h
cinder-create-db-x552q                                  0/2       Completed   0          11h
cinder-create-keystone-endpoint-admin-7xhjp             0/1       Completed   0          11h
cinder-create-keystone-endpoint-adminv2-252bg           0/1       Completed   0          11h
cinder-create-keystone-endpoint-adminv3-4zcv7           0/1       Completed   0          11h
cinder-create-keystone-endpoint-internal-s2n77          0/1       Completed   0          11h
cinder-create-keystone-endpoint-internalv2-9wr7f        0/1       Completed   0          11h
cinder-create-keystone-endpoint-internalv3-2srh2        0/1       Completed   0          11h
cinder-create-keystone-endpoint-public-7mksf            0/1       Completed   0          11h
cinder-create-keystone-endpoint-publicv2-pqhms          0/1       Completed   0          11h
cinder-create-keystone-endpoint-publicv3-8z6xg          0/1       Completed   0          11h
cinder-create-keystone-service-4sbp6                    0/1       Completed   0          11h
cinder-create-keystone-servicev2-9h88v                  0/1       Completed   0          11h
cinder-create-keystone-servicev3-p89wk                  0/1       Completed   0          11h
cinder-create-keystone-user-4whfz                       0/1       Completed   0          11h
cinder-manage-db-hgppr                                  0/1       Completed   0          11h
cinder-scheduler-0                                      1/1       Running     0          11h
glance-api-6f649fbf8d-9hwzn                             1/1       Running     0          11h
glance-create-db-76lwc                                  0/2       Completed   0          11h
glance-create-keystone-endpoint-admin-m4mxm             0/1       Completed   0          11h
glance-create-keystone-endpoint-internal-q9whd          0/1       Completed   0          11h
glance-create-keystone-endpoint-public-stszm            0/1       Completed   0          11h
glance-create-keystone-service-hcznf                    0/1       Completed   0          11h
glance-create-keystone-user-9f2g7                       0/1       Completed   0          11h
glance-manage-db-ch6rp                                  0/1       Completed   0          11h
glance-registry-684d9cc765-d5g5p                        3/3       Running     0          11h
horizon-7bc45d8df6-8ndt6                                1/1       Running     0          11h
keystone-b55d658-4bmpf                                  1/1       Running     0          12h
keystone-create-db-rb9wq                                0/2       Completed   0          12h
keystone-create-endpoints-65m86                         0/1       Completed   0          12h
keystone-fernet-setup-job-knfm8                         0/1       Completed   0          12h
keystone-manage-db-x4m2n                                0/1       Completed   0          12h
mariadb-0                                               1/1       Running     0          12h
mariadb-init-element-ndbxt                              0/1       Completed   0          12h
memcached-7b95fd6b69-v8f4v                              2/2       Running     0          12h
neutron-create-db-w2hqk                                 0/2       Completed   0          11h
neutron-create-keystone-endpoint-admin-hkg8p            0/1       Completed   0          11h
neutron-create-keystone-endpoint-internal-cwzrt         0/1       Completed   0          11h
neutron-create-keystone-endpoint-public-bjzzk           0/1       Completed   0          11h
neutron-create-keystone-service-q7ms9                   0/1       Completed   0          11h
neutron-create-keystone-user-zvqnw                      0/1       Completed   0          11h
neutron-dhcp-agent-l5qkg                                1/1       Running     0          11h
neutron-l3-agent-network-64v9x                          1/1       Running     0          11h
neutron-manage-db-5dqkn                                 0/1       Completed   0          11h
neutron-metadata-agent-network-ttf5v                    1/1       Running     0          11h
neutron-openvswitch-agent-network-j6llm                 1/1       Running     0          11h
neutron-server-6d74c78c98-xzdd8                         3/3       Running     0          11h
nova-api-7d5cf595bc-rxg4k                               3/3       Running     0          11h
nova-api-create-cell-r288q                              0/1       Completed   0          11h
nova-api-create-db-5w2lg                                0/2       Completed   0          11h
nova-api-manage-db-wd4b8                                0/1       Completed   0          11h
nova-cell0-create-db-5bz6v                              0/2       Completed   0          11h
nova-compute-wn5lb                                      1/1       Running     0          11h
nova-compute-xkv8r                                      1/1       Running     0          11h
nova-conductor-0                                        1/1       Running     0          11h
nova-consoleauth-0                                      1/1       Running     0          11h
nova-create-db-476gl                                    0/2       Completed   0          11h
nova-create-keystone-endpoint-admin-xbt8x               0/1       Completed   0          11h
nova-create-keystone-endpoint-internal-58dvx            0/1       Completed   0          11h
nova-create-keystone-endpoint-public-8c56c              0/1       Completed   0          11h
nova-create-keystone-service-jngxg                      0/1       Completed   0          11h
nova-create-keystone-user-4gc62                         0/1       Completed   0          11h
nova-libvirt-kbcrl                                      1/1       Running     0          11h
nova-libvirt-n2nnj                                      1/1       Running     0          11h
nova-novncproxy-79bf74796f-9p7ct                        3/3       Running     0          11h
nova-scheduler-0                                        1/1       Running     0          11h
openvswitch-ovsdb-network-rwwrz                         1/1       Running     0          11h
openvswitch-vswitchd-network-6q9w9                      1/1       Running     0          11h
placement-api-create-keystone-endpoint-admin-bg9ct      0/1       Completed   0          11h
placement-api-create-keystone-endpoint-internal-v998h   0/1       Completed   0          11h
placement-api-create-keystone-endpoint-public-p6mvf     0/1       Completed   0          11h
placement-api-fc8f68544-rvhwc                           1/1       Running     0          11h
placement-create-keystone-service-blj57                 0/1       Completed   0          11h
placement-create-keystone-user-tw5k4                    0/1       Completed   0          11h
rabbitmq-0                                              1/1       Running     0          12h
rabbitmq-init-element-gtvgw                             0/1       Completed   0          12h
</code></pre>

<p>使用官方的tool建立admin的openrc file，建立完成的檔案會存在當前使用者的home目錄下。</p>

<pre><code class="language-bash">$kolla-kubernetes/tools/build_local_admin_keystonerc.sh ext
</code></pre>

<p>接者安裝OpenStack clients套件</p>

<pre><code class="language-bash">$sudo pip install &quot;python-openstackclient&quot;
$sudo pip install &quot;python-neutronclient&quot;
$sudo pip install &quot;python-cinderclient&quot;
</code></pre>

<p>使用openstack語法去產生image,network&hellip;等</p>

<pre><code class="language-bash">$source ~/keystonerc_admin
$IMAGE_URL=http://download.cirros-cloud.net/0.3.5/
$IMAGE=cirros-0.3.5-x86_64-disk.img
$IMAGE_NAME=cirros
$IMAGE_TYPE=linux
EXT_NET_CIDR='172.24.10.1/24'
EXT_NET_RANGE='start=172.24.10.10,end=172.24.10.200'
EXT_NET_GATEWAY='172.24.10.1'
$curl -L -o ./${IMAGE} ${IMAGE_URL}/${IMAGE}

$openstack image create --disk-format qcow2 --container-format bare --public \
    --property os_type=${IMAGE_TYPE} --file ./${IMAGE} ${IMAGE_NAME}

$openstack network create --external --provider-physical-network physnet1 \
    --provider-network-type flat public1

$openstack subnet create --no-dhcp \
    --allocation-pool ${EXT_NET_RANGE} --network public1 \
    --subnet-range ${EXT_NET_CIDR} --gateway ${EXT_NET_GATEWAY} public1-subnet

openstack flavor create --id 1 --ram 512 --disk 1 --vcpus 1 m1.tiny
openstack flavor create --id 2 --ram 2048 --disk 20 --vcpus 1 m1.small
openstack flavor create --id 3 --ram 4096 --disk 40 --vcpus 2 m1.medium
openstack flavor create --id 4 --ram 8192 --disk 80 --vcpus 4 m1.large
openstack flavor create --id 5 --ram 16384 --disk 160 --vcpus 8 m1.xlarge
</code></pre>

<p>可以使用openstack horizon操作openstack dashboard，使用admin user的帳號、密碼進行登入。</p>

<pre><code class="language-bash">$kubectl get service -n kolla
NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)     AGE
cinder-api           ClusterIP   10.3.3.125   10.0.0.182    8776/TCP    12h
glance-api           ClusterIP   10.3.3.141   10.0.0.182    9292/TCP    12h
glance-registry      ClusterIP   10.3.3.15    &lt;none&gt;        9191/TCP    12h
horizon              ClusterIP   10.3.3.11    10.0.0.182    80/TCP      12h
keystone-admin       ClusterIP   10.3.3.35    10.0.0.182    35357/TCP   12h
keystone-internal    ClusterIP   10.3.3.228   &lt;none&gt;        5000/TCP    12h
keystone-public      ClusterIP   10.3.3.124   10.0.0.182    5000/TCP    12h
mariadb              ClusterIP   10.3.3.98    &lt;none&gt;        3306/TCP    12h
memcached            ClusterIP   10.3.3.140   &lt;none&gt;        11211/TCP   12h
neutron-server       ClusterIP   10.3.3.21    10.0.0.182    9696/TCP    12h
nova-api             ClusterIP   10.3.3.150   10.0.0.182    8774/TCP    12h
nova-metadata        ClusterIP   10.3.3.217   &lt;none&gt;        8775/TCP    12h
nova-novncproxy      ClusterIP   10.3.3.4     10.0.0.182    6080/TCP    12h
nova-placement-api   ClusterIP   10.3.3.159   10.0.0.182    8780/TCP    12h
rabbitmq             ClusterIP   10.3.3.66    &lt;none&gt;        5672/TCP    12h
rabbitmq-mgmt        ClusterIP   10.3.3.37    &lt;none&gt;        15672/TCP   12h


$cat keystonerc_admin
unset OS_SERVICE_TOKEN
export OS_USERNAME=admin
export OS_PASSWORD=kQHEss3THBmHCQWdqNd2b51U8xRB3hKPH6KD4kx3
export OS_AUTH_URL=http://10.0.0.182:5000/v3
export PS1='[\u@\h \W(keystone_admin)]$ '
export OS_PROJECT_NAME=admin
export OS_USER_DOMAIN_NAME=Default
export OS_PROJECT_DOMAIN_NAME=Default
export OS_IDENTITY_API_VERSION=3
export OS_REGION_NAME=RegionOne
export OS_VOLUME_API_VERSION=2
</code></pre>


<figure>
    
        <img src="/images/post/openstack-kolla-dashboard.png" alt="登入即可看到openstack的操作畫面。" />
    
    
    <figcaption>
        <p>
        登入即可看到openstack的操作畫面。
        
            
        
        </p> 
    </figcaption>
    
</figure>


<h2 id="如果需要拆除你的openstack-kolla-kubernetes環境">如果需要拆除你的OpenStack Kolla Kubernetes環境</h2>

<p>在你的master上，使用helm拆除OpenStack相關元件。</p>

<pre><code class="language-bash">$helm install --debug ~/kolla-bringup/kolla-kubernetes/helm/service/nova-cleanup --namespace kolla --name nova-cleanup --values ~/kolla-bringup/cloud.yaml
$helm delete mariadb --purge
$helm delete mariadb --purge
$helm delete rabbitmq --purge
$helm delete memcached --purge
$helm delete keystone --purge
$helm delete glance --purge
$helm delete cinder-control --purge
$helm delete horizon --purge
$helm delete openvswitch --purge
$helm delete neutron --purge
$helm delete nova-control --purge
$helm delete nova-compute --purge
$helm delete nova-cell0-create-db-job --purge
$helm delete cinder-volume-lvm --purge
</code></pre>

<p>在每個節點上拆除相關的OpenStack volume</p>

<pre><code class="language-bash">$sudo rm -rf /var/lib/kolla/volumes/*
</code></pre>

<p>在每個節點上刪除Kubernetes</p>

<pre><code class="language-bash">$sudo kubeadm reset
$sudo rm -rf /etc/kolla
$sudo rm -rf /etc/kubernetes
$sudo rm -rf /etc/kolla-kubernetes
</code></pre>
		</div>
		
<div class="post__tags tags clearfix">
	<svg class="icon icon-tag" width="16" height="16" viewBox="0 0 16 16"><path d="M16 9.5c0 .373-.24.74-.5 1l-5 5c-.275.26-.634.5-1 .5-.373 0-.74-.24-1-.5L1 8a2.853 2.853 0 0 1-.7-1C.113 6.55 0 5.973 0 5.6V1.4C0 1.034.134.669.401.401.67.134 1.034 0 1.4 0h4.2c.373 0 .95.113 1.4.3.45.187.732.432 1 .7l7.5 7.502c.26.274.5.632.5.998zM3.5 5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/></svg>
	<ul class="tags__list">
		<li class="tags__item"><a class="tags__link btn" href="/tags/openstack/" rel="tag">OpenStack</a></li>
		<li class="tags__item"><a class="tags__link btn" href="/tags/kubernetes/" rel="tag">Kubernetes</a></li>
	</ul>
</div>
	</article>
	
<div class="authorbox clearfix">
	<figure class="authorbox__avatar">
		<img alt="Meng Ze avatar" src="/img/apple.jpg" class="avatar" height="90" width="90">
	</figure>
	<div class="authorbox__header">
		<span class="authorbox__name">About Meng Ze</span>
	</div>
	<div class="authorbox__description">
		Meng 專注於雲端世界的耕耘者，喜歡潛水慢跑等休閒運動。
	</div>
</div>
	
<nav class="post-nav flex">
	<div class="post-nav__item post-nav__item--prev">
		<a class="post-nav__link" href="/post/golang/pointer/" rel="prev"><span class="post-nav__caption">«&thinsp;Previous</span><p class="post-nav__post-title">簡單介紹一下golang的指標</p></a>
	</div>
	<div class="post-nav__item post-nav__item--next">
		<a class="post-nav__link" href="/post/kubernetes/minkube-mount/" rel="next"><span class="post-nav__caption">Next&thinsp;»</span><p class="post-nav__post-title">minikube 在掛載本機遇到的神奇問題</p></a>
	</div>
</nav>
	
<section class="comments">
	<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "mengzn" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>

</main>


<aside class="sidebar">
	
	
<div class="widget-recent widget">
	<h4 class="widget__title">Recent Posts</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/post/kubernetes/istio1.0-install/">Istio1.0 安裝及簡易操作</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/kubernetes/minkube-mount/">minikube 在掛載本機遇到的神奇問題</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/openstack/kolla-kubernetes/">Kolla Kubernetes</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/golang/pointer/">簡單介紹一下golang的指標</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/grpc/proto/">初嚐Protocol Buffer</a></li>
			<li class="widget__item"><a class="widget__link" href="/post/sdn/ovs-commonly-command/">OVS Commonly Command</a></li>
		</ul>
	</div>
</div>
	
<div class="widget-categories widget">
	<h4 class="widget__title">Categories</h4>
	<div class="widget__content">
		<ul class="widget__list">
			<li class="widget__item"><a class="widget__link" href="/categories/golang">Golang</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/grpc">Grpc</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/istio">Istio</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/kubernetes">Kubernetes</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/networking">Networking</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/openstack">Openstack</a></li>
			<li class="widget__item"><a class="widget__link" href="/categories/servicemesh">Servicemesh</a></li>
		</ul>
	</div>
</div>
	
<div class="widget-social widget">
	<h4 class="widget-social__title widget__title">Social</h4>
	<div class="widget-social__content widget__content">
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Facebook" rel="noopener noreferrer" href="https://facebook.com/ameng0330" target="_blank">
				<svg class="widget-social__link-icon icon-facebook" viewBox="0 0 352 352" width="24" height="24" fill="#fff"><path d="m0 32v288c0 17.5 14.5 32 32 32h288c17.5 0 32-14.5 32-32v-288c0-17.5-14.5-32-32-32h-288c-17.5 0-32 14.5-32 32zm320 0v288h-83v-108h41.5l6-48h-47.5v-31c0-14 3.5-23.5 23.5-23.5h26v-43.5c-4.4-.6-19.8-1.5-37.5-1.5-36.9 0-62 22.2-62 63.5v36h-42v48h42v108h-155v-288z"/></svg>
				<span>Facebook</span>
			</a>
		</div>
		
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="LinkedIn" rel="noopener noreferrer" href="https://linkedin.com/in/meng-ze-li-0330" target="_blank">
				<svg class="widget-social__link-icon icon-linkedin" viewBox="0 0 352 352" width="24" height="24" fill="#fff"><path d="M0,40v272c0,21.9,18.1,40,40,40h272c21.9,0,40-18.1,40-40V40c0-21.9-18.1-40-40-40H40C18.1,0,0,18.1,0,40z M312,32 c4.6,0,8,3.4,8,8v272c0,4.6-3.4,8-8,8H40c-4.6,0-8-3.4-8-8V40c0-4.6,3.4-8,8-8H312z M59.5,87c0,15.2,12.3,27.5,27.5,27.5 c15.2,0,27.5-12.3,27.5-27.5c0-15.2-12.3-27.5-27.5-27.5C71.8,59.5,59.5,71.8,59.5,87z M187,157h-1v-21h-45v152h47v-75 c0-19.8,3.9-39,28.5-39c24.2,0,24.5,22.4,24.5,40v74h47v-83.5c0-40.9-8.7-72-56.5-72C208.5,132.5,193.3,145.1,187,157z M64,288h47.5 V136H64V288z"/></svg>
				<span>LinkedIn</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Telegram" rel="noopener noreferrer" href="https://t.me/Jason0330" target="_blank">
				<svg class="widget-social__link-icon icon-telegram" viewBox="0 0 132 110" width="24" height="24"><path fill="#ddd" d="M50 103c-4 0-3-1-5-5L34 60l88-52"/><path fill="#aaa" d="M50 103c3 0 4-1 6-3l16-16-20-12"/><path fill="#fff" d="M52 72l48 36c6 3 10 2 11-5l20-93c2-8-3-11-8-9L7 45c-8 4-8 8-1 10l29 9 69-43c3-2 6-1 4 1"/></svg>
				<span>Telegram</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="GitHub" rel="noopener noreferrer" href="https://github.com/MengZn" target="_blank">
				<svg class="widget-social__link-icon icon-github" viewBox="0 0 384 374" width="24" height="24" fill="#fff"><path d="m192 0c-106.1 0-192 85.8-192 191.7 0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2 0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8 0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7 0 0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4 0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5 0 25.6-.2 46.3-.2 52.6 0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg>
				<span>GitHub</span>
			</a>
		</div>
		<div class="widget-social__item widget__item">
			<a class="widget-social__link widget__link btn" title="Email" href="mailto:jason.meng.lee@gmail.com">
				<svg class="widget-social__link-icon icon-mail" viewBox="0 0 416 288" width="24" height="24" fill="#fff"><path d="m0 16v256 16h16 384 16v-16-256-16h-16-384-16zm347 16-139 92.5-139-92.5zm-148 125.5 9 5.5 9-5.5 167-111.5v210h-352v-210z"/></svg>
				<span>jason.meng.lee@gmail.com</span>
			</a>
		</div>
	</div>
</div>
	
<div class="widget-taglist widget">
	<h4 class="widget__title">Tags</h4>
	<div class="widget__content">
		<a class="widget-taglist__link widget__link btn" href="/tags/golang" title="Golang">Golang</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/grpc" title="Grpc">Grpc</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/istio" title="Istio">Istio</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/kubernetes" title="Kubernetes">Kubernetes</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/minikube" title="Minikube">Minikube</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/openstack" title="Openstack">Openstack</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/ovs" title="Ovs">Ovs</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/proto" title="Proto">Proto</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/sdn" title="Sdn">Sdn</a>
		<a class="widget-taglist__link widget__link btn" href="/tags/servicemesh" title="Servicemesh">Servicemesh</a>
	</div>
</div>
</aside>
	</div>
		<footer class="footer">
			<div class="container container-inner">
				<div class="footer__copyright">&copy; 2018 Meng Ze&#39;s Blog. <span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span></div>
			</div>
		</footer>
	</div>

<script>
	var navigation = responsiveNav(".menu", {
		navClass: "menu--collapse",
		label: "Menu",
	});
</script></body>
</html>