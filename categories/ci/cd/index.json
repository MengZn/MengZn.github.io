[{"content":"  è¨˜éŒ„ä¸€ä¸‹ï¼Œåœ¨å¼·è¿«ä½¿ç”¨TDDæ¨¡å¼é–‹ç™¼çš„æƒ…å¢ƒèˆ‡å¿ƒå¾—ã€‚\næ¯”å¦‚æˆ‘å€‘éœ€è¦ä¸€å€‹ä¸‹è¼‰å™¨ï¼Œé€™ä¸€å€‹ä¸‹è¼‰å™¨æœƒå¹«åŠ©æˆ‘å€‘å¾ç¶²è·¯ä¸‹è¼‰ä¸€äº›è³‡æ–™ä¸¦ä¸”æŠ½å–å‡ºç‰¹å®šçš„è³‡æ–™ã€‚\nå› æ‡‰é€™å€‹æƒ…å¢ƒæˆ‘ä½¿ç”¨TDDé–‹ç™¼æ¨¡å¼å¼·è¿«è‡ªå·±ä½¿ç”¨æ¸¬è©¦é©…å‹•çš„æ€ç¶­æ€è€ƒã€‚\né¦–å…ˆæˆ‘å€‘è¦éœ€è¦ä¸€å€‹ä¸‹è¼‰å™¨ Downloader ï¼Œæ‰€ä»¥æˆ‘å€‘æœƒåœ¨ package å¯«ä¸‹ NewDownloader çš„æ–¹æ³•ï¼Œæ¥è‘—è®“ IDE å¹«æˆ‘è£œé½Šæ¸¬è©¦ã€‚\nä»¥æœ€å°æ­¥é©Ÿé–‹ç™¼ æ¯”å¦‚æˆ‘åœ¨download package å…ˆå®šç¾©ä¸€å€‹ NewDownloader çš„æ–¹æ³•ï¼Œé€é IDE æŒ‡å¼•å¹«æˆ‘å€‘å»ºç«‹ä»–çš„æ¸¬è©¦ã€‚\n1 2 3  func NewDownloader() *Downloader { }     IDEæœƒå¹«æˆ‘å€‘å»ºç«‹ Test Function å¦‚ä¸‹åœ–æ‰€ç¤ºã€‚\n  é€™æ™‚å€™æˆ‘å€‘æœƒå—åˆ°IDEçš„æç¤ºï¼Œå‘Šè¨´æˆ‘å€‘ Downloader é€™å€‹é¡å‹æ²’æœ‰å®šç¾©ã€‚\nå¦å¤–ä¹Ÿå‘Šè¨´æˆ‘å€‘é€™è£¡æœ‰ TODO List è¦æˆ‘å€‘åŠ å…¥ä¸€äº› test cases ã€‚\næˆ‘å€‘å…ˆå®Œæˆæœ€å°‘æ¸¬è©¦æ‰€éœ€è¦çš„ç‰©ä»¶ Downloader ï¼Œé€éIDEå¿«é€Ÿåœ°å»ºç«‹æ‰€éœ€è¦çš„ç‰©ä»¶ã€‚\n  å…¶å¯¦ IDE ä¹Ÿåªæ˜¯ç°¡å–®å¹«ä½ æ‰“å¹¾å€‹å­—è€Œå·²ï¼Œåƒæ˜¯é€™æ˜¯ä¸€å€‹ interface é‚„æ˜¯ä¸€å€‹ struct é‚„æ˜¯ä¸€å€‹ function é‚„æ˜¯å…¶ä»–ç‰©ä»¶é€™é‚Šå°±éœ€è¦è‡ªå·±å®šç¾©ã€‚\n  æˆ‘å€‘éœ€è¦çš„æ˜¯ä¸€å€‹ struct ï¼Œç‚ºä»€éº¼ï¼Ÿ\n é‚„è¨˜å¾—æˆ‘å€‘å‰é¢å®šç¾©çš„ function æ˜¯ä¸€å€‹ NewDownloader å—ï¼Ÿ\né€šå¸¸é€™é‚Šæœƒéœ€è¦çš„æ˜¯ structï¼Œæ‰€ä»¥ code æ‡‰è©²æœƒé•·é€™æ¨£å­ã€‚  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  type Downloader struct { } func TestNewDownloader(t *testing.T) { tests := []struct { name string want *Downloader }{ // TODO: Add test cases. \t} for _, tt := range tests { t.Run(tt.name, func(t *testing.T) { if got := NewDownloader(); !reflect.DeepEqual(got, tt.want) { t.Errorf(\u0026#34;NewDownloader() = %v, want %v\u0026#34;, got, tt.want) } }) } }   é‚„ç¼ºå°‘ä»€éº¼å‘¢ï¼Ÿ\nå‰›å‰›æœ‰æåˆ°çš„ Test Case ï¼Œæ¥è‘—è£œæ»¿æˆ‘å€‘çš„ Test Case ã€‚\né€™è£¡åªè¦å› ç‚ºæˆ‘å€‘åªæ˜¯ New ä¸€å€‹ NewDownloader å‡ºä¾†è€Œå·²æ‰€ä»¥ Test Case å¾ˆé–“å–®çš„å»ºç«‹ä¸€å€‹ç‰©ï¼Œé€™æ™‚å€™ç¨‹å¼ç¢¼å¯èƒ½æœƒé•·é€™æ¨£å­ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  func TestNewDownloader(t *testing.T) { tests := []struct { name string want *Downloader }{ { name: \u0026#34;really init\u0026#34;, want: \u0026amp;Downloader{}, }, } for _, tt := range tests { t.Run(tt.name, func(t *testing.T) { if got := NewDownloader(); !reflect.DeepEqual(got, tt.want) { t.Errorf(\u0026#34;NewDownloader() = %v, want %v\u0026#34;, got, tt.want) } }) } }   å¯ä»¥çœ‹åˆ° IDE é‚„æœ‰ç´…è‰²çš„å­—è¡¨ç¤ºæœ‰å•é¡Œ\n  æ–¼æ˜¯æˆ‘å€‘åˆ° download.go å»è§€å¯Ÿæœ‰ä»€éº¼å•é¡Œã€‚\n  åŸä¾†é€™é‚Šå‘Šè¨´æˆ‘å€‘æ²’æœ‰å®šç¾© Download çš„å‹åˆ¥\nç–‘ï¼å¥‡æ€ªï¼Œæˆ‘å€‘ä¸æ˜¯åœ¨ Test å·²ç¶“å®šç¾©éäº†å—ï¼Ÿ\næ˜¯é€™æ¨£çš„ï¼Œåœ¨ test å®šç¾©éçš„ Download struct æ˜¯æ²’æœ‰è¾¦æ³•å†ä¸æ˜¯ test çš„ package æ‰€ä½¿ç”¨çš„ã€‚\næ‰€ä»¥æˆ‘å€‘éœ€è¦æŠŠ Test å®šç¾©éçš„ Download struct éç§»éä¾†åˆ°é€™è£¡ï¼Œçœ‹çœ‹é‚„æœ‰ä»€éº¼å…¶ä»–å•é¡Œã€‚\n  æ¬ç§»éä¾†äº†ï¼Œ Download å‹åˆ¥å·²ç¶“æ²’æœ‰å‡ºç¾ç´…å­—äº†ï¼Œé€™æ™‚å€™ IDE å‘Šè¨´æˆ‘å€‘ NewDownloader é€™å€‹ function æ²’æœ‰å¯« return å›å‚³å€¼ã€‚é‚£æˆ‘å€‘å°±å¯«ä¸€å€‹çµ¦ä»–å§ã€‚\næ–¼æ˜¯æˆ‘å€‘çš„ code ç¾åœ¨è®Šæˆé€™æ¨£å­\ndownload.go\n1 2 3 4 5 6 7 8  package download type Downloader struct { } func NewDownloader() *Downloader { return \u0026amp;Downloader{} }   download_test.go\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  package download import ( \u0026#34;reflect\u0026#34; \u0026#34;testing\u0026#34; ) func TestNewDownloader(t *testing.T) { tests := []struct { name string want *Downloader }{ { name: \u0026#34;really init\u0026#34;, want: \u0026amp;Downloader{}, }, } for _, tt := range tests { t.Run(tt.name, func(t *testing.T) { if got := NewDownloader(); !reflect.DeepEqual(got, tt.want) { t.Errorf(\u0026#34;NewDownloader() = %v, want %v\u0026#34;, got, tt.want) } }) } }   é€™æ™‚å€™è·‘test æ‡‰è©²æœƒçœ‹åˆ°ä¸€å€‹å®Œç¾çš„ Test æˆåŠŸ\ngo test . ok kata-go-example/download 0.239s æŒçºŒè¿­ä»£ é›–ç„¶ä½ å¯èƒ½æœƒè¦ºå¾—å¾ˆç…©ï¼Œç‚ºä»€éº¼è¦å¯«é€™äº›æœ‰çš„æ²’çš„ï¼Œé€™äº›æ­¥é©Ÿ IDE å¯ä»¥å¹«ä½ å¤§é‡è™•ç†ï¼Œä¸éç•¶æˆ‘å€‘ç¿’æ…£ä¹‹å¾Œ IDE æœƒè®Šæˆè¼”åŠ©ä½ å“ªè£¡å¿˜è¨˜å¯«ï¼Œè¨˜ä½ä¸€å€‹è¦é» å°æ­¥é©Ÿçš„è¿­ä»£ã€‚\nå¥½çš„æœ‰ Downloader ç‰©ä»¶ä¹‹å¾Œæˆ‘å€‘æ²’æœ‰ä¸€å€‹çœŸçš„ä¸‹è¼‰çš„æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦ä¸€å€‹ Download çš„æ–¹æ³•ï¼Œä½†æ˜¯ å› ç‚ºå¾ˆé‡è¦æ‰€ä»¥è¦èªªå¾ˆå¤šæ¬¡ ä½†æ˜¯ ä½†æ˜¯ ä½†æ˜¯ ä½†æ˜¯ ï¼Œæˆ‘å€‘é€šå¸¸æœƒå¸Œæœ›é€™å€‹ Download çš„æ–¹æ³• ä¸æ˜¯å¯«æ­»çš„ï¼Œä¿ç•™ä¸€äº›æŠ½è±¡ç©ºé–“å¯ä»¥æ›¿æ›ã€‚\né€™é‚Šæˆ‘æä¾›å¹¾ç¨®æ–¹æ³•\nç¬¬ä¸€ç¨® åœ¨çµæ§‹æ³¨å…¥ function type ç¾å®šç¾©ä¸€å€‹æœ€ç°¡å–®çš„download function ï¼Œæˆ‘å€‘é æœŸè¼¸å…¥ä¸€ä¸²ç¶²å€ï¼Œä¸‹è¼‰å™¨æœƒå¹«æˆ‘è™•ç†ï¼Œé€™ä¸²ç¶²å€å°æ‡‰çš„IPä½ç½®ï¼Œæœ€ç°¡å–®function å¯èƒ½æœƒæ˜¯é•·é€™æ¨£å­ã€‚\n1 2 3  func (d *Downloader) Download(url string) string { }   å®šç¾©å®Œæˆä¹‹å¾Œé€é IDE å¹«å¿™è£œé½Š Test function\n  IDE å»ºç«‹å®Œæˆçš„ Code å¤§æ¦‚æœƒé•·ä»¥ä¸‹é€™æ¨£å­ï¼Œä¹ŸæœƒæœŸå¾…ä½ å¹«ä»–è£œå®Œtest case ã€‚\n  åˆ°é€™è£¡ä¸çŸ¥é“å¤§å®¶æœ‰æ²’æœ‰ç™¼ç¾é‚„æ˜¯é‚„æ²’å¯¦ä½œ download çš„ functionï¼Œ test code çœ‹èµ·ä¾†é™¤äº†è¦æˆ‘å€‘åŠ å…¥ä¸€äº› test case ä¹‹å¤–å¥½åƒå°±æ²’æœ‰åˆ¥çš„éŒ¯èª¤äº†ã€‚\né€™é‚Šéœ€è¦ä½¿ç”¨åˆ°ä¸€äº›å°æŠ€å·§ä¾‹å¦‚ function type ï¼Œæˆ‘å€‘å¯ä»¥å®šç¾©ä¸€å€‹ Download çš„function type å¦‚ä¸‹æ‰€ç¤º\n1  type DownloadFunc func(url string) string   å®šç¾©äº† DownloadFunc æˆ‘å€‘å¯èƒ½æœƒå¸Œæœ›é€™å€‹ Function åœ¨ Downloader çš„struct è£¡é¢è®“ Downloader çš„çµæ§‹æ“æœ‰å¤–éƒ¨çš„å‚³é€²ä¾†çš„ä¸‹è¼‰æ–¹æ³•ï¼Œå¦‚æ­¤ä¸€ä¾†å°±ä¸æœƒå¼·ä¾è³´ Downloader è£¡é¢å¯«ä»€éº¼ã€‚\næ—¢ç„¶æˆ‘æ”¹äº† NewDownloader å‹¢å¿…æœƒå°è‡´ NewDownloader çš„æ¸¬è©¦æ–¹æ³•ä¸æœƒé€šé\n  é€™é‚ŠIDEå°±æç¤ºæˆ‘å€‘åƒæ•¸ä¸æ­£ç¢ºï¼Œæˆ‘å€‘é€™é‚Šå°±ç°¡å–®åœ°è£œä¸Šä¸€å€‹ Download function å°±è¡Œï¼Œè¦è¨£ä¿®æ”¹åˆ°ä¹‹å‰çš„ test code éœ€è¦å…ˆä¿è­‰èˆŠçš„ test code æ˜¯å¯ä»¥æ­£ç¢ºåŸ·è¡Œçš„ï¼\nå¥½ï¼Œé‚£å°±ç¹¼çºŒå›åˆ° Download function æ¸¬è©¦é€™å€‹éƒ¨åˆ†ï¼Œæˆ‘å€‘åœ¨ struct ä¸­æ–°å¢äº† DownloadFunc å°±å¯ä»¥è®“ Downloader ç›´æ¥ä½¿ç”¨ï¼Œcode å¯èƒ½æœƒåƒæ˜¯ä»¥ä¸‹ç¯„ä¾‹ã€‚\n1 2 3  func (d *Downloader) Download(url string) string { return d.downloadFunc(url) }   é‚£éº¼ test code æœƒè®Šæˆæ€æ¨£æ¨£å­å‘¢ï¼Ÿ\nåŸæœ¬æ˜¯é•·é€™æ¨£å­çš„test code\n  ä½†æˆ‘å€‘æ–°å¢äº†åœ¨ struct è£¡æ–°å¢äº† DownloadFunc è®“ Download çš„é‚è¼¯è¢«æŠ½é›¢äº†ï¼Œé€™é‚Šæˆ‘å€‘åªè¦ç°¡å–®çš„é©—è­‰ä¸€ä¸‹ DownloadFunc æ˜¯å¦æ­£ç¢ºè¢«ä½¿ç”¨å³å¯ï¼Œè¨˜å¾—æœ€å¾Œé‚„éœ€è¦è£œä¸Štest case å‘¦ï¼\næœ€å¾Œæˆ‘å€‘çš„Download Function çš„test code æ‡‰è©²æœƒé•·é€™æ¨£å­\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  func TestDownloader_Download(t *testing.T) { type args struct { url string } fakeWant := \u0026#34;this is fake function\u0026#34; tests := []struct { name string args args want string }{ { name: \u0026#34;Fake Download Func\u0026#34;, args: args{ \u0026#34;google.com\u0026#34;, }, want: fakeWant, }, } fakeDownloadFunc := func(url string) string { return fakeWant } for _, tt := range tests { t.Run(tt.name, func(t *testing.T) { d := NewDownloader(fakeDownloadFunc) if got := d.Download(tt.args.url); got != tt.want { t.Errorf(\u0026#34;Download() = %v, want %v\u0026#34;, got, tt.want) } }) } }   è€Œæˆ‘å€‘ package è£¡é¢çš„ code æ‡‰è©²æœƒæ˜¯é•·é€™æ¨£å­\n1 2 3 4 5 6 7 8 9 10 11 12 13  type DownloadFunc func(url string) string type Downloader struct { downloadFunc DownloadFunc } func NewDownloader(downloadFunc DownloadFunc) *Downloader { return \u0026amp;Downloader{downloadFunc} } func (d *Downloader) Download(url string) string { return d.downloadFunc(url) }   ç¬¬äºŒç¨® åœ¨æ–¹æ³•æ³¨å…¥ function type ç¬¬äºŒç¨®æ–¹æ³•ä¸€æ¨£æ˜¯æ³¨å…¥function type ä¸éè·Ÿç¬¬ä¸€ç¨®ä¸ä¸€æ¨£çš„åœ°æ–¹åœ¨æ–¼æˆ‘å€‘é€™ä¸€æ¬¡æ˜¯åœ¨functnio çš„åƒæ•¸æ³¨å…¥ã€‚\nä¸€æ¨£å®šç¾©ä¸€å€‹ function type\n1  type DownloadFunc func(url string) string   é€™ä¸€æ¬¡æˆ‘å€‘ä¸åœ¨ Struct è£¡é¢æ¥æ”¶é€™å€‹ function ï¼Œæ”¹ç”¨åœ¨functnion è£¡é¢æ¥æ”¶é€™å€‹function ï¼Œä¾‹å¦‚èªªæˆ‘å€‘æœƒå®šç¾©ä¸€å€‹ function ä»–è¦æ±‚æ”œå¸¶ä¸€å€‹ function é€²ä¾†ã€‚\n1 2 3  func (d *Downloader) DownloadWithFunc(url string, downloadFunc DownloadFunc) string { }   é€™æ™‚å€™æˆ‘å€‘ä¸€æ¨£ç”¨ IDE å¹«æˆ‘å€‘æ’°å¯« test code\n  é•·å‡ºä¾†çš„code å¤§æ¦‚æ˜¯æœƒå¦‚ä¸‹æ–¹åœ–ç‰‡æ‰€ç¤ºï¼Œä¸€æ¨£è¦æ±‚ä½ åŠ å…¥ä¸€äº›test case ã€‚\n  é€™æ™‚å€™æˆ‘å€‘å…ˆä¾†ä¿®æ­£ package ï¼Œæ¯”å¦‚èªªæˆ‘å¸Œæœ›å¤–é¢function è™•ç†å®Œæˆå¾Œä¹‹å¾Œæˆ‘è¦åŠ å…¥ä¸€é»æ±è¥¿ï¼Œç¯„ä¾‹å¦‚ä¸‹æ‰€ç¤ºã€‚\n1 2 3  func (d *Downloader) DownloadWithFunc(url string, downloadFunc DownloadFunc) string { return downloadFunc(url)+\u0026#34;WithFunc\u0026#34; }   æ”¹å®Œäº†ï¼Œé‚£ test code è¦æ€éº¼å¯«ï¼Ÿ\né€™æ™‚å€™æˆ‘å€‘è·Ÿ æ–¹æ³•ä¸€ ä¸€æ¨£ä¾å¤–éƒ¨çš„function ï¼Œæ‰€ä»¥æˆ‘å€‘ä¸€æ¨£è¦è¨‚ fakeDownloadFuncã€‚\nå¤§è‡´ä¸Šçš„test codeæœƒåƒæ˜¯ä¸‹é¢ç¯„ä¾‹çš„æ¨£å­ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66  func TestDownloader_Download(t *testing.T) { type args struct { url string } fakeWant := \u0026#34;this is fake function\u0026#34; tests := []struct { name string args args want string }{ { name: \u0026#34;Fake Download Func\u0026#34;, args: args{ \u0026#34;google.com\u0026#34;, }, want: fakeWant, }, } fakeDownloadFunc := func(url string) string { return fakeWant } for _, tt := range tests { t.Run(tt.name, func(t *testing.T) { d := NewDownloader(fakeDownloadFunc) if got := d.Download(tt.args.url); got != tt.want { t.Errorf(\u0026#34;Download() = %v, want %v\u0026#34;, got, tt.want) } }) } } func TestDownloader_DownloadWithFunc(t *testing.T) { type args struct { url string downloadFunc DownloadFunc } fakeWant := \u0026#34;this is fake function\u0026#34; fakeDownloadFunc := func(url string) string { return fakeWant } tests := []struct { name string args args want string }{ { name: \u0026#34;Fake Download Func\u0026#34;, args: args{ downloadFunc: fakeDownloadFunc, url: \u0026#34;google.com\u0026#34;, }, want: fakeWant + \u0026#34;WithFunc\u0026#34;, }, } for _, tt := range tests { t.Run(tt.name, func(t *testing.T) { d := \u0026amp;Downloader{} if got := d.DownloadWithFunc(tt.args.url, tt.args.downloadFunc); got != tt.want { t.Errorf(\u0026#34;DownloadWithFunc() = %v, want %v\u0026#34;, got, tt.want) } }) } }   ","description":"","id":2,"section":"posts","tags":["Go","TDD"],"title":"å¼·è¿«ä½¿ç”¨ TDD é–‹ç™¼æ¨¡å¼ä»¥Goç‚ºä¾‹-2","uri":"https://blog.jjmengze.website/posts/go/tdd-test2/"},{"content":"  connection ç‰¹æ€§  ç•¶ç™¼é€ä¸€å€‹ http2 è«‹æ±‚çš„æ™‚å€™æœƒå»ºç«‹ä¸€å€‹ connection (TCP connection) ç™¼é€ç¬¬äºŒå€‹è«‹æ±‚çš„æ™‚å€™æœƒå»¶çºŒä½¿ç”¨ç¬¬ä¸€å€‹è«‹æ±‚æ‰€å»ºç«‹çš„Connection è‹¥æ˜¯æœ‰å¤šå€‹ stream çš„æƒ…æ³ï¼Œæ¯å€‹ stream æ˜¯å¯ä»¥åœ¨åŒä¸€å€‹ tcp connection ä½µç™¼å‚³è¼¸ï¼Œç¨±åšç‚ºå¤šè·¯å¾©ç”¨(multiplexing)  stream ç‰¹æ€§  ä¸€æ¢ TCP é€£ç·šä¸Šå¯ä»¥æœ‰å¤šå€‹è™•æ–¼ Open ç‹€æ…‹çš„ streamï¼ˆä½µç™¼å‚³è¼¸ï¼‰ Client å¯ä»¥ä¸»å‹•å»ºç«‹ stream (IDåŸºæ•¸ 1,3,5,7,9\u0026hellip;) Server å¯ä»¥ä¸»å‹•å»ºç«‹ stream (IDå¶æ•¸ 2,4,6,8,10\u0026hellip;) ä»»ä½•ä¸€ç«¯éƒ½å¯ä»¥è‡ªä¸»é—œé–‰ stream åŒä¸€æ¢ stream è£¡é¢çš„ frame éƒ½æ˜¯æœ‰åºåœ°æ’åˆ—  Client å‘ Server è«‹æ±‚æ™‚ Stream ID æœƒç‚ºåŸºæ•¸ï¼ˆ1,3,5,7,9\u0026hellip;)\nServer å‘ Client ä¸»å‹•æ¨é€ Stream ID æœƒç‚ºå¶æ•¸ï¼ˆ2,4,6,8,10\u0026hellip;)\nframe ç‰¹æ€§  å¯ä»¥åŒ…å«ä¸€åˆ°å¤šå€‹ Header (Headerå¾ˆå°åªè¦ä¸€å€‹message ï¼Œåˆ°Headerå¾ˆå¤§æœƒè¢«åˆ‡æˆå¤šå€‹frame) å¯ä»¥åŒ…å«é›¶åˆ°å¤šå€‹ Data!   æƒ³åƒä¸€ä¸‹ http1.1 æ™‚çš„ body è·Ÿ header éƒ½è®Šæˆäº† frame\nç°¡å–®çš„ä¾†èªª body ä¹Ÿå« frame , header ä¹Ÿå« frame åªæ˜¯è£¡é¢è³‡æ–™ä¸åŒè€Œå·²ã€‚\n åˆ°é€™è£¡ä½ èƒ½æ¯”è¼ƒ http1.1 èˆ‡ http2 çš„ä¸åŒå— ï¼Ÿ  åœ¨ http1.1 ä¸­ æ¯ä¸€æ¬¡è«‹æ±‚éƒ½è¦é‡æ–°å»ºç«‹ä¸€å€‹ tcp connection åœ¨ http1.1 ä¸­ æ¯ä¸€æ¬¡å‚³è¼¸éƒ½è¦å¸¶ä¸Šé‡è¤‡çš„ header åœ¨ http1.1 ä¸­ è³‡æ–™éƒ½æ˜¯ä»¥ç´”æ–‡æœ¬çš„æ–¹å¼å‚³è¼¸ åœ¨ http1.1 ä¸­ server ç„¡æ³•ä¸»å‹•æ¨é€è³‡æ–™çµ¦ client åœ¨ http1.1 ä¸­ header æ²’æœ‰é€²è¡Œå£“ç¸®  æœ¬ç¯‡æ–‡ç« é‚„æœƒå†æ·±å…¥ä¸€é»é»è§£æ http2 stream çš„ç›¸é—œçŸ¥è­˜\nstream status å¯ä»¥è§€å¯Ÿä¸‹åœ– stream status çš„ç‹€æ…‹è®ŠåŒ–ï¼Œæ‰€æœ‰çš„ stream ä¸€é–‹å§‹æœƒè™•æ–¼ idle ç‹€æ…‹ï¼Œæœ€çµ‚æœƒçµæŸæ–¼ closed ç‹€æ…‹ã€‚\näº†è§£å„å€‹ç‹€æ…‹ç›£è¦–å¦‚ä½•åˆ‡æ›çš„ï¼Œéœ€è¦çŸ¥é“ æ¥æ”¶/ç™¼é€ äº†ä»€éº¼ flagï¼Œä¸‹æ–¹æˆ‘åˆ—å‡ºäº†å¹¾ç¨®æœƒç™¼é€æˆ–æ˜¯æ¥æ”¶çš„ flagã€‚\n HEADERS (H) PUSH_PROMISE (PP) END_STREAM (ES) RST_STREAM (RST)  é€™é‚Šæœƒç°¡å–®çš„èªªæ˜ä¸€ä¸‹å¹¾ç¨®å¯èƒ½çš„ç‹€æ³\n  idle ç‹€æ…‹è½‰æ›\n ç•¶ stream ç‹€æ…‹è™•æ–¼ idle ï¼Œ server æ”¶åˆ° head (h) flag æ™‚å¾ŒæœƒæŠŠç•¶å‰ stream é€²è¡Œç‹€æ…‹çš„åˆ‡æ›ï¼Œå¾åœ–ä¸­å¯ä»¥æˆ‘å€‘å¾çœ‹åˆ° idle æ”¶ h flag å¾Œåˆ‡æ›æˆ open ç‹€æ…‹ã€‚ ç•¶ stream ç‹€æ…‹è™•æ–¼ idle ç‹€æ…‹ï¼Œå¦‚æœé€™æ™‚å€™ Server æƒ³è¦æ¨é€æ¶ˆæ¯çµ¦ Client ç«¯ï¼Œé‚£Server æœƒç™¼å‡º PUSH_PROMISE (PP) Flag é€™æ™‚ Server æœƒè™•æ–¼ reserved ç‹€æ…‹ï¼Œé€™æ™‚å€™å°±è¦æº–å‚™ç™¼é€å¾Œé¢çš„è³‡æ–™ï¼ˆHead+Dataï¼‰ã€‚    Open ç‹€æ…‹è½‰æ›\n ç•¶ stream ç‹€æ…‹è™•æ–¼ open ç‹€æ…‹ï¼Œé€™æ™‚æˆ‘å€‘å¦‚æœç™¼é€ï¼ˆsendï¼‰æˆ–æ˜¯æ¥æ”¶(recv) END_STREAM (ES) flag çš„è©±ï¼Œéƒ½æœƒé€²å…¥ä¸€å€‹æ‰€è¬‚çš„åŠé—œé–‰ç‹€æ…‹(half closed)é€™æ™‚streamæœƒç­‰å¾…æ¥å—flagé€²è€Œè½‰è®Šæˆcloseç‹€æ…‹ã€‚    reserved ç‹€æ…‹è½‰æ›\n ç•¶ stream ç‹€æ…‹è™•æ–¼ reserved ç‹€æ…‹ï¼Œé€™æ™‚å€™Server ä¸€ä½†æ¨é€äº†ç¬¬ä¸€ç­†è³‡æ–™çš„Headå‡ºå»å°±æœƒæŠŠç‹€æ…‹åˆ‡æ›æˆåŠé—œé–‰ç‹€æ…‹ (half closed) ç­‰å¾…æ¥å—flagé€²è€Œè½‰è®Šæˆcloseç‹€æ…‹ã€‚    half closed ç‹€æ…‹è½‰æ›\n ç•¶ stream ç‹€æ…‹è™•æ–¼ half closed ç‹€æ…‹ï¼Œé€™æ™‚æˆ‘å€‘å¦‚æœç™¼é€ï¼ˆsendï¼‰æˆ–æ˜¯æ¥æ”¶(recv) END_STREAM (ES) ã€RST_STREAM (RST) flag çš„è©±ï¼ŒæœƒæŠŠè©² Stream çš„ç‹€æ…‹åˆ‡æ›æˆClosedã€‚    Data source:http2-in-action/\nstream çš„priortyé †åº ç”±æ–¼ http2 å¤§é‡çš„é‹ç”¨åœ¨å‰å¾Œèˆ‡ç«¯æºé€šä¸Šï¼Œå°±ç®—å·¥ç¨‹å¸«åªé—œå¿ƒå¾Œç«¯æœå‹™ä¹‹é–“çš„æºé€šä¹Ÿéœ€è¦çŸ¥é“ï¼Œé—œæ–¼ http2 stream çš„ priorty çš„ç›¸é—œçŸ¥è­˜å¯ä»¥å¹«åŠ©æˆ‘å€‘åœ¨è¨­è¨ˆæœå‹™çš„æ™‚å€™å–„ç”¨å·²ç¶“å­˜åœ¨çš„æ¬„ä½ã€‚\n+---------------+ |Pad Length? (8)| +-+-------------+-----------------------------------------------+ |E| Stream Dependency? (31) | +-+-------------+-----------------------------------------------+ | Weight? (8) | +-+-------------+-----------------------------------------------+ | Header Block Fragment (*) ... +---------------------------------------------------------------+ | Padding (*) ... +---------------------------------------------------------------+ å¾ä¸Šåœ–æˆ‘å€‘å¯ä»¥çœ‹åˆ° E ã€ Stream Dependency? ã€ Weight? ä¸‰å€‹æ¬„ä½ï¼Œé€™ä¸‰å€‹æ¬„ä½å°±è¡¨ç¤ºäº† http2 stream çš„ priorty çš„ç‹€æ…‹ã€‚\n ï¼Ÿè¡¨ç¤ºæ˜¯å¯ä»¥é¸çš„æ¬„ä½\n  Stream Dependency : è¡¨ç¤ºä¾è³´å…¶ä»– Stream ç•¶å…¶ä»– Stream å®Œæˆæ‰èƒ½æ›è©² Stream Weight : è¡¨ç¤ºè©² Stream çš„æ¬Šé‡ï¼Œé è¨­å€¼ç‚º 16 ï¼Œé‚£å¯ä»¥è¨­å®šçš„ç¯„åœåœ¨ 1~256ã€‚  wireshark å‹•æ‰‹åšçœ‹çœ‹ ç›´æ¥å¾ wireshark æŠ“å– http2 çš„å°åŒ…ä¾†è§€å¯Ÿ priortyï¼Œçœ‹çœ‹ http2 priorty ï¼Œ Stream ID ï¼Œ Frame åˆ°åº•æ˜¯æ€éº¼ä¸€å›äº‹ã€‚\nä¸‹åœ–ç‚º wireshark æŠ“å–ç€è¦½å™¨å­˜å– https://www.nba.com/?37 çš„å°åŒ…\nMagic SETTINGS WINDOW_UPDATE å¯ä»¥çœ‹åˆ°ç¬¬ä¸€å€‹å°åŒ…æ˜¯ client (192.168.51.150) é€å¾€ server (23.11.187.239) å°åŒ…çš„ç°¡æ˜“æè¿°æ˜¯ Magic é¡å‹çš„å°åŒ…ï¼ŒåŒæ™‚åŒ…å«äº†SETTINGS frame èˆ‡ WINDOW_UPDATEã€‚\nMagic  é»é–‹magic stream çš„è©±å¯ä»¥çœ‹åˆ° client ç™¼é€äº†ä¸€å€‹ PRI * HTTP/2.0\\r\\n\\r\\nSM\\r\\n\\r\\n  SETTINGS  é»é–‹SETTINGS stream çš„è©±å¯ä»¥çœ‹åˆ° client ç™¼é€äº†å¥½å¹¾å€‹è¨­å®šå€¼ï¼Œå‘Šè¨´äº†Server æˆ‘è¦è¨­å®šæˆé€™æ¨£ã€‚  Header table size Max concurrent streams Max hader list size Unknown    WINDOW_UPDATE  é»é–‹WINDOW_UPDATE stream çš„è©±å¯ä»¥çœ‹åˆ° client ç™¼é€äº†ä¸€å€‹è¨­å®šï¼Œå‘Šè¨´Serveræœ€å¤§æˆ‘çš„è³‡æ–™åªèƒ½å‚³è¼¸å¤šå°‘ã€‚  Headers å¯ä»¥çœ‹åˆ° client ç™¼é€äº†å¥½å¹¾å€‹ HEADS çµ¦SERVERä¸¦ä¸”Stream ID éƒ½æ˜¯å¥‡æ•¸ï¼Œé€™è¡¨ç¤ºClient ç™¼é€çµ¦Server çš„è«‹æ±‚Stream IDéƒ½æœƒæ˜¯å¥‡æ•¸ã€‚æ¥ä¸‹ä¾† Cleint åˆåˆ†åˆ¥è¦äº† Head[3] , Head[5] , Head[7] é‚£é€™äº› Headeræœ‰ä»€éº¼é—œè¯ï¼Ÿ\nstream ID priority é»é–‹ Head[3] å¯ä»¥çœ‹åˆ°é€™å€‹è«‹æ±‚çš„æ¬Šé‡ï¼Œé‚£è·Ÿ Head[5] æœ‰ä»€éº¼å·®åˆ¥\né»é–‹ Head[5] å¯ä»¥çœ‹åˆ° ï¼Œè§€å¯Ÿå¾Œå¯ä»¥çœ‹åˆ° Head[3] çš„priority å¤§æ–¼ Head[5]ï¼Œæ¬Šé‡è¨ˆç®—å¾Œ Head[3] è¦æ¯” Head[5] çš„è³‡æ–™æ›´å¿«è¢«æ¥æ”¶ã€‚\nstream ID dependency é™¤äº† priority ä¹‹å¤–é‚„æœ‰ stream ID dependency å¯ä»¥å¾ä¸Šåœ–è§€å¯Ÿåˆ°é€™å…©å€‹è«‹æ±‚éƒ½è¦ä¾è³´ stream ID 0ï¼Œè¡¨ç¤ºéƒ½è¦å…ˆæ¥æ”¶å®Œæˆstream ID 0æ‰å¯ä»¥æ¥æ”¶å„è‡ªçš„è³‡æ–™ã€‚\nData å¯ä»¥çœ‹åˆ° Server å›å‚³äº†è³‡æ–™çµ¦ Client ç«¯ï¼Œå¦‚åœ–æ‰€ç¤º Client è¦äº† Head[1]çš„è³‡æ–™ï¼Œ Server å°±å›å‚³äº†å…­ç­†è³‡æ–™çµ¦ Client ã€‚\nå°çµ é‡æ–°è¤‡ç¿’äº† http2 çš„ç‰¹æ€§ï¼Œä»¥å‰å¸¸æåˆ°å¾—å¤šè·¯å¾©ç”¨ï¼ˆmultiplexingï¼‰ï¼ŒStream ä»¥åŠ Frame åˆ°åº•æ˜¯ä»€éº¼åˆæœ‰ä»€éº¼ç‰¹æ€§ï¼Œä»¥åŠç•¶ Client/Server ç™¼é€æˆ–æ˜¯æ¥æ”¶è«‹æ±‚å¾Œ connection æœƒè™•æ–¼ä»€éº¼ç‹€æ…‹ åšä¸€å€‹ç°¡å–®çš„åˆ†æèˆ‡ä»‹ç´¹ã€‚\næœ€å¾Œå¾ wireshark è§€å¯Ÿ http2 è«‹æ±‚çš„å…§å®¹ï¼Œè§€å¯Ÿ Stream ID èˆ‡ Stream ID priority ï¼Œå…±ç”¨åŒä¸€å€‹ Connection æœ‰äº›è«‹æ±‚éœ€è¦å…ˆè¢«åŸ·è¡Œæ‰èƒ½åœ¨åŸ·è¡Œå…¶ä»–è«‹æ±‚çš„ä¾è³´é—œä¿‚ï¼Œé™¤æ­¤ä¹‹å¤– æ²’æœ‰ä¾è³´é—œä¿‚çš„è«‹æ±‚éœ€è¦æŒ‰ç…§ priority çš„å¤§å° å„ªå…ˆè™•ç†ã€‚\n","description":"","id":3,"section":"posts","tags":["http2"],"title":"Http2_stream","uri":"https://blog.jjmengze.website/posts/protocol/http2/http2_stream/"},{"content":"  å…ˆå¯«æ¸¬è©¦ å‡è¨­ä»Šå¤©æˆ‘å€‘è¦å¯«ä¸€ä¸‹è¨ˆç®—é•·æ–¹å½¢é€±é•·çš„å‡½æ•¸ï¼Œé‚£æˆ‘å€‘å¯èƒ½æœƒå®šç¾©ä¸€å€‹ Perimeter çš„ function ï¼Œé€™å€‹ function æœƒé æœŸæ”œå¸¶å…©å€‹åƒæ•¸ä¸€å€‹æ˜¯é•·åº¦ length ä¸€å€‹æ˜¯å¯¬åº¦ width ï¼Œä»¥åŠä»–å€‘çš„å‹æ…‹æ˜¯æµ®é»æ•¸çš„å‹æ…‹ float64 ã€‚\næˆ‘å€‘é€™æ¸¬è©¦å‡½æ•¸å¯èƒ½æ˜¯é•·é€™æ¨£å­\næ¸¬è©¦é•·ä»€éº¼æ¨£å­ Go åœ¨æ’°å¯«æ¸¬è©¦çš„æ™‚å€™ç¿’æ…£ä½¿ç”¨ä»¥ä¸‹é€™ç¨®é¢¨æ ¼( table-drive)ï¼Œé€™ç¨®æ¸¬è©¦æ¨¡å¼ç›¸ç•¶çš„æ–¹ä¾¿ã€‚\næˆ‘æœƒå…ˆå¯«å‡ºæ¸¬è©¦çš„ç›®æ¨™æ‰€éœ€é»ä¸‰å€‹æ•¸å€¼ä¸¦ä¸”åŒ…è£æˆä¸€å€‹çµæ§‹é«”ã€‚\n æƒ…å¢ƒåç¨± æƒ…å¢ƒéœ€è¦çš„åƒæ•¸ æƒ…å¢ƒé æœŸçš„ç­”æ¡ˆ  åœ¨æƒ…å¢ƒæ‰€éœ€è¦çš„åƒæ•¸éƒ¨åˆ†ï¼Œåœ¨è¨ˆç®—é€±é•·çš„æƒ…å¢ƒä¹‹ä¸‹æˆ‘å€‘éœ€è¦é•·å¯¬ï¼Œæ•…æˆ‘å€‘ä¹Ÿå°‡åŒ…è£æˆä¸€å€‹çµæ§‹é«”ã€‚\næ‰€ä»¥æœ¬æ¬¡æ¸¬è©¦çš„ç¨‹å¼ç¢¼å¤§æ¦‚å¦‚ä¸‹æ‰€ç¤ºã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  func TestPerimeter(t *testing.T) { type args struct { width float64 height float64 } tests := []struct { name string args args want float64 }{ { name: \u0026#34;rectangles\u0026#34;, args: args{ width: 4.0, height: 4.0, }, want: 16.00, }, } for _, tt := range tests { t.Run(tt.name, func(t *testing.T) { if got := Perimeter(tt.args.width, tt.args.height); got != tt.want { t.Errorf(\u0026#34;Perimeter() = %.2f, want %.2f\u0026#34;, got, tt.want) } }) } }   æŒ‰ç…§ TDD çš„æ•™æˆ°æ‰‹å†Šï¼Œå°±æ˜¯æ’°å¯«æœ€å°‘çš„ç¨‹å¼ç¢¼é”åˆ°ç”¨æ¸¬è©¦æ¨å°å‡ºçœŸæ­£çš„å‡½æ•¸è¦æ€éº¼å®šç¾©ã€‚\né€™æ™‚å€™æˆ‘å€‘å¯è·‘ä¸€ä¸‹æ¸¬è©¦çœ‹çœ‹ï¼Œç«™åœ¨æ¸¬è©¦çš„è§’åº¦æˆ‘å€‘çœŸæ­£çš„å‡½æ•¸é‚„ç¼ºå°‘äº†ä»€éº¼æ±è¥¿ã€‚\n1 2 3 4  go test # go-tdd-example/perimeter [go-tdd-example/perimeter.test] ./main_test.go:27:14: undefined: Perimeter FAIL go-tdd-example/perimeter [build failed]   å¯ä»¥çœ‹åˆ°åœ¨æ¸¬è©¦çš„éç¨‹ä¸­æˆ‘å€‘çœ‹åˆ° Error ï¼Œé€™å€‹ Error æ˜¯å‘Šè¨´æˆ‘å€‘ undefined: Perimeter ï¼ŒåŸå› æ˜¯æˆ‘å€‘åœ¨ main package è£¡é¢é‚„æ²’æœ‰å®šç¾© Perimeter function ï¼Œé‚£å°±ä¾†å®šç¾©å§ï¼\nè£œå……main package func Perimeter(width float64, height float64) float64 { return 2*(width + height) } é€™æ™‚å¾Œå†åŸ·è¡Œä¸€æ¬¡ go test çœ‹çœ‹çµæœã€‚\n1 2 3  go test PASS ok go-tdd-example/perimeter 0.006s   é‡æ§‹ï¼ æ¸¬è©¦å¯«å®Œäº†ä¹Ÿæ­£ç¢ºåŸ·è¡Œï¼Œæˆ‘å€‘å¯ä»¥æ€è€ƒä¸€ä¸‹ Perimeter é€™å€‹å‡½æ•¸æ‰€ä»£è¡¨çš„æ„æ€ï¼Œæ‡‰è©²æ˜¯è¨ˆç®—é€±é•·å§ï¼Ÿ\né‚£æœƒä¸æœƒæœ‰å…¶ä»–é–‹ç™¼è€…ï¼ŒæŠŠè¨ˆç®—é•·æ–¹è¡Œé€±é•·çš„å‡½æ•¸æ‹¿ä¾†è¨ˆç®—ä¸‰è§’å½¢çš„é€±é•·ï¼Œæˆ‘æƒ³é€™æ˜¯æœ‰å¯èƒ½çš„å§xD\næ‰€ä»¥æˆ‘å€‘éœ€è¦æŠŠè¨ˆç®—é•·æ–¹å½¢çš„å‘¨é•·å‡½æ•¸é€²è¡Œå°è£ï¼Œå¸Œæœ›é€™å€‹å‡½æ•¸åªèƒ½è¨ˆç®—é•·æ–¹å½¢é€±é•·ã€‚\né‚£æˆ‘å€‘æœƒå…ˆå®šç¾©é•·æ–¹å½¢çš„çµæ§‹é«”ï¼Œå¸Œæœ›è¨ˆç®—é€±é•·çš„å‡½æ•¸ Perimeter åªæ¥å—é•·æ–¹å½¢çš„çµæ§‹é«”ï¼Œä¸¦ä¸”è¨ˆç®—ä»–çš„é€±é•·ã€‚\n1 2 3 4  type Rectangle struct { Width float64 Height float64 }   æ¸¬è©¦é•·ä»€éº¼æ¨£å­ æŒ‰ç…§ TDD çš„æ•™æˆ°æ‰‹å†Šï¼Œå°±æ˜¯æ’°å¯«æœ€å°‘çš„ç¨‹å¼ç¢¼é”åˆ°ç”¨æ¸¬è©¦æ¨å°å‡ºçœŸæ­£çš„å‡½æ•¸è¦æ€éº¼å®šç¾©ï¼Œç°¡å–®çš„èªªå°±æ˜¯è®“ç·¨è­¯å™¨å¹«åŠ©æˆ‘å€‘å»ºæ§‹æ­£ç¢ºçš„ç¨‹å¼ç¢¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29  func TestPerimeter(t *testing.T) { type args struct { Rectangle Rectangle } tests := []struct { name string args args want float64 }{ { name: \u0026#34;rectangles\u0026#34;, args: args{ \u0026amp;Rectangle{ Width: 4.0, Height: 4.0, }, }, want: 16.00, }, } for _, tt := range tests { t.Run(tt.name, func(t *testing.T) { if got := Perimeter(tt.args.Rectangle); got != tt.want { t.Errorf(\u0026#34;Perimeter() = %.2f, want %.2f\u0026#34;, got, tt.want) } }) } }   é€™æ™‚å€™æˆ‘å€‘å¯è·‘ä¸€ä¸‹æ¸¬è©¦çœ‹çœ‹ï¼Œç«™åœ¨æ¸¬è©¦çš„è§’åº¦æˆ‘å€‘çœŸæ­£çš„å‡½æ•¸é‚„ç¼ºå°‘äº†ä»€éº¼æ±è¥¿ã€‚\n1 2 3 4 5 6  go test # go-tdd-example/perimeter [go-tdd-example/perimeter.test] ./main_test.go:28:23: not enough arguments in call to Perimeter have (Rectangle) want (float64, float64) FAIL go-tdd-example/perimeter [build failed]   å¯ä»¥çœ‹åˆ°åœ¨æ¸¬è©¦çš„éç¨‹ä¸­æˆ‘å€‘çœ‹åˆ° Error ï¼Œé€™å€‹ Error æ˜¯å‘Šè¨´æˆ‘å€‘\nnot enough arguments in call to Perimeter have (Rectangle) want (float64, float64) FAIL go-tdd-example/perimeter [build failed] è£œå……main package åŸå› æ˜¯æˆ‘å€‘ Perimeter function ï¼Œå®šç¾©çš„æ˜¯ (width, height float64) ç¾åœ¨éœ€è¦æ”¹æˆæ¥æ”¶(rectangle Rectangle)ã€‚\né‚£æˆ‘å€‘çš„ Perimeter function å°±æœƒä¿®æ”¹æˆä»¥ä¸‹å½¢å¼ã€‚\n1 2 3  func Perimeter(rectangle Rectangle) float64 { return 2 * (rectangle.Width + rectangle.Height) }   é€™æ™‚å¾Œå†åŸ·è¡Œä¸€æ¬¡ go test çœ‹çœ‹çµæœã€‚\n1 2 3  go test PASS ok go-tdd-example/perimeter 0.006s   ä¸åœçš„é‡æ§‹ åšä¸€å€‹åˆæ ¼çš„å·¥ç¨‹å¸«ä¸€ç›´æ”¶åˆ°æ–°çš„éœ€æ±‚ä¹Ÿæ˜¯å¾ˆæ­£å¸¸çš„ï¼Œä»Šå¤©PMå‘Šè¨´æˆ‘å®¢æˆ¶æƒ³è¦è¨ˆç®—åœ“å½¢çš„é€±é•·ï¼Œå°æ–¼å·¥ç¨‹å¸«ä¾†èªªèƒ½ç›¡é‡å°‘æ”¹codeå°±å°‘æ”¹code xDï¼Œé€™æ™‚å€™éµå¾ª TDD çš„åŸå‰‡å…ˆå¯« test !\nå°æ–¼åœ“å½¢ä¾†èªªï¼Œä»–æœ‰çš„çµæ§‹é«”æ‡‰è©²åªæœ‰åŠå¾‘ï¼Œé‚£æˆ‘å€‘å…ˆå®šç¾©å‡ºä»–çš„çµæ§‹é«”å§ï¼\n1 2 3  type Cycle struct { Radius float64 }   æ¸¬è©¦çš„ code å¯èƒ½æœƒé•·é€™æ¨£å­ï¼Œæ‡‰ç®—å¾ˆç›´è¦ºçš„ test code ï¼Œå› ç‚ºæˆ‘å€‘ç¾åœ¨ Perimeter çš„è¨ˆç®—å‡½æ•¸ï¼Œéœ€è¦è¨ˆç®—é•·æ–¹å½¢è·Ÿåœ“å½¢ã€‚\n æƒ…å¢ƒéœ€è¦çš„åƒæ•¸è‡ªç„¶å°±è®Šæˆ Rectangle åŠ  Cycle åœ¨ for è¿´åœˆè£¡é¢ Perimeter function æœ‰è¼¸å…¥ Rectangle ä¹Ÿæœ‰è¼¸å…¥ Cycle çœ‹èµ·ä¾†ä¸€åˆ‡éƒ½å¾ˆåˆç†  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44  func TestPerimeter(t *testing.T) { type args struct { Rectangle Rectangle Cycle Cycle } tests := []struct { name string args args want float64 }{ { name: \u0026#34;rectangles\u0026#34;, args: args{ \u0026amp;Rectangle{ Width: 4.0, Height: 4.0, }, Cycle{ Radius: 16.0, }, }, want: 7.85, }, { name: \u0026#34;rectangles\u0026#34;, args: args{ \u0026amp;Cycle{ Radius: 1, }, }, want: 1.57, }, } for _, tt := range tests { t.Run(tt.name, func(t *testing.T) { if got := Perimeter(tt.args.Rectangle); got != tt.want { t.Errorf(\u0026#34;Perimeter() = %.2f, want %.2f\u0026#34;, got, tt.want) } if got := Perimeter(tt.args.Cycle); got != tt.want { t.Errorf(\u0026#34;Perimeter() = %.2f, want %.2f\u0026#34;, got, tt.want) } }) } }   é€™æ™‚å€™æˆ‘å€‘å¯è·‘ä¸€ä¸‹æ¸¬è©¦çœ‹çœ‹ï¼Œç«™åœ¨æ¸¬è©¦çš„è§’åº¦æˆ‘å€‘çœŸæ­£çš„å‡½æ•¸é‚„ç¼ºå°‘äº†ä»€éº¼æ±è¥¿ã€‚\n1 2 3 4  go test # go-tdd-example/perimeter [go-tdd-example/perimeter.test] ./main_test.go:34:31: cannot use tt.args.Cycle (type Cycle) as type Rectangle in argument to Perimeter FAIL go-tdd-example/perimeter [build failed]   å¯ä»¥çœ‹åˆ°åœ¨æ¸¬è©¦çš„éç¨‹ä¸­æˆ‘å€‘çœ‹åˆ° Error ï¼Œé€™å€‹ Error æ˜¯å‘Šè¨´æˆ‘å€‘\ncannot use tt.args.Cycle (type Cycle) as type Rectangle in argument to Perimeter é€™å€‹æ„æ€å¤§æ¦‚æ˜¯ Perimeter function è¦æ±‚è¼¸å…¥ä¸€å€‹ Rectangle çš„é¡åˆ¥ï¼Œä½†æ˜¯æˆ‘å€‘è¼¸å…¥ Cycle é¡åˆ¥ã€‚\næ˜æ˜ é•·æ–¹å½¢ï¼ˆRectangleï¼‰ ä¹Ÿè¦è¨ˆç®—å‘¨é•·ï¼Œ åœ“å½¢ï¼ˆCycleï¼‰ä¹Ÿè¦è¨ˆç®—é€±é•·å•Šï¼æˆ‘ä¸æœæ°£ï¼xD\næ‰¾åˆ°å…±åŒé» å¾ä¸Šé¢çš„å•é¡Œæˆ‘å€‘æ‰¾åˆ° é•·æ–¹å½¢ è·Ÿ åœ“å½¢ çš„å…±åŒé»ï¼Œéƒ½éœ€è¦è¨ˆç®—é€±é•·ï¼é‚£æˆ‘å€‘éœ€è¦å€ŸåŠ© go çš„ interface ä¾†å®šç¾©å…±åŒçš„æ–¹æ³•ï¼Œåœ¨æœ¬ç¯‡çš„ä¾‹å­å°±æ˜¯ è¨ˆç®—é€±é•· Perimeter functionã€‚\n1 2 3  type Shape interface { Perimeter() float64 }   ç¾åœ¨æ¸¬è©¦è®Šæˆæ€éº¼æ¨£äº†ï¼Ÿ é‚„è¨˜å¾—å‰é¢æåˆ°çš„æ¸¬è©¦çµæ§‹å—ï¼Ÿæˆ‘æœƒå…ˆå¯«å‡ºæ¸¬è©¦çš„ç›®æ¨™æ‰€éœ€é»ä¸‰å€‹æ•¸å€¼ä¸¦ä¸”åŒ…è£æˆä¸€å€‹çµæ§‹é«”ã€‚\n æƒ…å¢ƒåç¨± æƒ…å¢ƒéœ€è¦çš„åƒæ•¸ æƒ…å¢ƒé æœŸçš„ç­”æ¡ˆ  é€™æ™‚å€™æƒ…å¢ƒæ‰€éœ€è¦çš„åƒæ•¸éœ€è¦åšè®Šå‹•ï¼Œç¾åœ¨æƒ…å¢ƒéœ€è¦çš„æ˜¯æœ‰è¨ˆç®—é€±é•·èƒ½åŠ›çš„æ±è¥¿ä¹Ÿå°±æ˜¯interface Shapeã€‚\nç°¡å–®çš„èªªç¾åœ¨æƒ…éœ€è¦çš„åƒæ•¸æ˜¯ä¸€å€‹æœ‰èƒ½åŠ›è¨ˆç®—å‘¨é•·çš„ç‰©ä»¶ï¼Œåœ¨é€™å€‹æƒ…å¢ƒä¸‹æˆ‘æœƒæŠŠç‰©ä»¶æ‹¿å»è¨ˆç®—çœ‹æ˜¯å¦èƒ½å¾—åˆ°æˆ‘é æœŸçš„ç­”æ¡ˆã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31  func TestPerimeter(t *testing.T) { type args struct { shape Shape } tests := []struct { name string args args want float64 }{ { name: \u0026#34;rectangles\u0026#34;, args: args{ Rectangle{ Width: 4.0, Height: 4.0, }, Cycle{ Radius: 1, }, }, want: 1.57, }, } for _, tt := range tests { t.Run(tt.name, func(t *testing.T) { if got := tt.args.shape.Perimeter(); got != tt.want { t.Errorf(\u0026#34;Perimeter() = %.2f, want %.2f\u0026#34;, got, tt.want) } }) } }   é€™æ™‚å€™æˆ‘å€‘å¯è·‘ä¸€ä¸‹æ¸¬è©¦çœ‹çœ‹ï¼Œç«™åœ¨æ¸¬è©¦çš„è§’åº¦æˆ‘å€‘çœŸæ­£çš„å‡½æ•¸é‚„ç¼ºå°‘äº†ä»€éº¼æ±è¥¿ã€‚\n1 2 3 4 5 6 7 8 9  go test # go-tdd-example/perimeter [go-tdd-example/perimeter.test] ./main_test.go:17:15: cannot use \u0026amp;Rectangle literal (type *Rectangle) as type Shape in field value: *Rectangle does not implement Shape (missing Perimeter method) ./main_test.go:27:11: cannot use \u0026amp;Cycle literal (type *Cycle) as type Shape in field value: *Cycle does not implement Shape (missing Perimeter method) FAIL go-tdd-example/perimeter [build failed]   å¯ä»¥çœ‹åˆ°åœ¨æ¸¬è©¦çš„éç¨‹ä¸­æˆ‘å€‘çœ‹åˆ° Error ï¼Œé€™å€‹ Error æ˜¯å‘Šè¨´æˆ‘å€‘\n./main_test.go:17:15: cannot use \u0026amp;Rectangle literal (type *Rectangle) as type Shape in field value: *Rectangle does not implement Shape (missing Perimeter method) ./main_test.go:27:11: cannot use \u0026amp;Cycle literal (type *Cycle) as type Shape in field value: *Cycle does not implement Shape (missing Perimeter method) FAIL go-tdd-example/perimeter [build failed] æœƒçœ‹åˆ°é€™å…©å€‹éŒ¯èª¤ï¼Œç¬¬ä¸€å€‹éŒ¯èª¤æ˜¯åœ¨èªª *Rectangle æ²’æœ‰å¯¦ä½œ Shape interface ï¼Œå› ç‚ºä»–å»å°‘äº† Perimeter function ã€‚\nç¬¬äºŒå€‹éŒ¯æ˜¯åœ¨èªª *Cycle æ²’æœ‰å¯¦ä½œ Shape interface ï¼Œå› ç‚ºä»–å»å°‘äº† Perimeter function ã€‚\nè£œå……main package å› ç‚ºåœ¨æ¸¬è©¦çš„æ™‚å€™ç·¨è­¯å™¨å‘Šè¨´æˆ‘å€‘ Rectangle æ²’æœ‰å¯¦ä½œ Shape interface ï¼Œå› ç‚ºä»–å»å°‘äº† Perimeter function ï¼Œé‚£æˆ‘å€‘å°±è­˜åšä¸€å€‹å§ï¼Œé€™æ™‚å€™æˆ‘å€‘éœ€è¦ç”¨åˆ° go çš„function reciver ä¾†å¹« Rectangle æ–°å¢ä¸€å€‹ Perimeter functionã€‚\n1 2 3 4 5 6 7 8 9 10 11  type Shape interface { Perimeter() float64 } func (r *Rectangle) Perimeter() float64 { return 2 * (r.Width + r.Height) } func (r *Cycle) Perimeter() float64 { return 3.14 * r.Radius / 2 }   é€™æ™‚å¾Œå†åŸ·è¡Œä¸€æ¬¡ go test çœ‹çœ‹çµæœã€‚\n1 2 3  go test PASS ok go-tdd-example/perimeter 0.006s   æˆ‘å€‘æˆåŠŸäº†ï¼\nå°çµ æœ¬ç¯‡æ˜¯ä¸€å€‹ TDD åŸºæœ¬çš„ç¯„ä¾‹ï¼Œä¸æ–·å˜—è©¦åŸ·è¡Œé€™äº› test code ä¸¦è®“ç·¨è­¯å™¨ æŒ‡å¼• æˆ‘å€‘æ‰¾åˆ°æ­£ç¢ºçš„æ–¹æ¡ˆã€‚\nç”¨ Go èªè¨€å¯¦ä½œäº†ä¸€å€‹é€±é•·çš„è¨ˆç®—å‡½æ•¸ï¼Œåœ¨æœ€åˆçš„éœ€æ±‚æˆ‘å€‘åªéœ€è¦ä¸€å€‹ é•·æ–¹å½¢çš„ è¨ˆç®—æ–¹æ³•ï¼Œéå¸¸ç°¡å–®å°±å¯ä»¥å¯¦ä½œå‡ºä¾†ã€‚ é€é go test æç¤ºæˆ‘å€‘ çœŸæ­£çš„å‡½æ•¸é•·ä»€éº¼æ¨£å­ï¼Œè—‰è‘—æˆ‘å€‘å»è£œé½Šå…§éƒ¨çš„é‚è¼¯ï¼Œç•¶è£œé½Šå…§éƒ¨é‚è¼¯å¾Œå†æ¬¡åŸ·è¡Œ test code ç›´åˆ°æ¸¬è©¦é€šéç‚ºæ­¢ã€‚\nç•¶æœ‰æ–°çš„éœ€æ±‚ï¼ˆåœ“å½¢å‘¨é•·è¨ˆç®—ï¼‰ï¼Œæˆ‘å€‘é€é test code èˆ‡è»Ÿé«”å·¥ç¨‹çš„æ¦‚å¿µæŠ½é›¢å‘¨é•·è¨ˆç®—æ–¹æ³•ï¼Œä½¿ç”¨ go çš„ interface èˆ‡ function reciver å”åŠ©æˆ‘å€‘é€éä»‹é¢çš„æ–¹å¼é€²è¡Œæ¸¬è©¦èˆ‡é‡æ§‹ã€‚\nTDD åœ¨ç¾ä»Šçš„éœ€æ±‚ä¹‹å¾Œè®Šå¾—éå¸¸çš„é‡è¦ï¼Œæˆ‘å€‘å¯ä»¥é€é test å®Œæˆé‡æ§‹è®“ç¨‹å¼ç¢¼è®Šå¾—å¯ä»¥æ¸¬è©¦èˆ‡èƒ½å¤ é æœŸåŸå¸‚çš„è¡Œç‚ºã€‚\n","description":"","id":4,"section":"posts","tags":["Go","TDD"],"title":"å¼·è¿«ä½¿ç”¨ TDD é–‹ç™¼æ¨¡å¼ä»¥Goç‚ºä¾‹","uri":"https://blog.jjmengze.website/posts/go/tdd-test/"},{"content":"  å¦‚ä½•ç¢ºèªç¶²é æ˜¯å¦æ”¯æ´ http2 plugins chrome ç€è¦½å™¨å¯ä»¥é€éå®‰è£ HTTP/2 and SPDY indicator é€™å€‹ plugins ï¼Œä¾†è§€å¯Ÿç›®å‰æ­£åœ¨ç€è¦½çš„ç¶²ç«™æ˜¯å¦æ”¯æ´ http2 ã€‚\nå¦‚æœç•¶å‰ç€è¦½é é¢å•Ÿç”¨äº† HTTP2 å‰‡ç‚ºè—è‰²ï¼Œå¦‚æœå•Ÿç”¨äº† SPDY å‰‡ç‚ºç¶ è‰²ã€‚\nå¯ä»¥çœ‹ä¸€ä¸‹æˆ‘æœ€å¸¸ç€è¦½çš„ç¶²é ä»–æ˜¯æ”¯æ´ä»€éº¼æ¨£çš„ protocal\nç•¶æˆ‘ç€è¦½ Kubernetes.io çš„æ™‚å€™å¯ä»¥çœ‹åˆ°å³ä¸Šè§’æ˜¯è—è‰²çš„é–ƒé›»è¡¨ç¤ºæ”¯æ´ http2\n  é‚£ä»Šå¤©ä»€éº¼ç¶²é æ”¯æ´ SPDY å‘¢ï¼Ÿ\nç•¶æˆ‘ç€è¦½ google é¦–é çš„æ™‚å€™ç™¼ç¾å®ƒæ”¯æ´ SPDY protocal\n  dev mod å¯ä»¥é€é chrome çš„é–‹ç™¼è€…æ¨¡å¼è§€å¯Ÿ è«‹æ±‚æ˜¯ééä»€éº¼æ¨£çš„å”å®šå»é€²è¡Œå‚³è¼¸çš„ã€‚\nç•¶æˆ‘å€‘é–‹å•Ÿ dev mod çš„æ™‚å€™å­˜å– github çš„é é¢å¯ä»¥è§€å¯Ÿåˆ°æœ‰è¨±å¤šçš„è«‹æ±‚æ˜¯é€éhttp2å®Œæˆçš„ï¼Œå¦‚ä¸‹åœ–æ‰€ç¤ºã€‚\n  å¾åœ–ä¸­æˆ‘å€‘å¯ä»¥è§€å¯Ÿåˆ° æœ‰http/1.1çš„è«‹æ±‚ä¹Ÿæœ‰ h2çš„è«‹æ±‚ï¼Œé€™å…©ç¨®è«‹æ±‚åˆ†åˆ¥ä»£è¡¨è‘—å‰ç«¯ç¶²é é€é http1.1 ä»¥åŠ åŸºæ–¼ tls çš„ http2 è«‹æ±‚ã€‚\nè¦ç±³ wireshark æŠ“ä¸åˆ° http2 çš„å°åŒ… æŠ“ä¸åˆ° http2 å°åŒ… å…ˆä¾†çœ‹ä¸€å¼µåœ–ï¼Œæ˜¯æˆ‘è¨­å®š wireshark filter åªé¡¯ç¤º http2 çš„å°åŒ…ï¼Œä¸¦ä¸”åŒæ™‚å­˜å– kubernetes.io ã€‚\n  å¾ä¸Šåœ–æœƒç™¼ç¾\u0026hellip;.ä»€éº¼è³‡æ–™éƒ½æ²’æœ‰ï¼Œé‚£æ€éº¼æœƒé€™æ¨£å­ï¼Ÿ\næ€éº¼è§£æ±º åŸå› å‡ºåœ¨ç€è¦½å™¨å­˜å–æœå‹™çš„æ™‚å€™éœ€è¦é€éåŸºæ–¼ TLS çš„ Http2 protocal ï¼Œæ‰€æœ‰çš„è³‡æ–™éƒ½è¢«åŠ å¯†äº†æˆ‘å€‘ä¸èƒ½çœ‹åˆ° Client server ä¹‹é–“åˆ°åº•æºé€šäº†ä»€éº¼ï¼Œè§£æ±ºçš„æ–¹æ³•å…¶å¯¦å¾ˆç°¡å–®åªè¦åœ¨ç€è¦½å™¨ Chrome è¨­å®š SSLKEYLOGFILE å°±å¯ä»¥é †åˆ©çš„å¾ Chrome æŠ“åˆ° http2 å°åŒ…äº†ã€‚\nç”±æ–¼æˆ‘çš„ä½œæ¥­ç³»çµ±æ˜¯ MACOS é€™é‚Šå°±ç¤ºç¯„ MACOS æ€éº¼åœ¨ Chrome ä¸Šå•Ÿå‹• SSLKEYLOGFILEã€‚\n å»ºç«‹keylogfile.log æ–‡ä»¶ï¼Œæ›´æ”¹æ¬Šé™ã€‚è®“ chrome å•Ÿå‹•æ™‚èƒ½å¯«å…¥æ”œå¸¶sslkeylogfile  mkdir ~/sslkeylogfile touch ~/sslkeylogfile/keylogfile.log sudo chmod 777 ~/sslkeylogfile/keylogfile.log è¨­å®šç’°å¢ƒè®Šæ•¸  export SSLKEYLOGFILE=~/sslkeylogfile/keylogfile.log echo \u0026quot;alias chrome=\\\u0026quot;open -a 'Google Chrome'\\\u0026quot;\u0026quot; \u0026gt;\u0026gt; ~/.zshrc source ~/.zshrc å¦‚æœè¦å¯¦é©— HTTP2 çš„è©±éœ€è¦å¾ terminal é–‹å•Ÿ Chrome  chrome é€é terminal å•Ÿå‹• chrome çš„åœ–å¦‚ä¸‹æ‰€ç¤º\n  å¯ä»¥çœ‹ä¸€ä¸‹ sslkeylogfile çš„è³‡æ–™ï¼Œè£¡é¢å¯«ä»€éº¼ä¸æ˜¯å¾ˆé‡è¦ wireshark çœ‹å¾—æ‡‚å°±å¥½xDDD\n1 2 3 4 5 6 7 8 9  cat ~/sslkeylogfile/keylogfile.log CLIENT_HANDSHAKE_TRAFFIC_SECRET e379a0d9d454a5c80bf4d7b49dcbc6eb9055f07cda497306768b828b20380056 c0dc0b38f983aa5f1dd82f4b555c6be6195570622e90c956444938027e0dedc5 SERVER_HANDSHAKE_TRAFFIC_SECRET e379a0d9d454a5c80bf4d7b49dcbc6eb9055f07cda497306768b828b20380056 52ff297d7a0b1705bf6a876cbb307836ecc462455b9455d5eac606a1a6b1cac1 CLIENT_TRAFFIC_SECRET_0 e379a0d9d454a5c80bf4d7b49dcbc6eb9055f07cda497306768b828b20380056 ea654ba45d35cae4a0d81fa2eb3e795c930ea8e06caab92f4da992cba14c354b SERVER_TRAFFIC_SECRET_0 e379a0d9d454a5c80bf4d7b49dcbc6eb9055f07cda497306768b828b20380056 ef0d144892cf974cbb9e8d6ddebf5bd80370951cbaf5cc1223e8c63084e1da20 EXPORTER_SECRET e379a0d9d454a5c80bf4d7b49dcbc6eb9055f07cda497306768b828b20380056 d4e350adc0738aea83d6035fe0a21792fccd1a317208b6f9af547ffa36ba8195 CLIENT_HANDSHAKE_TRAFFIC_SECRET f95d9c5cd50060635969f3a88c89c548a063e1fa74c8cdb59d3af8d55a7e4558 c27c5c111347c718a3875a1300fa7a7dc88bbe4229189d7e0f0b887a0c9ac8a0 SERVER_HANDSHAKE_TRAFFIC_SECRET f95d9c5cd50060635969f3a88c89c548a063e1fa74c8cdb59d3af8d55a7e4558 507c5b0b8040cf85364dd272cf7d26eff2072baee3b2ed32206bddba85a88bc0 ...   è¨­å®šwireshark é–‹å•Ÿ wireshark å¾Œé»é¸wireshark é¸æ“‡ Preferences æ‰“é–‹è¨­å®šé é¢ï¼Œå¦‚ä¸‹åœ–æ‰€ç¤ºã€‚\n  æ¥è‘—é¸æ“‡ Protocols -\u0026gt; TLS -\u0026gt; (Pre)-Master-Secret log filename æŠŠ~/sslkeylogfile/keylogfile.log æ”¾é€²å»ã€‚\n  é©—è­‰ wireshark æŠ“å–ç€è¦½å™¨å­˜å– http2 çš„å°åŒ… ç¾åœ¨é–‹å•Ÿ wireshark filter è¼¸å…¥ http2 æ¥è‘—é€éç€è¦½å™¨å­˜å– githubçš„ç¶²ç«™ï¼Œè§€å¯Ÿ wireshark æ˜¯å¦èƒ½æŠ“å–åˆ°å°åŒ…ï¼Œå¦‚ä¸‹åœ–æ‰€ç¤ºã€‚\n  å¾åœ–ä¸­çœ‹èµ·ä¾†éƒ½èƒ½å¤ é †åˆ©åœ°æŠ“åˆ°å°åŒ…ï¼Œå¾ŒçºŒæœƒé‡å° http2 çš„æ¬„ä½é€²ä¸€æ­¥åˆ†æèˆ‡è¤‡ç¿’ç›¸é—œçš„æ¦‚å¿µã€‚\n","description":"","id":5,"section":"posts","tags":["http2"],"title":"æ€éº¼é€é wireshark æŠ“å–ç€è¦½å™¨å­˜å– Http2 çš„å°åŒ…ï¼Ÿ","uri":"https://blog.jjmengze.website/posts/protocol/http2/http2_wireshark/"},{"content":"  ref:kubernetes scheduler\nå¾ä¸Šåœ–å¯ä»¥çœ‹åˆ°æœƒç¶“éå¹¾å€‹æ­¥é©Ÿåˆ†åˆ¥æ˜¯æ’æˆï¼ˆscheduingï¼‰ç¶å®š(binding)ï¼Œæ¯å€‹æ­¥é©Ÿåˆåˆ†æˆå¥½å¹¾å€‹ Task æ¯ä¸€å€‹ Task ç”±ä¸€åˆ°å¤šå€‹pluginsçµ„åˆè€Œæˆã€‚\nä¸‹é¢å°‡ç°¡å–®æ•˜è¿°å„å€‹ Task çš„ä½œç”¨ï¼Œå¾ŒçºŒç« ç¯€è¬›åˆ°pluginsæ™‚æœƒæ¯”è¼ƒäº†è§£åœ¨åšä»€éº¼ã€‚\nå…ˆæ˜¯æ’æˆ(scheduing)\n Sort  ç”¨æ–¼å° scheduler queue ä¸­çš„ Pod é€²è¡Œæ’åºã€‚ä¸€æ¬¡åªèƒ½å•Ÿç”¨ä¸€å€‹ sort plugins ã€‚   PreFilter  ç”¨ä¾†é€²è¡Œé å…ˆæª¢æŸ¥ pod çš„éœ€è¦æ»¿è¶³çš„æ¢ä»¶ï¼Œè‹¥æ˜¯è™•ç†å¤±æ•—å‰‡é›¢é–‹èª¿åº¦é€±æœŸï¼Œé‡æ–°é€²å…¥ scheduler queue ã€‚   Filter  ç”¨ä¾†å°ç¯€é»é€²è¡Œéæ¿¾ï¼Œåªæœƒç•™ä¸‹æ»¿è¶³ pod åŸ·è¡Œæ¢ä»¶çš„ç¯€é»ã€‚   PreScore  å°‡ Filter éšæ®µæ‰€ç”¢å‡ºçš„ç¯€é»é€²è¡Œé è©•åˆ†å·¥ä½œï¼Œè‹¥æ˜¯è™•ç†å¤±æ•—å‰‡é›¢é–‹èª¿åº¦é€±æœŸï¼Œé‡æ–°é€²å…¥ scheduler queueã€‚   Score  å°‡ Filter éšæ®µæ‰€ç”¢å‡ºçš„ç¯€é»é€²è¡Œè©•åˆ†   NormalizeScore  é€²è¡Œåˆ†æ•¸çš„æ­£è¦åŒ–è™•ç†ã€‚   Reserve  é€™æ™‚Podè™•æ–¼ä¿ç•™ç‹€æ…‹ï¼Œå®ƒå°‡åœ¨ç¶å®šé€±æœŸçµæŸæ™‚è§¸ç™¼  å¤±æ•— : Unreserve plugins æˆåŠŸ : PostBindæ’ä»¶ã€‚     Permit  Podçš„èª¿åº¦é€±æœŸçµæŸæ™‚ï¼Œåšæœ€å¾Œçš„æŠŠé—œç”¨ä¾†Permitã€denyæˆ–æ˜¯waité€™æ¬¡çš„èª¿åº¦ã€‚    æœ€å¾Œé€²è¡Œç¶å®š(binding)\n PreBind  åœ¨PodçœŸæ­£ç¶å®šå‰è¨­å®šç›¸é—œçš„volumeä¸¦å°‡å…¶å®‰è£åœ¨ç›®æ¨™ç¯€é»ï¼Œè‹¥æ˜¯è™•ç†å¤±æ•—å‰‡é›¢é–‹ç¶å®šé€±æœŸï¼Œé‡æ–°é€²å…¥scheduler queueã€‚   Bind  å°‡Podç¶å®šåˆ°ç¯€é»ã€‚   PostBind  æˆåŠŸç¶å®šPodå¾Œï¼Œç”¨ä¾†æ¸…ç†ç›¸é—œçš„è³‡æºã€‚    çµèª æ¥ä¸‹ä¾†å°‡æœƒç°¡å–®ä»‹ç´¹ä¸€ä¸‹æ¯å€‹éšæ®µçš„ plugins åœ¨åšä»€éº¼ ï¼Œä»¥ä¾¿æˆ‘å€‘äº†è§£æ•´å€‹ framwork çš„æ¶æ§‹ã€‚\n","description":"","id":6,"section":"posts","tags":["kubernetes"],"title":"Kubernetes Scheduler contextæµæ°´ç·šç•¥çªºä¸€äºŒ","uri":"https://blog.jjmengze.website/posts/kubernetes/scheduler/kubernetes-scheduler-context/"},{"content":"  kube-scheduler æ˜¯Kubernetesçš„é è¨­èª¿åº¦ç¨‹å¼ï¼Œæ¯å€‹æ–°å»ºç«‹çš„Podï¼Œkube-scheduleréœ€è¦å¹«ä»–é¸æ“‡ä¸€å€‹æœ€ä½³çš„ç¯€é»ï¼Œè®“ç¯€é»ä¸Šçš„Kubeletå¯ä»¥æŠŠPodåŸ·è¡Œèµ·ä¾†ã€‚\nä½†æ˜¯ï¼Œæ¯å€‹Podå°è³‡æºçš„è¦æ±‚éƒ½ä¸åŒï¼Œå› æ­¤ï¼Œéœ€è¦æ ¹æ“šç‰¹å®šçš„èª¿åº¦æ¼”ç®—æ³•å°ç¾æœ‰çš„ç¯€é»é€²è¡Œéæ¿¾ã€‚\nkube-scheduleré€šéå…©æ­¥æ“ä½œç‚ºPodé¸æ“‡ç¯€é»ï¼š\n ç¯©é¸  ç¯©é¸æ­¥é©Ÿä¸­ï¼Œscheduleræ ¹æ“šç¯©é¸è¦å‰‡ï¼Œä¿ç•™ç¬¦åˆè¦å‰‡çš„ç¯€é»ï¼Œä¾‹å¦‚æŸäº›ç¯€é»è¢«æ‰“ä¸Štaintçš„æ¨™è¨˜ï¼ŒPodç„¡æ³•å®¹å¿é€™äº›è¢«æ±¡æŸ“é(taint)çš„ç¯€é»ï¼Œscheduleræ ¹æ“šç¯©é¸è¦å‰‡å°‡åˆé©çš„ç¯€é»ç•™ä¸‹ã€‚   è¨ˆåˆ†  è¨ˆåˆ†æ­¥é©Ÿä¸­ï¼Œscheduleræ ¹æ“šè¨ˆåˆ†è¦å‰‡ç‚ºæ¯å€‹å°ç¯©é¸å®Œçš„ç¯€é»æ‰“åˆ†æ•¸æ¥è‘—ç‚ºæ¯ä¸€å€‹ç¯€é»é€²è¡Œå¾—åˆ†æ’åï¼Œè—‰ä»¥é¸æ“‡æœ€åˆé©æ“ºæ”¾çš„Podç¯€é»ã€‚ å¦‚æœå­˜åœ¨å¤šå€‹å¾—åˆ†ç›¸ç­‰çš„ç¯€é»ï¼Œå‰‡ scheduler æœƒéš¨æ©Ÿé¸æ“‡å…¶ä¸­ä¹‹ä¸€ã€‚    äº†è§£ä¸Šè¿°çš„å¤§æ–¹å‘å¾Œï¼Œå¾ŒçºŒçš„æ–‡ç« å°‡source codeä¾†äº†è§£æ•´å€‹schedulerçš„æ¶æ§‹èˆ‡é‹ä½œæµç¨‹ã€‚\n","description":"","id":7,"section":"posts","tags":["kubernetes"],"title":"Kubernetes Scheduler æ¢è¨ source code å‰çš„æº–å‚™","uri":"https://blog.jjmengze.website/posts/kubernetes/scheduler/kubernetes-scheduler/"},{"content":"  Openshift cluster monitoring operator æˆ‘æ‰ä¸å‘Šè¨´ä½ å‹’ slide: https://hackmd.io/p/OonUQ9QKQ7-7JPBd1N9tOA?both\nWe have a collaborative session\nplease prepare laptop or smartphone to join!\nWho am I?  Jason Li SRE/Backend developer â¤ kubernetes Go Rust ğŸˆ lover ä¸æ–·çš„å¾å…¥é–€åˆ°æ”¾æ£„  Agenda  Background Related Work Method Conclusion  Background Prometheus Operator, Prometheus, Prometheus Adapter, kube-state-metrics, \u0026hellip; e.t.c.\nIn order to manage such diverse components, a centralized management configuration file is required.\nRelated Work  UI Prometheus Metrics Thanos  UI  Grafana  Prometheus  Prometheus Operator Prometheus-k8s\nğŸ‘ - Prometheus-user-workload Alertmanager  Prometheus Operator   Provide Kubernetes native deployment and management related monitoring components.\n  automate the configuration of a Prometheus based monitoring stack for Kubernetes clusters.\n Prometheus Alertmanager Related components    Prometheus Operator(contâ€™d) Metrics  node-exporter kube-state-metrics openshift-state-metrics  ğŸ‘ prometheus-adapter\nğŸ‘ Telemeter Client\nğŸ‘ configuration sharing\nnode-exporter  Node exporter for hardware and OS metrics exposed by *NIX kernels. We can scrape, including a wide variety of system metrics further down in the output (prefixed with node_).  1 2 3 4 5 6 7 8 9 10  # HELP node_network_transmit_queue_length transmit_queue_length value of /sys/class/net/\u0026lt;iface\u0026gt;. # TYPE node_network_transmit_queue_length gauge node_network_transmit_queue_length{device=\u0026#34;br0\u0026#34;} 1000 node_network_transmit_queue_length{device=\u0026#34;eth0\u0026#34;} 1000 node_network_transmit_queue_length{device=\u0026#34;lo\u0026#34;} 1000 node_network_transmit_queue_length{device=\u0026#34;ovs-system\u0026#34;} 1000 node_network_transmit_queue_length{device=\u0026#34;tun0\u0026#34;} 1000 node_network_transmit_queue_length{device=\u0026#34;veth24377b8e\u0026#34;} 0 node_network_transmit_queue_length{device=\u0026#34;veth58bd788d\u0026#34;} 0 ...   kube-state-metrics  Focused on the health of the individual Kubernetes components, such as deployments, nodes and pods. Exposes raw data unmodified from the Kubernetes API Designed to be consumed either by Prometheus  openshift-state-metrics  Expands upon kube-state-metrics by adding metrics for OpenShift specific resources. Expose cluster-level metrics for OpenShift specific resources  openshift-state-metrics (contâ€™d)  BuildConfig Metrics Build Metrics DeploymentConfig Metrics ClusterResourceQuota Metrics Route Metrics Group Metrics  ref: https://github.com/openshift/openshift-state-metrics\nThanos  Thanos Thanos Querier Thanos Ruler  Method    Component Key     Prometheus Operator prometheusOperator   Prometheus prometheusK8s   Alertmanager alertmanagerMain   kube-state-metrics kubeStateMetrics   openshift-state-metrics openshiftStateMetrics   Grafana grafana   Telemeter Client telemeterClient   Prometheus Adapter k8sPrometheusAdapter   Thanos Querier thanosQuerier    Method (contâ€™d)  Only Prometheus and Alertmanager have extensive configuration options. Other components usually provide only the nodeSelector field.  Method (contâ€™d) move components to the node\n1 2 3 4 5 6 7 8  data:config.yaml:| prometheusOperator:nodeSelector:foo:barprometheusK8s:nodeSelector:foo:bar  persistent volume claim\n1 2 3 4 5 6 7 8 9 10 11  data:config.yaml:| prometheusK8s:volumeClaimTemplate:metadata:name:localpvcspec:storageClassName:local-storageresources:requests:storage:40Gi  custom Alertmanager configuration  At this stage, cluster monitoring does not provide Alertmanager settings  Conclusion ğŸ’¯ ğŸ’ª ğŸ‰\nWrap up  Self-updating monitoring stack that is based on Prometheus wider eco-system Provides monitoring of cluster components Expect to manage each component through the configuration fileğŸ‰  Thank you! ğŸ‘","description":"","id":8,"section":"posts","tags":["openshift","talk"],"title":"Cluster Monitoring Operator","uri":"https://blog.jjmengze.website/posts/ocp/cluster-monitoring-operator/"},{"content":"  åœ–ç‰‡ä¾†æº\nKubernetes Cluster ä¸­ API Server æ˜¯ç®¡ç†æ•´å€‹å¢é›†çš„å¤§è…¦ï¼Œ API-Server ä¸€èˆ¬åŸ·è¡Œåœ¨ Controller Plane ï¼ˆMaster Nodeï¼‰ä¸Šï¼Œç¶­é‹äººå“¡é€šå¸¸æœƒé€é CLI kubectl å·¥å…·å»ç®¡ç† Kubernetesã€‚\nä½†é‚„æœ‰è¨±å¤šæ–¹å¼å¯ä»¥å­˜å– Kubernetes API Server ï¼Œä»Šå¤©æœƒå»ºç«‹ä¸€å€‹ç‰¹æ®Šå ´æ™¯ã€‚æœ‰ä¸€å€‹åç‚º Jean çš„ä½¿ç”¨è€…ï¼Œé€é Rest API çš„æ–¹å¼å­˜å– Kubernetes çš„è³‡æº\nå‘ Kubernetes API Server ç™¼èµ·è«‹æ±‚é€šå¸¸éœ€è¦æœ‰ä¸€å€‹æœ‰æ¬Šé™çš„ ServiceAccount ï¼Œä½¿ç”¨é€™å€‹ ServiceAccount é€šé ClusterRole ã€ Role ã€ ClusterRoleBinding ã€ RoleBinding è³¦äºˆæ“ä½œç›¸é—œè³‡æºçš„æ¬Šé™ï¼Œ èˆ‡ API Server çš„è«‹æ±‚åŸºæœ¬ä¸Šæ˜¯åŸºæ–¼ TLS ï¼Œæ‰€ä»¥ User ç™¼èµ·è«‹æ±‚çš„æ™‚å€™é‚„éœ€è¦è‡ªå¸¶æ†‘è­‰ï¼Œç•¶ç„¶æˆ‘å€‘ä¹Ÿå¯ä»¥é€ééå®‰å…¨æ–¹å¼å­˜å– API Server ï¼Œ ä½†æ˜¯ä¸æ¨è–¦åœ¨ç’°å¢ƒä¸­ä½¿ç”¨ï¼Œé€™é‚Šå°±ä¸å†å¤šåšèªªæ˜ã€‚\ncreate user create private key ç‚ºäº†ç°¡å–®èµ·è¦‹ï¼Œæœ¬ç¯‡å°‡ X.509 client certificates èˆ‡ OpenSSL çµåˆä½¿ç”¨å»ºç«‹Userï¼š\n Create a private key for jean:  1  openssl genrsa -out jean.key 2048   create CSR å»ºç«‹ä¸€å€‹è­‰æ›¸ç±¤åè«‹æ±‚ï¼ˆCSRï¼‰\n Without Group\n 1 2 3  openssl req -new -key jean.key \\ -out jean.csr \\ -subj \u0026#34;/CN=jean\u0026#34;   singup CSR èˆ‡ Kubernetes CA ç°½ç½² CSR ï¼Œ Kubernetes CA é€šå¸¸åœ¨ /etc/kubernetes/pki/ é–“å–®çš„æˆæ¬Š100å¤©ã€‚\n1 2 3 4 5  openssl x509 -req -in jean.csr \\ -CA /etc/kubernetes/pki/ca.crt \\ -CAkey /etc/kubernetes/pki/ca.key \\ -CAcreateserial \\ -out jean.crt -days 100   æª¢æŸ¥ä¸€ä¸‹ç•¶å‰è³‡æ–™å¤¾çš„æª”æ¡ˆï¼Œæ‡‰è©²æœƒæœ‰ä¸‰å€‹æª”æ¡ˆåˆ†åˆ¥æ˜¯ jean.crt ã€ jean.csr ã€ jean.key\n1 2  ls jean.crt jean.csr jean.key   åšå®Œä»¥ä¸Šçš„æ­¥é©Ÿå°±ç°¡å–®çš„å»ºç«‹äº†ä¸€å€‹åç‚º Jean çš„ user ï¼Œæˆ‘å€‘å¾ŒçºŒå¯ä»¥ä½¿ç”¨ rest api æˆ–æ˜¯ CLI kubectl å»å­˜å– Kubernetes è³‡æºã€‚\naccess kubernetes api server check API Server IP æˆ‘å€‘éœ€è¦å…ˆç¢ºèª Master åœ¨å“ªè£¡ï¼Œé€™é‚Šæœ‰å…©ç¨®æ–¹å¼éƒ½å¯ä»¥å­˜å–åˆ° Kubernetes Master Node çš„IPã€‚\n master NIC IP  1 2 3  kubectl get node jason-test -o go-template --template=\u0026#39;{{ (index .status.addresses 0).address }}\u0026#39; 172.18.0.5   API Server Service IP  1 2 3  kubectl get svc kubernetes -o go-template --template=\u0026#39;{{.spec.clusterIP}}\u0026#39; 10.96.0.1   ç¬¬ä¸€ç¨®å°±æ˜¯ç›´æ¥ç¢ºèª master Node çš„ IP ï¼Œç¬¬äºŒç¨®æ˜¯å¯ä»¥é€é Kubernetes Service ä¸Šçš„ VIP ã€‚\naccess pods list ä¾‹å¦‚æˆ‘å€‘å¯ä»¥é€é curl æŒ‡ä»¤ç›´æ¥å­˜å– Master Node IP ä¸Šçš„ API Server\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  curl https://172.18.0.5:6443/api/v1/namespaces/default/pods/ --cacert /etc/kubernetes/pki/ca.crt --cert ./jean.crt --key ./jean.key { \u0026#34;kind\u0026#34;: \u0026#34;Status\u0026#34;, \u0026#34;apiVersion\u0026#34;: \u0026#34;v1\u0026#34;, \u0026#34;metadata\u0026#34;: { }, \u0026#34;status\u0026#34;: \u0026#34;Failure\u0026#34;, \u0026#34;message\u0026#34;: \u0026#34;pods is forbidden: User \\\u0026#34;jean\\\u0026#34; cannot list resource \\\u0026#34;pods\\\u0026#34; in API group \\\u0026#34;\\\u0026#34; in the namespace \\\u0026#34;default\\\u0026#34;\u0026#34;, \u0026#34;reason\u0026#34;: \u0026#34;Forbidden\u0026#34;, \u0026#34;details\u0026#34;: { \u0026#34;kind\u0026#34;: \u0026#34;pods\u0026#34; }, \u0026#34;code\u0026#34;: 403 }   ä½†é€™è£¡æœƒç™¼ç¾ç„¡æ³•å­˜å– Pod resource in \u0026quot;\u0026rdquo; group é€™é‚Šæ˜¯å› ç‚ºæ²’æœ‰é‡å° jean å»è¨­å®š RBAC çš„å­˜å–ç¯„åœã€‚\n æ–°å¢ä¸€å€‹è®€å– default namespace çš„ role  1 2 3 4 5 6 7 8 9  apiVersion:rbac.authorization.k8s.io/v1kind:Rolemetadata:namespace:defaultname:pod-readerrules:- apiGroups:[\u0026#34;\u0026#34;]# \u0026#34;\u0026#34; indicates the core API groupresources:[\u0026#34;pods\u0026#34;]verbs:[\u0026#34;get\u0026#34;,\u0026#34;watch\u0026#34;,\u0026#34;list\u0026#34;]   å¹« Jean ç¶å®šæœ‰èƒ½åŠ›è®€å– Pod çš„è§’è‰²  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  apiVersion:rbac.authorization.k8s.io/v1# This role binding allows \u0026#34;jean\u0026#34; to read pods in the \u0026#34;default\u0026#34; namespace.# You need to already have a Role named \u0026#34;pod-reader\u0026#34; in that namespace.kind:RoleBindingmetadata:name:read-podsnamespace:defaultsubjects:# You can specify more than one \u0026#34;subject\u0026#34;- kind:Username:jane# \u0026#34;name\u0026#34; is case sensitiveapiGroup:rbac.authorization.k8s.ioroleRef:# \u0026#34;roleRef\u0026#34; specifies the binding to a Role / ClusterRolekind:Role#this must be Role or ClusterRolename:pod-reader# this must match the name of the Role or ClusterRole you wish to bind toapiGroup:rbac.authorization.k8s.io  å®Œæˆä»¥ä¸Šç¶å®šçš„å‹•ä½œä¹‹å¾Œ Jean å°±æœ‰äº†è®€å– default namespaces çš„æ¬Šé™äº†\nreaccess kubernetes api server ä¸€æ¨£é€é curl æŒ‡ä»¤å­˜å– Kubernetes api server ï¼Œæœ€å¾Œé€é jq å¹«å¿™æ•´ç†è¼¸å‡ºçš„å…§å®¹ã€‚\n1 2 3 4 5 6 7 8 9 10 11  curl -s https://172.18.0.5:6443/api/v1/namespaces/default/pods/ --cacert /etc/kubernetes/pki/ca.crt --cert ./jean.crt --key ./jean.key | jq -r \u0026#39;.items[].metadata.name\u0026#39; greetings-run-1598345882182-pod-c7vbz h2c-client h2c-server-78bbb8f665-qz7kw hello-run-1598334732648-pod-ckvgk hello-run-1598342326047-pod-5hbj7 hello-run-1598342412495-pod-kbcsp hello-run-1598342606769-pod-xj6wd hello-run-1598344900394-pod-nc95n print-date-run-1598433322555-pod-m9lqf   å°çµ å…¶å¯¦å¤§å¤šæ•¸çš„æ–¹æ³• ä¾‹å¦‚é€é client-go æ’°å¯«ç¨‹å¼å»å­˜å– Kubernetes è³‡æºåˆæˆ–æ˜¯é€é CLI kubectl å»å­˜å– Kubernetes ç‹€æ…‹ï¼Œåº•å±¤éƒ½æ˜¯é€é Reset api ï¼Œå­¸ç¿’æ€éº¼ä½¿ç”¨ Reset api å»è®€å–è³‡æ–™ä¹Ÿæ˜¯ä¸€å€‹å¾ˆæœ‰ç”¨çš„æ–¹æ³•\nåƒæ˜¯ python client å¦‚æœæ²’æœ‰æ›´æ–°çš„è©±ï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨ reset api çš„æ–¹å¼å–å¾—ç•¶å‰ Kubernetes è³‡æºè¿‘ä¸€æ­¥å»ä¿®æ”¹ã€‚\n","description":"","id":9,"section":"posts","tags":["kubernetes"],"title":"ä½¿ç”¨reset api å­˜å– Kubernetes ","uri":"https://blog.jjmengze.website/posts/kubernetes/reset-api-server/"},{"content":"  ç°¡å–®ç†è§£ Operator Lifecycle Manager - 2 (OLM) OpenShift Container Platform 4ï¼Œä½¿ç”¨äº†å¤§é‡çš„ Operator ç®¡ç† Kubernetes Resource ï¼Œæˆ–è¨±é€™è·Ÿ redhat çš„æ¨è¡ŒKubernetesæ”¿ç­–æœ‰é—œå§ xDã€‚\nä½†æ˜¯é€™é‚Šæœƒå»¶ä¼¸å‡ºè›‹ç”Ÿé›é›ç”Ÿè›‹çš„å•é¡Œï¼Œé‚£ Operator è¦æ€éº¼è¢«ç®¡ç†å‘¢ï¼Ÿ\nredhat çµ¦å‡ºäº†ä¸€å€‹è§£ç­”é‚£å°±æ˜¯ Operator Lifecycle Manager åˆç¨± OLMï¼Œä½¿ç”¨è€…é€é Declarative çš„æ–¹å¼å‘Šè¨´ OLM ï¼Œè¦å»ºç«‹ä»€éº¼æ¨£å­çš„ Operator ã€‚\n:::info\næœ¬ç¯‡æ–‡ç« çš„é‡é»åœ¨æ–¼ OLMï¼Œæ˜¯ç”¨ä¾†ç®¡ç† Operatorã€‚\næœè‘—é€™æ–¹é¢å»æ€è€ƒä¸€ä¸”éƒ½æœƒè®Šå¾—æ¯”è¼ƒç°¡å–®ï¼\n:::\næ¥çºŒè‘—ä¸Šç¯‡æåˆ°è§€å¿µæœ¬ç¯‡æœƒç¤ºç¯„å¦‚ä½•åœ¨ cluster ä¸­å¾ CatalogSources ä¸‹è¼‰ä¸€å€‹ PackageManifest ä¸¦ä¸”å®‰è£åˆ°ç’°å¢ƒã€‚\nGUI æ“ä½œ å¯ä»¥å¾åœ–ç‰‡çœ‹åˆ°åœ¨ administration æ¨¡å¼åº•ä¸‹å¯ä»¥å¾å·¦é‚Šé¸å– Operators ï¼Œè£¡é¢æœ‰å…©å€‹åˆ†é åˆ†åˆ¥æ˜¯ OperatorHub ä»¥åŠ install Operatorsã€‚\næˆ‘å€‘å¯ä»¥é€é OCP Portal ç›´æ¥ä¸‹è¼‰æƒ³è¦çš„ Operator ï¼Œå¯ä»¥åœ¨å³æ‰‹é‚Šçœ‹åˆ°æœ‰è¨±å¤šç¨®é¡æä¾›æˆ‘å€‘åšé¸æ“‡ã€‚\né€™å€‹éƒ¨ä»½ç•™çµ¦æœ‰èˆˆè¶£çš„æœ‹å‹ï¼Œä»Šå¤©è‘—é‡æ–¼ CLI çš„æ“ä½œã€‚\nCRD - OperatorGroup å¾ CatalogSources ä¸‹è¼‰ä¸€å€‹ PackageManifest ä¹‹å‰æˆ‘å€‘è¦å…ˆå»ºç«‹ä¸€å€‹project(namespaces)ï¼Œè®“æ“ä½œéƒ½åœ¨é€™å€‹ project ä¸‹ã€‚\n1  oc new-project playolm   å»ºç«‹å®Œæˆ project å¾Œæˆ‘å€‘é‚„éœ€è¦å»ºç«‹ä¸€å€‹ OperatorGroup ç¢ºèªä¹‹å¾Œå®‰è£çš„ operator åªæœ‰æ“ä½œé€™å€‹ namespaces çš„æ¬Šé™ï¼Œå°æ–¼ OperatorGroup æƒ³è¦å¤šç­è§£ä¸€ä¸‹å¯ä»¥åƒè€ƒolm bookã€‚\n1 2 3 4 5 6 7 8 9 10 11  cat \u0026lt;\u0026lt;EOF | oc apply -f - apiVersion: operators.coreos.com/v1 kind: OperatorGroup metadata: name: prometheus-operatorgroup namespace: playolm spec: targetNamespaces: - playolm EOF operatorgroup.operators.coreos.com/prometheus-operatorgroup created   é€éæŒ‡ä»¤ç¢ºèªä¸€ä¸‹å‰›å‰›éƒ¨ç½²ä¸Šå»çš„ operatorgroup\n1 2 3  oc get operatorgroup prometheus-operatorgroup NAME AGE prometheus-operatorgroup 114s   CRD - Subscription å‰›å‰›è¨­å®šå¥½operatorgroupï¼Œç¾åœ¨è¦åˆ° CatalogSources ä¸‹è¼‰ä¸€å€‹ PackageManifest é‚„è¨˜å¾—ä¸Šä¸€å€‹ç« ç¯€æœ‰æ‹¿ä¸€å€‹ community-operators çš„ prometheus-exporter-operator yaml ç°¡å–®çš„çœ‹ä¸€ä¸‹è£¡é¢çš„å…§å®¹å—ï¼Ÿ\né€™é‚Šåœ¨åŸ·è¡Œä¸€æ¬¡çœ‹ä¸€ä¸‹è£¡é¢çš„ yaml æª”\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124  oc get packagemanifests prometheus-exporter-operator -o yaml apiVersion: packages.operators.coreos.com/v1 kind: PackageManifest metadata: creationTimestamp: \u0026#34;2020-06-20T07:23:23Z\u0026#34; labels: catalog: community-operators catalog-namespace: openshift-marketplace olm-visibility: hidden openshift-marketplace: \u0026#34;true\u0026#34; operatorframework.io/arch.amd64: supported operatorframework.io/os.linux: supported opsrc-datastore: \u0026#34;true\u0026#34; opsrc-owner-name: community-operators opsrc-owner-namespace: openshift-marketplace opsrc-provider: community provider: Red Hat provider-url: \u0026#34;\u0026#34; name: prometheus-exporter-operator namespace: default selfLink: /apis/packages.operators.coreos.com/v1/namespaces/default/packagemanifests/prometheus-exporter-operator spec: {} status: catalogSource: community-operators catalogSourceDisplayName: Community Operators catalogSourceNamespace: openshift-marketplace catalogSourcePublisher: Red Hat channels: - currentCSV: prometheus-exporter-operator.v0.2.0 currentCSVDesc: annotations: alm-examples: |- [ { \u0026#34;apiVersion\u0026#34;: \u0026#34;monitoring.3scale.net/v1alpha1\u0026#34;, \u0026#34;kind\u0026#34;: \u0026#34;PrometheusExporter\u0026#34;, \u0026#34;metadata\u0026#34;: { \u0026#34;name\u0026#34;: \u0026#34;example-memcached\u0026#34; }, \u0026#34;spec\u0026#34;: { \u0026#34;dbHost\u0026#34;: \u0026#34;your-memcached-host\u0026#34;, \u0026#34;dbPort\u0026#34;: 11211, \u0026#34;grafanaDashboard\u0026#34;: { \u0026#34;label\u0026#34;: { \u0026#34;key\u0026#34;: \u0026#34;autodiscovery\u0026#34;, \u0026#34;value\u0026#34;: \u0026#34;enabled\u0026#34; } }, \u0026#34;type\u0026#34;: \u0026#34;memcached\u0026#34; } } ] capabilities: Deep Insights categories: Monitoring certified: \u0026#34;false\u0026#34; containerImage: quay.io/3scale/prometheus-exporter-operator:v0.2.0 createdAt: \u0026#34;2020-06-08 00:00:00\u0026#34; description: Operator to setup 3rd party prometheus exporters, with a collection of grafana dashboards repository: https://github.com/3scale/prometheus-exporter-operator support: Red Hat, Inc. apiservicedefinitions: {} customresourcedefinitions: owned: - description: Configures a prometheus exporter to monitor a memcached instance displayName: PrometheusExporter kind: PrometheusExporter name: prometheusexporters.monitoring.3scale.net version: v1alpha1 description: | A Kubernetes Operator based on the Operator SDK to centralize the setup of 3rd party prometheus exporters on **Kubernetes/OpenShift**, with a collection of grafana dashboards. You can setup different prometheus exporters to monitor the internals from different databases, or even any available cloudwatch metric from any AWS Service, by just providing a few parameters like **dbHost** or **dbPort** (operator manages the container image, port, argument, command, volumes... and also prometheus **ServiceMonitor** and **GrafanaDashboard** k8s objects). Current prometheus exporters types supported, managed by same prometheus-exporter-operator: * memcached * redis * mysql * postgresql * sphinx * es (elasticsearch) * cloudwatch The operator manages the lifecycle of the following objects: * Deployment (one per CR) * Service (one per CR) * ServiceMonitor (optional, one per CR) * GrafanaDashboard (optional, one per Namespace) ### Documentation Documentation can be found on our [website](https://github.com/3scale/prometheus-exporter-operator#documentation). ### Getting help If you encounter any issues while using operator, you can create an issue on our [website](https://github.com/3scale/prometheus-exporter-operator) for bugs, enhancements, or other requests. ### Contributing You can contribute by: * Raising any issues you find using Prometheus Exporter Operator * Fixing issues by opening [Pull Requests](https://github.com/3scale/prometheus-exporter-operator/pulls) * Submitting a patch or opening a PR * Improving [documentation](https://github.com/3scale/prometheus-exporter-operator) * Talking about Prometheus Exporter Operator All bugs, tasks or enhancements are tracked as [GitHub issues](https://github.com/3scale/prometheus-exporter-operator/issues). ### License Prometheus Exporter Operator is licensed under the [Apache 2.0 license](https://github.com/3scale/prometheus-exporter-operator/blob/master/LICENSE) displayName: Prometheus Exporter Operator installModes: - supported: true type: OwnNamespace - supported: true type: SingleNamespace - supported: false type: MultiNamespace - supported: true type: AllNamespaces provider: name: Red Hat version: 0.2.0 name: alpha defaultChannel: alpha packageName: prometheus-exporter-operator provider: name: Red Hat   è£¡é¢çš„å…§å®¹å¾ˆå¤šçœ‹èµ·ä¾†å¿ƒç…©æ„äº‚çš„ï¼Œä¸éæˆ‘å€‘çœŸæ­£è¦é—œå¿ƒçš„åªæœ‰ä»¥ä¸‹å››é»ã€‚\n name: prometheus-exporter-operator defaultChannel: alpha catalogSource: community-operators catalogSourceNamespace: openshift-marketplace  æœ‰é€™å¹¾å€‹åƒæ•¸å°±å¯ä»¥å‘Šè¨´olmèªªæˆ‘å€‘è¦ç”¨çš„æ˜¯å“ªå€‹catalogsourcesä»¥åŠæ˜¯å“ªä¸€å€‹packagemanifestsã€‚\nå¾defaultChannel æˆ‘å€‘å¯ä»¥çœ‹åˆ°æˆ‘å€‘è¦ç”¨åˆ°æ˜¯ alpha ç‰ˆï¼Œalpha å°æ‡‰åˆ°çš„æ˜¯operator prometheus-exporter-operator.v0.2.0 ç‰ˆã€‚\né€²å…¥é€™å€‹ CRD Subscription çš„é‡é ­æˆ²ï¼Œå®£å‘Šæˆ‘è¦ç”¨å“ªä¸€å€‹catalogsourcesä»¥åŠæ˜¯å“ªä¸€å€‹packagemanifestsã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  cat\u0026lt;\u0026lt;EOF|ocapply-f-apiVersion:operators.coreos.com/v1alpha1kind:Subscriptionmetadata:name:prometheus-exporter-operatornamespace:playolmspec:channel:alphainstallPlanApproval:Manualname:prometheus-exporter-operatorsource:community-operatorssourceNamespace:openshift-marketplaceinstallPlanApproval:ManualEOFsubscription.operators.coreos.com/prometheus-exporter-operatorcreated  é€™æ™‚å€™å¯ä»¥é€éæŒ‡ä»¤çœ‹çœ‹é€™å€‹projectè¨‚é–±äº†å“ªäº›subscriptionã€‚\n1 2 3  $ oc get subscription NAME PACKAGE SOURCE CHANNEL prometheus-exporter-operator prometheus-exporter-operator community-operators alpha   é€™é‚Šçš„ subscription å¯ä»¥æŠŠå®ƒç•¶æˆ å¦‚æœpackagemanifests æœ‰æ›´æ–°æˆ‘å€‘æœƒæ”¶åˆ°æ›´æ–°çš„æ¦‚å¿µï¼Œèªªç™½äº†å°±æ˜¯ä½ è¨‚é–±youtuberæœ‰é–‹å•Ÿå°éˆ´éºä»–å°±æœƒé€šçŸ¥ä½ xDã€‚\nCRD - Installplan å¯ä»¥é€éå¦å¤–ä¸€å€‹CRDçœ‹åˆ°ç›®å‰ project åº•ä¸‹æœ‰è¨‚é–±ï¼ˆå®‰è£ï¼Ÿ æŠ±æ­‰æ‰¾ä¸åˆ°ä¸€å€‹é©ç•¶çš„ä¸­æ–‡ï¼‰å“ªäº› Operator ä»–çš„ç‰ˆæœ¬æ˜¯å¤šå°‘ï¼Œç¾åœ¨å®‰è£äº†å—ç­‰è³‡è¨Šã€‚\n1 2 3  oc get installplan NAME CSV APPROVAL APPROVED install-b5tmz prometheus-exporter-operator.v0.2.0 Manual false   å¾ä¸Šç½²æŒ‡ä»¤çš„çµæœä¾†çœ‹é€™å€‹ project è¨‚é–±äº†prometheus-exporter-operator.v0.2.0 ç¾åœ¨é‚„æ²’æœ‰è¢« approved æ‰€ä»¥é‚„æ²’å®‰è£åˆ°ç’°å¢ƒä¸­ã€‚\nç¾åœ¨æˆ‘å€‘è¦æ‰‹å‹•ä¸Šä¸€å€‹ patch è®“é€™å€‹å®‰è£åŒ…è¢« approved ï¼Œå†ä¾†è§€å¯Ÿç’°å¢ƒçš„è®ŠåŒ–ã€‚\n1 2  oc patch installplan install-b5tmz --type=\u0026#39;json\u0026#39; -p \u0026#39;[{\u0026#34;op\u0026#34;: \u0026#34;replace\u0026#34;, \u0026#34;path\u0026#34;: \u0026#34;/spec/approved\u0026#34;, \u0026#34;value\u0026#34;:true}]\u0026#39; installplan.operators.coreos.com/install-b5tmz patched   å†é€éæŒ‡ä»¤çœ‹ç¾åœ¨prometheus-exporter-operator.v0.2.0æ˜¯å¦è¢«approvedäº†ã€‚\n1 2 3  oc get installplan NAME CSV APPROVAL APPROVED install-b5tmz prometheus-exporter-operator.v0.2.0 Manual true   CRD - ClusterServiceVersion (CSV) å¯ä»¥é€é ClusterServiceVersion è§€å¯Ÿç›®å‰åœ¨ cluster åŸ·è¡Œçš„ Operator æ˜¯å“ªä¸€å€‹ç‰ˆæœ¬ï¼Œä»¥åŠæœ‰å“ªäº› operator æ­£åœ¨åŸ·è¡Œã€‚\n:::warning\né€™é‚Šè¦æ³¨æ„ï¼Œåªæœ‰è¢«approvedäº†çš„installplanæ‰æœƒè¢«clusterserviceversionç´€éŒ„ã€‚\n:::\n1 2 3  oc get clusterserviceversion NAME DISPLAY VERSION REPLACES PHASE prometheus-exporter-operator.v0.2.0 Prometheus Exporter Operator 0.2.0 Succeeded   çœ‹èµ·ä¾†éƒ½æœ‰æˆåŠŸåœ¨åŸ·è¡Œï¼Œç¾åœ¨å¯ä»¥è§€å¯Ÿ Kubernetes Cluster è£¡é¢æ˜¯å¦æœ‰å®‰è£ prometheus çš„ç›¸é—œå…ƒä»¶ã€‚\nè§€å¯Ÿprometheus CRDæœ‰æ²’æœ‰æˆåŠŸå®‰è£\n1 2 3 4  oc get crd | grep prometheus prometheuses.monitoring.coreos.com 2020-06-20T07:24:12Z prometheusexporters.monitoring.3scale.net 2020-07-24T03:20:46Z prometheusrules.monitoring.coreos.com 2020-06-20T07:24:13Z   è§€å¯Ÿ Prometheus CRDæœ‰æ²’æœ‰æˆåŠŸå®‰è£\n1 2 3 4  oc get crd | grep prometheus prometheuses.monitoring.coreos.com 2020-06-20T07:24:12Z prometheusexporters.monitoring.3scale.net 2020-07-24T03:20:46Z prometheusrules.monitoring.coreos.com 2020-06-20T07:24:13Z   è§€å¯Ÿ Prometheus ServiceAccount æœ‰æ²’æœ‰æˆåŠŸå®‰è£\n1 2  oc get sa | grep prometheus prometheus-exporter-operator 2 7m45s   è§€å¯Ÿ Prometheus role rolebinding æœ‰æ²’æœ‰æˆåŠŸå®‰è£\n1 2 3  oc get role,rolebinding | grep prometheus role.rbac.authorization.k8s.io/prometheus-exporter-operator.v0.2.0-2nb8s 8m40s rolebinding.rbac.authorization.k8s.io/prometheus-exporter-operator.v0.2.0-2nb8s-prometheus-exporfkbqh 8m40s   æœ€å¾Œçœ‹çœ‹ Prometheus Operator æœ‰æ²’æœ‰æˆåŠŸå®‰è£åˆ° Kubernetes ä¸Š\noc get deployments NAME READY UP-TO-DATE AVAILABLE AGE prometheus-exporter-operator 1/1 1 1 9m38s çœ‹èµ·ä¾†ä¸€åˆ‡éƒ½å¾ˆæ­£å¸¸ï¼Œä½†é­”é¬¼è—åœ¨ç´°ç¯€è£¡æ˜¯ä¸æ˜¯ prometheus-exporter-operator Deploymentç‰ˆæœ¬å¦‚æˆ‘å€‘é æœŸçš„ä¸€æ¨£\n1 2  oc get deployment prometheus-exporter-operator -o go-template --template \u0026#39;{{range .spec.template.spec.containers}} {{.image}}{{end}}\u0026#39; quay.io/3scale/prometheus-exporter-operator:v0.2.0   å¾ä¸Šè¿°è¼¸å‡ºçš„çµæœä¾†çœ‹ç‰ˆæœ¬è·Ÿ packagemanifests æ‰€å®šç¾©çš„æ˜¯ä¸€æ¨£çš„ã€‚\nçµèª é›–ç„¶æ„Ÿè¦ºå¾—å‡ºä¾† RedHat ç«‹æ„è‰¯å¥½ï¼Œä½†æ˜¯æ“ä½œé‚£éº¼å¤š CRD æƒ…æ³çœŸçš„æœ‰é»éº»ç…©ï¼Œå¦å¤–æˆ‘åœ¨æ¸¬è©¦é€™å¹¾å€‹ CRD çš„æ™‚å€™ç™¼ç¾ç•¶åˆªé™¤ ClusterServiceVersion çš„æ™‚å€™ï¼ŒOperatorçš„ç›¸é—œè³‡æºéƒ½æœƒè¢«åˆªé™¤ï¼Œæ„Ÿè¦ºé€™å€‹é‚è¼¯ä¸æ€éº¼æ­£ç¢ºã€‚\næˆ‘å€‹äººè¦ºå¾—æ˜¯ä¸æ˜¯ installplan åˆªé™¤æˆ–æ˜¯ DISAPPROVED æ‰æœƒåˆªé™¤ ClusterServiceVersion ï¼Œä½¿ç”¨è€…å°±ç®— èª¤åˆª äº†ä¹Ÿæ‡‰è©²åµæ¸¬åˆ°é€™ä»¶äº‹æƒ…ä¸¦é‡æ–°ç”Ÿæˆä¸€å€‹ ClusterServiceVersion æ‰å°ã€‚\nä»¥ä¸Šç´”å±¬å€‹äººè¦‹è§£ï¼Œå¸Œæœ›èƒ½èˆ‡å¤§å®¶è¨è«–äº¤æµã€‚\n","description":"","id":10,"section":"posts","tags":["openshift"],"title":"ç°¡å–®ç†è§£ Operator Lifecycle Manager - 2 (OLM)","uri":"https://blog.jjmengze.website/posts/ocp/operator-lifecycle-manager-2/"},{"content":"  ç°¡å–®ç†è§£ Operator Lifecycle Manager - 1 (OLM) OpenShift Container Platform 4ï¼Œä½¿ç”¨äº†å¤§é‡çš„ Operator ç®¡ç† Kubernetes Resource ï¼Œæˆ–è¨±é€™è·Ÿ redhat çš„æ¨è¡ŒKubernetesæ”¿ç­–æœ‰é—œå§ xDã€‚\nä½†æ˜¯é€™é‚Šæœƒå»¶ä¼¸å‡ºè›‹ç”Ÿé›é›ç”Ÿè›‹çš„å•é¡Œï¼Œé‚£ Operator è¦æ€éº¼è¢«ç®¡ç†å‘¢ï¼Ÿ\nredhat çµ¦å‡ºäº†ä¸€å€‹è§£ç­”é‚£å°±æ˜¯ Operator Lifecycle Manager åˆç¨± OLMï¼Œä½¿ç”¨è€…é€é Declarative çš„æ–¹å¼å‘Šè¨´ OLM ï¼Œè¦å»ºç«‹ä»€éº¼æ¨£å­çš„ Operator ã€‚\n:::info\næœ¬ç¯‡æ–‡ç« çš„é‡é»åœ¨æ–¼ OLMï¼Œæ˜¯ç”¨ä¾†ç®¡ç† Operatorã€‚\næœè‘—é€™æ–¹é¢å»æ€è€ƒä¸€ä¸”éƒ½æœƒè®Šå¾—æ¯”è¼ƒç°¡å–®ï¼\n:::\næˆ‘å€‘å…ˆä¾†çœ‹çœ‹ OLM å®šç¾©äº†å“ªäº›ç‰©ä»¶çµ¦æˆ‘å€‘ä½¿ç”¨\nOLM CRD Operator Lifecycle Manager å®šç¾©äº†å…­å€‹è‡ªå®šç¾©çš„è³‡æº(Custom Resource Definitions,CRD)åˆ†åˆ¥æ˜¯\n CatalogSource Subscription ClusterServiceVersion (CSV) PackageManifest InstallPlan OperatorGroup  å¦‚æœæ‰‹é‚Šæœ‰ OpenShift æˆ–æ˜¯ OKD ç’°å¢ƒçš„æœ‹å‹å¯ä»¥è©¦è©¦çœ‹ä»¥ä¸‹é€™å€‹æŒ‡ä»¤ï¼Œå¯ä»¥çœ‹åˆ°ç’°å¢ƒä¸­æœ‰é€™å…­å€‹ CRD å­˜åœ¨ã€‚\n1 2 3 4 5 6 7  oc get crd | grep -E \u0026#39;catalogsource|subscription|clusterserviceversion|packagemanifest|installplan|operatorgroup\u0026#39; catalogsourceconfigs.operators.coreos.com 2020-06-20T06:57:36Z catalogsources.operators.coreos.com 2020-06-20T06:58:04Z clusterserviceversions.operators.coreos.com 2020-06-20T06:57:48Z installplans.operators.coreos.com 2020-06-20T06:57:53Z operatorgroups.operators.coreos.com 2020-06-20T06:58:12Z subscriptions.operators.coreos.com 2020-06-20T06:57:57Z   å»ºç«‹äº† CRD éœ€è¦æœ‰ç›¸å°æ‡‰çš„ Controller ä¾†è§€å¯Ÿè³‡æºçš„è®ŠåŒ–ï¼Œé€™å…­å€‹ OLM CRD è¢«ä¸‰å€‹ Controller æ‰€ç®¡ç†åˆ†åˆ¥æ˜¯ catalog-operator , olm-operator ä»¥åŠpackageserverï¼Œå¯ä»¥é€éä¸‹é¢é€™å€‹æŒ‡ä»¤è§€å¯Ÿåˆ°æ˜¯å¦å­˜åœ¨ä½ çš„ç’°å¢ƒä¸­ã€‚\n1 2 3 4 5  oc -n openshift-operator-lifecycle-manager get deploy NAME READY UP-TO-DATE AVAILABLE AGE catalog-operator 1/1 1 1 32d olm-operator 1/1 1 1 32d packageserver 2/2 2 2 32d   CRD - CatalogSources ç°¡å–®çš„ä¾†èªª CatalogSources å°±æ˜¯ Operator çš„ Repo Sourceï¼Œæ”¶é›†äº†å››ç¨®é¡å‹çš„ Operatorã€‚\nåˆ†åˆ¥æ˜¯\n Certified Operators\nåœ¨é€™å€‹ repo å…§çš„ Operator éƒ½æœ‰ç¶“é Redhat çš„èªè­‰ï¼Œç›¸é—œçš„èªªæ˜å¯ä»¥å¾Red Hat OpenShift Operator Certificationæœå°‹åˆ°ã€‚ Community Operators\nåœ¨é€™å€‹ repo å…§çš„éƒ½æ˜¯ç¤¾ç¾¤æä¾›çš„ï¼Œå„å¼å„æ¨£çš„ Operator å¯ä»¥å¾ Githubæ‰¾åˆ°ã€‚ Redhat-marketplace\nç”± Refhat èˆ‡ IBM å…±åŒåˆä½œçµ„ç¹”çµ¦ Enterprise ç”¨çš„ Repoï¼Œç›¸é—œè³‡æ–™å¯ä»¥æŸ¥è©¢ marketplaceã€‚ Redhat-operators\né€™äº› Operator ç”± Red Hat ç™¼è¡Œ  æˆ‘å€‘å¯ä»¥é€éæŒ‡ä»¤å»çœ‹ç’°å¢ƒä¸Šæœ‰æ²’æœ‰é€™å¹¾é … catalogsources ã€‚\n1 2 3 4 5  NAME DISPLAY TYPE PUBLISHER AGE certified-operators Certified Operators grpc Red Hat 32d community-operators Community Operators grpc Red Hat 32d redhat-marketplace Red Hat Marketplace grpc Red Hat 32d redhat-operators Red Hat Operators grpc Red Hat 32d   æœ‰äº†é€™äº› Repo å¾Œé‚£æ€éº¼æŸ¥çœ‹ Repo ä¸Šçš„ Operator é‚£å°±è¦ç”¨åˆ°å¦å¤–ä¸€å€‹ CRD packagemanifests ã€‚\nCRD - Packagemanifests ç°¡å–®çš„ä¾†èªª packagemanifests å°±è¨˜è¼‰äº† Operator éƒ¨ç½²çš„ç›¸é—œè¨Šæ¯\næˆ‘å€‘å¯ä»¥é€éæŒ‡ä»¤è§€å¯Ÿä¸Šé¢æåˆ°çš„ catalogsources è£¡é¢æœ‰å¤šå°‘å€‹ operator ã€‚\nCommunity Operators 1 2 3 4 5 6 7 8 9 10 11  oc get packagemanifests -l catalog=certified-operators NAME CATALOG AGE cyberarmor-operator-certified Certified Operators 32d kong-offline-operator Certified Operators 32d ibm-spectrum-symphony-operator Certified Operators 32d portshift-operator Certified Operators 32d storageos-1tb Certified Operators 32d joget-openshift-operator Certified Operators 32d aqua-operator-certified Certified Operators 32d node-red-operator-certified Certified Operators 32d ...   Community Operators oc get packagemanifests -l catalog=community-operators NAME CATALOG AGE kiali Community Operators 32d strimzi-kafka-operator Community Operators 32d planetscale Community Operators 32d nsm-operator-registry Community Operators 32d apicurito Community Operators 32d hazelcast-jet-operator Community Operators 32d ... Red Hat Marketplace 1 2 3 4 5 6 7 8  oc get packagemanifests -l catalog=redhat-marketplace NAME CATALOG AGE nxrm-operator-certified-rhmp Red Hat Marketplace 32d enterprise-operator-rhmp Red Hat Marketplace 32d storageos-rhmp Red Hat Marketplace 32d cortex-fabric-operator-rhmp Red Hat Marketplace 32d portshift-operator-rhmp Red Hat Marketplace 32d here-service-operator-certified-rhmp Red Hat Marketplace 32d   Red Hat Operators 1 2 3 4 5 6 7 8 9  oc get packagemanifests -l catalog=redhat-operators NAME CATALOG AGE rhsso-operator Red Hat Operators 32d amq-broker-rhel8 Red Hat Operators 32d advanced-cluster-management Red Hat Operators 32d jaeger-product Red Hat Operators 32d fuse-online Red Hat Operators 32d eap Red Hat Operators 32d kubevirt-hyperconverged Red Hat Operators 32d   é€™é‚Šæ‹¿ä¸€å€‹ community-operators çš„ prometheus-exporter-operator yaml ç°¡å–®çš„çœ‹ä¸€ä¸‹è£¡é¢çš„å…§å®¹ã€‚\nå¤§è‡´ä¸Šæè¿°äº†ä»¥ä¸‹å¹¾é»\n catalog channels\nä¸»è¦æè¿°äº†è¦ç®¡ç†çš„Operatorçš„ç›¸é—œè¨Šæ¯ï¼Œè©³ç´°å…§å®¹æœƒåœ¨ä¸‹ä¸€ç¯‡åšä»‹ç´¹  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124  ocgetpackagemanifestsprometheus-exporter-operator-oyamlapiVersion:packages.operators.coreos.com/v1kind:PackageManifestmetadata:creationTimestamp:\u0026#34;2020-06-20T07:23:23Z\u0026#34;labels:catalog:community-operatorscatalog-namespace:openshift-marketplaceolm-visibility:hiddenopenshift-marketplace:\u0026#34;true\u0026#34;operatorframework.io/arch.amd64:supportedoperatorframework.io/os.linux:supportedopsrc-datastore:\u0026#34;true\u0026#34;opsrc-owner-name:community-operatorsopsrc-owner-namespace:openshift-marketplaceopsrc-provider:communityprovider:RedHatprovider-url:\u0026#34;\u0026#34;name:prometheus-exporter-operatornamespace:defaultselfLink:/apis/packages.operators.coreos.com/v1/namespaces/default/packagemanifests/prometheus-exporter-operatorspec:{}status:catalogSource:community-operatorscatalogSourceDisplayName:CommunityOperatorscatalogSourceNamespace:openshift-marketplacecatalogSourcePublisher:RedHatchannels:- currentCSV:prometheus-exporter-operator.v0.2.0currentCSVDesc:annotations:alm-examples:|- [{\u0026#34;apiVersion\u0026#34;: \u0026#34;monitoring.3scale.net/v1alpha1\u0026#34;,\u0026#34;kind\u0026#34;: \u0026#34;PrometheusExporter\u0026#34;,\u0026#34;metadata\u0026#34;: {\u0026#34;name\u0026#34;: \u0026#34;example-memcached\u0026#34;},\u0026#34;spec\u0026#34;: {\u0026#34;dbHost\u0026#34;: \u0026#34;your-memcached-host\u0026#34;,\u0026#34;dbPort\u0026#34;: 11211,\u0026#34;grafanaDashboard\u0026#34;: {\u0026#34;label\u0026#34;: {\u0026#34;key\u0026#34;: \u0026#34;autodiscovery\u0026#34;,\u0026#34;value\u0026#34;: \u0026#34;enabled\u0026#34;}},\u0026#34;type\u0026#34;: \u0026#34;memcached\u0026#34;}}]capabilities:DeepInsightscategories:Monitoringcertified:\u0026#34;false\u0026#34;containerImage:quay.io/3scale/prometheus-exporter-operator:v0.2.0createdAt:\u0026#34;2020-06-08 00:00:00\u0026#34;description:Operatortosetup3rdpartyprometheusexporters,withacollectionofgrafanadashboardsrepository:https://github.com/3scale/prometheus-exporter-operatorsupport:RedHat,Inc.apiservicedefinitions:{}customresourcedefinitions:owned:- description:ConfiguresaprometheusexportertomonitoramemcachedinstancedisplayName:PrometheusExporterkind:PrometheusExportername:prometheusexporters.monitoring.3scale.netversion:v1alpha1description:| A Kubernetes Operator based on the Operator SDK to centralize the setup of 3rd party prometheus exporters on **Kubernetes/OpenShift**, with a collection of grafana dashboards.Youcansetupdifferentprometheusexporterstomonitortheinternalsfromdifferentdatabases,orevenanyavailablecloudwatchmetricfromanyAWSService,byjustprovidingafewparameterslike**dbHost**or**dbPort**(operatormanagesthecontainerimage,port,argument,command,volumes...andalsoprometheus**ServiceMonitor**and**GrafanaDashboard**k8sobjects).Current prometheus exporters types supported, managed by same prometheus-exporter-operator:*memcached*redis*mysql*postgresql*sphinx*es(elasticsearch)*cloudwatchThe operator manages the lifecycle of the following objects:*Deployment(oneperCR)*Service(oneperCR)*ServiceMonitor(optional,oneperCR)*GrafanaDashboard(optional,oneperNamespace)### DocumentationDocumentationcanbefoundonour[website](https://github.com/3scale/prometheus-exporter-operator#documentation).### Getting helpIfyouencounteranyissueswhileusingoperator,youcancreateanissueonour[website](https://github.com/3scale/prometheus-exporter-operator)forbugs,enhancements,orotherrequests.### ContributingYou can contribute by:*RaisinganyissuesyoufindusingPrometheusExporterOperator*Fixingissuesbyopening[PullRequests](https://github.com/3scale/prometheus-exporter-operator/pulls)*SubmittingapatchoropeningaPR*Improving[documentation](https://github.com/3scale/prometheus-exporter-operator)*TalkingaboutPrometheusExporterOperatorAllbugs,tasksorenhancementsaretrackedas[GitHubissues](https://github.com/3scale/prometheus-exporter-operator/issues).### LicensePrometheusExporterOperatorislicensedunderthe[Apache2.0license](https://github.com/3scale/prometheus-exporter-operator/blob/master/LICENSE)displayName:PrometheusExporterOperatorinstallModes:- supported:truetype:OwnNamespace- supported:truetype:SingleNamespace- supported:falsetype:MultiNamespace- supported:truetype:AllNamespacesprovider:name:RedHatversion:0.2.0name:alphadefaultChannel:alphapackageName:prometheus-exporter-operatorprovider:name:RedHat  çµèª å¤§è‡´ä¸Šèƒ½å¤ äº†è§£ OLM æ˜¯ç”¨ä¾†ç®¡ç† Operator çš„ç”Ÿå‘½é€±æœŸï¼ŒåŠ ä¸Šé€éå…­å€‹è‡ªå®šç¾©çš„è³‡æº( Custom Resource Definitions , CRD )ä»¥åŠä¸‰å€‹ Controllerå»ç®¡ç†æ•´å€‹ Operator çš„ç”Ÿæ…‹ã€‚\nä½¿ç”¨è€…å¯ä»¥é€é CatalogSources æ‰€æä¾›çš„ Repo ä¸‹è¼‰å„å¼å„æ¨£çš„ PackageManifest (Operator)ã€‚\nä¸‹ä¸€ç¯‡æœƒé‡å° OLM å‰©ä¸‹çš„ CRD é€²è¡Œé–“å–®çš„ä»‹ç´¹ï¼Œä»¥åŠå¾ CatalogSources ä¸‹è¼‰ä¸€å€‹ PackageManifest (Operator) ä¸¦ä¸”éƒ¨ç½²åˆ°ç’°å¢ƒä¸­ã€‚\n","description":"","id":11,"section":"posts","tags":["openshift"],"title":"ç°¡å–®ç†è§£ Operator Lifecycle Manager - 1 (OLM)","uri":"https://blog.jjmengze.website/posts/ocp/operator-lifecycle-manager-1/"},{"content":"  å°±æƒ³çœ‹çœ‹ä½ å°æˆ‘åšä»€éº¼å£å£çš„äº‹ åœ¨æ“ä½œ Kubernetes Cluster çš„æ™‚å€™ç³»çµ±ç®¡ç†å“¡æœƒç™¼çµ¦å„å€‹é–‹ç™¼è€…ã€ä½¿ç”¨è€…åˆæˆ–æ˜¯ Robot å¸³è™Ÿï¼Œé€™æ™‚å¥½å¤šäººåœ¨æ“ä½œ Cluster æœ‰æ²’æœ‰ä»€éº¼æ–¹æ³•å¯ä»¥çœ‹çœ‹èª°å° Cluster åšäº†ä»€éº¼ï¼Œåˆ°æ™‚å€™ç‚¸é‹çš„æ™‚å€™æ¯”è¼ƒå¥½æ‰¾å…‡æ‰‹ï¼ˆï¼¸ï¼‰ã€‚\nå¥½æ‹‰é™¤äº†æ‰¾å…‡æ‰‹ä¹‹å¤–é‚„å¯ä»¥é™¤éŒ¯è¨ˆè²»åšå¾ˆå¤šæˆ‘ç›®å‰é‚„æƒ³ä¸åˆ°çš„åŠŸèƒ½ï¼Œå¦‚æœæœ‰å¤§å¤§çœ‹åˆ°é€™ç¯‡æ–‡ç« æœ‰æƒ³åˆ° audit é‚„å¯ä»¥åšä»€éº¼å¯ä»¥è·Ÿæˆ‘åˆ†äº«èˆ‡è¨è«–å‘¦ï¼\næˆ‘å€‘å…ˆçœ‹çœ‹ Kubernetes æ”¯æ´å“ªäº› audit è™•ç†çš„æ–¹æ³•ã€‚\n Log backend, which writes events to a disk Webhook backend, which sends events to an external API Dynamic backend, which configures webhook backends through an AuditSink API object.  ç›®å‰ Kubernetes æ”¯æ´é€™ä¸‰ç¨®æ–¹æ³•è™•ç† audit è³‡æ–™ï¼Œä¸‹æ–‡æœƒä¸‰ç¨®æ–¹æ³•éƒ½æœƒä½¿ç”¨ä¸€æ¬¡ä½œç‚ºç¯„ä¾‹ï¼Œåœ¨çœ‹çœ‹å¯¦éš›çš„ç¯„ä¾‹ä¹‹å‰æˆ‘å€‘å¯ä»¥å…ˆä¾†çœ‹çœ‹ audit è³‡æ–™å¯ä»¥è¨˜éŒ„å“ªäº›æ±è¥¿ã€‚\n ç™¼ç”Ÿäº†ä»€éº¼äº‹æƒ…ï¼ˆWhat ä»€éº¼æ™‚å€™ç™¼ç”Ÿçš„ï¼ˆWhen èª°è®“äº‹æƒ…ç™¼ç”Ÿäº†ï¼ˆWho  é›–ç„¶é‚„æœ‰ç´€éŒ„å…¶ä»–å¯ä»¥çš„æ±è¥¿ï¼Œä¸éæˆ‘èªç‚ºé€™ä¸‰å€‹æœ€ç‚ºé‡è¦ï¼Œæœ‰èˆˆè¶£çš„æœ‹å‹å¯ä»¥çœ‹çœ‹å®˜æ–¹çš„æ–‡ä»¶ã€‚\næˆ‘å€‘äº†è§£åˆ° Kubernetes audit æœƒè¨˜éŒ„ä»€éº¼å¾Œï¼Œæ¥è‘—å°±æ˜¯ audit ç´€éŒ„ä»€éº¼æ™‚å€™æœƒè¢«è§¸ç™¼ï¼Œé€™é‚Šåˆ†ç‚ºå››å€‹éšæ®µã€‚\n  RequestReceived\n events generated as soon as the audit handler receives the request, and before it is delegated down the handler chain.ï¼ˆç°¡å–®ä¾†èªªå°±æ˜¯ apiserver æ”¶åˆ°è«‹æ±‚çš„éšæ®µï¼‰    ResponseStarted\n Once the response headers are sent, but before the response body is sent. This stage is only generated for long-running requests (e.g. watch).(é€™å€‹éšæ®µæˆ‘ä¸æ˜¯éå¸¸äº†è§£ï¼Œçœ‹èµ·ä¾†åƒæ˜¯ watch ä¹‹é¡çš„æ‰æœƒè§¸ç™¼é€™å€‹éšæ®µ)    ResponseComplete\n The response body has been completed and no more bytes will be sent.ï¼ˆé€™å€‹éšæ®µä»£è¡¨ apiserver çš„å›æ‡‰ï¼‰    Panic\n Events generated when a panic occurred.(ç™¼ç”Ÿ panic æ‰æœƒè§¸ç™¼)    ç›®å‰æˆ‘å€‘çŸ¥é“ Kubernetes audit æœƒè¨˜éŒ„äº‹æƒ…ç™¼ç”Ÿçš„å…§å®¹ï¼Œäº‹æƒ…ç™¼ç”Ÿçš„éšæ®µã€‚é‚£æœ‰å¯ä¸å¯ä»¥åˆ†é–€åˆ¥é¡ï¼Œä¾‹å¦‚æˆ‘åªæƒ³è¦ç´€éŒ„ pods çš„äº‹ä»¶ã€ configmaps çš„äº‹ä»¶ æˆ–æ˜¯æŸå€‹ user çš„è¡Œç‚ºå‘¢ï¼Ÿ\nç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼æ¯ç•¶æˆ‘çœ‹å®Œ Kubernetes çš„è¨­è¨ˆçœŸçš„è¦ºå¾—ç¤¾ç¾¤è€ƒæ…®çš„ç›¸ç•¶çš„å½ˆæ€§ï¼Œç¹¼çºŒé …é–‹æºå°ˆæ¡ˆå­¸ç¿’ï¼Œåªæœ‰ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šæ‰èƒ½çœ‹å¾—æ›´é ã€‚å¥½å»¢è©±ä¸å¤šèªªï¼Œå‰›å‰›è«‡åˆ°çš„åˆ†é–€åˆ¥é¡åœ¨ audit è£¡ç¨±ç‚º policy ï¼Œ policy åˆ†ç‚ºä»¥ä¸‹å››å€‹ç´šåˆ¥ã€‚\n None  (ä¸è¦è¨˜éŒ„èˆ‡æ­¤è¦å‰‡åŒ¹é…çš„äº‹ä»¶)   Metadata  (è¨˜éŒ„è«‹æ±‚çš„ metadata ä¾‹å¦‚ user timestamp resource verb e.t.c. ä½†ä¸è¨˜éŒ„è«‹æ±‚çš„å…§å®¹ï¼Œæœ‰é»é¡ä¼¼åªæŠŠ header ç´€éŒ„ä¸€ä¸‹ä¾† body éš¨å®ƒå»çš„æ„Ÿè¦ºã€‚)   Request  (è¨˜éŒ„æ•´å€‹äº‹ä»¶è«‹æ±‚çš„å…§å®¹ï¼Œ body è·Ÿ header éƒ½è¦å­˜çš„æ„æ€)   RequestResponse  (è¨˜éŒ„æ•´å€‹äº‹ä»¶å›æ‡‰çš„å…§å®¹ï¼Œ body è·Ÿ header éƒ½è¦å­˜çš„æ„æ€)    å®˜æ–¹æœ‰çµ¦å‡ºä¸€å€‹ç¯„ä¾‹è®“æˆ‘å€‘å¯ä»¥ä¾ç…§è‡ªå·±çš„éœ€æ±‚é€²è¡Œä¿®æ”¹ï¼Œç¯„ä¾‹å¦‚ä¸‹æ‰€ç¤ºã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68  apiVersion:audit.k8s.io/v1# This is required.kind:Policy# Don\u0026#39;t generate audit events for all requests in RequestReceived stage.omitStages:- \u0026#34;RequestReceived\u0026#34;rules:# Log pod changes at RequestResponse level- level:RequestResponseresources:- group:\u0026#34;\u0026#34;# Resource \u0026#34;pods\u0026#34; doesn\u0026#39;t match requests to any subresource of pods,# which is consistent with the RBAC policy.resources:[\u0026#34;pods\u0026#34;]# Log \u0026#34;pods/log\u0026#34;, \u0026#34;pods/status\u0026#34; at Metadata level- level:Metadataresources:- group:\u0026#34;\u0026#34;resources:[\u0026#34;pods/log\u0026#34;,\u0026#34;pods/status\u0026#34;]# Don\u0026#39;t log requests to a configmap called \u0026#34;controller-leader\u0026#34;- level:Noneresources:- group:\u0026#34;\u0026#34;resources:[\u0026#34;configmaps\u0026#34;]resourceNames:[\u0026#34;controller-leader\u0026#34;]# Don\u0026#39;t log watch requests by the \u0026#34;system:kube-proxy\u0026#34; on endpoints or services- level:Noneusers:[\u0026#34;system:kube-proxy\u0026#34;]verbs:[\u0026#34;watch\u0026#34;]resources:- group:\u0026#34;\u0026#34;# core API groupresources:[\u0026#34;endpoints\u0026#34;,\u0026#34;services\u0026#34;]# Don\u0026#39;t log authenticated requests to certain non-resource URL paths.- level:NoneuserGroups:[\u0026#34;system:authenticated\u0026#34;]nonResourceURLs:- \u0026#34;/api*\u0026#34;# Wildcard matching.- \u0026#34;/version\u0026#34;# Log the request body of configmap changes in kube-system.- level:Requestresources:- group:\u0026#34;\u0026#34;# core API groupresources:[\u0026#34;configmaps\u0026#34;]# This rule only applies to resources in the \u0026#34;kube-system\u0026#34; namespace.# The empty string \u0026#34;\u0026#34; can be used to select non-namespaced resources.namespaces:[\u0026#34;kube-system\u0026#34;]# Log configmap and secret changes in all other namespaces at the Metadata level.- level:Metadataresources:- group:\u0026#34;\u0026#34;# core API groupresources:[\u0026#34;secrets\u0026#34;,\u0026#34;configmaps\u0026#34;]# Log all other resources in core and extensions at the Request level.- level:Requestresources:- group:\u0026#34;\u0026#34;# core API group- group:\u0026#34;extensions\u0026#34;# Version of group should NOT be included.# A catch-all rule to log all other requests at the Metadata level.- level:Metadata# Long-running requests like watches that fall under this rule will not# generate an audit event in RequestReceived.omitStages:- \u0026#34;RequestReceived\u0026#34;  ä¸Šé¢å¤§è‡´ä¸Šç­è§£äº† Kuberetes audit çš„å¤§æ–¹å‘å¦‚ï¼Œç•¶ event ç™¼ç”Ÿçš„æ™‚å€™ä»–æœƒè¨˜éŒ„ä»€éº¼ï¼Œæœ‰å“ªå¹¾å€‹ stage æœƒè§¸ç™¼ event ä»¥åŠ event å¯ä»¥çœ‹ç…§ policy åˆ†é–€åˆ¥é¡ã€‚\näº†è§£é€™å¹¾é …æ±è¥¿ä¹‹å¾Œå°±å¯ä»¥ä¾†é€²è¡Œå¯¦é©—ï¼Œæˆ‘æœƒé€é kubeadm å»ºç«‹ä¸€å€‹ all in one çš„ kubernetes æ¸¬è©¦ audit ç´€éŒ„åœ¨ disk ä¸Šä»¥åŠ é€é webhook çš„æ–¹å¼æŠŠ event å‚³å‡ºä¾†é€²è¡Œé¡å¤–çš„è™•ç†ã€‚\nKubeadm å®‰è£æ¸¬è©¦ç’°å¢ƒ kubeadm å®‰è£æ–¹æ³•é€™é‚Šä¸å¤šè«‡ Google æœ‰å¾ˆå¤šå®‰è£çš„æ–¹æ³•ï¼Œåœ¨æœ¬æ¬¡å¯¦é©—éœ€è¦è¨­å®š audit çš„ç›¸é—œåƒæ•¸ï¼Œkubeadm ç›®å‰é‚„æ²’æœ‰å®Œå…¨æ”¯æ´ audit çš„ feature gate é™¤äº†è¨­å®š kubeadm config ä¹‹å¤–é‚„éœ€è¦æ‰‹å‹•è¨­å®šéƒ¨åˆ†åƒæ•¸ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22  apiVersion:kubeadm.k8s.io/v1beta2kind:ClusterConfiguration#featureGates:# not support DynamicAuditing# DynamicAuditing: trueapiServer:extraArgs:audit-log-path:/home/ubuntu/audit.logaudit-policy-file:/etc/kubernetes/addon/audit-policy.yaml# not support DynamicAuditing# runtime-config=auditregistration.k8s.io/v1alpha1: \u0026#34;true\u0026#34;# audit-dynamic-configuration:extraVolumes:- name:audithostPath:/etc/kubernetes/addon/audit-policy.yamlmountPath:/etc/kubernetes/addon/audit-policy.yamlreadOnly:truepathType:File- name:audit-loghostPath:/home/ubuntumountPath:/home/ubuntupathType:DirectoryOrCreate  1 2 3 4 5 6  cat \u0026lt;\u0026lt;EOF | \u0026gt;/etc/kubernetes/addon/audit-policy.yaml # Log all requests at the Metadata level. apiVersion: audit.k8s.io/v1 kind: Policy rules: - level: Metadata   å¯ä»¥é€éä¸Šè¿°é€™å€‹ kubeadm config å»è¨­å®šéƒ¨åˆ†çš„ audit åƒæ•¸ï¼Œå†ç”± kubeadm init å•Ÿå‹•çš„æ™‚å€™å°‡å®ƒè‡ªå‹•åœ°å¸¶å…¥ kube-apiserverä¸­ã€‚\n1 2 3 4 5 6  kubeadm init --config admin-apiserver.yml W0629 07:46:16.046453 86387 configset.go:202] WARNING: kubeadm cannot validate component configs for API groups [kubelet.config.k8s.io kubeproxy.config.k8s.io] [init] Using Kubernetes version: v1.18.5 [preflight] Running pre-flight checks [preflight] Pulling images required for setting up a Kubernetes cluster ...   ç”±æ–¼æœ¬æ¬¡æ¸¬è©¦ç’°å¢ƒåªæœ‰ä¸€å€‹ç¯€é»æ‰€ä»¥éœ€è¦é€²è¡Œuntaintçš„å‹•ä½œï¼Œè®“ pod å¯ä»¥åœ¨ master node ä¸Šé–‹å•Ÿã€‚\nkubectl taint node jason-test node-role.kubernetes.io/master- ç•¶ kubeadm åŸ·è¡Œå®Œä¹Ÿè¨­å®šå®Œ CNI å¾Œéœ€è¦ä¿®æ”¹/etc/kubernetes/manifests/kube-apiserver ç›¸é—œåƒæ•¸ï¼Œè®“ apiserver æ”¯æ´ audit-dynamic-configuration éœ€è¦åŠ å…¥ä»¥ä¸‹åƒæ•¸ã€‚\n1 2 3  - --audit-dynamic-configuration- --feature-gates=DynamicAuditing=true- --runtime-config=auditregistration.k8s.io/v1alpha1=true  ä¿®æ”¹å®Œæˆå¾Œï¼Œå¯ä»¥é€é kubectl æŒ‡ä»¤æª¢æŸ¥æ˜¯å¦é–‹å•Ÿ auditregistration.k8s.io/v1alpha1 çš„è³‡æºã€‚\n1 2  kubectl api-resources | grep AuditSink auditsinks auditregistration.k8s.io false AuditSin   å®Œæˆä»¥ä¸Šæ­¥é©Ÿå¾Œå°±å®Œæˆäº† kubernetes audit çš„æ¸¬è©¦ç’°å¢ƒæ­å»ºã€‚\nLog Backend äº‹å¯¦ä¸Šå‰›å‰›çš„æµç¨‹å·²ç¶“æŠŠ Backend è¨­å®šå¥½äº†ï¼Œä½ç½®å°±åœ¨ audit-log-path: /home/ubuntu/audit.log ï¼Œåªè¦è§¸ç™¼ audit å°±æœƒæŠŠç´€éŒ„å„²å­˜åœ¨é€™å€‹ä½ç½®ä¸Šã€‚é‚£æˆ‘å€‘ä¾†çœ‹çœ‹è¨­å®šå®Œ Kubernetes ä¹‹å¾Œæœƒå„²å­˜å“ªå¯«è³‡æ–™ã€‚\n1 2 3 4  tail -f audit.log {\u0026#34;kind\u0026#34;:\u0026#34;Event\u0026#34;,\u0026#34;apiVersion\u0026#34;:\u0026#34;audit.k8s.io/v1\u0026#34;,\u0026#34;level\u0026#34;:\u0026#34;Metadata\u0026#34;,\u0026#34;auditID\u0026#34;:\u0026#34;caa00b7a-e564-486c-837f-219eade633dd\u0026#34;,\u0026#34;stage\u0026#34;:\u0026#34;RequestReceived\u0026#34;,\u0026#34;requestURI\u0026#34;:\u0026#34;/apis/coordination.k8s.io/v1/namespaces/kube-system/leases/kube-controller-manager?timeout=10s\u0026#34;,\u0026#34;verb\u0026#34;:\u0026#34;get\u0026#34;,\u0026#34;user\u0026#34;:{\u0026#34;username\u0026#34;:\u0026#34;system:kube-controller-manager\u0026#34;,\u0026#34;groups\u0026#34;:[\u0026#34;system:authenticated\u0026#34;]},\u0026#34;sourceIPs\u0026#34;:[\u0026#34;10.0.2.4\u0026#34;],\u0026#34;userAgent\u0026#34;:\u0026#34;kube-controller-manager/v1.18.5 (linux/amd64) kubernetes/e6503f8/leader-election\u0026#34;,\u0026#34;objectRef\u0026#34;:{\u0026#34;resource\u0026#34;:\u0026#34;leases\u0026#34;,\u0026#34;namespace\u0026#34;:\u0026#34;kube-system\u0026#34;,\u0026#34;name\u0026#34;:\u0026#34;kube-controller-manager\u0026#34;,\u0026#34;apiGroup\u0026#34;:\u0026#34;coordination.k8s.io\u0026#34;,\u0026#34;apiVersion\u0026#34;:\u0026#34;v1\u0026#34;},\u0026#34;requestReceivedTimestamp\u0026#34;:\u0026#34;2020-07-04T15:19:21.083898Z\u0026#34;,\u0026#34;stageTimestamp\u0026#34;:\u0026#34;2020-07-04T15:19:21.083898Z\u0026#34;} {\u0026#34;kind\u0026#34;:\u0026#34;Event\u0026#34;,\u0026#34;apiVersion\u0026#34;:\u0026#34;audit.k8s.io/v1\u0026#34;,\u0026#34;level\u0026#34;:\u0026#34;Metadata\u0026#34;,\u0026#34;auditID\u0026#34;:\u0026#34;caa00b7a-e564-486c-837f-219eade633dd\u0026#34;,\u0026#34;stage\u0026#34;:\u0026#34;ResponseComplete\u0026#34;,\u0026#34;requestURI\u0026#34;:\u0026#34;/apis/coordination.k8s.io/v1/namespaces/kube-system/leases/kube-controller-manager?timeout=10s\u0026#34;,\u0026#34;verb\u0026#34;:\u0026#34;get\u0026#34;,\u0026#34;user\u0026#34;:{\u0026#34;username\u0026#34;:\u0026#34;system:kube-controller-manager\u0026#34;,\u0026#34;groups\u0026#34;:[\u0026#34;system:authenticated\u0026#34;]},\u0026#34;sourceIPs\u0026#34;:[\u0026#34;10.0.2.4\u0026#34;],\u0026#34;userAgent\u0026#34;:\u0026#34;kube-controller-manager/v1.18.5 (linux/amd64) kubernetes/e6503f8/leader-election\u0026#34;,\u0026#34;objectRef\u0026#34;:{\u0026#34;resource\u0026#34;:\u0026#34;leases\u0026#34;,\u0026#34;namespace\u0026#34;:\u0026#34;kube-system\u0026#34;,\u0026#34;name\u0026#34;:\u0026#34;kube-controller-manager\u0026#34;,\u0026#34;apiGroup\u0026#34;:\u0026#34;coordination.k8s.io\u0026#34;,\u0026#34;apiVersion\u0026#34;:\u0026#34;v1\u0026#34;},\u0026#34;responseStatus\u0026#34;:{\u0026#34;metadata\u0026#34;:{},\u0026#34;code\u0026#34;:200},\u0026#34;requestReceivedTimestamp\u0026#34;:\u0026#34;2020-07-04T15:19:21.083898Z\u0026#34;,\u0026#34;stageTimestamp\u0026#34;:\u0026#34;2020-07-04T15:19:21.085030Z\u0026#34;,\u0026#34;annotations\u0026#34;:{\u0026#34;authorization.k8s.io/decision\u0026#34;:\u0026#34;allow\u0026#34;,\u0026#34;authorization.k8s.io/reason\u0026#34;:\u0026#34;RBAC: allowed by ClusterRoleBinding \\\u0026#34;system:kube-controller-manager\\\u0026#34; of ClusterRole \\\u0026#34;system:kube-controller-manager\\\u0026#34; to User \\\u0026#34;system:kube-controller-manager\\\u0026#34;\u0026#34;}} ...   é€™é‚Šæœƒçœ‹åˆ°è¨±å¤šè§¸ç™¼ audit å¾Œè¨˜éŒ„çš„è¨Šæ¯ï¼Œé€™é‚Šéœ€è¦æ³¨æ„çš„åœ°æ–¹æœ‰ requestURI ã€ verb ã€ user ã€ sourceIPs ã€ userAgentã€‚\næˆ‘å…ˆåŸ·è¡Œä¸€å€‹ç°¡å–®çš„ kubectl æŒ‡ä»¤ä¾†è§€å¯Ÿ audit æœ‰æ²’æœ‰æ””æˆªåˆ°é€™å€‹è«‹æ±‚ã€‚\n1  kubectl get pod   å†å»çœ‹ audit æ‰€è¨˜éŒ„çš„ log æœ‰æ²’æœ‰å„²å­˜é€™å€‹æ“ä½œ\ncat /home/ubuntu/audit/log | grep {\u0026quot;kind\u0026quot;:\u0026quot;Event\u0026quot;,\u0026quot;apiVersion\u0026quot;:\u0026quot;audit.k8s.io/v1\u0026quot;,\u0026quot;level\u0026quot;:\u0026quot;Metadata\u0026quot;,\u0026quot;auditID\u0026quot;:\u0026quot;0595bb26-d8a2-4b59-b3d1-7d538c2e131f\u0026quot;,\u0026quot;stage\u0026quot;:\u0026quot;RequestReceived\u0026quot;,\u0026quot;requestURI\u0026quot;:\u0026quot;/api/v1/namespaces/default/pods?limit=500\u0026quot;,\u0026quot;verb\u0026quot;:\u0026quot;list\u0026quot;,\u0026quot;user\u0026quot;:{\u0026quot;username\u0026quot;:\u0026quot;kubernetes-admin\u0026quot;,\u0026quot;groups\u0026quot;:[\u0026quot;system:masters\u0026quot;,\u0026quot;system:authenticated\u0026quot;]},\u0026quot;sourceIPs\u0026quot;:[\u0026quot;10.0.2.4\u0026quot;],\u0026quot;userAgent\u0026quot;:\u0026quot;kubectl/v1.18.5 (linux/amd64) kubernetes/e6503f8\u0026quot;,\u0026quot;objectRef\u0026quot;:{\u0026quot;resource\u0026quot;:\u0026quot;pods\u0026quot;,\u0026quot;namespace\u0026quot;:\u0026quot;default\u0026quot;,\u0026quot;apiVersion\u0026quot;:\u0026quot;v1\u0026quot;},\u0026quot;requestReceivedTimestamp\u0026quot;:\u0026quot;2020-07-04T15:26:20.895927Z\u0026quot;,\u0026quot;stageTimestamp\u0026quot;:\u0026quot;2020-07-04T15:26:20.895927Z\u0026quot;} {\u0026quot;kind\u0026quot;:\u0026quot;Event\u0026quot;,\u0026quot;apiVersion\u0026quot;:\u0026quot;audit.k8s.io/v1\u0026quot;,\u0026quot;level\u0026quot;:\u0026quot;Metadata\u0026quot;,\u0026quot;auditID\u0026quot;:\u0026quot;0595bb26-d8a2-4b59-b3d1-7d538c2e131f\u0026quot;,\u0026quot;stage\u0026quot;:\u0026quot;ResponseComplete\u0026quot;,\u0026quot;requestURI\u0026quot;:\u0026quot;/api/v1/namespaces/default/pods?limit=500\u0026quot;,\u0026quot;verb\u0026quot;:\u0026quot;list\u0026quot;,\u0026quot;user\u0026quot;:{\u0026quot;username\u0026quot;:\u0026quot;kubernetes-admin\u0026quot;,\u0026quot;groups\u0026quot;:[\u0026quot;system:masters\u0026quot;,\u0026quot;system:authenticated\u0026quot;]},\u0026quot;sourceIPs\u0026quot;:[\u0026quot;10.0.2.4\u0026quot;],\u0026quot;userAgent\u0026quot;:\u0026quot;kubectl/v1.18.5 (linux/amd64) kubernetes/e6503f8\u0026quot;,\u0026quot;objectRef\u0026quot;:{\u0026quot;resource\u0026quot;:\u0026quot;pods\u0026quot;,\u0026quot;namespace\u0026quot;:\u0026quot;default\u0026quot;,\u0026quot;apiVersion\u0026quot;:\u0026quot;v1\u0026quot;},\u0026quot;responseStatus\u0026quot;:{\u0026quot;metadata\u0026quot;:{},\u0026quot;code\u0026quot;:200},\u0026quot;requestReceivedTimestamp\u0026quot;:\u0026quot;2020-07-04T15:26:20.895927Z\u0026quot;,\u0026quot;stageTimestamp\u0026quot;:\u0026quot;2020-07-04T15:26:20.897187Z\u0026quot;,\u0026quot;annotations\u0026quot;:{\u0026quot;authorization.k8s.io/decision\u0026quot;:\u0026quot;allow\u0026quot;,\u0026quot;authorization.k8s.io/reason\u0026quot;:\u0026quot;\u0026quot;}} æ•´ç† audit log çš„è³‡è¨Šå¾—åˆ°ä»¥ä¸‹é‡é»\n \u0026ldquo;requestURI\u0026rdquo;:\u0026quot;/api/v1/namespaces/default/pods?limit=500\u0026rdquo; \u0026ldquo;verb\u0026rdquo;:\u0026ldquo;list\u0026rdquo; \u0026ldquo;user\u0026rdquo;:{\u0026ldquo;username\u0026rdquo;:\u0026ldquo;kubernetes-admin\u0026rdquo;,\u0026ldquo;groups\u0026rdquo;:[\u0026ldquo;system:masters\u0026rdquo;,\u0026ldquo;system:authenticated\u0026rdquo;]} \u0026ldquo;sourceIPs\u0026rdquo;:[\u0026ldquo;10.0.2.4\u0026rdquo;] \u0026ldquo;userAgent\u0026rdquo;:\u0026ldquo;kubectl/v1.18.5 (linux/amd64) kubernetes/e6503f8\u0026rdquo;  å¯ä»¥æ¸…æ¥šçœ‹åˆ° kubernetes-admin é€™å€‹ user åŸ·è¡Œäº†é€™å€‹æ“ä½œ ï¼Œæ“ä½œæ˜¯ /api/v1/namespaces/default/pods?limit=500 åŸ·è¡Œçš„å‹•ä½œæ˜¯ list ï¼Œé€™å€‹æ“ä½œæ˜¯ä¾†è‡ª 10.0.2.4 çš„ kubectlã€‚\nçœ‹åˆ°ä»¥ä¸Šé€™äº›é‡é»ä¹‹å¾Œï¼Œå¤§è‡´ä¸Šå¯ä»¥æ¨æ¸¬åˆä½¿ç”¨è€…åœ¨ 10.0.2.4 é€é kubectlåŸ·è¡Œget pod --namespace defaultçš„å‹•ä½œã€‚\nDynamic Backend æ¥è‘—è®“æˆ‘å€‘ä¾†çœ‹çœ‹ Dynamic Backend æ˜¯æ€éº¼ä¸€å›äº‹ï¼Œå¯ä»¥é€šé AuditSink API è¨­å®šç›¸å°æ‡‰çš„ Webhook å°è³‡æ–™é€²è¡Œé è™•ç†å†é€å¾€å…¶ä»–åœ°æ–¹ã€‚\né è¨­çš„ kubernetes ä¸æœƒå¹«ä½ è¨­å®š AuditSink API ï¼Œéœ€è¦æ‰‹å‹•å»é–‹å•Ÿã€‚åœ¨å‰é¢çš„ç« ç¯€å·²ç¶“æœ‰å…ˆé–‹å•Ÿäº†ï¼Œé€™é‚Šæˆ‘å€‘å¯ä»¥å›é ­å»çœ‹ä¸€ä¸‹è¨­å®šäº†å“ªäº›æ±è¥¿ã€‚\n \u0026ndash;audit-dynamic-configuration \u0026ndash;feature-gates=DynamicAuditing=true \u0026ndash;runtime-config=auditregistration.k8s.io/v1alpha1=true  é€™ä¸‰å€‹è¨­å®šåœ¨ /etc/kubernetes/manifests/kube-apiserver.yaml è£¡å¯ä»¥çœ‹åˆ°ï¼Œé‚„æ²’æœ‰ä¿®æ”¹çš„å°å¤¥ä¼´å¯ä»¥ç¾åœ¨åŠ ä¸Šå»ã€‚\nç¢ºå®šå®Œè¨­å®šæª”å¾Œæˆ‘å€‘å¯ä»¥é€é kubectl å»æª¢æŸ¥é€™å€‹è³‡æºæ˜¯ä¸æ˜¯è¢«é–‹å•Ÿã€‚\n1 2  kubectl api-resources | grep AuditSink auditsinks auditregistration.k8s.io false AuditSin   æ¥è‘—æˆ‘å€‘è¦å»éƒ¨ç½²ä¸€å€‹ webhook server è®“ kubernetes audit å¯ä»¥æŠŠè³‡æ–™é€ä¸Šä¾†ï¼Œç”±æ–¼è¦å»ºç«‹ webhook éœ€è¦æ’°å¯« code ä»¥åŠéœ€è¦è¨­å®š CA é€™é‚Šæˆ‘æä¾›å¯¦é©—çš„ repo çµ¦å¤§å®¶è©¦è©¦çœ‹ã€‚\nä½¿ç”¨ä¸Šéå¸¸ç°¡å–®ï¼Œåªè¦é€é kubectl apply -f pod.yml -f service.ymlé€™æ¨£å°±æŠŠ webhook å»ºç«‹å¥½äº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12  k apply -f pod.yml -f service.yml pod/webhook created service/admissionwebhook created ... k get pod,svc NAME READY STATUS RESTARTS AGE pod/webhook 1/1 Running 0 7s NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/admissionwebhook ClusterIP 10.97.173.35 \u0026lt;none\u0026gt; 443/TCP 7s service/kubernetes ClusterIP 10.96.0.1 \u0026lt;none\u0026gt; 443/TCP 2d14h   å»ºç«‹å¥½ webhook pod å¾Œæˆ‘å€‘éœ€è¦å»ºç«‹ AuditSink ç‰©ä»¶è®“ audit äº‹ä»¶æŠŠè³‡æ–™å¾€é€™å€‹ webhook é€ï¼Œ\n1 2  kubectl apply -f auditSink.yml auditsink.auditregistration.k8s.io/mysink created   é€™ä¸€å€‹ auditSink.yml æè¿°äº†ï¼Œé™å®š audit è§¸ç™¼çš„äº‹ä»¶ä»¥åŠè¦å¾€å“ªå€‹åœ°æ–¹é€è³‡æ–™ã€‚\napiVersion: auditregistration.k8s.io/v1alpha1 kind: AuditSink metadata: name: mysink spec: policy: level: Metadata stages: - RequestReceived webhook: clientConfig: service: namespace: default name: admissionwebhook path: /sink port: 443 caBundle: \u0026quot;LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN2RENDQWFRQ0NRRHVXMXNYUVhqUjdEQU5CZ2txaGtpRzl3MEJBUXNGQURBZk1SMHdHd1lEVlFRRERCUkIKWkcxcGMzTnBiMjRnVjJWaWFHOXZheUJEUVRBZ0Z3MHlNREEzTURjd05UQTNOVEJhR0E4ek1ERTVNVEV3T0RBMQpNRGMxTUZvd0h6RWRNQnNHQTFVRUF3d1VRV1J0YVhOemFXOXVJRmRsWW1odmIyc2dRMEV3Z2dFaU1BMEdDU3FHClNJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUUMvWjZ1U1UrNlgrR3htN0NuYXR0RXBvUTN0VjJIb01TNGcKeCtGdEV4Q1Nqb0FjTk5wdHI1cjdTVjVIck1zS09wNDhrZFQ5NVI0YytWZUFnOGlqbVdpSEdQSXFyb1dIRys5cQpibzhoM0FZWk9MeWxQVjBUVWVSb0hQSkRmRmZsV054WlFnRHRXa2p0c2VRUVdsVisyVE5KVXF1cGtBMUMvZTJWCnVEckVkRzZTRFZaWDZMYTdTd3ViOXA4UnVaY21TMURrWlB3bFBmMEt2UVp5UHlMUXl4TVRjeVdJM3ZnNzlENWsKcTJPNFB0N080bm9MM0YzRGRyMHU3aGZwQjlJUUFUelZnTWRvQjNPRmV1NjRTZVRydmdmeG1XK1FZNFA0Z05aRQova21TTnNmaklnT202VnF1eEZHTEpsdUE3WlJoQkdadG1ON1N6dktTb21OZjlhTHJkWERSQWdNQkFBRXdEUVlKCktvWklodmNOQVFFTEJRQURnZ0VCQUtpMDBFRUZBdTFKL1M0ejBpVTVUYlJvOXI1WjRTZk5Ub3ZhS1U4bHA3YTAKaUUwWXRSVUdSMjhkRjRrRE12OXp4dTRCYy82N0ptb3g0SGtZMTFIU0RtOXVUUUs0T1dHMGo5MnIvOGY2RlRZMQpNSk1VNUJ0dy90Ym5hV2ZNWE5Xa0R5TnVhQXA1U3hMV1luODE4OWNqM0Zyd2NIL1VoODl4WFhDQnpzQUNOZGNiClRiN3ZKdnBGdWgyOXpNWUJGNTBPNHNnTi9UMWhNbTk3Y2xBbU9OZ1JoSTQ3cVdDamtlNlJKb2I0MnF6Ri8yK0gKK3k3eWlqQktkU2pQOVJOS3VreXM5VlY4eEN5TlpTSUFGYzM1dldMUDFLUEY1aFVTMWo1c0o2V3JncjdGVDU2ZQpZMC9rdGZkcWpSNXJVbWhzUW9GeHhJMzFHY1hjYktWTFNoRldtS2pMMERvPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==\u0026quot; é€™æ™‚å€™æœ‰è§¸ç™¼ audit çš„äº‹ä»¶å°±æœƒå¾€ webhook serviceé€ï¼Œå¯ä»¥é€é kubectl æŒ‡ä»¤å»ç¢ºèªç›¸é—œ log ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  k log -f webhook ... I0707 05:47:44.205612 1 main.go:34] this event is {TypeMeta:{Kind: APIVersion:} Level:Metadata AuditID:4b6cb6dd-456b-4b77-9e63-90634a6d93eb Stage:RequestReceived RequestURI:/apis/coordination.k8s.io/v1/namespaces/kube-system/leases/kube-controller-manager?timeout=10s Verb:update User:{Username:system:kube-controller-manager UID: Groups:[system:authenticated] Extra:map[]} ImpersonatedUser:nil SourceIPs:[10.0.2.4] UserAgent:kube-controller-manager/v1.18.5 (linux/amd64) kubernetes/e6503f8/leader-election ObjectRef:0xc000335980 ResponseStatus:nil RequestObject:nil ResponseObject:nil RequestReceivedTimestamp:2020-07-07 05:47:42.212444 +0000 UTC StageTimestamp:2020-07-07 05:47:42.212444 +0000 UTC Annotations:map[]} I0707 05:47:44.206093 1 main.go:34] this event is {TypeMeta:{Kind: APIVersion:} Level:Metadata AuditID:3d52b965-d65f-4060-b839-8e5ffe874b7f Stage:RequestReceived RequestURI:/api/v1/persistentvolumeclaims?allowWatchBookmarks=true\u0026amp;resourceVersion=492314\u0026amp;timeout=8m47s\u0026amp;timeoutSeconds=527\u0026amp;watch=true Verb:watch User:{Username:system:kube-scheduler UID: Groups:[system:authenticated] Extra:map[]} ImpersonatedUser:nil SourceIPs:[10.0.2.4] UserAgent:kube-scheduler/v1.18.5 (linux/amd64) kubernetes/e6503f8/scheduler ObjectRef:0xc000335a80 ResponseStatus:nil RequestObject:nil ResponseObject:nil RequestReceivedTimestamp:2020-07-07 05:47:43.363791 +0000 UTC StageTimestamp:2020-07-07 05:47:43.363791 +0000 UTC Annotations:map[]} I0707 05:47:44.206530 1 main.go:34] this event is {TypeMeta:{Kind: APIVersion:} Level:Metadata AuditID:d1a20f9d-0204-43ae-8ab1-82b2c09858ed Stage:RequestReceived RequestURI:/apis/apps/v1/replicasets?allowWatchBookmarks=true\u0026amp;resourceVersion=492314\u0026amp;timeout=5m20s\u0026amp;timeoutSeconds=320\u0026amp;watch=true Verb:watch User:{Username:system:kube-controller-manager UID: Groups:[system:authenticated] Extra:map[]} ImpersonatedUser:nil SourceIPs:[10.0.2.4] UserAgent:kube-controller-manager/v1.18.5 (linux/amd64) kubernetes/e6503f8/shared-informers ObjectRef:0xc000335b80 ResponseStatus:nil RequestObject:nil ResponseObject:nil RequestReceivedTimestamp:2020-07-07 05:47:43.610833 +0000 UTC StageTimestamp:2020-07-07 05:47:43.610833 +0000 UTC Annotations:map[]} I0707 05:47:44.206956 1 main.go:34] this event is {TypeMeta:{Kind: APIVersion:} Level:Metadata AuditID:5d48dc35-f089-4e76-a2f4-098e5628b055 Stage:RequestReceived RequestURI:/api/v1/namespaces/kube-system/endpoints/kube-scheduler?timeout=10s Verb:get User:{Username:system:kube-scheduler UID: Groups:[system:authenticated] Extra:map[]} ImpersonatedUser:nil SourceIPs:[10.0.2.4] UserAgent:kube-scheduler/v1.18.5 (linux/amd64) kubernetes/e6503f8/leader-election ObjectRef:0xc000335c80 ResponseStatus:nil RequestObject:nil ResponseObject:nil RequestReceivedTimestamp:2020-07-07 05:47:44.024424 +0000 UTC StageTimestamp:2020-07-07 05:47:44.024424 +0000 UTC Annotations:map[]} I0707 05:47:44.207483 1 main.go:34] this event is {TypeMeta:{Kind: APIVersion:} Level:Metadata AuditID:e2b5f015-d0e0-48ab-85a8-c9a42121cdfd Stage:RequestReceived RequestURI:/apis/coordination.k8s.io/v1/namespaces/kube-system/leases/kube-scheduler?timeout=10s Verb:get User:{Username:system:kube-scheduler UID: Groups:[system:authenticated] Extra:map[]} ImpersonatedUser:nil SourceIPs:[10.0.2.4] UserAgent:kube-scheduler/v1.18.5 (linux/amd64) kubernetes/e6503f8/leader-election ObjectRef:0xc000335d80 ResponseStatus:nil RequestObject:nil ResponseObject:nil RequestReceivedTimestamp:2020-07-07 05:47:44.026864 +0000 UTC StageTimestamp:2020-07-07 05:47:44.026864 +0000 UTC Annotations:map[]} I0707 05:47:44.207995 1 main.go:34] this event is {TypeMeta:{Kind: APIVersion:} Level:Metadata AuditID:0070ecce-3119-4e44-850d-5914e45dcde6 Stage:RequestReceived RequestURI:/api/v1/namespaces/kube-system/endpoints/kube-scheduler?timeout=10s Verb:update User:{Username:system:kube-scheduler UID: Groups:[system:authenticated] Extra:map[]} ImpersonatedUser:nil SourceIPs:[10.0.2.4] UserAgent:kube-scheduler/v1.18.5 (linux/amd64) kubernetes/e6503f8/leader-election ObjectRef:0xc000335e80 ResponseStatus:nil RequestObject:nil ResponseObject:nil RequestReceivedTimestamp:2020-07-07 05:47:44.028928 +0000 UTC StageTimestamp:2020-07-07 05:47:44.028928 +0000 UTC Annotations:map[]} I0707 05:47:44.208582 1 main.go:34] this event is {TypeMeta:{Kind: APIVersion:} Level:Metadata AuditID:ed450b92-27cc-449d-95cf-c2822fd0e380 Stage:RequestReceived RequestURI:/apis/coordination.k8s.io/v1/namespaces/kube-system/leases/kube-scheduler?timeout=10s Verb:get User:{Username:system:kube-scheduler UID: Groups:[system:authenticated] Extra:map[]} ImpersonatedUser:nil SourceIPs:[10.0.2.4] UserAgent:kube-scheduler/v1.18.5 (linux/amd64) kubernetes/e6503f8/leader-election ObjectRef:0xc000335f80 ResponseStatus:nil RequestObject:nil ResponseObject:nil RequestReceivedTimestamp:2020-07-07 05:47:44.032618 +0000 UTC StageTimestamp:2020-07-07 05:47:44.032618 +0000 UTC Annotations:map[]} I0707 05:47:44.209296 1 main.go:34] this event is {TypeMeta:{Kind: APIVersion:} Level:Metadata AuditID:9deb9b72-4a27-4a36-b6f8-74e976aee3cf Stage:RequestReceived RequestURI:/apis/coordination.k8s.io/v1/namespaces/kube-system/leases/kube-scheduler?timeout=10s Verb:update User:{Username:system:kube-scheduler UID: Groups:[system:authenticated] Extra:map[]} ImpersonatedUser:nil SourceIPs:[10.0.2.4] UserAgent:kube-scheduler/v1.18.5 (linux/amd64) kubernetes/e6503f8/leader-election ObjectRef:0xc000126080 ResponseStatus:nil RequestObject:nil ResponseObject:nil RequestReceivedTimestamp:2020-07-07 05:47:44.034645 +0000 UTC StageTimestamp:2020-07-07 05:47:44.034645 +0000 UTC Annotations:map[]} [GIN] 2020/07/07 - 05:47:44 | 200 | 105.108Âµs | 10.32.0.1 | POST \u0026#34;/sink?timeout=30s\u0026#34; [GIN] 2020/07/07 - 05:47:44 | 200 | 97.207Âµs | 10.32.0.1 | POST \u0026#34;/sink?timeout=30s\u0026#34; [GIN] 2020/07/07 - 05:47:44 | 200 | 150.111Âµs | 10.32.0.1 | POST \u0026#34;/sink?timeout=30s\u0026#34; ...   å¯ä»¥çœ‹åˆ° webhook çš„ log å·²ç¶“æ”¶åˆ°è¨±å¤š audit äº‹ä»¶çš„è³‡æ–™ï¼Œæˆ‘å€‘å¯ä»¥å»ä¿®æ”¹ webhook çš„ç¨‹å¼ç¢¼è®“ webhook æ”¶åˆ°è³‡æ–™å¾Œé€²è¡Œé è™•ç†å¾Œå†å¾€å…¶ä»–åœ°æ–¹ç™¼é€ä¾‹å¦‚ï¼šåšAlert ã€‚\nå¾Œè¨˜ ç›®å‰å¤§å¤šæ•¸çœ‹åˆ°çš„è§£æ±ºæ–¹æ¡ˆæ˜¯ç›´æ¥æ¡ç”¨ Log Backend ï¼ŒæŠŠè³‡æ–™ç›´æ¥è¨˜è¼‰åœ¨ master node ä¸Šå†é€é logstash or fluentd ç›´æ¥æŠŠè³‡æ–™éæ¿¾ä¸¦ä¸”ä¸Ÿåˆ° Elasticsearch ï¼Œå¯ä»¥åˆ©ç”¨ audit ç´€éŒ„ä½¿ç”¨è€…è¡Œç‚ºçœ‹åˆ° cluster å…§ç™¼ç”Ÿä»€éº¼äº‹æƒ…ã€‚\n","description":"","id":12,"section":"posts","tags":["kubernetes"],"title":"kubernetes Audit æŸ¥èµ·ä¾†","uri":"https://blog.jjmengze.website/posts/kubernetes/audit/"},{"content":"  å‰é¢èªªäº†ä¸€äº›åŸºç¤æ¦‚å¿µï¼Œæœ¬ç¯‡æ–‡ç« å°±å¯¦éš›ä¾†å‹•æ‰‹åšåšçœ‹ç”¨ OpenSSL ã€ Nginx åŠ ä¸Š GO é–‹ç™¼ä¸€å€‹ç°¡å–®çš„ TLS ç¯„ä¾‹ã€‚\nå»ºç«‹ CA key ç”±æ–¼æˆ‘å€‘è¦è‡ªå·±ç°½ SSL æ‰€ä»¥éœ€è¦é€é OpenSSL å…ˆå»ºç«‹ä¸€å€‹ CA çš„ç§é‘°ã€‚\n1 2 3 4 5 6 7 8  openssl genrsa -out ca.key 2048 Generating RSA private key, 2048 bit long modulus (2 primes) ........+++++ ......+++++ e is 65537 (0x010001) root@internalTest:/home/ca# ls ca.key   å»ºç«‹ CA CRT å»ºç«‹å®Œ CA çš„ç§é‘°å¾Œï¼Œæˆ‘å€‘é‚„éœ€è¦å»ºç«‹ CA çš„èº«åˆ†è­‰ CA CRT ï¼Œé€™å€‹èº«åˆ†è­‰å°±ä»£è¡¨ CA å…¬é–‹å‡ºå»çš„æ‰€æœ‰äººéƒ½çœ‹å¾—åˆ°ã€‚\n1 2 3 4 5  openssl req -x509 -new -nodes -key ca.key -days 10000 -out ca.crt -subj \u0026#34;/CN=playwithca\u0026#34; root@internalTest:/home/ca# ls ca.key ca.crt   å»ºç«‹ Server Key å»ºç«‹ server çš„ç§é‘° ï¼Œ ç”¨ä¾†çµ¦ nginx server çš„ TLS private keyã€‚\n1 2 3 4 5 6  openssl genrsa -out server.key 2048 Generating RSA private key, 2048 bit long modulus (2 primes) ...................+++++ .............................................................................................+++++ e is 65537 (0x010001)   Server CSR å»ºç«‹ä¸€å€‹ CSR ç”¨ä¾†å‘ CA èªªè«‹å¹«æˆ‘ç°½åï¼Œç°½çš„ Domain æ˜¯ example.com ã€‚\nå¯ä»¥æƒ³åƒä½ å»æˆ¶æ”¿äº‹å‹™æ‰€å¡«å¯«ç”³è«‹èº«åˆ†è­‰çš„è¡¨å–®\n1  openssl req -new -key server.key -out server.csr -subj \u0026#34;/CN=example.com\u0026#34;   Server CRT é€éå‰›å‰›ç”¢å‡ºçš„ CSR çµ¦ CA ç°½åï¼Œé€™é‚Šä¸€èˆ¬ä¾†èªªæ˜¯ç”¨è²·çš„ï¼Œä½ çµ¦ CA å•† CSR ä»–æœƒå¹«ä½ ç°½åå‡ºä¸€å€‹ CRT ï¼Œ é€™å€‹ CRT å°±æ˜¯é€™å€‹ server çš„èº«åˆ†è­‰ã€‚\nå¾ä½ å¡«å¯«è¡¨å–®çš„å…§å®¹æˆ¶æ”¿äº‹å‹™æ‰€ç™¼çµ¦ä½ å°æ‡‰çš„èº«åˆ†è­‰\n1 2 3 4 5 6 7 8 9  openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 365 -out server.crt -days 365 Signature ok subject=CN = example.com Getting CA Private Key root@internalTest:/home/ca# ls ca.crt ca.key ca.srl server.crt server.csr server.key   é€™é‚Šç°¡å–®è¨­å®šä¸€ä¸‹ nginx çš„ SSL ï¼Œè®“ nginx å¯ä»¥ä½¿ç”¨æŒ‡å®šçš„è­‰æ›¸ï¼Œä¸¦ä¸”é–‹å•Ÿ 443 port æä¾›å…¶ä»–äººé€£ç·šã€‚\nnginx config ... server { listen 443 ssl default_server; listen [::]:443 ssl default_server; ssl_certificate /home/ca/server.crt; ssl_certificate_key /home/ca/server.key; } ... è¨­å®šå¥½ nginx åˆ¥å¿˜äº†é‡æ–°è¼‰å…¥ nginx è¨­å®šæª”ï¼ˆé¡Œå¤–è©±æˆ‘è¦ºå¾— nginx graceful reloadåšå¾—æ»¿å¥½çš„ï¼Œæœ‰èˆˆè¶£çš„æœ‹å‹å¯ä»¥å»ç ”ç©¶ä¸€ä¸‹ï¼‰\n1  nginx -s reload   ç”±æ–¼æ˜¯æ¸¬è©¦ç’°å¢ƒæ²’æœ‰å¯¦éš›çš„ domain ï¼Œå°±å…ˆä»¥ä¿®æ”¹ hostname ä½œç‚ºæ›¿ä»£æ–¹æ¡ˆã€‚\n1 2 3 4 5 6 7 8 9  cat /etc/hosts ## # Host Database # # localhost is used to configure the loopback interface # when the system is booting. Do not change this entry. ## 52.163.243.191 example.com ...   ä¿®æ”¹å®Œæˆå¾Œæ¸¬è©¦ä¸€ä¸‹èƒ½ä¸èƒ½é€é https é€£ç·šåˆ° nginx ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  curl -k https://example.com \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Welcome to nginx!\u0026lt;/title\u0026gt; \u0026lt;style\u0026gt; body { width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; } \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; \u0026lt;h1\u0026gt;Welcome to nginx!\u0026lt;/h1\u0026gt; \u0026lt;p\u0026gt;If you see this page, the nginx web server is successfully i ...   å¯ä»¥é †åˆ©é€£ç·šåˆ°ï¼Œé‚£æ¥è‘—å¯ä»¥æ’°å¯«ä¸€å€‹ç°¡å–®çš„ Client å»æ‰“æ‰“çœ‹ Server å›‰ï¼\nSample Client é€™é‚Šæœƒä»¥ä¸€å€‹å–®å‘ TLS èªè­‰ä½œç‚ºç¤ºç¯„ï¼Œå–®å‘ TLS èªè­‰å¤§è‡´ä¸Šçš„å‹•ä½œæ˜¯ï¼Œ Client å‘ Server ç™¼èµ·è«‹æ±‚ã€‚é€™æ™‚å€™ Client æœƒæ‹¿åˆ° Server çš„ è­‰æ›¸( crt ) ï¼ŒClient æœƒæ‹¿è‘—é€™çµ„ Server crt è·Ÿ CA çš„ crt é€²è¡Œé©—è­‰ ï¼Œçœ‹ Server æ˜¯ä¸æ˜¯è¢« CA æˆæ¬Šçš„é‚„æ˜¯å‡å†’çš„ã€‚\nå¦‚æœæ˜¯å‡å†’çš„é‚£éº¼ Client æœƒæ‹’çµ•é€£ç·šï¼Œåä¹‹ Server è‹¥æ˜¯è¢« CA èªè­‰çš„é‚£ Client å°±æœƒç¹¼çºŒå¾€ Server ç™¼è«‹æ±‚ã€‚\nå¯ä»¥æƒ³å¾—ç°¡å–®ä¸€é»ï¼Œä»Šå¤©æ‰€æœ‰äººä¾†å‘ä½ è²·æ±è¥¿ï¼Œçœ‹åˆ°ä½ èº«åˆ†è­‰éƒ½é¦¬ä¸Šæ‹¿å»å•æˆ¶æ”¿äº‹å‹™æ‰€å•é€™å€‹èº«åˆ†è­‰æ˜¯ä¸æ˜¯åˆæ³•çš„å…¬æ°‘ï¼Œå¦‚æœä¸æ˜¯åˆæ³•çš„èº«åˆ†è­‰å°±ä¸é€²è¡Œäº¤æ˜“ã€‚\nä»¥ä¸‹æ˜¯ä¸€å€‹ç”¨ go é–‹ç™¼çš„å–®å‘ TLS è«‹æ±‚çš„ Client ã€‚\n1 2 3 4 5 6 7 8  tree /go/src/dev/ . â”œâ”€â”€ 2.0 â”‚Â â”œâ”€â”€ client.crt â”‚Â â”œâ”€â”€ client.key â”‚Â â””â”€â”€ root-ca.crt â””â”€â”€ main.go   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38  package main import ( \u0026#34;crypto/tls\u0026#34; \u0026#34;crypto/x509\u0026#34; \u0026#34;io\u0026#34; \u0026#34;io/ioutil\u0026#34; \u0026#34;log\u0026#34; \u0026#34;net/http\u0026#34; \u0026#34;os\u0026#34; ) func main() { tr := \u0026amp;http.Transport{ TLSClientConfig: \u0026amp;tls.Config{ RootCAs: loadCA(\u0026#34;/Users/jason/go/src/dev/example-tls/2.0/root-ca.crt\u0026#34;), }, } c := \u0026amp;http.Client{Transport: tr} if resp, e := c.Get(\u0026#34;https://example.com\u0026#34;); e != nil { log.Fatal(\u0026#34;http.Client.Get: \u0026#34;, e) } else { defer resp.Body.Close() io.Copy(os.Stdout, resp.Body) } } func loadCA(caFile string) *x509.CertPool { pool := x509.NewCertPool() if ca, e := ioutil.ReadFile(caFile); e != nil { log.Fatal(\u0026#34;ReadFile: \u0026#34;, e) } else { pool.AppendCertsFromPEM(ca) } return pool }   ä»¥ä¸‹æ˜¯å–®å‘ TLS è«‹æ±‚çš„ Client å‘ Server è«‹æ±‚çš„çµæœã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  go run main.go \u0026lt;!DOCTYPE html\u0026gt; \u0026lt;html\u0026gt; \u0026lt;head\u0026gt; \u0026lt;title\u0026gt;Welcome to nginx!\u0026lt;/title\u0026gt; \u0026lt;style\u0026gt; body { width: 35em; margin: 0 auto; font-family: Tahoma, Verdana, Arial, sans-serif; } \u0026lt;/style\u0026gt; \u0026lt;/head\u0026gt; \u0026lt;body\u0026gt; ...   çµæŸèª é€™ç¯‡æ–‡ç« åˆ†äº«äº†å¦‚ä½•ç”¨ nginx ã€ OpenSSL ä»¥åŠ Go åšä¸€å€‹è‡ªç°½çš„ TLS æœå‹™ï¼Œé›–ç„¶æ˜¯ä¸€å€‹ç°¡å–®çš„ç¯„ä¾‹ä½†æˆ‘å€‘å¯ä»¥å¾ä¸­ç­è§£å–®å‘ TLS ï¼Œ Client åªè¦å‘ CA é©—è­‰ Server çš„èº«ä»½å³å¯ï¼Œé‚£é€™æ¨£å®‰å…¨å—ï¼Ÿé€™å€‹è¨è«–æˆ‘æœƒä¿ç•™åˆ°ä¸‹ä¸€ç« å†ä¾†è·Ÿå¤§å®¶åˆ†äº«ã€‚\n","description":"","id":13,"section":"posts","tags":["ci/cd"],"title":"CA å‹•æ‰‹ç©","uri":"https://blog.jjmengze.website/posts/ca/ca-one-way-ssl/"},{"content":"  å‰é¢æœ‰ä¸€ç¯‡æ–‡ç« ï¼Œåœ¨æè¿° Github Action åš CI/CD çš„å¥½è™•ï¼Œå°æ–¼ Github Action é‚„ä¸å¤ªäº†è§£çš„æœ‹å‹å¯ä»¥åƒè€ƒGithub Action èµ·æ­¥èµ°ç¬¬ä¸€å¼äº†è§£ä¸€ä¸‹æœ€åŸºç¤çš„æ±è¥¿æ€éº¼ç”¨å§ï½\nåœ¨ CI/CD ç¸½æœ‰ä¸€å€‹éšæ®µæœƒéœ€è¦å•Šæˆ‘å€‘æ‡‰æ‡‰ç”¨æœå‹™éƒ¨ç½²åˆ° Server ä¸Šæä¾›å°æ‡‰çš„æœå‹™ï¼Œå°æ–¼åˆæœŸå¿«é€Ÿç™¼å±•çš„å…¬å¸ä¾†èªª Heroku æ˜¯ä¸€å€‹æ»¿å¥½ç”¨çš„å¹³å°ï¼Œå¯ä»¥ç›´æ¥æŠŠ source code push ä¸Šå»ï¼Œ Heroku æœƒæä¾›å…è²»å¸³æˆ¶æ¯å€‹æœˆ 450 å€‹å°æ™‚çš„ï¼Œé–‹é€šä¿¡ç”¨å¡ï¼Œé‚„æœƒé¡å¤–å¢åŠ  550 å€‹å°æ™‚çš„å…è²»æ™‚æ•¸ï¼Œæ­¤å¤– Heroku æœƒå¹«ä½ è¨­å®šç›¸é—œçš„ Url è®“å¤–éƒ¨å¯ä»¥è®€å–ä½ çš„æœå‹™ï¼Œé€™è®“é–‹ç™¼äººå“¡ä¸ç”¨æ“”å¿ƒ infrastructure çš„å•é¡Œï¼Œå¯ä»¥æ›´åŠ å°ˆæ³¨åœ¨ application çš„é–‹ç™¼ã€‚\né€™ç¯‡æ–‡ç« ä¸»è¦æ˜¯ä¸€å€‹å°ç¯„ä¾‹ï¼Œæˆ‘å€‘å¯ä»¥åœ¨ Github Action ä¸­åµŒå…¥ä¸€å€‹ Job è®“æœå‹™éƒ¨ç½²åˆ° Herokuä¸Šï½\nç”³è«‹ Heroku å¸³è™Ÿ é¦–å…ˆæˆ‘å€‘è¦å»ç”³è«‹ Heroku å¸³è™Ÿ ï¼Œé€™é‚Šéå¸¸ç°¡å–®æŠŠä»–æ‰“ç±³å­—è™Ÿçš„æ¬„ä½å¡«ä¸€å¡«å¯«ä¸€å¯«å°±æ²’å•é¡Œäº†ï½\n  å®Œæˆé€™å€‹å®Œæˆé€™å€‹ç”³è«‹å¸³è™Ÿçš„æ­¥é©Ÿä¹‹å¾Œï¼Œæ¥è‘—é–‹ä¸€å€‹ Heroku çš„æ‡‰ç”¨ç¨‹å¼ï¼Œé€éä»‹é¢ä¸Šçš„ New çš„ Create new app å»ºç«‹ä¸€å€‹æ‡‰ç”¨ç¨‹å¼ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯App name åªèƒ½ç”¨å°å¯«çš„è‹±æ–‡ï¼Œè€Œä¸”æ˜¯æ²’æœ‰è¢«ä½¿ç”¨éçš„ï¼ŒåŸºæœ¬ä¸Šé€™æ¨£å°±å®Œæˆäº†è·Ÿåœ¨ Github ä¸Šå»ºç«‹ä¸€å€‹ Repository ä¸€æ¨£ç°¡å–®ã€‚\n  å®‰è£ Heroku CLI å®‰è£ Heroku CLI é€™å€‹éƒ¨åˆ†ä¹Ÿç›¸ç•¶çš„ç°¡å–®å®‰è£éç¨‹å¯ä»¥åƒè€ƒå®˜æ–¹çš„æ•™å­¸ï¼Œæˆ‘é€™é‚Šä»¥ MACOS ä½œç‚ºç¤ºç¯„æœ‰å…¶ä»–ä½œæ¥­ç³»çµ±éœ€æ±‚çš„è«‹éº»ç…©è«‹åƒè€ƒå®˜ç¶²å›‰ï½\nbrew tap heroku/brew \u0026amp;\u0026amp; brew install heroku Updating Homebrew... ==\u0026gt; Auto-updated Homebrew! Updated 3 taps (homebrew/core, homebrew/cask and homebrew/cask-fonts). ... ... ==\u0026gt; Installing dependencies for heroku/brew/heroku: heroku/brew/heroku-node ==\u0026gt; Installing heroku/brew/heroku dependency: heroku/brew/heroku-node ğŸº /usr/local/Cellar/heroku-node/12.16.2: 3 files, 42.2MB, built in 3 seconds ==\u0026gt; Installing heroku/brew/heroku ... æ¸¬è©¦ä¸€ä¸‹ Heroku CLI æ˜¯ä¸æ˜¯å·²ç¶“è£å¥½äº†\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53  heroku CLI to interact with Heroku VERSION heroku/7.41.1 darwin-x64 node-v12.16.2 USAGE $ heroku [COMMAND] COMMANDS access manage user access to apps addons tools and services for developing, extending, and operating your app apps manage apps on Heroku auth check 2fa status authorizations OAuth authorizations autocomplete display autocomplete installation instructions buildpacks scripts used to compile apps certs a topic for the ssl plugin ci run an application test suite on Heroku clients OAuth clients on the platform config environment variables of apps container Use containers to build and deploy Heroku apps domains custom domains for apps drains forward logs to syslog or HTTPS features add/remove app features git manage local git repository for app help display help for heroku keys add/remove account ssh keys labs add/remove experimental features local run Heroku app locally logs display recent log output maintenance enable/disable access to app members manage organization members notifications display notifications orgs manage organizations pg manage postgresql databases pipelines manage pipelines plugins list installed plugins ps Client tools for Heroku Exec psql open a psql shell to the database redis manage heroku redis instances regions list available regions for deployment releases display the releases for an app reviewapps manage reviewapps in pipelines run run a one-off process inside a Heroku dyno sessions OAuth sessions spaces manage heroku private spaces status status of the Heroku platform teams manage teams update update the Heroku CLI webhooks list webhooks on an app   æ¸¬è©¦ Heroku é€™é‚Šä»¥ä¸€å€‹ç°¡å–®çš„ go server ä½œç‚ºç¯„ä¾‹ï¼Œç¨‹å¼ç¢¼å¦‚ä¸‹æ‰€ç¤ºã€‚ç•¶æˆ‘å€‘å°é€™å€‹ server ç™¼èµ·è«‹æ±‚ä»–æœƒå›æ‡‰ä½  ç¾åœ¨ server æ˜¯ä½¿ç”¨å“ªä¸€å€‹ port è·Ÿä½ åšæºé€šã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  package main import ( \u0026#34;net/http\u0026#34; \u0026#34;os\u0026#34; ) func main() { http.HandleFunc(\u0026#34;/\u0026#34;, func(w http.ResponseWriter, r *http.Request) { w.WriteHeader(http.StatusOK) w.Header().Set(\u0026#34;Content-Type\u0026#34;, \u0026#34;text/html; charset=utf-8\u0026#34;) p:=os.Getenv(\u0026#34;PORT\u0026#34;) w.Write([]byte(p)) }) http.ListenAndServe(\u0026#34;0.0.0.0:\u0026#34;+os.Getenv(\u0026#34;PORT\u0026#34;), nil) }   é€é Heroku CLI ç™»å…¥ Heroku ï¼Œé©—è­‰å®Œèº«ä»½å¾Œï¼Œå°±èƒ½å¤ é€é Git æŠŠsource code æ¨åˆ° Heroku ä¸Šå›‰ï½\n1 2 3 4 5 6  heroku login heroku: Press any key to open up the browser to login or q to exit: Opening browser to https://cli-auth.heroku.com/auth/cli/browser/5e83cd9d-51cc-4676-b0be-d240a1f5c480 Logging in... done ...   æ¥è‘—è¨­å®š heroku git æŠŠgit remote url è¨­å®šå¥½\nheroku git:remote -a example-githubaction set git remote heroku to https://git.heroku.com/example-githubaction.git å…ˆçœ‹çœ‹ Heroku æœ‰æ²’æœ‰åŠ åˆ° git remote url\n1 2 3 4 5  git remote -v heroku\thttps://git.heroku.com/example-githubaction.git (fetch) heroku\thttps://git.heroku.com/example-githubaction.git (push) origin\thttps://github.com/jjmengze/heroku-go.git (fetch) origin\thttps://github.com/jjmengze/heroku-go.git (push)   æœ€å¾Œé€égit push æŒ‡ä»¤å°‡source codeä¸Šå‚³åˆ° Heroku\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  git push heroku master Enumerating objects: 10, done. Counting objects: 100% (10/10), done. Delta compression using up to 8 threads Compressing objects: 100% (6/6), done. Writing objects: 100% (10/10), 1.25 KiB | 640.00 KiB/s, done. Total 10 (delta 0), reused 0 (delta 0) remote: Compressing source files... done. remote: Building source: remote: remote: -----\u0026gt; Go app detected ... ... remote: -----\u0026gt; Launching... remote: Released v3 remote: https://example-githubaction.herokuapp.com/ deployed to Heroku remote: remote: Verifying deploy... done. To https://git.heroku.com/example-githubaction.git * [new branch] master -\u0026gt; master   å®Œæˆå¾Œå›åˆ°ä¹‹å‰åœ¨ Heroku ä¸Šå»ºç«‹çš„æ‡‰ç”¨ç¨‹å¼ï¼Œä¸¦ä¸”åœ¨ä¸Šæ–¹çš„é¸é …é»é¸ Settings\n  æœ€ä¸‹æ–¹ Heroku æœƒå‘Šè¨´ä½ é€™å€‹æ‡‰ç”¨ç¨‹å¼çš„ Domain ï¼Œä¸€èˆ¬ä¾†èªªæœƒæ˜¯ https://\u0026lt;appname\u0026gt;.herokuapp.com/ï¼Œæ‰€ä»¥ä»¥æœ¬ç¯‡çš„ä¾‹å­æœƒæ˜¯ https://example-githubaction.herokuapp.com/ ã€‚åˆ°é é¢ä¸‹æ–¹æª¢æŸ¥ä¸€ä¸‹ Domainæ˜¯ä¸æ˜¯é€™å€‹ï½\n  å¯ä»¥è«‹æ±‚ä¸€ä¸‹é€™å€‹ domain çœ‹çœ‹å¾—åˆ°çš„çµæœæ˜¯ä»€éº¼\n1 2  curl https://example-githubaction.herokuapp.com/ 59048   è¡¨ç¤ºç›®å‰ server æ˜¯ç”¨ 59048 çš„ port è·Ÿä½ é€²è¡Œæºé€šï¼Œé€™é‚Šæˆ‘å°±æƒ³åˆ°å£å£çš„äº‹æƒ…æƒ¹ï¼Œé‚£æˆ‘èƒ½ä¸èƒ½ç”¨ Heroku æä¾›çš„æœå‹™ åœ¨è£¡é¢å•Ÿç”¨ä¸€å€‹ sshd ï¼Œå¦é¡ VM çš„æ¦‚å¿µxD (ä¸éé‚£åˆæ˜¯å¦å¤–ä¸€å€‹æ•…äº‹äº†)\næ”¹åˆ° Github Action æ—¢ç„¶ç´”æ‰‹å‹• ( manually setup ) å¯ä»¥å®Œæˆï¼Œé‚£æˆ‘ç›¸ä¿¡é€é CI/CD è‡ªå‹•åŒ–æ©Ÿåˆ¶ä¹Ÿå¯ä»¥å®Œæˆï¼\né€™é‚Šå¯ä»¥åˆ° Github Marketplace å»æ‰¾æ‰¾æœ‰æ²’æœ‰äººåšç›¸é—œçš„ Action ï¼Œå¥½çš„å·¥ç¨‹å¸«ç¬¬ä¸€æ­¥è¦å­¸æœƒæ€éº¼æ‰¾è³‡æ–™ xD\né€™é‚Šå¯ä»¥çœ‹åˆ°æœ‰ä¸å°‘ Action éƒ½æœ‰åœ¨åš HeroKu ç›¸é—œçš„éƒ¨ç½²ï¼Œå¯ä»¥åƒè€ƒäººå®¶æ€éº¼å¯¦ä½œåœ¨è©¦è©¦çœ‹èƒ½ä¸èƒ½ç”¨æ›´ç°¡å–®çš„æ–¹æ³•åšä¸€å€‹å‡ºä¾†ã€‚\n  é€™é‚Šæˆ‘ç›´æ¥çµ¦å‡ºä¸€å€‹æ–¹æ¡ˆæ‰€æœ‰ç¨‹å¼ç¢¼èˆ‡å…§å®¹å¯ä»¥åƒè€ƒæˆ‘åœ¨ Github çš„ç¯„ä¾‹å°ˆæ¡ˆï¼Œæœ‰èˆˆè¶£çš„å¯ä»¥è©¦è©¦çœ‹ï¼ŒåŸºæœ¬ä¸Šçš„æ€è·¯æ˜¯é€é Heroku æä¾›çš„ container æœå‹™ç›´æ¥æŠŠ source code åŒ…æˆ container ä¸¦ä¸”ä¸Šå‚³åˆ° heroku image registry ä¸Šï¼Œç›¸é—œçš„éƒ¨ç½²ä»¥åŠè©³ç´°å‹•ä½œå¯ä»¥åƒè€ƒå®˜æ–¹çš„ç¯„ä¾‹\né€™é‚Šæˆ‘ç›´æ¥ä¸Šgithub action æ•´åˆHeroku container image å¾Œçš„ ci yamlçµ¦å¤§å®¶åƒè€ƒï¼Œå¤§å®¶ä¹Ÿå¯ä»¥ä¾ç…§å€‹åšè®ŠåŒ–åšæˆè‡ªå·±æƒ³è¦çš„æ¨£å­ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  push:name:Pushruns-on:ubuntu-lateststeps:- name:CheckoutcodeintotheGomoduledirectoryuses:actions/checkout@v2- name:LogintoHerokuContainerregistryenv:HEROKU_API_KEY:${{secrets.HEROKU_API_KEY}}run:herokucontainer:login- name:Buildandpushenv:HEROKU_API_KEY:${{secrets.HEROKU_API_KEY}}run:herokucontainer:push-a${{env.APP_NAME}}web- name:Releaseenv:HEROKU_API_KEY:${{secrets.HEROKU_API_KEY}}run:herokucontainer:release-a${{env.APP_NAME}}web  å…¶ä¸­å¯ä»¥çœ‹åˆ° push é€™å€‹ stage åŸ·è¡Œäº†å››å€‹ steps ï¼Œæ¯”è¼ƒè¦é—œæ³¨çš„æ˜¯å¾Œé¢é‚£ä¸‰å€‹ã€‚åˆ†åˆ¥æ˜¯åŸ·è¡Œ\n heroku container:login heroku container:push -a ${{ env.APP_NAME }} web heroku container:release -a ${{ env.APP_NAME }} web  é€™ä¸‰éƒ¨åˆ†åˆ¥å°æ‡‰çš„æ˜¯\n ç™»å…¥ heroku æ§‹å»º Container image ä¸¦å°‡å…¶æ¨é€åˆ° Heroku Container Registry å°‡ Heroku Container Registry ä¸Šçš„ Container image é€²è¡Œéƒ¨ç½²èˆ‡ç™¼ä½ˆ  HEROKU_API_KEY ä»¥åŠ APP_NAME éƒ½å¯ä»¥åœ¨ Github çš„ CI/CD æœå‹™ç›´æ¥åšç’°å¢ƒè®Šæ•¸çš„ç·¨è¼¯ï¼Œé€éé€™ä¸€ç¨®æ–¹å¼æˆ‘å€‘å¯ä»¥å¾ˆç°¡å–®çš„æŠŠæœå‹™éƒ¨ç½²åˆ°Herokuä¸Šé¢ã€‚é–‹ç™¼äººå“¡å¯ä»¥å¿«é€Ÿçš„éƒ¨ç½²èˆ‡æ¸¬è©¦è‡ªå·±çš„æœå‹™ï½ CI/CD å¸¶ä¾†çš„å¥½è™•å¤šå¤šï¼Œå¸Œæœ›å¤§å®¶å¯ä»¥å¤šå¤šå˜—è©¦ã€‚\nçµæŸèª ä»Šå¤©éå¸¸ç°¡å–®çš„ä»‹ç´¹äº† Heroku èˆ‡ Github Action çš„æ•´åˆçš„åŠŸèƒ½ï¼Œä»¥åŠæ€éº¼å¿«é€Ÿå¾—ä½¿ç”¨ Heroku çµ¦å¤–éƒ¨åšå­˜å–ï¼Œä¸‹æ¬¡æœ‰æ©Ÿæœƒå†ä¾†ä»‹ç´¹ä»–è·Ÿdockeræ€éº¼æ•´åˆä»¥åŠæ€éº¼æ’°å¯«è‡ªå·±çš„ action è²¢ç»çµ¦ Github Action Marketplace è®“å¤§å®¶ä¾†ä½¿ç”¨ã€‚\n","description":"","id":14,"section":"posts","tags":null,"title":"Github Action å¦³å„ä½ï¼Œæ³¨æ„ Heroku ï¼","uri":"https://blog.jjmengze.website/posts/cicd/github/github-action-2/"},{"content":"  è¨˜éŒ„ä¸€ä¸‹ä¹‹å‰åœ¨å·¥ä½œä¸Šé‡åˆ°çš„ Gitlab domain æ²’æœ‰ç°½æ†‘è­‰ï¼Œä½†æ˜¯å¤–éƒ¨æœå‹™(Azure Kubernetes Service)åˆéœ€è¦å­˜å– Gitlab Container Registry æœƒé‡åˆ°çš„å•é¡Œã€‚\nç™¼ç”Ÿäº†ä»€éº¼ï¼Ÿ   Gitlab çš„ domain æ²’æœ‰è²· SSL ï¼ˆç”±æ–¼æ”¿ç­–å•é¡Œä¹Ÿä¸èƒ½ç”¨ letsencrypt)\n  Kubernetes æ‹‰å– Gitlab Container Registry éœ€è¦å¸³å¯†\n  Kubernetes æ‹‰å– Gitlab Container Registry æ†‘è­‰ä¸è¢«ä¿¡ä»»\n  æª¢è¦–å„é …å•é¡Œ Gitlab domain æ²’æœ‰ssl   å¦‚æœæˆ‘å€‘åœ¨ host ä¸Šé€é docker æ‹‰å–è©² Container Registry çš„ image å¯èƒ½æœƒå‡ºç¾çš„ç‹€æ³ã€‚\nå…ˆçœ‹ä¸€ä¸‹æˆ‘ä½¿ç”¨çš„ docker æ¸¬è©¦ç’°å¢ƒ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28  $docker version Client: Version: 19.03.6 API version: 1.40 Go version: go1.12.17 Git commit: 369ce74a3c Built: Fri Feb 28 23:45:43 2020 OS/Arch: linux/amd64 Experimental: false Server: Engine: Version: 19.03.6 API version: 1.40 (minimum version 1.12) Go version: go1.12.17 Git commit: 369ce74a3c Built: Wed Feb 19 01:06:16 2020 OS/Arch: linux/amd64 Experimental: false containerd: Version: 1.3.3-0ubuntu1~18.04.2 GitCommit: runc: Version: spec: 1.0.1-dev GitCommit: docker-init: Version: 0.18.0 GitCommit:   æ¥è‘—æˆ‘é€é Docker CLI å»æ‹‰ Gitlab Container Registry ä¸Šçš„ private imageï¼Œç”±æ–¼\u0026hellip;ä¸€äº›å…¬å¸æ”¿ç­–å•é¡Œæˆ‘æŠŠå…¬å¸çš„ä½ç½®æ›¿æ›æ‰äº†è«‹è¦‹è«’ã€‚\n1 2  $docker pull registry-gitlab.com.tw/repo/image-cli:v4.4.0 Error response from daemon: Get registry-gitlab.com.tw/v2/: x509: certificate is not authorized to sign other certificates   ç›´æ¥åƒå–æœƒå‡ºç¾ x509: certificate is not authorized to sign other certificatesï¼Œé€™å€‹éƒ¨åˆ†éå¸¸å®¹æ˜“è§£æ±º Google ä¸€ä¸‹å°±å¯ä»¥å¾ˆå¿«çš„æ‹¿åˆ°è§£ï¼Œåªè¦docker login ä¸€ä¸‹å°±æ²’å•é¡Œäº†ã€‚\nåœ¨é‚£ä¹‹å‰æˆ‘å€‘å…ˆä¾†çœ‹ä¸€ä¸‹ç›¸é—œçš„ docker è¨­å®šæª”\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48  $cat /lib/systemd/system/docker.service [Unit] Description=Docker Application Container Engine Documentation=https://docs.docker.com BindsTo=containerd.service After=network-online.target firewalld.service containerd.service Wants=network-online.target Requires=docker.socket [Service] Type=notify # the default is not to use systemd for cgroups because the delegate issues still # exists and systemd currently does not support the cgroup feature set required # for containers run by docker ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock ExecReload=/bin/kill -s HUP $MAINPID TimeoutSec=0 RestartSec=2 Restart=always # Note that StartLimit* options were moved from \u0026#34;Service\u0026#34; to \u0026#34;Unit\u0026#34; in systemd 229. # Both the old, and new location are accepted by systemd 229 and up, so using the old location # to make them work for either version of systemd. StartLimitBurst=3 # Note that StartLimitInterval was renamed to StartLimitIntervalSec in systemd 230. # Both the old, and new name are accepted by systemd 230 and up, so using the old name to make # this option work for either version of systemd. StartLimitInterval=60s # Having non-zero Limit*s causes performance problems due to accounting overhead # in the kernel. We recommend using cgroups to do container-local accounting. LimitNOFILE=infinity LimitNPROC=infinity LimitCORE=infinity # Comment TasksMax if your systemd version does not support it. # Only systemd 226 and above support this option. TasksMax=infinity # set delegate yes so that systemd does not reset the cgroups of docker containers Delegate=yes # kill only the docker process, not all processes in the cgroup KillMode=process [Install] WantedBy=multi-user.target   ä¸Šé¢å¯ä»¥çœ‹åˆ° Docker systemD çš„ç›¸é—œè¨­å®š ï¼Œçœ‹èµ·ä¾†éƒ½ç›¸ç•¶çš„ç°¡å–®è€Œä¸”æ²’æœ‰ä»»ä½•ç¹é insecure çš„é¸é …ã€‚\nä¹ŸåŒæ™‚åœ¨ /etc åº•ä¸‹çœ‹çœ‹ Docker çš„è¨­å®š\n1 2  $ls /etc/docker/ key.json   é€™é‚Šæˆ‘å€‘å¯ä»¥çœ‹åˆ° Docker å®Œå…¨æ²’æœ‰è¨­å®šä»»ä½•ç¹é insecure çš„é¸é …å¾Œï¼Œä½¿ç”¨docker login å¾Œå†çœ‹çœ‹æœ‰æ²’æœ‰ä»»ä½•çš„æ”¹è®Šã€‚\n1 2 3 4  docker login registry-gitlab.com.tw Username (test): Password: Error response from daemon: Get https://registry-gitlab.com.tw/v2/: x509: certificate is not authorized to sign other certificates   é€™æ™‚å€™æˆ‘å€‘åˆè§€å¯Ÿåˆ°æ–°çš„å•é¡Œäº†ï¼Œåœ¨ login çš„æ™‚å€™ç™¼ç¾æˆ‘å€‘çš„Gitlab Registry çš„æ†‘è­‰æœ‰å•é¡Œï¼Œåœ¨ç¹¼çºŒ Google æœƒçœ‹åˆ°åŸä¾†è¦æŠŠæ†‘è­‰æœ‰å•é¡Œçš„ domain è¨­å®šåˆ° /etc/docker/daemon.json ä¸‹é¢ï¼Œé€™é‚Šæˆ‘å¾ˆå¿«çš„è¨­å®šèµ·ä¾†ï¼Œä¸¦ä¸”é‡å•Ÿdockerdã€‚\n1 2 3 4 5  cat \u0026lt;\u0026lt;EOF | \u0026gt;\u0026gt; /etc/docker/daemon.json { \u0026#34;insecure-registries\u0026#34;:[\u0026#34;registry-gitlab.com.tw\u0026#34;] } systemctl restart docker   æ¥è‘—å†å˜—è©¦é€édocker login ç™»å…¥ä¸¦ä¸”æ‹‰å– Gitlab container registry çš„ imageã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  $docker login registry-gitlab.com.tw Username (test): Password: WARNING! Your password will be stored unencrypted in /root/.docker/config.json. Configure a credential helper to remove this warning. See https://docs.docker.com/engine/reference/commandline/login/#credentials-store Login Succeeded $docker pull registry-gitlab.com.tw/repo/image-cli:v4.4.0 v4.4.0: Pulling from registry-gitlab.com.tw/repo/image-cli:v4.4.0 23302e52b49d: Pulling fs layer cf5693de4d3c: Download complete 0bdf97977791: Downloading [=\u0026gt; ] 110.1kB/3.493MB 8b8c7ad8f3fb: Waiting 40eb930bd6b2: Waiting   åˆ°é€™é‚Šæˆ‘å€‘çµ‚æ–¼è§£æ±ºåœ¨ docker æ‹‰å–æ²’æœ‰ SSL Container registry ä¸Šçš„ private image äº†ï¼Œæ¥è‘—æˆ‘å€‘è¦ä¾†çœ‹åœ¨å…¬æœ‰é›²(Azure Kubernetes Service)ä¸Šå‡ºäº†ä»€éº¼å•é¡Œã€‚\nKubernetes pull image og Gitlab Container Registry æ¥è‘—ä¾†çœ‹çœ‹åœ¨å…¬æœ‰é›²ç’°å¢ƒä¸­( Azure Kubernetes Service , AKS )æœƒå‡ºç¾çš„å•é¡Œï¼Œæˆ‘åœ¨ AKS éƒ¨ç½²ä¸€å€‹ä¸‰å€‹ç¯€é»çš„ç’°å¢ƒï¼ŒKubernetes ç‰ˆæœ¬ç‚º 1.15.11ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21  bash-5.0# kubectl get node NAME STATUS ROLES AGE VERSION aks-agentpool-20139558-vmss000000 Ready agent 11m v1.15.11 aks-agentpool-20139558-vmss000001 Ready agent 11m v1.15.11 aks-agentpool-20139558-vmss000002 Ready agent 11m v1.15.11 bash-5.0# kubectl get pod --all-namespaces NAMESPACE NAME READY STATUS RESTARTS AGE kube-system coredns-698c77c5d7-69rch 1/1 Running 0 11m kube-system coredns-698c77c5d7-vsrzb 1/1 Running 0 14m kube-system coredns-autoscaler-5bd7c6759b-jx9dt 1/1 Running 0 14m kube-system kube-proxy-46phd 1/1 Running 0 11m kube-system kube-proxy-fgb6f 1/1 Running 0 11m kube-system kube-proxy-gxck8 1/1 Running 0 11m kube-system kubernetes-dashboard-74d8c675bc-j25fz 1/1 Running 0 14m kube-system metrics-server-7d654ddc8b-bljdd 1/1 Running 0 14m kube-system omsagent-rs-c45c944df-5crtb 1/1 Running 0 14m kube-system omsagent-w5b8l 1/1 Running 1 11m kube-system omsagent-xfndn 1/1 Running 1 11m kube-system omsagent-xhnbv 1/1 Running 0 11m kube-system tunnelfront-98c8b5dc6-b56d5 1/1 Running 0 14m   åœ¨AKSçš„ç’°å¢ƒä¸Šæˆ‘ç›´æ¥é€ékubectl CLI å»ºç«‹ä¸€å€‹éå¸¸ç°¡å–®çš„Deployment Resourceï¼Œæ¸¬è©¦æ‹‰å– Container registry ä¸Šçš„ private image æœƒæœ‰ä»€éº¼å•é¡Œã€‚\n1  bash-5.0# kubectl run -ti --rm test --image registry-gitlab.com.tw/repo/image-cli:v4.4.0 bash   æ¥è‘—è§€å¯Ÿ pod æ˜¯å¦æœ‰æˆåŠŸè¢«å»ºç«‹èµ·èµ·ä¾†ã€‚\n1 2 3  bash-5.0# kubectl get pod NAME READY STATUS RESTARTS AGE test 0/1 ErrImagePull 0 12s   å¯ä»¥çœ‹åˆ° pod å‡ºç¾ ErrImagePull çš„ status æ­¤æ™‚ï¼Œéœ€è¦æ›´é€²æ­¥ä¸€åˆ†æå‡ºç¾ErrImagePullçš„åŸå› ã€‚\n1 2 3 4 5 6 7 8  bash-5.0# kubectl describe pod test ... Normal BackOff 16s (x3 over 45s) kubelet, aks-agentpool-20139558-vmss000000 Back-off pulling image \u0026#34;registry-gitlab.com.tw/repo/image-cli:v4.4.0\u0026#34; Warning Failed 16s (x3 over 45s) kubelet, aks-agentpool-20139558-vmss000000 Error: ImagePullBackOff Normal Pulling 4s (x3 over 46s) kubelet, aks-agentpool-20139558-vmss000000 Pulling image \u0026#34;registry-gitlab.com.tw/repo/image-cli:v4.4.0\u0026#34; Warning Failed 4s (x3 over 45s) kubelet, aks-agentpool-20139558-vmss000000 Failed to pull image \u0026#34;registry-gitlab.com.tw/repo/image-cli:v4.4.0\u0026#34;: rpc error: code = Unknown desc = Error response from daemon: Get https://registry-gitlab.com.tw/v2/: x509: certificate is not authorized to sign other certificates Warning Failed 4s (x3 over 45s) kubelet, aks-agentpool-20139558-vmss000000 Error: ErrImagePull   é€™é‚Šå¯ä»¥è§€å¯Ÿåˆ°å•é¡Œ\nPulling image \u0026ldquo;registry-gitlab.com.tw/repo/image-cli:v4.4.0\u0026rdquo; æ™‚ç™¼ç”Ÿ\nx509: certificate is not authorized to sign other certificates\nGoogle å¯ä»¥æœå°‹åˆ°å¾ˆå¤š Kubernetes pull private çš„è§£æ±ºæ–¹æ³•ï¼Œé€™é‚Šç›´æ¥ä½¿ç”¨çœ‹çœ‹é‚„æœƒé‡åˆ°ä»€éº¼å•é¡Œã€‚å¤§è‡´ä¸Šå°±æ˜¯è¨­å®š kubernetes çš„æŸå€‹ namespace å¦‚æœè¦æ‹‰æŸä¸€å€‹ä½ç½®ä¸Šçš„ private image å¯ä»¥é€éé€™ä¸€å€‹ä½¿ç”¨è€…å¸³å¯†å»åŸ·è¡Œã€‚\nkubectl create secret docker-registry gitlab-registry \\ --docker-username=jason \\ --docker-password=RmgmeG4K-1oD4j3XW5A- \\ --docker-email=jason@hello.com.tw \\ --docker-server=registry-gitlab.com.tw secret/gitlab-registry created é€™ä¸€æ­¥åšå®Œæˆ‘å€‘å¯ä»¥å†ä¾†çœ‹çœ‹æ˜¯ä¸æ˜¯å¯ä»¥æˆåŠŸpullåˆ°imageï¼Œæˆ‘å€‘å…ˆæŠŠåŸæœ¬çš„ pod delete å†é‡æ–° åŸ·è¡Œä¸€å€‹ã€‚\n1 2 3 4 5  bash-5.0# kubectl delete pod test pod \u0026#34;test\u0026#34; deleted kubectl run -ti --rm test --image registry-gitlab.com.tw/repo/image-cli:v4.4.0 bash ...   é€™æ™‚å€™æŒçºŒè§€å¯Ÿ pod çš„ç‹€æ…‹æ˜¯ä¸æ˜¯running\n1 2 3  bash-5.0# kubectl get pod NAME READY STATUS RESTARTS AGE test 0/1 ErrImagePull 0 12s   ä»€éº¼ç«Ÿç„¶é‚„ä¸æ˜¯ running é‚£æˆ‘å€‘ç¹¼çºŒé †è—¤æ‘¸ç“œçœ‹çœ‹ pod åˆ°åº•éŒ¯äº†ä»€éº¼ã€‚\n1 2 3 4 5 6 7 8  bash-5.0# kubectl describe pod test ... Normal BackOff 16s (x3 over 45s) kubelet, aks-agentpool-20139558-vmss000000 Back-off pulling image \u0026#34;registry-gitlab.com.tw/repo/image-cli:v4.4.0\u0026#34; Warning Failed 16s (x3 over 45s) kubelet, aks-agentpool-20139558-vmss000000 Error: ImagePullBackOff Normal Pulling 4s (x3 over 46s) kubelet, aks-agentpool-20139558-vmss000000 Pulling image \u0026#34;registry-gitlab.com.tw/repo/image-cli:v4.4.0\u0026#34; Warning Failed 4s (x3 over 45s) kubelet, aks-agentpool-20139558-vmss000000 Failed to pull image \u0026#34;registry-gitlab.com.tw/repo/image-cli:v4.4.0\u0026#34;: rpc error: code = Unknown desc = Error response from daemon: Get https://registry-gitlab.com.tw/v2/: x509: certificate is not authorized to sign other certificates Warning Failed 4s (x3 over 45s) kubelet, aks-agentpool-20139558-vmss000000 Error: ErrImagePull   æ€éº¼é‚„æ˜¯æ¨£çš„éŒ¯ï¼Œé€™æ™‚å€™ä¸å¾—ä¸å»çœ‹çœ‹ pod çš„ spec åˆ°åº•å®šç¾©äº†ä»€éº¼æœ‰æ²’æœ‰ä½¿ç”¨æˆ‘å€‘æŒ‡å®šçš„ image pull secret ã€‚\n1 2 3 4 5 6 7 8 9 10 11  bash-5.0# kubectl get pod test -o yaml ... name: default-token-wvgsq readOnly: true dnsPolicy: ClusterFirst enableServiceLinks: true nodeName: aks-agentpool-20139558-vmss000000 nodeSelector: node-role.kubernetes.io/agent: \u0026#34;\u0026#34; priority: 0 ...   æ€éº¼æ²’æœ‰ image pull secret å‘¢\u0026hellip;ï¼Œæ‰¾äº†ä¸€ä¸‹æ–‡ä»¶ pod å†å•Ÿå‹•æ™‚éƒ½æœƒå»ç”¨ default service account çš„ä¸€äº›è¨­å®šã€‚\nref:https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#add-imagepullsecrets-to-a-service-account\né€™é‚Šå°±å·æ‡¶è®“ default namesapce éƒ½ç”¨åŒä¸€å€‹ image pull secret å§ xDD\nkubectl patch serviceaccount default -p '{\u0026quot;imagePullSecrets\u0026quot;: [{\u0026quot;name\u0026quot;: \u0026quot;gitlab-registry\u0026quot;}]}' é€™é‚Šå†æŠŠ Pod åˆªæ‰å†é‡æ–°æ¸¬è©¦ä¸€æ¬¡çœ‹çœ‹ image èƒ½ä¸èƒ½æ­£ç¢ºçš„æ‹‰å–åˆ°ã€‚\n1 2 3 4 5  bash-5.0# kubectl delete pod test pod \u0026#34;test\u0026#34; deleted kubectl run -ti --rm test --image registry-gitlab.com.tw/repo/image-cli:v4.4.0 bash ...   é€™æ™‚å€™æŒçºŒè§€å¯Ÿ pod çš„ç‹€æ…‹æ˜¯ä¸æ˜¯running\n1 2 3  bash-5.0# kubectl get pod NAME READY STATUS RESTARTS AGE test 0/1 ErrImagePull 0 12s   é‚„æ˜¯ä¸è¡Œå•Šï¼Œç¹¼çºŒé€ékubectl CLI æ‰¾å°‹éŒ¯èª¤çš„åŸå› ã€‚\nbash-5.0# kubectl describe pod test ... Normal BackOff 21s kubelet, aks-agentpool-20139558-vmss000002 Back-off pulling image \u0026quot;registry-gitlab.com.tw/repo/image-cli:v4.4.0\u0026quot; Warning Failed 21s kubelet, aks-agentpool-20139558-vmss000002 Error: ImagePullBackOff Normal Pulling 10s (x2 over 23s) kubelet, aks-agentpool-20139558-vmss000002 Pulling image \u0026quot;registry-gitlab.com.tw/repo/image-cli:v4.4.0\u0026quot; Warning Failed 10s (x2 over 22s) kubelet, aks-agentpool-20139558-vmss000002 Failed to pull image \u0026quot;registry-gitlab.com.tw/repo/image-cli:v4.4.0\u0026quot;: rpc error: code = Unknown desc = Error response from daemon: Get https://registry-gitlab.com.tw/v2/: x509: certificate is not authorized to sign other certificates Warning Failed 10s (x2 over 22s) kubelet, aks-agentpool-20139558-vmss000002 Error: ErrImagePull é€™æ¬¡çœ‹åˆ°ä¸€æ¨£çš„éŒ¯èª¤è³‡è¨Šï¼Œé€™æ™‚å€™æƒ³åˆ° unssl çš„ image registry ä¸æ˜¯è¦å»è¨­å®š docker/daemon.json ï¼Œé€™æ¨£ docker å»æ‹‰ image çš„æ™‚å€™æ‰ä¸æœƒèªè­‰ä»–çš„æ†‘è­‰ã€‚\nå› ç‚ºåœ¨å…¬æœ‰é›²(Azure Kubernetes Server,AKS)ä¸Šç¢°ä¸åˆ°é€™å¹¾å°worker ä¸»æ©Ÿï¼Œåªå¥½ç”¨å¥‡é–€éç”²çš„æ–¹å¼ mount ä»–çš„ filesystem äº†ã€‚\né€™é‚Šæˆ‘è§£æ±ºçš„æ–¹æ³•é€é daemonset è®“ pod éƒ¨ç½²åˆ°æ‰€æœ‰çš„ node ä¸Šï¼Œè©² pod æŠŠ host çš„ /etc mount å‡ºä¾†ã€‚è®“æˆ‘å¯ä»¥è§€å¯ŸAKS host docker çš„ configã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  apiVersion:apps/v1kind:DaemonSetmetadata:name:registry-canamespace:kube-systemlabels:k8s-app:config-dockerspec:selector:matchLabels:name:config-dockertemplate:metadata:labels:name:config-dockerspec:containers:- name:config-dockerimage:nginx:1.18command:[\u0026#39;sh\u0026#39;]args:[\u0026#39;-c\u0026#39;,\u0026#39;tail -f /dev/null\u0026#39;]volumeMounts:- name:etc-dockermountPath:/etc/dockersecurityContext:privileged:trueterminationGracePeriodSeconds:30hostPID:truevolumes:- name:etc-dockerhostPath:path:/etc/docker  é€™é‚Šçœ¼å°–å¾—è§€çœ¾å¯èƒ½æœƒç™¼ç¾ç‚ºä»€éº¼æˆ‘ç”¨äº†ï¼ŒsecurityContextä»¥åŠhostPIDé€™é‚Šå¾ŒçºŒæœƒè¬›ç‚ºä»€éº¼æˆ‘è¦é€™æ¨£åšã€‚\nå¥½çš„å»¢è©±ä¸å¤šèªªï¼Œéƒ¨ç½²å®Œé€™å€‹ daemset å¾Œç›´æ¥é€²å…¥ pod è£¡é¢çœ‹ä»–çš„è¨­å®šã€‚\nroot@registry-ca-rdzbv:/# cat /etc/docker/daemon.json { \u0026quot;live-restore\u0026quot;: true, \u0026quot;log-driver\u0026quot;: \u0026quot;json-file\u0026quot;, \u0026quot;log-opts\u0026quot;: { \u0026quot;max-size\u0026quot;: \u0026quot;50m\u0026quot;, \u0026quot;max-file\u0026quot;: \u0026quot;5\u0026quot; } } ç™¼ç¾ï¼ä»–ç«Ÿç„¶æ²’æœ‰è¨­å®š insecure-registries é€™é‚Šæˆ‘åªå¥½æ‰‹å‹•å¹«ä»–åšè¨­å®šï¼Œè¨­å®šå®Œå¾Œç›´æ¥é€çµ¦ host pid reload dockerdã€‚é€™é‚Šä½ æœƒå¥½å¥‡èªªç‚ºä»€éº¼å¯å‹•åˆ° host ä¸Šçš„ pid ï¼Œå› ç‚ºä¸Šé¢çš„ yaml æœ‰è¨­å®š securityContext ä»¥åŠ hostPID ï¼Œæ‰€ä»¥ container å¯ä»¥ç›´çš†ç¢°åˆ° host çš„ process ä¸¦ä¸”å¯ä»¥ä¸‹ä¸€äº›éœ€è¦ security çš„æŒ‡ä»¤ã€‚\n1 2 3  root@registry-ca-rdzbv:/#pidof dockerd 3322 root@registry-ca-rdzbv:/#kill -1 3322   é€™é‚Šå®Œæˆå¾Œï¼Œç›´æ¥delete test pod çœ‹çœ‹é‡æ–° run ä¸€å€‹èƒ½ä¸èƒ½æˆåŠŸpull åˆ° private image ã€‚\n1 2 3 4 5  bash-5.0# kubectl delete pod test pod \u0026#34;test\u0026#34; deleted kubectl run -ti --rm test --image registry-gitlab.com.tw/repo/image-cli:v4.4.0 bash ...   é€™æ™‚å€™æŒçºŒè§€å¯Ÿ pod çš„ç‹€æ…‹æ˜¯ä¸æ˜¯running\n1 2 3  bash-5.0# kubectl get pod NAME READY STATUS RESTARTS AGE test 1/1 Running 0 30s   æ­¤æ™‚é‚„æœ‰ä¸€å€‹å•é¡Œï¼Œå‰›å‰›åªæœ‰ä¿®æ”¹ä¸€å€‹ç¯€é»å¦‚æœ Pod ä»Šå¤©éƒ¨ç½²åˆ°å…¶ä»–ç¯€é»ä¸Šï¼Œé‚„æ˜¯æœƒå‡ºç¾x509: certificate is not authorized to sign other certificatesçš„å•é¡Œã€‚æœ‰æ²’æœ‰æ–¹å¼å¯ä»¥ä¸€å‹æ°¸é€¸å‘¢ï¼Ÿæˆ‘é€™é‚Šç›´æ¥æ²¿ç”¨å‰›å‰›çš„daemset ä¸¦ä¸”ä¿®æ”¹ä¸€ä¸‹ yaml fileè®“é€™å€‹ pod å¯ä»¥è™•ç†é€™å€‹å•é¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  apiVersion:apps/v1kind:DaemonSetmetadata:name:registry-canamespace:kube-systemlabels:k8s-app:config-dockerspec:selector:matchLabels:name:config-dockertemplate:metadata:labels:name:config-dockerspec:containers:- name:config-dockerimage:nginx:1.18command:[\u0026#39;sh\u0026#39;]args:[\u0026#39;-c\u0026#39;,\u0026#39;cp --remove-destination /home/core/daemon.json /etc/docker/daemon.json \u0026amp;\u0026amp; kill -1 $(pidof dockerd) \u0026amp;\u0026amp; tail -f /dev/null\u0026#39;]volumeMounts:- name:etc-dockermountPath:/etc/docker- name:docker-configmountPath:/home/coresecurityContext:privileged:trueterminationGracePeriodSeconds:30hostPID:truevolumes:- name:etc-dockerhostPath:path:/etc/docker- name:docker-configconfigMap:name:docker-insecure  é€™é‚Šå¯ä»¥çœ‹åˆ°ç›´æ¥å¥—äº†ä¸€å€‹ configmap ä»¥åŠé€é runtime çš„ args æŠŠconfigmap çš„è³‡æ–™è¤‡è£½åˆ° /etc/docker/daemon.json æœ€å¾Œé‡å•Ÿäº† dockerd çš„ processã€‚\nä»¥ä¸Šæ˜¯è§£æ±ºåœ¨Azure Kubernetes Service é‡åˆ°çš„ unssl image registry çš„æ€è·¯èˆ‡è§£æ±ºæ–¹æ³•ã€‚\n","description":"","id":15,"section":"posts","tags":["kubernetes"],"title":"Azure Kubernetes Service pull unssl  image registry","uri":"https://blog.jjmengze.website/posts/azure/private-image/"},{"content":"  ref: https://docs.openshift.com/container-platform/4.4/authentication/identity_providers/configuring-gitlab-identity-provider.html\nGitlab ç®¡æ§ä½¿ç”¨è€… ç‚ºä»€éº¼è¦ä½¿ç”¨ Gitlab é€²è¡Œå¹³å°çš„ç®¡æ§\ndentity providers use OpenShift Container Platform Secrets in the openshift-config namespace to contain the client secret, client certificates, and keys.\nYou can define an OpenShift Container Platform Secret containing a string by using the following command.\nCreating the Application OAuth ç¬¬ä¸€æ­¥ï¼Œå…ˆå»Gitlabä¸Šå»ºç½®ç›¸é—œçš„applicationï¼Œä¸¦ä¸”è¨­å®šè©²applicationæ‰€éœ€è¦çš„æ¬Šé™ã€‚\n å¦‚åœ–æ‰€ç¤ºå…ˆé¸æ“‡Gitlabç¶²é ä¸Šå³ä¸Šè§’è‡ªå·±çš„é ­åƒï¼Œä¸¦é¸æ“‡Settingã€‚    é¸æ“‡å®ŒSettingå¾Œï¼Œåˆ°å·¦æ–¹é¸æ“‡Applicationsï¼Œé€²å…¥åˆ°è¨­å®šApplicationçš„é é¢ã€‚    é€²åˆ°è¨­å®šApplicationçš„é é¢å¾Œï¼Œæœƒçœ‹åˆ°ä»¥ä¸‹ç•«é¢ã€‚é€™é‚Šæœ‰å¹¾å€‹éƒ¨åˆ†éœ€è¦ç•™æ„ã€‚    Redirect URI\néœ€è¦ç‰¹å®šæ ¼å¼é€²è¡Œå¡«å¯«ï¼Œhttps://oauth-openshift.apps.\u0026lt;cluster-name\u0026gt;.\u0026lt;cluster-domain\u0026gt;/oauth2callback/\u0026lt;idp-provider-name\u0026gt;\ncluster name èˆ‡ cluster-domain å¯ä»¥åœ¨ openshift console çš„ç¶²å€ä¸Šçœ‹åˆ°ï¼Œä¾‹å¦‚:console-openshift-console.apps.ocp4demo.jjmengze.website\nå…¶ä¸­ ocp4demo å°±æ˜¯æˆ‘å€‘çš„ cluster name ï¼Œè€Œ jjmengze.website å°±æ˜¯ cluster-domainã€‚\n  openid\nå› ç‚º Openshift éœ€è¦é€é OpenID Connect (OIDC)é©—è­‰ Gitlab ä½¿ç”¨è€…çš„ç™»å…¥è³‡è¨Šï¼Œæ‰€ä»¥æˆ‘å€‘è¦æŠŠ openid çµ¦å‹¾é¸èµ·ä¾†ã€‚\n    å¡«å¯«å®Œæˆå¾ŒæŒ‰ä¸‹ Save application å¯ä»¥çœ‹åˆ°ä»¥ä¸‹çµæœã€‚    Create secret è¦åœ¨ OCP ä¸Šé¢å»ºç«‹ä¸€å€‹ secret å¾ŒçºŒè®“é©—è­‰çš„æ™‚å€™å¯ä»¥æ”œå¸¶é€™å€‹ secret è³‡è¨Šã€‚\né€™è£¡çš„ clientSecret çš„æ•¸å€¼å°±æ˜¯å‰›å‰›åœ¨ Gitlab ä¸Šå»ºç«‹ Application çš„ Secret çš„æ•¸å€¼å‘¦ï¼\n$kubectl create secret generic gitlab-app-oath --from-literal=clientSecret=\u0026quot;1368992d4100943938f4896d47419b4bba3c5598dce0fa15f8c4ca50fc16758f\u0026quot; -n openshift-config Create Comfigmap æ¥è‘—å»ºç«‹ configmap ï¼Œé€™è£¡çš„ configmap æ˜¯ Gitlab çš„æ†‘è­‰ï¼Œåªè¦ä¿®æ”¹ä¸€ä¸‹æ†‘è­‰çš„è·¯å¾‘åœ¨æŒ‰ç…§ä¸‹é¢çš„å‘½ä»¤åŸ·è¡Œå°±å¯ä»¥æŠŠæ†‘è­‰æ”¾åˆ° OCP ä¸Šäº†ã€‚\n$kubectl create configmap gitlab-ca --from-file=ca.crt=/mnt/gitlab-ca.crt -n openshift-config Create OAuth ä¸Šé¢çš„æ­¥é©Ÿåšå®Œä¹‹å¾Œï¼Œæˆ‘å€‘é‚„éœ€è¦å»ºç«‹ä¸€å€‹ yaml æ¡ˆä¾†å‘Šè¨´ OCP èªªç¾åœ¨è¦å¤šæä¾›ä¸€ç¨®ç™»å…¥åŠèªè­‰æ–¹å¼ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  apiVersion:config.openshift.io/v1kind:OAuthmetadata:name:clusterspec:identityProviders:- name:\u0026lt;ç™»å…¥é¸é …æœƒå‡ºç¾çš„åç¨±\u0026gt; mappingMethod: claim type:GitLabgitlab:clientID:\u0026lt;Gitlabä¸Šå–å¾—çš„applicationID\u0026gt; clientSecret: name:gitlab-app-oathurl:\u0026lt;Gitlabçš„ä½ç½®\u0026gt; ca: name:gitlab-ca  de re mi so ï¼Œæˆ‘å€‘å¯ä»¥ apply é€™å€‹è¨­å®šæª”æ¡ˆåˆ° OCP ä¸Šå›‰ï¼\n$kubectl apply -f oath-gitlab.yml å°±è‘—æˆ‘å€‘å°±å¯ä»¥åˆ°openshift console çœ‹å‰›å‰›çš„è¨­å®šæ˜¯ä¸æ˜¯å¤§æˆåŠŸäº†ï¼\n  å¿«æ¨‚åœ°é»é€²å»ä¹‹å¾Œï¼Œå¯ä»¥çœ‹çœ‹ã€‚å¯ä»¥çœ‹åˆ° OCP å‘ä½ çš„ Gitlab è¦æ¬Šé™ç™»å…¥å›‰ã€‚\n  æŒ‰ä¸‹ Authorize å¾Œå°±å¯é€²å…¥åˆ° Openshift çš„é é¢ï¼Œæ¥è‘—é–‹å§‹æ“ä½œä½ çš„ç’°å¢ƒå›‰ï¼\n  ","description":"","id":16,"section":"posts","tags":["openshift"],"title":"OpenShift ç‡ˆç´…é…’ç¶ èˆ‡ Gitlab identity","uri":"https://blog.jjmengze.website/posts/ocp/gitlab-ocp/"},{"content":"  ç‚ºä»€éº¼è¦ä½¿ç”¨ï¼Ÿ é€™é‚Šæˆ‘ç›´æ¥é»å‡ºæˆ‘å€‹äººçš„è§€é»ï¼Œæ­¡è¿å¤§å®¶ä¾†æ¢è¨åˆ°åº•éœ€ä¸éœ€è¦å°å…¥ tracing çš„æ¦‚å¿µåœ¨å°ˆæ¡ˆä¸­ã€‚\nå°±æˆ‘å€‹äººçš„ç†è§£å°å…¥ tracing æœ‰å¹¾å€‹å¥½è™•ï¼Œèƒ½æä¾›ç³»çµ±é‹ä½œæ™‚æœ‰æ›´å…¨é¢çš„ç†è§£èˆ‡è¿½ç¸±ï¼ŒåŒ…æ‹¬å»¶é²ï¼ŒéŒ¯èª¤ä»¥åŠæ•ˆèƒ½ç­‰å•é¡Œï¼Œæˆ‘å€‘å¯ä»¥é€é tracing æŸ¥çœ‹æ•´å€‹ç³»çµ±æˆ–æ˜¯å–®å€‹æ‡‰ç”¨ç¨‹å¼æ˜¯å¦‚ä½•è™•ç†æŸä¸€é …æ¥­å‹™æ“ä½œ ä¸¦ä¸”è¿½è¹¤æ­¤é …æ“ä½œçš„æµç¨‹èˆ‡ç›¸é—œè¨Šæ¯ã€‚\né€™æ¨£å¸¶ä¾†äº†ä»€éº¼å¥½è™•ï¼Ÿ\nå¦‚æœå¯ä»¥é€éåœ–è¡¨ç­‰æ–¹å¼é¡¯ç¤ºæˆ‘å€‘è·Ÿè¹¤çš„çµæœï¼Œå¯ä»¥åŠ é€Ÿå¾ŒçºŒç¶­é‹äººå“¡æ’é™¤æ•…éšœçš„é€Ÿåº¦ä¸¦ä¸”å¯ä»¥å¹«åŠ©é–‹ç™¼è€…æ‰¾åˆ°æ•ˆèƒ½å•é¡Œçš„ç™¥çµé»ï¼Œæ­¤å¤–æˆ‘å€‘é‚„å¯ä»¥çœ‹åˆ°ä¸€æ¢æ¥­å‹™é‚è¼¯å¯¦éš›çš„æµå‘æ˜¯å¦‚ä½•è¢«è™•ç†çš„ã€‚\né‚£ä»€éº¼æ˜¯Opentracing å†è«‡è«‡ Opentracing ä¹‹å‰æˆ‘å€‘å¯ä»¥å°‡æ™‚é–“å›æ¨å€’90å¹´ä»£ï¼Œç•¶æ™‚ Google ç™¼è¡¨äº†ä¸€ç¯‡é—œæ–¼åˆ†æ•£æ˜¯è¿½è¹¤çš„è«–æ–‡\u0026ldquo;Dapper, a Large-Scale Distributed Systems Tracing Infrastructure\u0026rdquo;ï¼Œé™¤äº†è©²ç¯‡è«–æ–‡å¤– Google é‚„ç™¼è¡¨äº†å¦å¤–ä¸€ç¯‡åˆ†æ•£å¼è¿½è¹¤çš„çš„å•é¡Œæ‰€åœ¨\u0026ldquo;Uncertainty in Aggregate Estimates from Sampled Distributed Traces\u0026rdquo;ï¼Œå…©ç¯‡è«–æ–‡éƒ½éå¸¸çš„ç²¾é‡‡èªªæ˜äº†ç‚ºä»€éº¼éœ€è¦åšåˆ†æ•£å¼è¿½è¹¤ä»¥åŠè¿½è¹¤å¸¶ä¾†çš„æ•ˆç›Šå·²æä»¥åŠè¿½è¹¤å¸¶ä¾†çš„æ•ˆç›Šèˆ‡å…¶å›°é›£é»ã€‚\néš¨å¾Œå„å®¶å» å•†è·Ÿè‘—é€™å¹¾ç¯‡è«–æ–‡çš„å¼•å°é–‹ç™¼å‡ºä¸€ç³»åˆ—ç›¸é—œçš„å·¥å…·ä¾‹å¦‚ï¼Œ Dapper ã€ Zipkin ã€ Appdash ç­‰ç­‰ï¼Œè¶Šä¾†è¶Šå¤šå» å•†åˆ°äº†æˆ°å ´ä¸Šçˆ­å¥ªé€™ä¸€å¡Š tracing çš„å¤§é¤…ï¼Œä¸éå°±ä½¿ç”¨è€…è€Œè¨€å°±ç›¸ç•¶çš„é ­ç—›äº†ï¼Œå°æ–¼å„å» å•†æä¾›çš„ API èˆ‡ç³»çµ±æ”¯æ´åº¦éƒ½ä¸ç›¸åŒçš„æƒ…æ³ä¹‹ä¸‹ï¼Œä½¿ç”¨è€…å¹¾ä¹æ²’æœ‰è¾¦æ³•ç„¡ç—›å¾—è½‰ç§»æ‰€ä½¿ç”¨çš„ tracing Systemã€‚\nä¸‹ä¸€å€‹æ™‚ä»£ä¾†è‡¨å¿…é ˆè¦æœ‰äººçµ±ä¸€ç¾¤é›„æ‰“é€ ä¸€å€‹è¼•é‡ç´šä¸”æ¨™æº–åŒ–çš„ä¸­ä»‹å±¤çµ±ä¸€ä¸Šä¸‹å±¤ä¹‹é–“çš„éš”é–¡ï¼Œ CNCF åº•ä¸‹çš„ OpenTracing é¡˜æ™¯ç‚ºæä¾›ä¸€å€‹æ¨™æº–çš„ tracing API æ‰€æœ‰ä½¿ç”¨è€…åªè¦åœ¨ä¹ OpenTracing tracing æ‰€æä¾›çš„ API ï¼Œä¸éœ€è¦å†äº†è§£å„å®¶å» å•†å¦‚ Zipkin ã€ Appdash çš„æµç¨‹ï¼Œé€™é»æˆ‘èªç‚ºä»–è·Ÿ Kubernetes çš„ CNI ã€ CRI ã€ CSIæœ‰ç•°æ›²åŒå·¥ä¹‹å¦™ã€‚\nåè¯è§£é‡Š åœ¨äº†è§£ Opentracing çš„ç”±ä¾†ä¹‹å¾Œï¼Œç¾åœ¨ä¾†ä»‹ç´¹ä»–çš„æ¶æ§‹èˆ‡ç›¸é—œçš„åè©ï¼Œé€™æœ‰åŠ©æ–¼æˆ‘å€‘å¾ŒçºŒé–‹ç™¼ä¸Šçš„ API ä½¿ç”¨ã€‚\nTrace ä¸€å€‹ trace åœ¨ Opentracing ä»£è¡¨ä¸€å€‹äº‹ä»¶åœ¨ç³»çµ±çš„åŸ·è¡Œéç¨‹ï¼Œæˆ‘å€‘å¯ä»¥å¾åœ–ä¸­çœ‹åˆ°è—è‰²çš„ä»£è¡¨ä¸€å€‹äº‹ä»¶åœ¨ Opentracing ç¨±ç‚ºä¸€å€‹ trace ï¼Œåº•ä¸‹ç¶“éç´…è‰²ç¶ è‰²ä»¥åŠç°è‰²çš„è™•ç†ã€‚\næ¯”è¼ƒå­¸è¡“çš„èªªæ³•å”¯æœ‰å‘ç„¡ç’°åœ–Directed Acyclic Graph ï¼ˆ DAG )ï¼Œæœ‰èˆˆè¶£çš„å¯ä»¥å»æŸ¥æŸ¥é€™æ˜¯ä»€éº¼ã€‚\nSpan span ä»£è¡¨åœ¨ Opentracing ä¸­å„å€‹å·¥ä½œå–®å…ƒã€‚ä¸€å€‹ span å¯ä»¥åŒ…å«å…¶ä»– span çš„ reference ï¼Œå¦‚æ­¤ä¸€ä¾†å¯ä»¥å½¢æˆä¸€å€‹çˆ¶å­é—œä¿‚åœ–ï¼Œé€²è€Œå½¢æˆä¸€å€‹å®Œæ•´çš„ trace ã€‚\nå…¶ä¸­ span æœƒæ”œå¸¶ä¸€äº›è³‡è¨Šæ–¹ä¾¿ä½¿ç”¨è€…é–±è®€ä¾‹å¦‚ï¼š\n reference span åç¨± span é–‹å§‹èˆ‡çµæŸæ™‚é–“ tag log span Context baggage Items\n  ChildOf å…ˆä¾†çœ‹çœ‹æµç¨‹çµæ§‹æ™‚åºåœ–ï¼ŒChildof æˆ‘æœƒæ­¸é¡æˆçˆ¶ç¯€é»ä¾è³´å­ç¯€é»çš„çµæœã€‚ä¾‹å¦‚ Server Span é€é RPCç­‰æ–¹å¼ å»å«äº† register Span ï¼Œ register Span è™•ç†äº†ä¸€äº›è³‡æ–™åˆå»å‘¼å« SQL Span åš insert çš„å‹•ä½œï¼ŒSQL Span å° SQL å­˜å…¥è³‡æ–™å¾Œæœƒè¿”å›çµ¦ register Span å›å ± insert å‹•ä½œæˆåŠŸï¼Œæ¥è‘— register Span åˆæœƒè¿”å›çµ¦ Server Span è¨»å†ŠæˆåŠŸçš„æ¶ˆæ¯ã€‚\né€™ç¨®çˆ¶ç¯€é»ä¾è³´å­ç¯€é»çš„è¡Œç‚ºç¨±ç‚ºChildOfã€‚\n [-Parent Server Span--------------] [-Child register Span A----] [-Child Span B----] FollowsFrom å…ˆä¾†çœ‹çœ‹æµç¨‹çµæ§‹æ™‚åºåœ–ï¼Œçˆ¶ç¯€é»ä¸ä¾è³´ä»»ä½•å­ç¯€é»çš„çµæœæˆ‘æŠŠä»–æ­¸é¡ç‚º FollowsFrom ï¼Œä¾‹å¦‚æˆ‘ç™¼é€ä¸€æ¢è¨Šæ¯ï¼Œè¨Šæ¯æ˜¯å¦æˆåŠŸè¢«è™•ç†èˆ‡ç™¼è¨Šæ¯çš„äº‹ä»¶æ²’æœ‰é—œè¯ï¼Œé€™æ™‚å°±ç¨±ç‚º FollowsFrom ã€‚\n[-Parent Span-] [-Child Span-] Span-tag åœ¨ OpenTracing çš„è¦ç¯„ä¹‹ä¸‹ï¼Œæ¯ä¸€å€‹ span éƒ½å¯ä»¥æœ‰ tag å±¬æ€§ä»¥ key-value çš„å½¢å¼å‡ºç¾ã€‚ tag æˆ‘å€‘å¯ä»¥ç†è§£æˆæŸä¸€ç¨®å±¬æ€§ä¾‹å¦‚åœ–ä¸­çš„error tag ï¼Œæˆ‘å€‘å¯ä»¥åˆ©ç”¨é€™æ ¼å±¬æ€§éæ¿¾æ‰error =false çš„spanï¼Œæ–¹ä¾¿æˆ‘å€‘æŸ¥è©¢æˆ‘è¿½è¹¤ã€‚\nSpan-log é™¤äº† tag ä¹‹å¤– Opentracing é‚„è¦ç¯„äº† log ï¼Œé–‹ç™¼è€…å¯ä»¥åœ¨ span ä¸­åŠ å…¥ log ï¼Œä»–ä»¥ä»¥ key-value çš„å½¢å¼å‡ºç¾ï¼Œæ–¹ä¾¿é–‹ç™¼è€…æˆ–æ˜¯ç¶­é‹äººå“¡å¿«é€Ÿåœ°æª¢è¦–è©² span åŸ·è¡Œçš„ç›¸é—œè¨Šæ¯ã€‚å¦‚åœ–æ‰€ç¤ºå¯ä»¥çœ‹åˆ°åœ¨ external service api ä¸­çš„ log event é¡¯ç¤ºtime out æˆ‘å€‘å¯ä»¥å¾ˆå¿«ç­è§£åœ¨åŸ·è¡Œé€™å€‹æ“ä½œçš„æ™‚å€™ä»–çš„æ’å¿«ç‚ºä½•ã€‚\nSpan Context æˆ‘èªç‚ºé€™å€‹æ¯”è¼ƒé›£è§£é‡‹ï¼Œå¯ä»¥åƒè€ƒè‘—å®˜æ–¹çš„èªªæ˜å°ç…§è‘—çœ‹ï¼Œç°¡å–®çš„èªªå°±æ˜¯spanæœƒå‚³é context è³‡è¨Šçµ¦ä¸‹ä¸€å€‹ span ï¼Œä¾‹å¦‚ spanID ã€traceIDç­‰ã€‚\n The SpanContext carries data across process boundaries. Specifically, it has two major components:\n An implementation-dependent state to refer to the distinct span within a trace\n i.e., the implementing Tracerâ€™s definition of spanID and traceID\n Any Baggage Items\n These are key:value pairs that cross process-boundaries.\nThese may be useful to have some data available for access throughout the trace.\n   Baggage Items å¾å­—é¢ä¸Šä¾†çœ‹ baggage å°±æ˜¯è¡Œæçš„æ„æ€ï¼Œä¸€å€‹ trace é–‹å§‹åˆ°çµæŸï¼Œå¯èƒ½æœƒå¾æŸä¸€å€‹ span æ”œå¸¶è¡Œæåˆ°ä¸‹ä¸€å€‹ span é€²è¡Œè™•ç†ï¼Œä¸éé€™è£¡æœ‰ä¸€å€‹éå¸¸é‡è¦çš„é»å°±æ˜¯è¡Œæåœ¨æ•´å€‹ trace çš„éç¨‹éƒ½ä¸æœƒè¢«ä¸Ÿæ£„ï¼Œç›´åˆ° trace çµæŸç‚ºæ­¢ã€‚\nå¾ç¯„ä¾‹ä¾†çœ‹App A æ˜¯ä¸€å€‹ span ï¼Œæ”œå¸¶äº†ä¸€äº›è³‡æ–™åˆ°å¦‚ot-baggage-environment:production åˆ° APP B å¦‚æœå¾Œé¢é‚„æœ‰ APP C ã€APP Dï¼Œé€™ä¸€å€‹è³‡æ–™æœƒå‚³åˆ°æ•´å€‹traceçµæŸç‚ºæ­¢ã€‚\nå°çµ ä¸Šé¢æˆ‘å€‘è¨è«–äº† Opentracing çš„å‰ä¸–ä»Šç”Ÿï¼Œç‚ºä»€éº¼è¦æœ‰ tracing ä»¥åŠç›¸é—œçš„è«–æ–‡ã€‚åŒæ™‚é‡å° Opentracing æœƒå‡ºç¾çš„åè©åšä¸€å€‹åˆæ­¥çš„è§£èªªï¼Œå¯ä»¥ä»¥å¹«åŠ©æˆ‘å€‘å¾ŒçºŒå†ä½¿ç”¨ Opentracing æä¾›çš„ API æ™‚æ›´èƒ½äº†è§£ä»–æ‰€ä»£è¡¨çš„æ„ç¾©ä»¥åŠæ­£ç¢ºçš„ä½¿ç”¨å§¿å‹¢ã€‚ä¸‹ä¸€ç¯‡æˆ‘æœƒçºŒç¹¼åˆ†äº«Opentracing with jaeger çš„ç”¨æ³•ã€‚\n","description":"","id":17,"section":"posts","tags":["devops"],"title":"å‰æ–¹é«˜èƒ½ä¹‹Opentracing","uri":"https://blog.jjmengze.website/posts/go/opentracing/"},{"content":"  Github Action èµ·æ­¥èµ° ç”±æ–¼æœ€è¿‘åœ¨ä½¿ç”¨ Github æ™‚ä¸è«–æ˜¯ Create ä¸€å€‹æ–°çš„ Repository æˆ–æ˜¯ Fork åˆ¥äººç¾æœ‰çš„ Project éƒ½æœƒè·³å‡ºä»¥ä¸‹æç¤ºï¼Œç‚ºäº†æ»¿è¶³å¥½å¥‡å¿ƒå°±èŠ±äº†ä¸€é»æ™‚é–“ç ”ç©¶äº† Github Action é€™å€‹æ–°åŠŸèƒ½ã€‚\n  GitHub Actions æ˜¯ GitHub åœ¨ç¾åœ‹11/13è™Ÿå…¨é¢é–‹æ”¾çš„ CI/CD workflowç³»çµ±ï¼Œæˆ‘å€‘å…ˆçœ‹çœ‹å®˜æ–¹çš„æè¿°ã€‚\nå®˜æ–¹çš„æè¿°:\nGitHub Actions makes it easy to automate all your software workflows, now with world-class CI/CD. Build, test, and deploy your code right from GitHub. å¯ä»¥å¾å®˜æ–¹çš„ä»‹ç´¹çœ‹å‡ºä¾† GitHub Actions æ˜¯ä¸€å€‹è‡ªå‹•åŒ– CI/CD çš„åŠŸèƒ½ï¼Œå¯ä»¥ç›´æ¥å¾GitHub deploy ä»¥åŠ test ä½ çš„ source codeã€‚\nç‚ºä»€éº¼è¦ç”¨ï¼Ÿ åœ¨æ²’æœ‰ç”¨ Github Action ä¹‹å‰ç¶­é‹äººå“¡å¯èƒ½æœƒé€é WebHook ä¹‹é¡çš„æ–¹å¼å»å¾—çŸ¥ç•¶å‰ Repository çš„ç‹€æ…‹ï¼Œä¾‹å¦‚ Kubernetes ç¤¾ç¾¤å°±é–‹ç™¼äº†ä¸€å€‹æ©Ÿå™¨äººkubernetes/test-infraå°ˆé–€å»è™•ç†ç›¸é—œçš„ç‹€æ…‹æ”¹è®Šä¸¦ä¸”è§¸ç™¼å¾ŒçºŒçš„æµç¨‹ï¼Œå¦‚ unit test ã€intregration test æˆ–æ˜¯ e2e test(end to end test) \u0026hellip;.ç­‰ç­‰ï¼Œæˆ–æ˜¯é€éå…¶ä»– CI/CD å·¥å…· å¦‚ Jenkins ã€ Argo ç­‰ç­‰å…¶ä»–å·¥å…·å»å»ºæ§‹ä¸€å€‹ piplineï¼ŒGithub é–‹ç™¼äº†Githbu Action å¯ä»¥å¹«é€™æˆ‘å€‘åœ¨ Github Repository ä¸Šç›´æ¥å»ºç«‹è‡ªå‹•åŒ–éƒ¨å±¬ä»¥åŠæ¸¬è©¦çš„æµç¨‹ï¼Œé™¤æ­¤ä¹‹å¤– Github æä¾›äº†ä¸€äº›å¸å¼•é–‹ç™¼è€…å»ä½¿ç”¨çš„ç‰¹é»ã€‚\n Discovering actions Notifications for workflow runs Disabling or limiting GitHub Actions for your repository or organization  \u0026quot;Managing a workflow run\u0026quot; \u0026quot;Events that trigger workflows\u0026quot; \u0026quot;Virtual environments for GitHub-hosted runners\u0026quot; \u0026quot;Managing billing for GitHub Actions\u0026quot; å¸¸è¦‹çš„ç”¨æ³•èªªæ˜ GitHub Actionsæœ‰è¨±å¤šå¸¸è¦‹çš„ç”¨è©ï¼Œé€™é‚Šç¨å¾®åšä¸€äº›ç°¡å–®çš„è§£èªªã€‚(é€™é‚Šæˆ‘å€‹äººèªç‚ºæˆ‘è§£é‡‹å¾—ä¸å¥½ï¼Œä¸éé‚„æ˜¯è½è½å§xD)\n Continuous integration (CI):  æˆ‘å€‘å¯ä»¥é€é CI å» build ä»¥åŠ test Repository ä¸Šçš„ Source codeã€‚å¯ä»¥å¾ test å¾—éç¨‹å¿«é€Ÿåœ°æª¢æ¸¬éŒ¯èª¤çš„é‚è¼¯ï¼ˆé€™é‚Šå¯ä»¥åŒ…å«æ•´å€‹unit test ã€intregration test æˆ–æ˜¯ e2e test(end to end test) \u0026hellip;.ç­‰ç­‰ï¼‰ã€‚\næƒ³è¦äº†è§£æ›´å¤šå¯ä»¥ä¸Šwikiä¹‹é¡çš„å»äº†è§£å®ƒçš„å®šç¾©\n  Continuous deployment (CD)\nCDé€šå¸¸æ˜¯å»ºç¯‰æ–¼CIçš„çµæœä¹‹ä¸Šï¼Œç•¶CIåŸ·è¡ŒæˆåŠŸå¾Œæœƒè§¸ç™¼CDï¼Œé€™å€‹æ­¥é©ŸåŸºæœ¬ä¸Šæ˜¯å°‡CIæ‰“åŒ…å¥½çš„\nbinaryæª”æ¡ˆéƒ¨ç½²åˆ°å„ç¨®ä¸åŒçš„ç’°å¢ƒå¦‚Test ç’°å¢ƒ Staging ç­‰ç­‰ã€‚å®¢æˆ¶çš„ä½¿ç”¨è€…æˆ–æ˜¯æ¸¬è©¦äººå“¡å¯ä»¥å¿«é€Ÿåœ°å¾—åˆ°éƒ¨ç½²å®Œçš„ç’°å¢ƒï¼Œä¸¦ä¸”é€²è¡Œæ¥­å‹™é‚è¼¯çš„æ¸¬è©¦ã€‚\n  Workflow file:\næ˜¯å®šç¾©é€™å€‹ Repository CI/CD çš„å·¥ä½œæµç¨‹(workflow/pipline)çš„ä¸€å€‹ YAML æª”ï¼Œé€™å€‹æª”æ¡ˆæœƒæ”¾åœ¨ RepoRepository è·Ÿç›®éŒ„åº•ä¸‹çš„ .github/workflows è³‡æ–™å¤¾ä¸­ã€‚\n  Action:\nAction çµ„åˆäº†å¤šå€‹ Step ï¼Œæˆ‘å¯ä»¥å°‡ Action æ‰“åŒ…å¥½ä¸¦ä¸”åˆ†äº«åˆ°åˆ†äº«åˆ° GitHub Action ç¤¾ç¾¤ã€‚\n  Step:\næ˜¯ä¸€å€‹åŸ·è¡Œä¸€å€‹ç¨ç«‹çš„æŒ‡ä»¤æˆ–æ˜¯åŸ·è¡Œåˆ¥äººæ‰“åŒ…å¥½çš„Actionï¼Œä¸€å€‹ Job è£¡é¢æœƒåŒ…å«ä¸€åˆ°å¤šå€‹Stepï¼ŒJob è£¡é¢çš„Step æ˜¯å…±ç”¨åŒä¸€å€‹environmentèˆ‡filesystemã€‚\n  Job:\nç”±ä¸€å€‹æˆ–æ˜¯å¤šå€‹Stepçµ„æˆï¼Œç•¶æœ‰å¤šå€‹Jobçš„æ™‚å€™æˆ‘å€‘å¯ä»¥å®šç¾©Jobçš„ç›¸ä¾é—œä¿‚èˆ‡åŸ·è¡Œæµç¨‹ã€‚Job å¯ä»¥ä¸¦è¡Œ(parallel)åŸ·è¡Œæˆ–æ˜¯æŒ‰é †åº(sequentially)åŸ·è¡Œã€‚ä¾‹å¦‚Repository æœ‰å»ºç«‹Build Job ä»¥åŠTest Job ï¼ŒTest Job ä¾è³´Build Job çš„åŸ·è¡Œçµæœï¼Œå¦‚æœä»Šå¤©Build Job åŸ·è¡Œå¤±æ•—Test Job å‰‡ä¸æœƒåŸ·è¡Œã€‚\n  é€šå¸¸JobåŸ·è¡Œåœ¨ä¸åŒçš„Runner(è™›æ“¬ç’°å¢ƒvirtual environment).\n Runner:\nRunneræ˜¯åœ¨åŸ·è¡ŒJobçš„è™›æ“¬ç’°å¢ƒï¼Œæˆ‘å€‘å¯ä»¥è‡ªå·±å»ºç«‹Runneræˆ–æ˜¯ä½¿ç”¨Github ä»£ç®¡çš„Runner ï¼Œ Runner æœƒå»å»ç›£è½ Github Job çš„è³‡æ–™ï¼Œç•¶æœ‰ Job è³‡æ–™ç”¢ç”Ÿçš„æ™‚å€™ Github æœƒå°‡ Job ä¸‹æ”¾çµ¦æŸä¸€å€‹ Runner å»åŸ·è¡Œï¼Œä¸€ä½† Runner åŸ·è¡Œå®Œ Job æœƒå°‡åŸ·è¡Œçµæœå›å ±çµ¦Githubã€‚  Runner ä¸€æ¬¡åªèƒ½åŸ·è¡Œä¸€å€‹ Job ã€‚\n  Artifact:\nArtifacts å°±æ˜¯æŠŠæŸä¸€å€‹ Job åŸ·è¡Œå®Œçš„çµæœï¼ˆå¯èƒ½æ˜¯ binary æª”ã€ log æª”ç­‰ç­‰ï¼‰ï¼Œå¯ä»¥æŠŠé€™ä¸€å€‹ Job åŸ·è¡Œå®Œçš„çµæœé€åˆ°ä¸‹ä¸€å€‹ Job ã€‚\n  Event:\nç•¶æŸä¸€å€‹äº‹ä»¶ç”¢ç”Ÿçš„æ™‚å€™å¦‚ create PR ã€create issue æˆ–æ˜¯ create branchç­‰ç­‰ï¼ŒGitlab æœƒæ”¶åˆ°é€™å€‹æ¶ˆæ¯ä¸¦ä¸”ä¸”é€²è¡Œè™•ç†ã€‚\n  è¦æ€éº¼ä¸Šæ‰‹ä½¿ç”¨ Github æœ‰æä¾›ä¸€äº›é è¨­çš„ Workflow templatesçµ¦é–‹ç™¼è€…åšä½¿ç”¨ï¼Œé–‹ç™¼è€…å¯ä»¥é‡å°ä¸åŒèªè¨€å¥—ç”¨ä¸åŒçš„æ¨£æ¿ã€‚\nGithubé‚„æœƒåˆ†æä½ Repository çš„source codeä¸¦ä¸”æ¨è–¦ä½ é©åˆçš„Workflow templatesï¼Œä¾‹å¦‚æˆ‘çš„Repository åŒ…å«Golangçš„source code ï¼Œæˆ‘å€‘æœƒæ”¶åˆ°Github çš„å»ºè­°Golang Workflow templates æˆ‘å€‘å¯ä»¥ä»¥é€™å€‹æ¨¡å‹å †ç–Šæˆ‘å€‘éœ€è¦çš„Workflowã€‚\nå¯ä»¥åƒè€ƒactions/starter-workflowsæŸ¥è©¢Github å®˜æ–¹ç¶­è­·çš„ Workflow templatesã€‚\nèµ·æ‰‹å¼ å…ˆå‰µä¸€å€‹å°ˆæ¡ˆå†èªªï¼Œæˆ‘é€™é‚Šå…ˆç”¨ Golang å»ºç«‹ä¸€å€‹éå¸¸ç°¡å–®çš„WebServer Repoã€‚\nå¦‚åœ–æ‰€ç¤ºï¼Œæˆ‘å€‘å¯ä»¥åœ¨ Github ä¸Šé¢å¯ä»¥çœ‹åˆ°é€™ä¸€å€‹æç¤ºï¼Œå•æˆ‘å€‘è¦ä¸è¦å»ºç«‹ä¸€å€‹ GitHub Actions ã€‚\né€™é‚Šé»é¸Set Up Actionæœƒè·³è½‰åˆ°é€™å€‹é é¢ï¼Œé¸æ“‡æƒ³è¦å»ºç«‹çš„Workflow templatesã€‚\n  é€™é‚Šå¯ä»¥ç›´æ¥é»æ“ŠSet up workerflowï¼Œé»é€²å»å¾Œæœƒè·³è½‰åˆ°Workerflow ç·¨è¼¯é é¢ï¼Œé é¢ä¸Šå¯ä»¥çœ‹è¦‹é è¨­çš„jobã€stepsç­‰è³‡è¨Šã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34  name:Goon:push:branches:[master]pull_request:branches:[master]jobs:build:name:Buildruns-on:ubuntu-lateststeps:- name:SetupGo1.13uses:actions/setup-go@v1with:go-version:1.13id:go- name:CheckoutcodeintotheGomoduledirectoryuses:actions/checkout@v2- name:Getdependenciesrun:| go get -v -t -d ./...if[-fGopkg.toml];thencurlhttps://raw.githubusercontent.com/golang/dep/master/install.sh|shdepensurefi- name:Buildrun:gobuild-v.  ç¨å¾®å¹¾è§£é‡‹ä¸€ä¸‹é€™å€‹yamlæ‰€ä»£è¡¨çš„æ„ç¾©\n name\nè¡¨ç¤ºé€™å€‹Workflowçš„åå­— on\nè¡¨ç¤ºé€™å€‹ä»€éº¼æ™‚å€™æœƒè§¸ç™¼é€™å€‹Workerflow  push\nè¡¨ç¤ºæ¨åˆ°é€™å€‹æŸä¸€å€‹branchçš„æ™‚å€™æœƒè§¸ç™¼ï¼Œé€™è£¡é è¨­æ˜¯master pull_request\nè¡¨ç¤ºåƒé€™å€‹æŸä¸€å€‹branchç™¼å‡ºPRçš„æ™‚å€™æœƒè§¸ç™¼ï¼Œé€™è£¡é è¨­æ˜¯master   job\nè£¡é¢æœƒæœ‰è¦åŸ·è¡Œçš„æ­¥é©Ÿèˆ‡ç’°å¢ƒè¨­å®š  build  name\nè¡¨ç¤ºé€™å€‹jobç”¨ä¾†å»ºæ§‹ç¨‹å¼ç¢¼ runs-on\nè¡¨ç¤ºé€™å€‹é€™å€‹jobè¦åŸ·è¡Œåœ¨ä»€éº¼è™›æ“¬ç’°å¢ƒä¸Šï¼Œé€™è£¡æ˜¯ubuntuï¼Œå¯ä»¥æ”¹æˆæ›´å°çš„image   steps\nè¡¨ç¤ºé€™å€‹jobæœ‰å¤šå°‘æ­¥é©Ÿè¦åŸ·è¡Œ  name\næè¿°é€™å€‹é€™ä¸€æ­¥è¦åšä»€éº¼ï¼Œé€™é‚Šé è¨­æ˜¯Set up Go 1.13 uses\né€™é‚Šçš„æ„æ€æ˜¯ä½¿ç”¨åˆ¥äººå¯«çš„actionï¼Œé è¨­æ˜¯actions/setup-go@v1 with\nå¯ä»¥æŒ‡å®šactionçš„åƒæ•¸ï¼Œé€™é‚ŠæŒ‡å®šgoç”¨1.13ç‰ˆgo-version: 1.13 id\nå¯ä»¥åœ¨setupä¸ŠåŠ ä¸Šä¸€äº›æ¨™è¨˜ï¼Œé€™é‚Šé è¨­æ˜¯go run\nå¦‚æœä¸è¦ç”¨åˆ¥äººçš„actionæƒ³è¦åŸ·è¡Œè‡ªå·±çš„è…³æœ¬å¯ä»¥ç”¨é€™å€‹åƒæ•¸ï¼Œå¦‚go build -v .       [color=#FF0000]é€™é‚Šéå¸¸ç²—æ·ºçš„å¸¶éé€™äº›åƒæ•¸æ‰€ä»£è¡¨çš„æ„ç¾©ï¼Œå¦‚æœæƒ³é€²è¡Œæ›´è¤‡é›œçš„è¨­å®šå¯ä»¥åƒè€ƒGitHub Help\n é€™é‚Šè¨­å®šå¥½è‡ªå·±æƒ³è¦çš„Workerflowæµç¨‹å¾Œå¯ä»¥æŒ‰Start commit æäº¤é€™ä¸€å€‹commitã€‚\n  Commit ä¹‹å¾Œå¯ä»¥çœ‹åˆ°Github Action è¢«è§¸ç™¼ï¼Œæˆ‘å€‘å¯ä»¥é»é€²å»çœ‹ä¸€ä¸‹CI/CDæœ‰æ²’æœ‰éã€‚\né€™é‚Šå°±å¯ä»¥çœ‹åˆ°æˆ‘åœ¨Workflow Buildçš„éšæ®µå°±å¤±æ•—äº†xDï¼Œå¯ä»¥é»é€²å»çœ‹ç‚ºä»€éº¼å¤±æ•—ï¼Œåˆ¤æ–·æ˜¯ä¸æ˜¯codeå¯«éŒ¯é‚„æ˜¯å“ªè£¡æœ‰å•é¡Œã€‚\n  é»é€²å»å¾Œæˆ‘å€‘ç™¼ç¾ï¼ŒåŸä¾†æ˜¯go build -v .å‡ºéŒ¯æ‹‰ï½é‚£æˆ‘å€‘é€™é‚Šåšç°¡å–®çš„ä¿®æ”¹å†é‡æ–°æäº¤ä¸€æ¬¡ã€‚\n  å°‡ Build é‚£ä¸€æ®µ run æ”¹æˆæ­£ç¢ºçš„èªæ³•ï¼Œå†é‡æ–°commitã€‚\n1 2  - name:Buildrun:gobuildcmd/main.go  å†æ¬¡æª¢æŸ¥Github Action çš„Workflowæ˜¯ä¸æ˜¯éƒ½äº®ç¶ ç‡ˆé€šéæ‹‰ï½\n  çµæŸèª ä»Šå¤©éå¸¸ç°¡å–®çš„ä»‹ç´¹äº†Github Actionçš„åŠŸèƒ½ï¼Œä»¥åŠæ€éº¼å¿«é€Ÿçš„ä¸Šæ‰‹ä½¿ç”¨é€™å€‹æ–°åŠŸèƒ½ï¼Œä¸‹æ¬¡æœ‰æ©Ÿæœƒå†ä¾†ä»‹ç´¹ä»–è·Ÿdockeræ€éº¼æ•´åˆä»¥åŠæ€éº¼æ’°å¯«è‡ªå·±çš„actionè²¢ç»çµ¦Github Action Marketplace è®“å¤§å®¶ä¾†ä½¿ç”¨ã€‚\n","description":"","id":18,"section":"posts","tags":["ci/cd"],"title":"Github Action èµ·æ­¥èµ°ç¬¬ä¸€å¼","uri":"https://blog.jjmengze.website/posts/cicd/github/github-action-1/"},{"content":"  åœ¨ Kubernetes è³‡æºæ˜¯æ€éº¼è¢«å›æ”¶çš„ï¼Ÿ æ˜¯ç”± kubernetes master node ä¸Šçš„ kube-controller-manger ä¸­çš„ garbage-collection controller é€²è¡Œå›æ”¶ç®¡ç†çš„ã€‚\næˆ‘å€‘å…ˆä¸ç®¡ kubernetes åº•å±¤æ˜¯æ€éº¼å›æ”¶é€™äº›åƒåœ¾ç‰©ä»¶çš„ï¼Œå…ˆæŠŠç„¦é»æ”¾åœ¨æˆ‘å€‘è¦æ€éº¼è¨­å®šyamlæª”ï¼Œç•¢ç«Ÿæˆ‘å€‘æ˜¯yamlå·¥ç¨‹å¸«å˜›(ç¬‘)ï¼Œæœ¬ç¯‡æ–‡ç« æœƒç”¨é€²è¡Œå¹¾å€‹å¯¦é©—ä¾†è§€å¯Ÿå„ç¨® kubernetes å›æ”¶ç­–ç•¥æ˜¯å¦‚ä½•é€²è¡Œçš„ã€‚\nç•¶æˆ‘å€‘åˆªé™¤ç‰©ä»¶æ™‚ï¼Œå¯ä»¥æŒ‡å®šè©²ç‰©ä»¶åº•ä¸‹é—œè¯çš„å­ç‰©ä»¶æ˜¯å¦ä¹Ÿè·Ÿè‘—è‡ªå‹•åˆªé™¤ã€‚\n è‡ªå‹•åˆªé™¤é™„å±¬çš„è¡Œç‚ºä¹Ÿç¨±ç‚º ç´šè¯åˆªé™¤ï¼ˆCascading Deletionï¼‰  Kubernetes ä¸­æœ‰å…©ç¨® Cascading Deletion (è¯é›†) åˆªé™¤åˆ†åˆ¥æ˜¯ï¼š\n å¾Œå°ï¼ˆBackgroundï¼‰ æ¨¡å¼ å‰å°ï¼ˆForegroundï¼‰ æ¨¡å¼ã€‚  Foreground æ¢ä»¶  ç‰©ä»¶çš„ metadata.finalizers è¢«è¨­å®šç‚º foregroundDeletion ç‰©ä»¶è™•æ–¼ deletion in progress ç‹€æ…‹ï¼ˆdeletionTimestampè¢«å»ºç«‹ï¼‰  è¡Œç‚º  éœ€è¦ç­‰åˆ°ç‰©ä»¶æ‰€æœ‰çš„é—œè¯çš„å­ç‰©ä»¶è¢«åˆ é™¤å®Œä¹‹å¾Œï¼Œæ‰å¯ä»¥åˆ é™¤è©²ç‰©ä»¶ å¦‚ä½•ç¢ºå®šé—œè¯çš„å­ç‰©ä»¶çš„çˆ¶è¦ªæ˜¯èª°ï¼Ÿ  é€éå­ç‰©ä»¶çš„ ownerReferences ä¾†ç¢ºå®š    Background kubernetes ç«‹åˆ» é¦¬ä¸Š åˆ é™¤ç‰©ä»¶ï¼Œ garbage-collection controller æœƒåœ¨å¾Œå°(èƒŒæ™¯)åˆ é™¤è©²ç‰©ä»¶çš„å­ç‰©ä»¶ã€‚\né™¤äº†åœ¨èƒŒæ™¯åˆªé™¤å­ç‰©ä»¶çš„è¡Œç‚ºå¤–é‚„æœ‰ä¸€ç¨®æ˜¯ä¸åˆªé™¤å­ç‰©ä»¶ï¼Œè®“å­ç‰©ä»¶è®Šæˆå­¤å…’(Orphan)ã€‚\nå¯¦é©— propagation Policy (Foreground) deploy éƒ¨ç½²æ¸¬è©¦çš„nginx deployment\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  cat \u0026lt;\u0026lt;EOF | kubectl apply -f - apiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.14.2 ports: - containerPort: 80 EOF deployment.apps/nginx-deployment created   ç‹€æ…‹ å–çš„deployment ReplicaSet ä»¥åŠpodçš„ç‹€æ…‹\n1 2 3 4 5 6 7 8 9  kubectl get deploy,pod NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/nginx-deployment 3/3 3 3 4m44s NAME READY STATUS RESTARTS AGE pod/nginx-deployment-6b474476c4-nbtkw 1/1 Running 0 4m44s pod/nginx-deployment-6b474476c4-nkbrb 1/1 Running 0 4m44s pod/nginx-deployment-6b474476c4-zh5g7 1/1 Running 0 4m44s   å–å¾—ReplicaSetèˆ‡podçš„ownerReferences ç”¨ä¾†ç¢ºå®šç‰©ä»¶ä¹‹é–“çš„é—œä¿‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  kubectl get rs nginx-deployment-6b474476c4 -o go-template --template={{.metadata.ownerReferences}} [map[ apiVersion:apps/v1 blockOwnerDeletion:true controller:true kind:Deployment name:nginx-deployment uid:597d36f5-968a-4025-8621-b24f17f7f3a6]] kubectl get pod nginx-deployment-6b474476c4-nbtkw -o go-template --template={{.metadata.ownerReferences}} [map[ apiVersion:apps/v1 blockOwnerDeletion:true controller:true kind:ReplicaSet name:nginx-deployment-6b474476c4 uid:97fb6974-6882-4459-b6b0-b39357a7650b]]   destroy Foreground é€éæŒ‡å®šçš„åˆªé™¤æ¨¡å¼ä¾†åˆªé™¤ç‰©ä»¶ï¼Œé€™è£¡æ˜¯é€éForeground çš„æ–¹å¼åˆªé™¤ç‰©ä»¶ã€‚\ncurl -X DELETE curl -X DELETE localhost:8080/apis/apps/v1/namespaces/default/deployments/nginx-deployment \\ -d '{\u0026quot;kind\u0026quot;:\u0026quot;DeleteOptions\u0026quot;,\u0026quot;apiVersion\u0026quot;:\u0026quot;v1\u0026quot;,\u0026quot;propagationPolicy\u0026quot;:\u0026quot;Foreground\u0026quot;}' \\ -H \u0026quot;Content-Type: application/json\u0026quot; ç‹€æ…‹ å–çš„deployment ä»¥åŠpodçš„ç‹€æ…‹è§€å¯Ÿåˆªé™¤ç‹€æ…‹ã€‚\nå¾é€™å€‹ç‹€æ…‹å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„ pod éƒ½åœ¨ Terminating çš„ç‹€æ…‹ï¼Œ ReplicaSet ä»¥åŠ deployment éƒ½æ²’æœ‰å…ˆç§»é™¤ã€‚\n1 2 3 4 5 6 7 8 9 10 11  kubectl get pod,deploy,rs NAME READY STATUS RESTARTS AGE pod/nginx-deployment-6b474476c4-nbtkw 0/1 Terminating 0 133m pod/nginx-deployment-6b474476c4-nkbrb 0/1 Terminating 0 133m pod/nginx-deployment-6b474476c4-zh5g7 0/1 Terminating 0 133m NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/nginx-deployment 0/3 0 0 133m NAME DESIRED CURRENT READY AGE replicaset.apps/nginx-deployment-6b474476c4 3 0 0 133m   æ¯”è¼ƒå·®ç•° æ¯”è¼ƒåˆªé™¤å‰å¾Œçš„å·®ç•°\nDeployment Deploymentç‹€æ…‹çš„å·®ç•°\nå¾ diff çš„ç‹€æ…‹å¯ä»¥çœ‹å‡ºä¾†ï¼Œåœ¨ metadata çš„éƒ¨åˆ†ä¿®æ”¹äº† finalizers ä¸¦ä¸”æŒ‡å®šäº† foregroundDeletion çš„æ¨¡å¼è¡¨ç¤ºä½¿ç”¨ foreground åˆªé™¤æ¨¡å¼ï¼Œå¦å¤–æ–°å¢äº† deletionTimestamp çš„æ™‚é–“ç¢ºå®šäº†ç‰©ä»¶çš„åˆªé™¤æ™‚é–“ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37  --- a/dpeloy.yaml +++ b/dpeloy.yaml - generation: 1 + deletionGracePeriodSeconds: 0 + deletionTimestamp: \u0026#34;2020-08-10T08:22:55Z\u0026#34; + finalizers: + - foregroundDeletion + generation: 2  namespace: default - resourceVersion: \u0026#34;1480766\u0026#34; + resourceVersion: \u0026#34;1499040\u0026#34;  ... status: - availableReplicas: 3  conditions: - - lastTransitionTime: \u0026#34;2020-08-10T06:10:18Z\u0026#34; - lastUpdateTime: \u0026#34;2020-08-10T06:10:18Z\u0026#34; - message: Deployment has minimum availability. - reason: MinimumReplicasAvailable - status: \u0026#34;True\u0026#34; - type: Available  ... - observedGeneration: 1 - readyReplicas: 3 - replicas: 3 - updatedReplicas: 3 + - lastTransitionTime: \u0026#34;2020-08-10T08:22:55Z\u0026#34; + lastUpdateTime: \u0026#34;2020-08-10T08:22:55Z\u0026#34; + message: Deployment does not have minimum availability. + reason: MinimumReplicasUnavailable + status: \u0026#34;False\u0026#34; + type: Available + observedGeneration: 2 + unavailableReplicas: 3    ReplicaSet è§€å¯ŸReplicaSetçš„è®ŠåŒ–ä¹Ÿæ˜¯ç¢ºå®šäº†åˆªé™¤çš„æ™‚é–“ deletionTimestamp ä»¥åŠä¿®æ”¹æ™‚é–“ time ï¼Œä»¥åŠæ˜¯é€é foregroundDeletion çš„ç­–ç•¥é€²è¡Œåˆªé™¤ã€‚\nåœ¨ç‹€æ…‹æ¬„çš„åœ°æ–¹ä¹Ÿèƒ½çœ‹å‡ºç¾åœ¨ç‹€æ…‹replicasçš„æ•¸é‡è¢«ç¸®æ¸›ç‚º0å€‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30  --- a/rs.yaml +++ b/rs.yaml  creationTimestamp: \u0026#34;2020-08-10T06:09:12Z\u0026#34; - generation: 1 + deletionGracePeriodSeconds: 0 + deletionTimestamp: \u0026#34;2020-08-10T08:22:55Z\u0026#34; + finalizers: + - foregroundDeletion + generation: 2 ... - time: \u0026#34;2020-08-10T06:10:18Z\u0026#34; + time: \u0026#34;2020-08-10T08:22:55Z\u0026#34; ... ownerReferences: @@ -86,7 +87,7 @@ metadata:  kind: Deployment name: nginx-deployment uid: 597d36f5-968a-4025-8621-b24f17f7f3a6 - resourceVersion: \u0026#34;1480765\u0026#34; + resourceVersion: \u0026#34;1499039\u0026#34; ... terminationGracePeriodSeconds: 30 status: - availableReplicas: 3 - fullyLabeledReplicas: 3 - observedGeneration: 1 - readyReplicas: 3 - replicas: 3 + observedGeneration: 2 + replicas: 0   Pod pod çš„éƒ¨åˆ†ä¹Ÿæƒ³ç•¶çš„ç°¡å–®ï¼Œå› ç‚ºæ²’æœ‰å­ç‰©ä»¶æ‰€ä»¥åªè¦ç¢ºå®šåˆªé™¤æ™‚é–“ deletionTimestamp ä»¥åŠä¿®æ”¹æ™‚é–“ time ã€‚\npodçš„ç‹€æ…‹æœƒè¢«ä¿®æ”¹æˆ pending ä»¥åŠç›¸é—œçš„è³‡æºéƒ½æœƒè¢«ç§»é™¤ä¾‹å¦‚: pod ipã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53  --- a/pod.yaml +++ b/pod.yaml  creationTimestamp: \u0026#34;2020-08-10T06:09:12Z\u0026#34; + deletionGracePeriodSeconds: 30 + deletionTimestamp: \u0026#34;2020-08-10T08:23:25Z\u0026#34; ... - time: \u0026#34;2020-08-10T06:10:16Z\u0026#34; + time: \u0026#34;2020-08-10T08:22:57Z\u0026#34;  uid: 97fb6974-6882-4459-b6b0-b39357a7650b - resourceVersion: \u0026#34;1480754\u0026#34; + resourceVersion: \u0026#34;1499048\u0026#34; status: \u0026#34;True\u0026#34; type: Initialized - lastProbeTime: null - lastTransitionTime: \u0026#34;2020-08-10T06:10:16Z\u0026#34; - status: \u0026#34;True\u0026#34; + lastTransitionTime: \u0026#34;2020-08-10T08:22:57Z\u0026#34; + message: \u0026#39;containers with unready status: [nginx]\u0026#39; + reason: ContainersNotReady + status: \u0026#34;False\u0026#34;  type: Ready - lastProbeTime: null - lastTransitionTime: \u0026#34;2020-08-10T06:10:16Z\u0026#34; - status: \u0026#34;True\u0026#34; + lastTransitionTime: \u0026#34;2020-08-10T08:22:57Z\u0026#34; + message: \u0026#39;containers with unready status: [nginx]\u0026#39; + reason: ContainersNotReady + status: \u0026#34;False\u0026#34; ... containerStatuses: - - containerID: docker://f20bbce2b58ac42426b61fc21e3f1a61938a51a4dc30277f50e9ac7aea88aa3d - image: nginx:1.14.2 - imageID: docker-pullable://nginx@sha256:f7988fb6c02e0ce69257d9bd9cf37ae20a60f1df7563c3a2a6abe24160306b8d + - image: nginx:1.14.2 + imageID: \u0026#34;\u0026#34;  lastState: {} name: nginx - ready: true + ready: false  restartCount: 0 - started: true + started: false  state: - running: - startedAt: \u0026#34;2020-08-10T06:10:16Z\u0026#34; + waiting: + reason: ContainerCreating  hostIP: 172.18.0.5 - phase: Running - podIP: 10.32.0.5 - podIPs: - - ip: 10.32.0.5 + phase: Pending   å¯¦é©—propagationPolicy (Background) deploy éƒ¨ç½²æ¸¬è©¦çš„nginx deployment\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  cat \u0026lt;\u0026lt;EOF | kubectl apply -f - apiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.14.2 ports: - containerPort: 80 EOF deployment.apps/nginx-deployment created   ç‹€æ…‹ å–çš„Deployment ReplicaSet ä»¥åŠPodçš„ç‹€æ…‹\n1 2 3 4 5 6 7 8 9 10 11  kubectl get deploy,rs,pod NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/nginx-deployment 3/3 3 3 55s NAME DESIRED CURRENT READY AGE replicaset.apps/nginx-deployment-6b474476c4 3 3 3 55s NAME READY STATUS RESTARTS AGE pod/nginx-deployment-6b474476c4-4hjx8 1/1 Running 0 55s pod/nginx-deployment-6b474476c4-6qvvg 1/1 Running 0 55s pod/nginx-deployment-6b474476c4-plsn7 1/1 Running 0 55s   å–å¾—ReplicaSetèˆ‡podçš„ownerReferencesç”¨ä¾†ç¢ºå®šç‰©ä»¶ä¹‹é–“çš„é—œä¿‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  kubectl get replicaset.apps/nginx-deployment-6b474476c4 -o go-template --template={{.metadata.ownerReferences}} [map[ apiVersion:apps/v1 blockOwnerDeletion:true controller:true kind:Deployment name:nginx-deployment uid:8a2be904-c306-426c-881e-c6914415c5fe]] kubectl get pod nginx-deployment-6b474476c4-6qvvg -o go-template --template={{.metadata.ownerReferences}} [map[ apiVersion:apps/v1 blockOwnerDeletion:true controller:true kind:ReplicaSet name:nginx-deployment-6b474476c4 uid:565540ad-fbf1-4d74-8841-f0475e12a200]]   destroy background 1 2 3 4  curl -X DELETE localhost:8080/apis/apps/v1/namespaces/default/deployments/nginx-deployment \\  -d \u0026#39;{\u0026#34;kind\u0026#34;:\u0026#34;DeleteOptions\u0026#34;,\u0026#34;apiVersion\u0026#34;:\u0026#34;v1\u0026#34;,\u0026#34;propagationPolicy\u0026#34;:\u0026#34;Background\u0026#34;}\u0026#39; \\  -H \u0026#34;Content-Type: application/json\u0026#34;   ç‹€æ…‹ å–çš„deployment ä»¥åŠpodçš„ç‹€æ…‹\nå¾é€™å€‹ç‹€æ…‹å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„ pod éƒ½åœ¨Terminating çš„ç‹€æ…‹ï¼Œä½†æ˜¯replicaset ä»¥åŠ deployment éƒ½å…ˆè¢«ç§»é™¤ã€‚\n1 2 3 4 5  kubectl get pod,deploy,rs NAME READY STATUS RESTARTS AGE pod/nginx-deployment-6b474476c4-4hjx8 0/1 Terminating 0 31m pod/nginx-deployment-6b474476c4-6qvvg 0/1 Terminating 0 31m pod/nginx-deployment-6b474476c4-plsn7 0/1 Terminating 0 31m   æ¯”è¼ƒå·®ç•° deployment deploymentç‹€æ…‹çš„å·®ç•°\nå¯ä»¥çœ‹åˆ°deployment ç›´æ¥è¢«æ®ºæ‰äº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17  --- a/dpeloy.yaml +++ b/dpeloy.yaml -apiVersion: apps/v1 -kind: Deployment -metadata: - annotations: - deployment.kubernetes.io/revision: \u0026#34;1\u0026#34; - kubectl.kubernetes.io/last-applied-configuration: | - {\u0026#34;apiVersion\u0026#34;:\u0026#34;apps/v1\u0026#34;,\u0026#34;kind\u0026#34;:\u0026#34;Deployment\u0026#34;,\u0026#34;metadata\u0026#34;:{\u0026#34;annotations\u0026#34;:{},\u0026#34;labels\u0026#34;:{\u0026#34;app\u0026#34;:\u0026#34;nginx\u0026#34;},\u0026#34;name\u0026#34;:\u0026#34;nginx-deployment\u0026#34;,\u0026#34;namespace\u0026#34;:\u0026#34;default\u0026#34;},\u0026#34;spec\u0026#34;:{\u0026#34;replicas\u0026#34;:3,\u0026#34;selector\u0026#34;:{\u0026#34;matchLabels\u0026#34;:{\u0026#34;app\u0026#34;:\u0026#34;nginx\u0026#34;}},\u0026#34;template\u0026#34;:{\u0026#34;metadata\u0026#34;:{\u0026#34;labels\u0026#34;:{\u0026#34;app\u0026#34;:\u0026#34;nginx\u0026#34;}},\u0026#34;spec\u0026#34;:{\u0026#34;containers\u0026#34;:[{\u0026#34;image\u0026#34;:\u0026#34;nginx:1.14.2\u0026#34;,\u0026#34;name\u0026#34;:\u0026#34;nginx\u0026#34;,\u0026#34;ports\u0026#34;:[{\u0026#34;containerPort\u0026#34;:80}]}]}}}} - creationTimestamp: \u0026#34;2020-08-10T10:05:25Z\u0026#34; - generation: 1 - labels: - app: nginx - managedFields: - - apiVersion: apps/v1 ... ...   replicaset å¯ä»¥çœ‹åˆ° replicaset ä¹Ÿæ˜¯ç›´æ¥è¢«æ®ºæ‰äº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  --- a/rs.yaml +++ b/rs.yaml -apiVersion: apps/v1 -kind: ReplicaSet -metadata: - annotations: - deployment.kubernetes.io/desired-replicas: \u0026#34;3\u0026#34; - deployment.kubernetes.io/max-replicas: \u0026#34;4\u0026#34; - deployment.kubernetes.io/revision: \u0026#34;1\u0026#34; - creationTimestamp: \u0026#34;2020-08-10T10:05:25Z\u0026#34; - generation: 1 - labels: - app: nginx - pod-template-hash: 6b474476c4 - managedFields: - - apiVersion: apps/v1 - fieldsType: FieldsV1 - fieldsV1: - f:metadata: - f:annotations: - .: {} - f:deployment.kubernetes.io/desired-replicas: {} - f:deployment.kubernetes.io/max-replicas: {} - f:deployment.kubernetes.io/revision: {} ... ...   pod å¯ä»¥çœ‹åˆ° pod æ˜¯ç·©æ…¢çš„å›æ”¶ ï¼Œ å¯ä»¥çœ‹åˆ°è¢«è¨­å®šäº†ç§»é™¤çš„æ™‚é–“ä»¥åŠç›¸é—œç‹€æ…‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49  --- a/pod.yaml +++ b/pod.yaml - time: \u0026#34;2020-08-10T10:05:25Z\u0026#34; + time: \u0026#34;2020-08-10T10:08:20Z\u0026#34;  + deletionGracePeriodSeconds: 30 + deletionTimestamp: \u0026#34;2020-08-10T10:08:20Z\u0026#34;  generateName: nginx-deployment-6b474476c4- - resourceVersion: \u0026#34;1513382\u0026#34; + resourceVersion: \u0026#34;1513717\u0026#34; ... - lastTransitionTime: \u0026#34;2020-08-10T10:08:20Z\u0026#34; - status: \u0026#34;True\u0026#34; + lastTransitionTime: \u0026#34;2020-08-10T10:08:20Z\u0026#34; + message: \u0026#39;containers with unready status: [nginx]\u0026#39; + reason: ContainersNotReady + status: \u0026#34;False\u0026#34;  type: Ready - lastProbeTime: null - lastTransitionTime: \u0026#34;2020-08-10T10:08:20Z\u0026#34; - status: \u0026#34;True\u0026#34; + lastTransitionTime: \u0026#34;2020-08-10T10:08:20Z\u0026#34; + message: \u0026#39;containers with unready status: [nginx]\u0026#39; + reason: ContainersNotReady + status: \u0026#34;False\u0026#34; - - containerID: docker://bb34d6af8dbe1c72c423fece3d9d797ec8a5a0b62fd82f1f46bfcf5d67157be1 - image: nginx:1.14.2 - imageID: docker-pullable://nginx@sha256:f7988fb6c02e0ce69257d9bd9cf37ae20a60f1df7563c3a2a6abe24160306b8d + - image: nginx:1.14.2 + imageID: \u0026#34;\u0026#34;  lastState: {} name: nginx - ready: true + ready: false  restartCount: 0 - started: true + started: false  state: - running: - startedAt: \u0026#34;2020-08-10T10:08:20Z\u0026#34; + waiting: + reason: ContainerCreating  hostIP: 172.18.0.5 - phase: Running - podIP: 10.32.0.6 - podIPs: - - ip: 10.32.0.6 + phase: Pending ...   å¯¦é©— propagation Policy (Orphan) deploy éƒ¨ç½²æ¸¬è©¦çš„nginx deployment\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24  cat \u0026lt;\u0026lt;EOF | kubectl apply -f - apiVersion: apps/v1 kind: Deployment metadata: name: nginx-deployment labels: app: nginx spec: replicas: 3 selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: containers: - name: nginx image: nginx:1.14.2 ports: - containerPort: 80 EOF deployment.apps/nginx-deployment created   ç‹€æ…‹ å–çš„deployment replicaset ä»¥åŠpodçš„ç‹€æ…‹\n1 2 3 4 5 6 7 8 9  kubectl get deploy,pod NAME READY UP-TO-DATE AVAILABLE AGE deployment.apps/nginx-deployment 3/3 3 3 4m44s NAME READY STATUS RESTARTS AGE pod/nginx-deployment-6b474476c4-nbtkw 1/1 Running 0 4m44s pod/nginx-deployment-6b474476c4-nkbrb 1/1 Running 0 4m44s pod/nginx-deployment-6b474476c4-zh5g7 1/1 Running 0 4m44s   å–å¾—replicasetèˆ‡podçš„ownerReferencesç¢ºå®šç‰©ä»¶ä¹‹é–“çš„é—œä¿‚\n1 2 3 4 5 6 7  kubectl get rs nginx-deployment-6b474476c4 -o go-template --template={{.metadata.ownerReferences}} [map[apiVersion:apps/v1 blockOwnerDeletion:true controller:true kind:Deployment name:nginx-deployment uid:b1d1a61d-8b51-4511-8c91-de44aaa2cdd0]] kubectl get pod nginx-deployment-6b474476c4-nbtkw -o go-template --template={{.metadata.ownerReferences}} [map[apiVersion:apps/v1 blockOwnerDeletion:true controller:true kind:ReplicaSet name:nginx-deployment-6b474476c4 uid:b052f80f-d72a-4e32-a4c4-f598274f2b07]]   destroy Orphan 1 2 3  curl -X DELETE localhost:8080/apis/apps/v1/namespaces/default/deployments/nginx-deployment \\  -d \u0026#39;{\u0026#34;kind\u0026#34;:\u0026#34;DeleteOptions\u0026#34;,\u0026#34;apiVersion\u0026#34;:\u0026#34;v1\u0026#34;,\u0026#34;propagationPolicy\u0026#34;:\u0026#34;Orphan\u0026#34;}\u0026#39; \\  -H \u0026#34;Content-Type: application/json\u0026#34;   ç‹€æ…‹ å–çš„deployment ä»¥åŠpodçš„ç‹€æ…‹\nå¾é€™å€‹ç‹€æ…‹å¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„ pod éƒ½åœ¨ Running çš„ç‹€æ…‹ï¼ŒReplicaSet ä»¥åŠ Pod éƒ½æ²’æœ‰è¢«ç§»é™¤ï¼Œåªæœ‰ Deployment è¢«æ®ºæ‰è€Œå·²ã€‚\n1 2 3 4 5 6 7 8 9  kubectl get pod,deploy,rs NAME READY STATUS RESTARTS AGE pod/nginx-deployment-6b474476c4-d6wns 1/1 Running 0 12m pod/nginx-deployment-6b474476c4-d7dtf 1/1 Running 0 12m pod/nginx-deployment-6b474476c4-m7rbz 1/1 Running 0 12m NAME DESIRED CURRENT READY AGE replicaset.apps/nginx-deployment-6b474476c4 3 3 3 12m   å°çµ å¾ä¸Šé¢ä¸‰å€‹å¯¦é©—å¯ä»¥çœ‹åˆ°ä¸åŒçš„ç§»é™¤æ–¹å¼æœƒæœ‰ä¸åŒçš„çµæœ\n  Front Ground\néœ€è¦ç­‰åˆ°é—œè¯çš„å­ç‰©ä»¶è¢«åˆªé™¤å¾Œæ‰æœƒé€²è¡Œæ¸…ç†çš„å‹•ä½œ(æ‰“ä¸ŠdeletionTimestamp)\n  BackGround\nå…ˆåˆªé™¤ç‰©ä»¶(æ‰“ä¸ŠdeletionTimestamp)ï¼Œå†æ…¢æ…¢å›æ”¶å­ç‰©ä»¶(æ‰“ä¸ŠdeletionTimestamp)\n  3.Orphan\nç›´æ¥æŠŠç‰©ä»¶åˆªé™¤ï¼ˆæ‰“ä¸ŠdeletionTimestampï¼‰ï¼Œæ‰€æœ‰å­ç‰©ä»¶ä¸åšä»»ä½•å‹•ä½œã€‚\n","description":"","id":19,"section":"posts","tags":["kubernetes"],"title":"å­¸ç¿’Kubernetes Garbage Collectionæ©Ÿåˆ¶","uri":"https://blog.jjmengze.website/posts/kubernetes/kubernetes-garbage-collection/"},{"content":"  Istio ç°¡ä»‹ Istioæä¾›äº†ä¸€å€‹å®Œæ•´çš„å¾®æœå‹™æ‡‰ç”¨è§£æ±ºæ–¹æ¡ˆï¼Œé€éç‚ºæ•´å€‹æœå‹™ç¶²è·¯æä¾›è¡Œç‚ºç›£æ§å’Œç´°ç²’åº¦çš„æ§åˆ¶ä¾†æ»¿è¶³å¾®æœå‹™æ‡‰ç”¨ç¨‹åºçš„å¤šæ¨£åŒ–éœ€æ±‚ã€‚\n Istioæä¾›äº†éå¸¸ç°¡å–®çš„æ–¹å¼å»ºç«‹å…·æœ‰ç›£æ§(monitor)ã€è² è¼‰å¹³è¡¡(load balance)ã€æœå‹™é–“çš„èªè­‰ï¼ˆservice-to-service authenticationï¼‰\u0026hellip;ç­‰åŠŸèƒ½çš„ç¶²è·¯åŠŸèƒ½ï¼Œè€Œä¸éœ€è¦å°æœå‹™çš„ç¨‹å¼ç¢¼é€²è¡Œä»»ä½•ä¿®æ”¹ã€‚\nç’°å¢ƒé…ç½® æœ¬æ¬¡å®‰è£æ˜¯ä½¿ç”¨ä¸‰å°Bare Metalå»ä½œéƒ¨ç½²ï¼Œä½œæ¥­ç³»çµ±æ¡ç”¨çš„æ˜¯Ubuntu 16.04 LTSç‰ˆã€‚\n   Kubernetes Role RAM CPUs IP Address     Master 16G 8Cores 10.20.0.154   Node1 16G 8Cores 10.20.0.164   Node2 16G 8Cores 10.20.0.174    é€™é‚Šåˆ©ç”¨çš„æ˜¯kubeadmé€²è¡Œkubernetesçš„å®‰è£ã€ç‰ˆæœ¬æ˜¯Kubernetes1.11ã€ï¼Œå¯ä»¥åƒè€ƒå®˜æ–¹ç¶²ç«™çš„éƒ¨å±¬æ–¹å¼ã€‚\nå®‰è£ Kubernetes latest version and docker and other package dependencies:\n1 2 3 4 5 6 7 8  $apt-get update \u0026amp;\u0026amp; apt-get install -y apt-transport-https curl $curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo -E apt-key add - $cat \u0026lt;\u0026lt;EOF \u0026gt;/etc/apt/sources.list.d/kubernetes.list deb http://apt.kubernetes.io/ kubernetes-xenial main EOF $sudo apt-get update $sudo apt-get install -y docker.io kubelet kubeadm kubectl  \nKubernetes v1.8+ è¦æ±‚é—œé–‰ç³»çµ± Swapï¼Œå¦‚æœä¸æƒ³é—œé–‰ç³»çµ±çš„Swapéœ€è¦ä¿®æ”¹ kubelet è¨­å®šåƒæ•¸ï¼Œæˆ‘å€‘åˆ©ç”¨ä»¥ä¸‹æŒ‡ä»¤é—œé–‰ç³»çµ±Swapï¼š\n1  $swapoff -a \u0026amp;\u0026amp; sysctl -w vm.swappiness=0  \né€éä»¥ä¸‹æŒ‡ä»¤å•Ÿå‹•Docker Daemonã€‚\n1  $systemctl enable docker \u0026amp;\u0026amp; systemctl start docker  \nå°‡æ©‹æ¥çš„IPv4æµé‡å‚³éçµ¦iptables\n1 2 3 4 5 6  $cat \u0026lt;\u0026lt;EOF \u0026gt; /etc/sysctl.d/k8s.conf net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 EOF $sysctl -p /etc/sysctl.d/k8s.conf  \nåœ¨masterç¯€é»ä¸Šä½¿ç”¨kubeadmé€²è¡Œkuberneteså¢é›†çš„åˆå§‹åŒ–\n1  $sudo kubeadm init --pod-network-cidr=192.168.0.0/16  \næœƒå¾—åˆ°ä¸‹åˆ—è¼¸å‡ºï¼Œæˆ‘å€‘åˆ©ç”¨ä¸‹åˆ—è¼¸å‡ºçš„è³‡è¨Šå°‡å…¶ä»–ç¯€é»åŠ å…¥å¢é›†ã€‚\n1 2 3 4  You can now join any number of machines by running the following on each node as root: kubeadm join 172.24.0.3:6443 --token i67sjb.0nvjxbldwuh342of --discovery-token-ca-cert-hash sha256:aa23e1e7a4d55d06fbdf34fa2a1c703dd7e7cfff735b0b0fe800b4335aff68b5  \nåœ¨å…¶ä»–ç¯€é»ä¸Šæˆ‘å€‘å¯ä»¥åˆ©ç”¨ä»¥ä¸‹æŒ‡ä»¤åŠ å…¥å¢é›†ã€‚\n1  $kubeadm join 172.24.0.3:6443 --token i67sjb.0nvjxbldwuh342of --discovery-token-ca-cert-hash sha256:aa23e1e7a4d55d06fbdf34fa2a1c703dd7e7cfff735b0b0fe800b4335aff68b5  \nåœ¨masterç¯€é»è¨­å®škube configã€‚\n1 2 3  $mkdir -p $HOME/.kube $sudo -H cp /etc/kubernetes/admin.conf $HOME/.kube/config $sudo -H chown $(id -u):$(id -g) $HOME/.kube/config  \nåœ¨master å®‰è£Kubernetes CNIï¼Œé€™é‚Šæ¡ç”¨çš„æ˜¯Calicoã€‚\n1 2  $kubectl apply -f https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/rbac-kdd.yaml $kubectl apply -f https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/kubernetes-datastore/calico-networking/1.7/calico.yaml  \nç­‰æ‰€æœ‰çš„podéƒ½å®Œæˆï¼Œåœ¨masterä¸Šæ“ä½œkubectlæŒ‡ä»¤å³å¯çœ‹åˆ°æ‰€æœ‰nodeå‘ˆç¾readyçš„ç‹€æ…‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  $kubectl get pod -n kube-system NAME READY STATUS RESTARTS AGE calico-node-cgtxh 2/2 Running 0 1m calico-node-qjrbm 2/2 Running 0 1m calico-node-v59b2 2/2 Running 0 2m coredns-78fcdf6894-dz9fs 1/1 Running 0 4m coredns-78fcdf6894-mn6k8 1/1 Running 0 4m etcd-master 1/1 Running 0 3m kube-apiserver-master 1/1 Running 0 3m kube-controller-manager-master 1/1 Running 0 3m kube-proxy-5xj2l 1/1 Running 0 4m kube-proxy-bh7wb 1/1 Running 0 1m kube-proxy-jqpqg 1/1 Running 0 1m kube-scheduler-master 1/1 Running 0 3m $kubectl get node NAME STATUS ROLES AGE VERSION master Ready master 4m v1.11.1 node-1 Ready \u0026lt;none\u0026gt; 2m v1.11.1 node-2 Ready \u0026lt;none\u0026gt; 2m v1.11.1  \nåœ¨masterç¯€é»ä¸Šï¼Œä¸‹è¼‰ä¸¦ä¸”å®‰è£helm\n1 2 3  $wget https://storage.googleapis.com/kubernetes-helm/helm-v2.9.1-linux-amd64.tar.gz $tar zxvf helm-v2.9.1-linux-amd64.tar.gz $mv linux-amd64/helm /usr/bin  \nç‚ºkubernetes Helm å»ºç«‹Tiller Service Accountä»¥åŠç¶å®šCluster-Admin Roleï¼Œæœ€å¾Œåœ¨åˆå§‹åŒ–helm ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33  $kubectl create serviceaccount tiller --namespace kube-system $cat \u0026lt;\u0026lt;EOF | kubectl create -f - kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1beta1 metadata: name: tiller-clusterrolebinding subjects: - kind: ServiceAccount name: tiller namespace: kube-system roleRef: kind: ClusterRole name: cluster-admin apiGroup: \u0026#34;\u0026#34; EOF $helm init --service-account tiller Creating /root/.helm Creating /root/.helm/repository Creating /root/.helm/repository/cache Creating /root/.helm/repository/local Creating /root/.helm/plugins Creating /root/.helm/starters Creating /root/.helm/cache/archive Creating /root/.helm/repository/repositories.yaml Adding stable repo with URL: https://kubernetes-charts.storage.googleapis.com Adding local repo with URL: http://127.0.0.1:8879/charts HELM_HOME has been configured at /root/.helm. Tiller (the Helm server-side component) has been installed into your Kubernetes Cluster. Please note: by default, Tiller is deployed with an insecure \u0026#39;allow unauthenticated users\u0026#39; policy. For more information on securing your installation see: https://docs.helm.sh/using_helm/#securing-your-helm-installation Happy Helming!  \nå®Œå¾Œæˆå¾Œå¯é€ékubectlæŒ‡ä»¤ç¢ºèª\n1 2 3 4 5 6  $kubectl get pod,svc -l app=helm -n kube-system NAME READY STATUS RESTARTS AGE pod/tiller-deploy-759cb9df9-b7n7j 1/1 Running 0 4m NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/tiller-deploy ClusterIP 10.107.71.110 \u0026lt;none\u0026gt; 44134/TCP 4m  \nå®‰è£Istio é€éå®˜æ–¹æä¾›çš„è…³æœ¬ï¼Œä¸‹è¼‰Istioä¸¦å®‰è£istioctl binary\n1 2 3  $curl -L https://git.io/getLatestIstio | sh - $cd istio-1.0.0/ $cp bin/istioctl /usr/bin/  \nåœ¨helm version 2.10.0ä»¥å‰çš„ç‰ˆæœ¬Istioé‚„æ˜¯éœ€è¦æ‰‹å®‰è£Istio CRD\n1 2  $kubectl apply -f install/kubernetes/helm/istio/templates/crds.yaml $kubectl apply -f install/kubernetes/helm/istio/charts/certmanager/templates/crds.yaml  \né€ékubectlæŒ‡ä»¤æª¢æŸ¥Istioæ˜¯å¦å®‰è£æˆåŠŸ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46  $kubectl get pod -n istio-system NAME READY STATUS RESTARTS AGE istio-citadel-7d8f9748c5-zd4vb 1/1 Running 0 4m istio-egressgateway-676c8546c5-fq55b 1/1 Running 0 4m istio-galley-5669f7c9b-q98ld 1/1 Running 0 4m istio-ingressgateway-5475685bbb-5jfwv 1/1 Running 0 4m istio-pilot-5795d6d695-2vfq9 2/2 Running 0 4m istio-policy-7f945bf487-brtxn 2/2 Running 0 4m istio-sidecar-injector-d96cd9459-ws647 1/1 Running 0 4m istio-statsd-prom-bridge-549d687fd9-mb99f 1/1 Running 0 4m istio-telemetry-6c587bdbc4-tzblq 2/2 Running 0 4m prometheus-6ffc56584f-xcpsj 1/1 Running 0 4m root@sdn-k8s-b4:/home/ubuntu|â‡’ kubectl get pod,svc NAME READY STATUS RESTARTS AGE pod/app-debug-6b4f85c9cc-gq7nx 1/1 Running 1 28d pod/config 1/1 Running 0 1d pod/hello-55f998cd56-d2q8n 1/1 Running 0 1d pod/hellogo-bb9bd67f7-ckmkc 1/1 Running 0 1d pod/myapp-pod 0/1 Completed 0 1d pod/myapp-pod2 0/1 Completed 0 1d pod/network-controller-server-tcp-7x6vm 1/1 Running 0 1d pod/network-controller-server-tcp-kjtm9 1/1 Running 0 1d pod/network-controller-server-unix-2rnfv 1/1 Running 0 1d pod/network-controller-server-unix-lh8qh 1/1 Running 0 1d pod/nginx-6f858d4d45-vrlgb 1/1 Running 0 1d pod/onos-65df85486f-tvk5t 1/1 Running 0 1d pod/skydive-agent-9x2n4 1/1 Running 0 6h pod/skydive-agent-rww57 1/1 Running 0 6h pod/skydive-analyzer-5f9556687f-gvdbj 2/2 Running 0 6h $kubectl get svc -n istio-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE istio-citadel ClusterIP 10.106.166.113 \u0026lt;none\u0026gt; 8060/TCP,9093/TCP 5m istio-egressgateway NodePort 10.100.183.7 \u0026lt;none\u0026gt; 80:31607/TCP,443:31053/TCP 5m istio-galley ClusterIP 10.109.104.146 \u0026lt;none\u0026gt; 443/TCP,9093/TCP 5m istio-ingressgateway NodePort 10.101.66.117 \u0026lt;none\u0026gt; 80:31380/TCP,443:31390/TCP,31400:31400/TCP,15011:32388/TCP,8060:32100/TCP, 15030:30847/TCP,15031:32749/TCP 5m istio-pilot ClusterIP 10.102.202.205 \u0026lt;none\u0026gt; 15010/TCP,15011/TCP,8080/TCP,9093/TCP 5m istio-policy ClusterIP 10.97.181.32 \u0026lt;none\u0026gt; 9091/TCP,15004/TCP,9093/TCP 5m istio-sidecar-injector ClusterIP 10.96.165.139 \u0026lt;none\u0026gt; 443/TCP 5m istio-statsd-prom-bridge ClusterIP 10.101.82.72 \u0026lt;none\u0026gt; 9102/TCP,9125/UDP 5m istio-telemetry ClusterIP 10.108.94.224 \u0026lt;none\u0026gt; 9091/TCP,15004/TCP,9093/TCP,42422/TCP 5m prometheus ClusterIP 10.104.3.226 \u0026lt;none\u0026gt; 9090/TCP 5m  \nç¯„ä¾‹ï¼šBookinfo Application é€™é‚Šç¤ºç¯„Istioå®˜æ–¹æä¾›çš„ç¯„ä¾‹ï¼šBookinfo Application\n1 2 3 4 5 6 7 8 9 10 11  $kubectl apply -f \u0026lt;(istioctl kube-inject -f samples/bookinfo/platform/kube/bookinfo.yaml) service/details created deployment.extensions/details-v1 created service/ratings created deployment.extensions/ratings-v1 created service/reviews created deployment.extensions/reviews-v1 created deployment.extensions/reviews-v2 created deployment.extensions/reviews-v3 created service/productpage created deployment.extensions/productpage-v1 created  \né€ékubectlæŒ‡ä»¤ç¢ºèªå®‰è£çš„podåŠservice\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  $kubectl get pod NAME READY STATUS RESTARTS AGE details-v1-fc9649d9c-tqbcn 2/2 Running 0 1m productpage-v1-58845c779c-2lqxg 2/2 Running 0 27m ratings-v1-6cc485c997-zqvqt 2/2 Running 0 1m reviews-v1-76987687b7-hfrn2 2/2 Running 0 1m reviews-v2-86749dcd5-ffmvs 2/2 Running 0 1m reviews-v3-7f4746b959-zr4ml 2/2 Running 0 1m $kubectl get services NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE details ClusterIP 10.101.208.129 \u0026lt;none\u0026gt; 9080/TCP 1m kubernetes ClusterIP 10.96.0.1 \u0026lt;none\u0026gt; 443/TCP 27m productpage ClusterIP 10.101.11.13 \u0026lt;none\u0026gt; 9080/TCP 1m ratings ClusterIP 10.105.132.197 \u0026lt;none\u0026gt; 9080/TCP 1m reviews ClusterIP 10.103.199.76 \u0026lt;none\u0026gt; 9080/TCP 1m  \nå»ºç«‹ä¸€å€‹Gatewayè®“å¢åŠå¤–éƒ¨å¯ä»¥å­˜å–\n1  $kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml  \næ¥è‘—æˆ‘å€‘é€éç€è¦½å™¨å»å­˜å–æˆ‘å€‘æœå‹™ï¼Œåœ¨ç¶²å€çš„åœ°æ–¹è¼¸å…¥http://\u0026lt;node or master ip\u0026gt;:31380/productpageï¼Œç¶²é æœƒé¡¯ä¸‹åœ–çš„ç¶²ç«™å…§å®¹ã€‚\n  Bookinfo Application ç¶²é æœå‹™\n  ä¸æ–·é‡æ–°æ•´ç†è©²æœå‹™çš„ç¶²é ï¼Œæœƒç™¼ç¾ç¶²é ä¸Šçš„æ˜Ÿæ˜Ÿçš„éƒ¨åˆ†æœ‰æ”¹è®Šã€‚å¾æ²’æ˜Ÿæ˜Ÿ==\u0026gt;é»‘æ˜Ÿæ˜Ÿ==\u0026gt;ç´…æ˜Ÿæ˜Ÿåˆ‡æ›ï¼Œåˆ†åˆ¥å°æ‡‰åˆ°podä¸­çš„ä¸‰å€‹ç‰ˆæœ¬çš„review,é è¨­çš„è¼‰å¹³è¡¡åŠŸèƒ½æ˜¯è¼ªè©¢ï¼ˆRound Robinï¼‰\nè¨­å®šdestination ruleï¼Œæ­¤æ™‚é‚„æ˜¯è¼ªè©¢æ³•\n1  $kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml  \nIntelligent Routing Istio æä¾›äº†æ™ºèƒ½è·¯ç”±ï¼ˆIntelligent Routingï¼‰ï¼Œé€™é‚Šç¤ºç¯„å¦‚ä½•ä½¿ç”¨Istioç®¡ç†å„ç¨®æœå‹™çš„æµé‡\nä¾ç…§ç‰ˆæœ¬é€²è¡Œè·¯ç”±ç®¡ç† 1 2 3 4 5  $kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml virtualservice.networking.istio.io/productpage created virtualservice.networking.istio.io/reviews created virtualservice.networking.istio.io/ratings created virtualservice.networking.istio.io/details created   é€™æ™‚å€™æˆ‘å€‘å†å›åˆ°ç€è¦½å™¨æŸ¥çœ‹Bookinfo Application ç¶²é æœå‹™ï¼Œä¸ç®¡é‡æ–°æ•´ç†å¤šå°‘æ¬¡ç¶²é ï¼Œéƒ½çœ‹ä¸åˆ°ç¶²é ä¸Šæœ‰æ˜Ÿæ˜Ÿçš„æ¨™ç¤ºï¼Œå› ç‚ºæ­¤æ™‚æ‰€æœ‰çš„è«‹æ±‚éƒ½è¢«è½‰é€åˆ°review v1ç‰ˆæœ¬ä¸Š\nä¾ç…§ç”¨æˆ¶é€²è¡Œè·¯ç”±ç®¡ç† 1 2  $kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml virtualservice.networking.istio.io/reviews create   æˆ‘å€‘å›åˆ°ç€è¦½å™¨ä¸Šï¼ŒæŒ‰ä¸‹å³ä¸Šè§’çš„Sign in çš„æŒ‰éˆ•ã€‚å¸³è™Ÿå¯†ç¢¼éƒ½ç‚ºjasonï¼Œç™»å…¥å¾Œæœƒç™¼ç¾ä¸ç®¡æ€éº¼æ›´æ–°é é¢ï¼Œç¶²é ä¸Šéƒ½æ˜¯å‘ˆç¾é»‘æ˜Ÿæ˜Ÿçš„æ¨™ç¤ºã€‚\nç•¶æˆ‘å€‘ç™»å‡ºå¾Œï¼Œä¹Ÿé€²è¡Œæ›´æ–°é é¢çš„å‹•ä½œï¼Œç¶²é ä¸Šä¸æœƒå‡ºç¾ä»»ä½•æ˜Ÿæ˜Ÿçš„æ¨™ç¤ºã€‚\nå› ç‚ºç•¶æˆ‘å€‘ç™»å…¥jasonå¾Œï¼Œæ‰€æœ‰çš„è·¯ç”±éƒ½è«‹æ±‚éƒ½æœƒè¢«è½‰ç™¼åˆ°review v2ç‰ˆæœ¬ä¸Šã€‚\nFault injection æœ‰æ™‚å€™æˆ‘å€‘çš„ç¨‹å¼ç¢¼è£¡é¢æœƒæœ‰bugï¼Œå¯ä»¥é€éæ³¨å…¥æ•…éšœçš„æ–¹å¼ç™¼ç¾é€™äº›æ½›ä¼åœ¨è£¡é¢çš„bugã€‚\nBookinfoç‰¹åˆ¥ç¤ºç¯„ä¸€å€‹httpå»¶é²çš„ä¾‹å­ï¼Œç‚ºäº†æ¸¬BookInfoçš„å¾®æœå‹™ï¼Œåœ¨reviews:v2å’Œratingsä»¥åŠç”¨æˆ¶jasonä¹‹é–“æ³¨å…¥ä¸ƒç§’å»¶é²ã€‚æ­¤æ¸¬è©¦å°‡ç™¼Bookinfoæ•…æ„å¡é€²å»çš„ä¸€å€‹éŒ¯èª¤ã€‚\nå‰›å‰›çš„è·¯ç”±è¦å‰‡ï¼Œå¦‚æœå·²ç¶“è¢«æ‚¨åˆªé™¤æ‰ã€‚è«‹å†åˆ©ç”¨ä»¥ä¸‹æŒ‡ä»¤åŠ å›ä»–çš„è·¯ç”±è¦å‰‡ã€‚\n1 2  $kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml $kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml  \nä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤æ³¨å…¥ä¸€å€‹http delay ï¼Œè©²æŒ‡ä»¤åœ¨reviews:v2å’Œratingsä»¥åŠç”¨æˆ¶jasonä¹‹é–“æ³¨å…¥ä¸ƒç§’http delay\n1  $kubectl apply -f samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml  \né€™æ™‚æˆ‘å€‘å»å­˜å–ç¶²é æœƒæ‹‹å‡ºä¸€å€‹ç•°å¸¸çš„éŒ¯èª¤ï¼Œå› ç‚ºæˆ‘å€‘æŠŠæœå‹™èˆ‡æœå‹™ä¹‹é–“çš„å­˜å–çš„æ™‚é–“æ‹‰é•·ï¼Œæˆ‘å€‘å¯ä»¥é€éæ³¨å…¥éŒ¯èª¤çš„æ–¹å¼ç™¼ç¾ä¸€å€‹å­˜å–å»¶é²çš„bugã€‚\n  æ³¨å…¥å»¶é²å¾Œçš„Bookinfo Applicationç¶²é æœå‹™\n  çµè«– ç©é istio ä¹‹å¾Œç™¼ç¾åŠŸèƒ½ååˆ†å¼·å¤§ï¼Œä½†æ¶æ§‹éæ–¼è¤‡é›œç•¶æœ‰å•é¡Œå‡ºç¾æ™‚ï¼Œç¶­é‹èˆ‡é–‹ç™¼äººå“¡é›£ä»¥æ’æŸ¥ç‹€æ³èˆ‡å•é¡Œçš„ç™¼ç”Ÿé»ï¼Œä½†ç›®å‰ istio é‚„åœ¨ 1.0 ç‰ˆæœ¬ æœªä¾†ç™¼å±•èµ·ä¾†æ‡‰è©²æ˜¯ä¸€é ­çŒ›ç¸ ï¼ŒæœƒæŒçºŒé—œæ³¨ service mesh çš„ç›¸é—œè­°é¡Œã€‚\nistio èƒŒå¾Œæ’è…°çš„å…¬å¸éå¸¸å¯æ€• ï¼Œå¯ä»¥è§€å¯Ÿé€™å€‹å°ˆæ¡ˆå¾ŒçºŒçš„èµ°å‘ï¼Œä½œç‚ºå­¸ç¿’çš„æ–¹å‘ï¼ï¼\n","description":"","id":25,"section":"posts","tags":["servicemesh","kubernetes"],"title":"service mesh ä¹‹ Istio 1.0 å®‰è£åŠæ¥µåº¦ç°¡æ˜“æ“ä½œ","uri":"https://blog.jjmengze.website/posts/istio/istio1.0-install/"},{"content":"  Serverless åœ¨é€²å…¥Kubelessä¹‹å‰å…ˆç§‘æ™®ä¸€ä¸‹ä»€éº¼æ˜¯Serverlessã€‚\nå°±å­—é¢ä¸Šçš„æ„æ€ä¾†èªªå°±æ˜¯æ²’æœ‰Serverï¼Œé‚£æ²’æœ‰Serveråˆæ˜¯ä»€éº¼æ„æ€ï¼Ÿ\nå…ˆå¾è¨­è¨ˆé–‹ç™¼åˆ°éƒ¨ç½²é–‹å§‹ï¼\næˆ‘å€‘æƒ³è¦åšå‡ºä¸€å¥—ç³»çµ±è»Ÿé«”ï¼Œå‹¢å¿…æœƒç¶“æ­·è¨­è¨ˆé–‹ç™¼éƒ¨ç½²\u0026hellip;ç­‰æµç¨‹ã€‚\næœ€å¾Œç¸½æœƒéƒ¨ç½²åˆ°å–®å°æˆ–æ˜¯å¤šå°çš„Serverä¸Šé¢ï¼Œç•¶æŠŠæœå‹™æ¶è¨­åˆ°Serverä¸Šæ™‚æœ‰è¨±å¤šæ–¹æ¡ˆå¯ä»¥æä¾›æˆ‘å€‘åƒè€ƒã€‚\nä¾‹å¦‚: Google æ‰€æä¾›çš„ GKEï¼ŒAWS æ‰€æä¾›çš„ EC2 äº¦æˆ–æ˜¯ Microsoft æ‰€æä¾›çš„ Azureã€‚\né¸æ“‡å®Œä½¿ç”¨å“ªå€‹é›²æœå‹™å•†æ‰€æä¾›çš„Cloudå¾Œï¼Œé‚„è¦è€ƒæ…®é€™å¥—ç³»çµ±ç©¶ç«Ÿéœ€è¦å¤šå°‘å°Serverã€å¤šå¤§ç©ºé–“Stroage\u0026hellip;ç­‰å•é¡Œã€‚\nåœ¨å¾®æœå‹™çš„æ¶æ§‹ä¹‹ä¸‹ï¼Œæˆ‘å€‘çš„æ¯å€‹æœå‹™æœƒé‹è¡Œåœ¨å„å€‹Serverä¸Šï¼ˆå…ˆä¸è€ƒæ…®Container XDï¼‰\nåœ¨ä½ çš„æ¥­å‹™æ“´å±•å¾Œï¼Œæˆ‘å€‘å°±éœ€è¦æ›´å¤šæ›´å¤šçš„è³‡æºï¼Œä¹Ÿå°±æ˜¯æ›´å¤šæ›´å¤šçš„Serverã€‚\nå¾ˆå¤šå¾®æœå‹™äº‹å¯¦ä¸Šè¢«callåˆ°çš„æ©Ÿæœƒå¾ˆå°‘ï¼Œä½†ä»–é‚„æ˜¯ä½”äº†ä¸€å°Serverçš„è³‡æºåŠç©ºé–“ã€‚åŒæ™‚é€™äº›å¾ˆå°‘è¢«ä½¿ç”¨åˆ°çš„å¾®æœå‹™ä¹Ÿä¸€é»ä¸€æ»´çš„èŠ±æ‰ä½ çš„éŒ¢ï¼ˆé–‹Serverå¯æ˜¯è¦éŒ¢çš„å•Šï¼ï¼ï¼ï¼‰\næœ‰äº†Serverlessåˆæˆ–æ˜¯ç¨±ç‚ºFaaSçš„å‡ºç¾å¾Œï¼Œæˆ‘å€‘å†ä¹Ÿä¸éœ€è¦å»é—œå¿ƒé‚£äº›Serverï¼Œåªè¦æŠŠå¾®æœå‹™source codeæäº¤çµ¦é›²æœå‹™å•†ï¼Œé›²æœå‹™å•†èƒ½æä¾›ä¸€å€‹é‹è¡Œçš„ç’°å¢ƒçµ¦ä½ ï¼Œç¸½è€Œè¨€ä¹‹å°±æ˜¯é–‹ç™¼è€…ä¸éœ€è¦å†å»é—œå¿ƒåº•ä¸‹Infrastructure Layerã€‚\nKubeless ç°¡ä»‹ Kubelessæ˜¯ä¸€å€‹Kubernetes-native ç„¡ä¼ºæœå™¨(Serverless)æ¡†æ¶ï¼Œåªè¦æ’°å¯«ç¨‹å¼ï¼ˆFunctionï¼‰ï¼Œè€Œä¸éœ€è¦äº†è§£åº•å±¤åŸºç¤å»ºè¨­ï¼ˆInfrastructure Layerï¼‰ã€‚Kubelessåˆ©ç”¨Kubernetesè³‡æºæä¾›è‡ªå‹•æ“´å±•ï¼ŒAPIè·¯ç”±ï¼Œç›£æ§ï¼Œæ•…éšœæ’é™¤\u0026hellip;ç­‰åŠŸèƒ½ã€‚\nç’°å¢ƒé…ç½® æœ¬æ¬¡å®‰è£æ˜¯ä½¿ç”¨OpenStackä¸Šçš„ä¸‰å°è™›æ“¬æ©Ÿå™¨å»ä½œéƒ¨ç½²ï¼Œä½œæ¥­ç³»çµ±æ¡ç”¨çš„æ˜¯Ubuntu 16.04 LTSç‰ˆã€‚\n   Kubernetes Role RAM CPUs IP Address     Master 8G 4Cores 172.24.0.2   Node1 8G 4Cores 172.24.0.2   Node2 8G 4Cores 172.24.0.4    éƒ¨ç½²kubernetes é€™é‚Šåˆ©ç”¨çš„æ˜¯kubeadmé€²è¡Œkubernetesçš„å®‰è£ã€ç‰ˆæœ¬æ˜¯Kubernetes1.10ã€ï¼Œå¯ä»¥åƒè€ƒå®˜æ–¹ç¶²ç«™çš„éƒ¨å±¬æ–¹å¼ã€‚\nå®‰è£å¥—ä»¶ å®‰è£ Kubernetes latest version and other dependencies:\n1 2 3 4 5 6 7  $curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add - $cat \u0026lt;\u0026lt;EOF \u0026gt;/etc/apt/sources.list.d/kubernetes.list deb http://apt.kubernetes.io/ kubernetes-xenial main EOF $sudo apt-get update $sudo apt-get install -y docker.io kubelet kubeadm kubectl  \né—œé–‰Swap Kubernetes v1.8+ è¦æ±‚é—œé–‰ç³»çµ± Swapï¼Œå¦‚æœä¸æƒ³é—œé–‰ç³»çµ±çš„Swapéœ€è¦ä¿®æ”¹ kubelet è¨­å®šåƒæ•¸ï¼Œæˆ‘å€‘åˆ©ç”¨ä»¥ä¸‹æŒ‡ä»¤é—œé–‰ç³»çµ±Swapï¼š\n1  $swapoff -a \u0026amp;\u0026amp; sysctl -w vm.swappiness=0  \né‡å•ŸDocker é€éä»¥ä¸‹æŒ‡ä»¤å•Ÿå‹•Docker Daemonã€‚\n1  $systemctl enable docker \u0026amp;\u0026amp; systemctl start docker  \nIPv4 forwardè¨­å®š å°‡æ©‹æ¥çš„IPv4æµé‡å‚³éçµ¦iptables\n1 2 3 4 5 6  $cat \u0026lt;\u0026lt;EOF \u0026gt; /etc/sysctl.d/k8s.conf net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 EOF $sysctl -p /etc/sysctl.d/k8s.conf  \nCluster åˆå§‹åŒ– åœ¨masterç¯€é»ä¸Šä½¿ç”¨kubeadmé€²è¡Œkuberneteså¢é›†çš„åˆå§‹åŒ–\n1  $sudo kubeadm init --pod-network-cidr=192.168.0.0/16   1  $sudo kubeadm init --pod-network-cidr=192.168.0.0/16   æœƒå¾—åˆ°ä¸‹åˆ—è¼¸å‡ºï¼Œæˆ‘å€‘åˆ©ç”¨ä¸‹åˆ—è¼¸å‡ºçš„è³‡è¨Šå°‡å…¶ä»–ç¯€é»åŠ å…¥å¢é›†ã€‚\n1 2 3 4 5  ... You can now join any number of machines by running the following on each node as root: kubeadm join 172.24.0.2:6443 --token i67sjb.0nvjxbldwuh342of --discovery-token-ca-cert-hash sha256:aa23e1e7a4d55d06fbdf34fa2a1c703dd7e7cfff735b0b0fe800b4335aff68b5  \nåœ¨å…¶ä»–ç¯€é»ä¸Šæˆ‘å€‘å¯ä»¥åˆ©ç”¨ä»¥ä¸‹æŒ‡ä»¤åŠ å…¥å¢é›†ã€‚\n1  $kubeadm join 172.24.0.2:6443 --token i67sjb.0nvjxbldwuh342of --discovery-token-ca-cert-hash sha256:aa23e1e7a4d55d06fbdf34fa2a1c703dd7e7cfff735b0b0fe800b4335aff68b5   åœ¨masterç¯€é»è¨­å®škube configã€‚\n1 2 3  $mkdir -p $HOME/.kube $sudo -H cp /etc/kubernetes/admin.conf $HOME/.kube/config $sudo -H chown $(id -u):$(id -g) $HOME/.kube/config  \nå®‰è£Calico CNI 1 2  $kubectl apply -f https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/rbac-kdd.yaml $kubectl apply -f https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/kubernetes-datastore/calico-networking/1.7/calico.yaml   æª¢æŸ¥ç’°å¢ƒ åœ¨masterä¸Šæ“ä½œkubectlæŒ‡ä»¤å³å¯çœ‹åˆ°æ‰€æœ‰nodeå‘ˆç¾readyçš„ç‹€æ…‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  $kubectl get pod -n kube-system NAME READY STATUS RESTARTS AGE calico-node-cgtxh 2/2 Running 0 1m calico-node-qjrbm 2/2 Running 0 1m calico-node-v59b2 2/2 Running 0 2m coredns-78fcdf6894-dz9fs 1/1 Running 0 4m coredns-78fcdf6894-mn6k8 1/1 Running 0 4m etcd-master 1/1 Running 0 3m kube-apiserver-master 1/1 Running 0 3m kube-controller-manager-master 1/1 Running 0 3m kube-proxy-5xj2l 1/1 Running 0 4m kube-proxy-bh7wb 1/1 Running 0 1m kube-proxy-jqpqg 1/1 Running 0 1m kube-scheduler-master 1/1 Running 0 3m $kubectl get node NAME STATUS ROLES AGE VERSION master Ready master 4m v1.10.0 node-1 Ready \u0026lt;none\u0026gt; 2m v1.10.0 node-2 Ready \u0026lt;none\u0026gt; 2m v1.10.0  \nå®‰è£Kubeless å®‰è£CLI å®‰è£æ“ä½œ Kubeless çš„ CLI\n1 2 3 4  $wget https://github.com/kubeless/kubeless/releases/download/v1.0.0-alpha.7/kubeless_linux-amd64.zip apt install -y unzip unzip kubeless_linux-amd64.zip $sudo mv ~/bundles/kubeless_linux-amd64 /usr/local/bin/  \næª¢æŸ¥CLIæ˜¯å¦å®‰è£å®Œæˆ\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  Serverless framework for Kubernetes Usage: kubeless [command] Available Commands: autoscale manage autoscale to function on Kubeless completion Output shell completion code for the specified shell. function function specific operations get-server-config Print the current configuration of the controller help Help about any command topic manage message topics in Kubeless trigger trigger specific operations version Print the version of Kubeless Flags: -h, --help help for kubeless Use \u0026#34;kubeless [command] --help\u0026#34; for more information about a command.  \nå®‰è£Kubeless Kubelesså®˜æ–¹é‡å°ä¸åŒKubernetesç’°å¢ƒæä¾›äº†å¤šç¨®è…³æœ¬ï¼ˆéRBACï¼ŒRBACå’Œopenshiftï¼‰ï¼Œé€™é‚Šæˆ‘æ¡ç”¨çš„æ˜¯æœ‰RBACçš„éƒ¨ç½²ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13  $kubectl create ns kubeless namespace/kubeless created $kubectl create -f https://github.com/kubeless/kubeless/releases/download/v1.0.0-alpha.8/kubeless-v1.0.0-alpha.8.yaml configmap/kubeless-config created deployment.apps/kubeless-controller-manager created serviceaccount/controller-acct created clusterrole.rbac.authorization.k8s.io/kubeless-controller-deployer created clusterrolebinding.rbac.authorization.k8s.io/kubeless-controller-deployer created customresourcedefinition.apiextensions.k8s.io/functions.kubeless.io created customresourcedefinition.apiextensions.k8s.io/httptriggers.kubeless.io created customresourcedefinition.apiextensions.k8s.io/cronjobtriggers.kubeless.io created  \nå¯ä»¥é€ékubetlæŒ‡ä»¤è§€å¯Ÿkubelessæ˜¯å¦æœ‰è¢«éƒ¨ç½²èµ·ä¾†\n1 2 3 4 5 6 7 8 9 10 11 12  kubectl get pods -n kubeless NAME READY STATUS RESTARTS AGE kubeless-controller-manager-66868fb689-77fkp 3/3 Running 0 1m $kubectl get deployment -n kubeless NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE kubeless-controller-manager 1 1 1 1 2m $kubectl get crd NAME CREATED AT cronjobtriggers.kubeless.io 2018-08-24T12:44:57Z functions.kubeless.io 2018-08-24T12:44:57Z httptriggers.kubeless.io 2018-08-24T12:44:57Z   ### å®‰è£Kubeless UI å®˜æ–¹æä¾›äº†æ“ä½œKubelessçš„Dashboardï¼Œå¯ä»¥é€éè©²ä»‹é¢æ“ä½œã€‚ ```bash $kubectl create -f https://raw.githubusercontent.com/kubeless/kubeless-ui/master/k8s.yaml å¯ä»¥é€ékubetlæŒ‡ä»¤è§€å¯ŸKubelessçš„Dashboardæ˜¯å¦æœ‰è¢«éƒ¨ç½²èµ·ä¾†\n1 2 3 4 5 6 7  kubectl -n kubeless get pod,svc NAME READY STATUS RESTARTS AGE pod/kubeless-controller-manager-66868fb689-77fkp 3/3 Running 0 39m pod/ui-6d868664c5-kr99m 2/2 Running 0 1m NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE service/ui NodePort 10.100.15.46 \u0026lt;none\u0026gt; 3000:30722/TCP 1m   å¯ä»¥é€Browserç€è¦½ Kubeless UI(172.24.0.2:30722)\n  Kubeless Dashboard\n  å»ºç«‹åŠæ¸¬è©¦Function é€™é‚Šç¤ºç¯„ä¸€å€‹ç°¡å–®çš„è³ªæ•¸åˆ¤æ–·çš„Functionï¼Œä»¥Goç‚ºä¾‹ã€‚\né€™é‚Šæœƒç¤ºç¯„å¾UIä¸Šæ“ä½œä»¥åŠä½¿ç”¨CLIæ“ä½œ\nUIæ“ä½œKubeless é€éBrowseré€£é€²Kubeless Dashboard å¾Œé»é¸ Create Function\n  å»ºç«‹ä¸€å€‹Function\n  æŒ‰ä¸‹Createå¾Œï¼Œå°±å¯ä»¥æ’°å¯«æˆ‘å€‘åˆ¤æ–·è³ªæ•¸çš„ç¨‹å¼ç¢¼ã€‚\nç¨‹å¼çš„æ’°å¯«ç•«é¢æœƒå¦‚ä¸‹åœ–æ‰€ç¤º\n  åœ¨functionå…§æ’°å¯«æˆ‘å€‘æƒ³è¦çš„åŠŸèƒ½\n  æ’°å¯«å®Œï¼Œè³ªæ•¸åˆ¤æ–·çš„functionå¤§è‡´ä¸Šæ˜¯é€™å€‹æ¨£å­\n  è³ªæ•¸åˆ¤æ–·çš„function\n  æ¸¬è©¦Function æ¥è‘—å¯ä»¥è¼¸å…¥å³å´çš„Requestï¼Œå¡«å…¥ä½ æƒ³è¦åˆ¤æ–·çš„æ•¸å€¼ã€‚å¦‚ï¼š177,9487\u0026hellip;ç­‰æ•¸å€¼ã€‚\nå¡«å®Œæ•¸å€¼å¾ŒæŒ‰ä¸‹Run fuctionï¼Œç™¼ç¾åº•ä¸‹æœƒæ²’æœ‰è¼¸å‡ºï¼ï¼ï¼\n å› ç‚ºkubeless UIæœ‰RBACçš„å•é¡Œï¼Œé€™é‚Šå·æ‡¶ç›´æ¥çµ¦cluster-adminã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  $cat \u0026lt;\u0026lt;EOF | kubectl create -f - apiVersion: rbac.authorization.k8s.io/v1beta1 kind: ClusterRoleBinding metadata: name: kubeless-ui-default roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: cluster-admin subjects: - kind: User name: system:serviceaccount:kubeless:ui-acct apiGroup: rbac.authorization.k8s.io EOF     é€™é‚Šé‚„æœƒç”¢ç”Ÿå¦å¤–ä¸€å€‹å•é¡Œï¼Œåœ¨Kubeless UI æ‰€ç”¢ç”Ÿçš„Requeståªèƒ½æ˜¯Stringå‹æ…‹çš„ã€‚\nåœ¨é€™å€‹ç¯„ä¾‹ä¹‹ä¸­æœƒçœ‹åˆ°ä»¥ä¸‹è¼¸å‡ºã€‚\n   åªèƒ½å¾—åˆ°must be a positive integerçš„å›æ‡‰\n  è¦è§£æ±ºé€™å€‹å•é¡Œæˆ‘å€‘å¯ä»¥è—‰ç”±Kubeless CLIç™¼é€è«‹æ±‚çµ¦ç‰¹å®šçš„functionã€‚\n1 2 3 4 5 6  $kubeless function call checkprime --data 9487 éè³ªæ•¸ $kubeless function call checkprime --data 177 éè³ªæ•¸ $kubeless function call checkprime --data 7 è³ªæ•¸   çµæŸå¯¦é©—å¾Œæˆ‘å€‘å¯ä»¥é€éKubeless UIåˆªé™¤æ‰å‰›å‰›å»ºç«‹çš„checkprime function\nCLIæ“ä½œKubeless å»ºç«‹ä¸€å€‹checkprime.goï¼Œä¸¦ä¸”æ’°å¯«è³ªæ•¸åˆ¤æ–·çš„functionã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26  package kubeless import ( \u0026#34;strconv\u0026#34; \u0026#34;fmt\u0026#34; \u0026#34;github.com/kubeless/kubeless/pkg/functions\u0026#34; ) func IsPrime(event functions.Event, context functions.Context) (string, error) { num, err := strconv.Atoi(event.Data) if err != nil { fmt.Println(err) return \u0026#34;must be a positive integer\u0026#34;, nil } if num \u0026lt;= 1 { return \u0026#34;must be a positive integer\u0026#34;, nil } for i := 2; i \u0026lt; num; i++ { if num%i == 0 { return \u0026#34;éè³ªæ•¸\u0026#34;, nil break } } return \u0026#34;è³ªæ•¸\u0026#34;, nil }   é€ékubeless CLIå¹«æˆ‘å€‘å»ºç«‹Functionåˆ°ç’°å¢ƒä¸Š\n1 2 3 4  $kubeless function deploy checkprime --runtime go1.10 --from-file checkprime.go --handler checkprime.IsPrime INFO[0000] Deploying function... INFO[0000] Function checkprime submitted for deployment INFO[0000] Check the deployment status executing \u0026#39;kubeless function ls checkprime\u0026#39;   é€éKubeless CLI ã€ Kubectl å»ç¢ºèªFunction æœ‰æ²’æœ‰æˆåŠŸçš„è¢«å»ºç«‹åˆ°ç’°å¢ƒä¸Šï¼š\n1 2 3 4 5 6 7 8 9 10 11  $kubectl get functions NAME AGE checkprime 1m $kubeless function ls NAME NAMESPACE\tHANDLER RUNTIME\tDEPENDENCIES\tSTATUS checkprime\tdefault checkprime.IsPrime\tgo1.10 1/1 READY $kubectl get po NAME READY STATUS RESTARTS AGE checkprime-7d4f$b7b64c-k47w9 1/1 Running 0 37s   æ¸¬è©¦Function é€éKubeless CLIå»æ¸¬è©¦å‰›å‰›æ’°å¯«çš„è³ªæ•¸åˆ¤æ–·æ˜¯å¦æ­£ç¢º\n1 2 3 4 5 6  $kubeless function call checkprime --data 9487 éè³ªæ•¸ $kubeless function call checkprime --data 177 éè³ªæ•¸ $kubeless function call checkprime --data 7 è³ªæ•¸   å¦å¤–ä¹Ÿèƒ½é€ékubernetesæŠŠè©²function proxy å‡ºä¾†é€²è¡Œæ¸¬è©¦\n1 2 3 4 5 6 7 8 9  $kubectl proxy -p 34567 \u0026amp; [1] 3533 Starting to serve on 127.0.0.1:34567 $curl --data 9487\\  --header \u0026#34;Content-Type:application/json\u0026#34; \\  localhost:34567/api/v1/namespaces/default/services/checkprime:8080/proxy/ éè³ªæ•¸   çµæŸå¯¦é©—å¾Œæˆ‘å€‘å¯ä»¥é€éKubeless CLIåˆªé™¤æ‰å‰›å‰›å»ºç«‹çš„checkprime function\n1 2 3 4 5  $kubeless function delete checkprime $kubeless function ls NAME\tNAMESPACE\tHANDLER\tRUNTIME\tDEPENDENCIES\tSTATUS   å°çµ é‚„æœ‰å¾ˆå¤šé–‹æºçš„ FAAS æ¡†æ¶å¯ä»¥ç›´æ¥å¥—ç”¨åœ¨ kubernetes ä¸Šï¼Œæœ¬ç¯‡æ–‡ç« åªé‡å° kubeless åšä¸€å€‹éå¸¸ç°¡å–®çš„ Demo ï¼Œæœ‰æ©Ÿæœƒçš„è©±é‚„æœƒç©ç©çœ‹ Knative , fission \u0026hellip;ç­‰æ¡†æ¶ã€‚\n","description":"","id":26,"section":"posts","tags":["kubernetes","serverless"],"title":"FAASä¹‹kubelessçš„æ–°æ»‹å‘³","uri":"https://blog.jjmengze.website/posts/kubeless/kubeless/"},{"content":"  kollaæ˜¯ç‚ºäº†æä¾›production-readyçš„ OpenStack Cloud ä¹‹containerå’Œdeployment toolsã€‚\nç’°å¢ƒé…ç½® æœ¬æ¬¡å®‰è£æ˜¯ä½¿ç”¨ä¸‰å°Bare Metalå»ä½œéƒ¨ç½²ï¼Œä½œæ¥­ç³»çµ±æ¡ç”¨çš„æ˜¯Ubuntu 16.04 LTSç‰ˆã€‚\n   Kubernetes Role OpeStack Role RAM CPUs IP Address     Master Controller 16G 8Cores 10.0.0.190   Node1 Compute1 16G 8Cores 10.0.0.191   Node2 Compute2 16G 8Cores 10.0.0.192    éƒ¨ç½²kubernetes é€™é‚Šåˆ©ç”¨çš„æ˜¯kubeadmé€²è¡Œkubernetesçš„å®‰è£ã€ç‰ˆæœ¬æ˜¯Kubernetes1.10ã€ï¼Œå¯ä»¥åƒè€ƒå®˜æ–¹ç¶²ç«™çš„éƒ¨å±¬æ–¹å¼ã€‚\nå®‰è£ Kubernetes latest version and other dependencies:\n1 2 3 4 5 6 7 8 9  $curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo -E apt-key add - $cat \u0026lt;\u0026lt;EOF \u0026gt; kubernetes.list deb http://apt.kubernetes.io/ kubernetes-xenial main EOF $sudo cp -aR kubernetes.list /etc/apt/sources.list.d/kubernetes.list $sudo apt-get update $sudo apt-get install -y docker.io kubelet kubeadm kubectl   Kubernetes v1.8+ è¦æ±‚é—œé–‰ç³»çµ± Swapï¼Œå¦‚æœä¸æƒ³é—œé–‰ç³»çµ±çš„Swapéœ€è¦ä¿®æ”¹ kubelet è¨­å®šåƒæ•¸ï¼Œæˆ‘å€‘åˆ©ç”¨ä»¥ä¸‹æŒ‡ä»¤é—œé–‰ç³»çµ±Swapï¼š\n1  $swapoff -a \u0026amp;\u0026amp; sysctl -w vm.swappiness=0   é€éä»¥ä¸‹æŒ‡ä»¤å•Ÿå‹•Docker Daemonã€‚\n1  $systemctl enable docker \u0026amp;\u0026amp; systemctl start docker   ç¢ºèªDockeræ˜¯å¦æ”¯æ´Cgroup Driveræˆ–æ˜¯Systemd Driverï¼Œé€²ä¸€æ­¥ä¿®æ”¹ kubelet è¨­å®šåƒæ•¸ã€‚\n1 2  $CGROUP_DRIVER=$(sudo docker info | grep \u0026#34;Cgroup Driver\u0026#34; | awk \u0026#39;{print $3}\u0026#39;) $sudo sed -i \u0026#34;s|KUBELET_KUBECONFIG_ARGS=|KUBELET_KUBECONFIG_ARGS=--cgroup-driver=$CGROUP_DRIVER|g\u0026#34; /etc/systemd/system/kubelet.service.d/10-kubeadm.conf   å°‡æ©‹æ¥çš„IPv4æµé‡å‚³éçµ¦iptables\n1 2 3 4 5 6  $cat \u0026lt;\u0026lt;EOF \u0026gt; /etc/sysctl.d/k8s.conf net.ipv4.ip_forward = 1 net.bridge.bridge-nf-call-ip6tables = 1 net.bridge.bridge-nf-call-iptables = 1 EOF $sysctl -p /etc/sysctl.d/k8s.conf   è¨­ç½®Kubernetes Server CIDRçš„DNSä½ç½®ã€‚\n1  $sudo sed -i \u0026#39;s/10.96.0.10/10.3.3.10/g\u0026#39; /etc/systemd/system/kubelet.service.d/10-kubeadm.conf   åˆ©ç”¨ä»¥ä¸‹é‡æ–°è¼‰å…¥kubeletç›¸é—œçš„å•Ÿå‹•åƒæ•¸\n1 2 3 4  $sudo systemctl daemon-reload $sudo systemctl stop kubelet $sudo systemctl enable kubelet $sudo systemctl start kubelet   åœ¨masterç¯€é»ä¸Šä½¿ç”¨kubeadmé€²è¡Œkubernetes å¢é›†çš„åˆå§‹åŒ–\n1  $sudo kubeadm init --feature-gates CoreDNS=true --pod-network-cidr=10.1.0.0/16 --service-cidr=10.3.3.0/24   æœƒå¾—åˆ°ä¸‹åˆ—è¼¸å‡ºï¼Œæˆ‘å€‘åˆ©ç”¨ä¸‹åˆ—è¼¸å‡ºçš„è³‡è¨Šå°‡å…¶ä»–ç¯€é»åŠ å…¥å¢é›†ã€‚\n1 2 3 4  You can now join any number of machines by running the following on each node as root: kubeadm join 10.0.0.181:6443 --token pieol0.2kfzpwhosxuqhe6t --discovery-token-ca-cert-hash sha256:e55b423135642404ffc60bcae4793732f18b4ce2866a8419c87b7dd92724a481   åœ¨å…¶ä»–ç¯€é»ä¸Šæˆ‘å€‘å¯ä»¥åˆ©ç”¨ä»¥ä¸‹æŒ‡ä»¤åŠ å…¥å¢é›†ã€‚\n1  $kubeadm join 10.0.0.181:6443 --token pieol0.2kfzpwhosxuqhe6t --discovery-token-ca-cert-hash sha256:e55b423135642404ffc60bcae4793732f18b4ce2866a8419c87b7dd92724a481   åœ¨masterç¯€é»è¨­å®škube configã€‚\n1 2 3  $mkdir -p $HOME/.kube $sudo -H cp /etc/kubernetes/admin.conf $HOME/.kube/config $sudo -H chown $(id -u):$(id -g) $HOME/.kube/config   åœ¨master å®‰è£Kubernetes CNIï¼Œé€™é‚Šæ¡ç”¨çš„æ˜¯Canalã€‚\n1 2 3 4 5  $wget https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/canal/rbac.yaml $kubectl apply -f rbac.yaml $wget https://docs.projectcalico.org/v3.1/getting-started/kubernetes/installation/hosted/canal/canal.yaml $sed -i \u0026#34;s@10.244.0.0/16@10.1.0.0/16@\u0026#34; canal.yaml $kubectl apply -f canal.yaml   å› ç‚ºæˆ‘å€‘è¦æŠŠkubernetes masterç•¶ä½œopenstack controllerçš„è§’è‰²ï¼Œæˆ‘å€‘å°‡kubernetes master çš„ç¯€é»æ±¡æŸ“æ‹¿æ‰ã€‚\n1  $kubectl taint nodes --all=true node-role.kubernetes.io/master:NoSchedule-   åœ¨CNIå®‰è£å®Œæˆå¾Œå¯é€éä¸‹åˆ—æŒ‡ä»¤ä¾†æª¢æŸ¥ï¼ŒNode \u0026amp; Podæ˜¯å¦éƒ½æº–å‚™å¥½äº†ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20  $kubectl get pod,node -o wide --all-namespaces NAMESPACE NAME READY STATUS RESTARTS AGE kube-system pod/canal-297sw 3/3 Running 0 2m kube-system pod/canal-f82qj 3/3 Running 0 2m kube-system pod/canal-zxfbk 3/3 Running 0 2m kube-system pod/coredns-7997f8864c-cglcr 1/1 Running 0 9m kube-system pod/coredns-7997f8864c-sxf2c 1/1 Running 0 9m kube-system pod/etcd-node1 1/1 Running 0 8m kube-system pod/kube-apiserver-node1 1/1 Running 0 8m kube-system pod/kube-controller-manager-node1 1/1 Running 0 8m kube-system pod/kube-proxy-6gwws 1/1 Running 0 6m kube-system pod/kube-proxy-9xbdq 1/1 Running 0 6m kube-system pod/kube-proxy-z54k4 1/1 Running 0 9m kube-system pod/kube-scheduler-node1 1/1 Running 0 8m NAME STATUS ROLES AGE VERSION node1 Ready master 8m v1.10.3 node2 Ready master 8m v1.10.3 node3 Ready master 8m v1.10.3   åˆ©ç”¨BusyBox ï¼Œé©—è­‰Kubernetes ç’°å¢ƒä¾‹å¦‚DNS æ˜¯å¦æœ‰é€šã€‚\n1 2 3 4 5 6 7 8 9  $kubectl run -i -t $(uuidgen) --image=busybox --restart=Never $nslookup kubernetes Server: 10.3.3.10 Address 1: 10.3.3.10 kube-dns.kube-system.svc.cluster.local Name: kubernetes Address 1: 10.3.3.1 kubernetes.default.svc.cluster.local   ç‚ºkubernetes Helm å»ºç«‹Tiller Service Accountä»¥åŠç¶å®šCluster-Admin Role\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  $kubectl create serviceaccount tiller --namespace kube-system $cat \u0026lt;\u0026lt;EOF | kubectl create -f - kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1beta1 metadata: name: tiller-clusterrolebinding subjects: - kind: ServiceAccount name: tiller namespace: kube-system roleRef: kind: ClusterRole name: cluster-admin apiGroup: \u0026#34;\u0026#34; EOF   æ¥è‘—æˆ‘å€‘å®‰è£Kubernetes Helmï¼Œç”¨ä¾†ç®¡ç†Helm packageçš„å…ƒä»¶ã€‚\n1 2 3 4  $curl -L https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get \u0026gt; get_helm.sh $chmod 700 get_helm.sh $./get_helm.sh $helm init --service-account tiller   ç”±æ–¼kolla kubernetes éœ€è¦ç”¨åˆ°ansible git ï¼Œæˆ‘å€‘åœ¨masterçš„ç¯€é»éœ€è¦å®‰è£ansible ï¼Œå…¶ä»–ç¯€é»éœ€å®‰è£pythonã€‚\n1 2 3  $sudo apt-get update \u0026amp;\u0026amp; sudo apt-get install -y software-properties-common git python python-pip $sudo apt-add-repository -y ppa:ansible/ansible $sudo apt-get update \u0026amp;\u0026amp; sudo apt-get install -y ansible   å»ºç«‹ä¸€å€‹è³‡æ–™å¤¾æ–¹ä¾¿æˆ‘å€‘æ¥ä¸‹ä¾†çš„æ­¥é©Ÿ\n1 2  $mkdir kolla-bringup $cd kolla-bringup   ä¸‹è¼‰ kolla-kubernetes \u0026amp; kolla ansible\n1 2 3 4 5 6 7  $git clone http://github.com/openstack/kolla-ansible $git clone http://github.com/openstack/kolla-kubernetes $cd kolla-kubernetes $git checkout 22ed0c232d7666afb6e288001b8814deea664992 $cd ../kolla-ansible $git checkout origin/stable/pike $cd ..   ä½¿ç”¨pip å®‰è£kolla-kubernetes \u0026amp; kolla-ansibleæ‰€éœ€è¦çš„å¥—ä»¶\n1  $sudo pip install -U kolla-ansible/ kolla-kubernetes   æŠŠç›¸é—œè¨­å®šæª”è£½åˆ°/etcåº•ä¸‹\n1 2  $cp -Ra kolla-kubernetes/etc/kolla/ /etc $cp -Ra kolla-kubernetes/etc/kolla-kubernetes/ /etc   pipå‰›å‰›å®‰è£çš„é …ç›®é€™æ™‚å€™å¯ä»¥å¹«æˆ‘å€‘ç”Ÿæˆdefault passwords\n1  $sudo kolla-kubernetes-genpwd   å»ºç«‹ä¸€å€‹Kubernetes namespacesä¾†éš”é›¢Kolla deployment\n1  $kubectl create namespace kolla   ä½¿ç”¨Labelæ¨™è¨˜è¦æˆç‚ºControlleråŠComputeçš„ç¯€é»ï¼Œæˆ‘å€‘é€™é‚Šå°‡node1ç•¶æˆControllerï¼Œnode2 node3ç•¶æˆCompute\n1 2 3  $kubectl label node node1 kolla_controller=true $kubectl label node node2 kolla_compute=true $kubectl label node node3 kolla_compute=true   å°‡/etc/kolla/globals.ymlè¨­å®šæª”ï¼Œä¿®æ”¹æˆèˆ‡è‡ªå·±ç’°å¢ƒç›¸ç¬¦\nå°‡/etc/kolla/globals.ymlä¸­çš„network_interfaceè¨­ç½®ç‚ºManagement interface nameã€‚ä¾‹å¦‚ï¼šeth1\nå°‡/etc/kolla/globals.ymlä¸­çš„neutron_external_interfaceè¨­ç½®ç‚ºneutron external interface nameã€‚ä¾‹å¦‚ï¼šeth2\nå°‡ç›¸é—œçš„openstackè¨­å®šåŠ å…¥/etc/kolla/globals.yml\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38  $cat \u0026lt;\u0026lt;EOF \u0026gt; add-to-globals.yml kolla_install_type: \u0026#34;source\u0026#34; tempest_image_alt_id: \u0026#34;{{ tempest_image_id }}\u0026#34; tempest_flavor_ref_alt_id: \u0026#34;{{ tempest_flavor_ref_id }}\u0026#34; neutron_plugin_agent: \u0026#34;openvswitch\u0026#34; api_interface_address: 0.0.0.0 tunnel_interface_address: 0.0.0.0 orchestration_engine: KUBERNETES memcached_servers: \u0026#34;memcached\u0026#34; keystone_admin_url: \u0026#34;http://keystone-admin:35357/v3\u0026#34; keystone_internal_url: \u0026#34;http://keystone-internal:5000/v3\u0026#34; keystone_public_url: \u0026#34;http://keystone-public:5000/v3\u0026#34; glance_registry_host: \u0026#34;glance-registry\u0026#34; neutron_host: \u0026#34;neutron\u0026#34; keystone_database_address: \u0026#34;mariadb\u0026#34; glance_database_address: \u0026#34;mariadb\u0026#34; nova_database_address: \u0026#34;mariadb\u0026#34; nova_api_database_address: \u0026#34;mariadb\u0026#34; neutron_database_address: \u0026#34;mariadb\u0026#34; cinder_database_address: \u0026#34;mariadb\u0026#34; ironic_database_address: \u0026#34;mariadb\u0026#34; placement_database_address: \u0026#34;mariadb\u0026#34; rabbitmq_servers: \u0026#34;rabbitmq\u0026#34; openstack_logging_debug: \u0026#34;True\u0026#34; enable_heat: \u0026#34;no\u0026#34; enable_cinder: \u0026#34;yes\u0026#34; enable_cinder_backend_lvm: \u0026#34;yes\u0026#34; enable_cinder_backend_iscsi: \u0026#34;yes\u0026#34; enable_cinder_backend_rbd: \u0026#34;no\u0026#34; enable_ceph: \u0026#34;no\u0026#34; enable_elasticsearch: \u0026#34;no\u0026#34; enable_kibana: \u0026#34;no\u0026#34; glance_backend_ceph: \u0026#34;no\u0026#34; cinder_backend_ceph: \u0026#34;no\u0026#34; nova_backend_ceph: \u0026#34;no\u0026#34; EOF $cat ./add-to-globals.yml | sudo tee -a /etc/kolla/globals.yml   æ¥ä¸‹ä¾†é€éansibleå¹«æˆ‘å€‘ç”¢ç”ŸOpneStackè¨­å®šæª”\n1  $ansible-playbook -e @/etc/kolla/globals.yml -e @/etc/kolla/passwords.yml -e CONFIG_DIR=/etc/kolla kolla-kubernetes/ansible/site.yml   ä½¿ç”¨å®˜æ–¹æä¾›çš„è…³æœ¬å¹«åŠ©æˆ‘å€‘å¿«é€Ÿçš„æŠŠOpenStackçš„passwordï¼ŒåŠ åˆ°Kubernetes secrets\n1  $kolla-kubernetes/tools/secret-generator.py create   ä½¿ç”¨ä¹‹å‰åœ¨pipå®‰è£çš„æª”æ¡ˆï¼Œå¿«é€Ÿçš„æŠŠOpenStackçš„è¨­å®šæª”ï¼ŒåŠ å…¥Kubernetes config mapsè£¡\n1 2 3 4 5 6 7 8 9 10  $kollakube res create configmap \\  mariadb keystone horizon rabbitmq memcached nova-api nova-conductor \\  nova-scheduler glance-api-haproxy glance-registry-haproxy glance-api \\  glance-registry neutron-server neutron-dhcp-agent neutron-l3-agent \\  neutron-metadata-agent neutron-openvswitch-agent openvswitch-db-server \\  openvswitch-vswitchd nova-libvirt nova-compute nova-consoleauth \\  nova-novncproxy nova-novncproxy-haproxy neutron-server-haproxy \\  nova-api-haproxy cinder-api cinder-api-haproxy cinder-backup \\  cinder-scheduler cinder-volume iscsid tgtd keepalived \\  placement-api placement-api-haproxy   é€éå®˜æ–¹æä¾›çš„è…³æœ¬å»ºç«‹Kolla Helm Chart\n1  $kolla-kubernetes/tools/helm_build_all.sh .   1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57  $cat \u0026lt;\u0026lt;EOF \u0026gt; cloud.yaml global: kolla: all: docker_registry: docker.io image_tag: \u0026#34;4.0.0\u0026#34; kube_logger: false external_vip: \u0026#34;192.168.7.105\u0026#34; base_distro: \u0026#34;centos\u0026#34; install_type: \u0026#34;source\u0026#34; tunnel_interface: \u0026#34;docker0\u0026#34; keystone: all: admin_port_external: \u0026#34;true\u0026#34; dns_name: \u0026#34;192.168.7.105\u0026#34; public: all: port_external: \u0026#34;true\u0026#34; rabbitmq: all: cookie: 67 glance: api: all: port_external: \u0026#34;true\u0026#34; cinder: api: all: port_external: \u0026#34;true\u0026#34; volume_lvm: all: element_name: cinder-volume daemonset: lvm_backends: - \u0026#39;192.168.7.105\u0026#39;: \u0026#39;cinder-volumes\u0026#39; ironic: conductor: daemonset: selector_key: \u0026#34;kolla_conductor\u0026#34; nova: placement_api: all: port_external: true novncproxy: all: port: 6080 port_external: true openvswitch: all: add_port: true ext_bridge_name: br-ex ext_interface_name: enp1s0f1 setup_bridge: true horizon: all: port_external: true EOF   å°‡è©²æ•¸å€¼ä¿®æ”¹æˆç’°å¢ƒä¸ŠManagement interfaceçš„IPã€‚ä¾‹å¦‚10.0.0.178\n1  $sed -i \u0026#34;s@192.168.7.105@10.0.0.178@g\u0026#34; ./cloud.yaml   å°‡è©²æ•¸å€¼ä¿®æ”¹æˆç’°å¢ƒä¸Šext_interface_nameçš„interfaceã€‚ä¾‹å¦‚ï¼šeth1\n1  $sed -i \u0026#34;s@enp1s0f1@eth1@g\u0026#34; ./cloud.yaml   å°‡è©²æ•¸å€¼ä¿®æ”¹æˆç’°å¢ƒä¸ŠManagement interfaceã€‚ä¾‹å¦‚ï¼šeth2\n1  $sed -i \u0026#34;s@docker0@eth2@g\u0026#34; ./cloud.yaml   åœ¨é€™é‚Šå»ºç«‹ä¸€å€‹çµ¦Openstack rbac ï¼Œè®“å¾Œä¾†helmå•Ÿå‹•çš„å…ƒä»¶å»å–å¾—Kubernetesè³‡æºä¸æœƒæœ‰æ¬Šé™å•é¡Œï¼ˆOpenStackå®˜æ–¹RBACé€™ä¸€é»é‚„æ²’ä¿®æ­£\u0026hellip;ï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14  $cat \u0026lt;\u0026lt;EOF | kubectl apply -f - apiVersion: rbac.authorization.k8s.io/v1beta1 kind: ClusterRoleBinding metadata: name: admin-user roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: cluster-admin subjects: - kind: ServiceAccount name: default namespace: kolla EOF   ä¸€å€‹ä¸€å€‹æŠŠopenstackçš„æœå‹™ä½¿ç”¨helmå•Ÿå‹•èµ·ä¾†ã€‚ï¼ˆä¾‹å¦‚mariadb,rabbitmq,memcached\u0026hellip;ç­‰)\n1 2 3 4 5 6 7 8 9 10 11  $helm install --debug kolla-kubernetes/helm/service/mariadb --namespace kolla --name mariadb --values ./cloud.yaml $helm install --debug kolla-kubernetes/helm/service/rabbitmq --namespace kolla --name rabbitmq --values ./cloud.yaml $helm install --debug kolla-kubernetes/helm/service/memcached --namespace kolla --name memcached --values ./cloud.yaml $helm install --debug kolla-kubernetes/helm/service/keystone --namespace kolla --name keystone --values ./cloud.yaml $helm install --debug kolla-kubernetes/helm/service/glance --namespace kolla --name glance --values ./cloud.yaml $helm install --debug kolla-kubernetes/helm/service/cinder-control --namespace kolla --name cinder-control --values ./cloud.yaml $helm install --debug kolla-kubernetes/helm/service/horizon --namespace kolla --name horizon --values ./cloud.yaml $helm install --debug kolla-kubernetes/helm/service/openvswitch --namespace kolla --name openvswitch --values ./cloud.yaml $helm install --debug kolla-kubernetes/helm/service/neutron --namespace kolla --name neutron --values ./cloud.yaml $helm install --debug kolla-kubernetes/helm/service/nova-control --namespace kolla --name nova-control --values ./cloud.yaml $helm install --debug kolla-kubernetes/helm/service/nova-compute --namespace kolla --name nova-compute --values ./cloud.yaml   é€™é‚Šæœ‰å¯èƒ½é‡åˆ°ç¬¬ä¸€å€‹å•é¡Œï¼Œä¹Ÿå°±æ˜¯nova-compute init æœƒå¡åœ¨é€™å€‹ç•«é¢ã€‚\n1  nova-api-create-cell-r288q 0/1 Init:2/3 0 5min   é€™é‚Šç™¼ç”Ÿäº†ä¸€äº›å•é¡Œï¼Œå®˜æ–¹æ²’æœ‰å»ä¿®æ­£ä»–ã€‚å…ˆæŠŠé€™å€‹helm chart åˆªé™¤æ‰ï¼Œæˆ‘åœ¨é€™é‚Šä¿®æ­£äº†helmçš„è¨­å®šæª”æ¡ˆï¼Œå»ä¿®æ”¹keystoneçš„urlã€‚\n1 2 3 4  $helm delete --purge nova-compute $vim kolla-bringup/kolla-kubernetes/helm/microservice/nova-api-create-simple-cell-job/templates/nova-api-create-cell.yaml {{- $keystonePort := include \u0026#34;kolla_val_get_str\u0026#34; (dict \u0026#34;key\u0026#34; \u0026#34;port\u0026#34; \u0026#34;searchPath\u0026#34; $keystoneSearchPath \u0026#34;Values\u0026#34; .Values )| default \u0026#34;5000\u0026#34; }}   å†é‡æ–°buildä¸€æ¬¡helm chart\n1  $kolla-kubernetes/tools/helm_build_all.sh .   å†é‡æ–°runä¸€æ¬¡ä¿®æ­£éå¾Œçš„chart.\n1  helm install --debug kolla-kubernetes/helm/service/nova-compute --namespace kolla --name nova-compute --values ./cloud.yaml   ç¢ºèªæ‰€æœ‰æœå‹™é‹ä½œæ­£å¸¸\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78  $ kubectl get pod -n kolla NAME READY STATUS RESTARTS AGE cinder-api-5d6fd874b5-tzwlr 3/3 Running 0 11h cinder-create-db-x552q 0/2 Completed 0 11h cinder-create-keystone-endpoint-admin-7xhjp 0/1 Completed 0 11h cinder-create-keystone-endpoint-adminv2-252bg 0/1 Completed 0 11h cinder-create-keystone-endpoint-adminv3-4zcv7 0/1 Completed 0 11h cinder-create-keystone-endpoint-internal-s2n77 0/1 Completed 0 11h cinder-create-keystone-endpoint-internalv2-9wr7f 0/1 Completed 0 11h cinder-create-keystone-endpoint-internalv3-2srh2 0/1 Completed 0 11h cinder-create-keystone-endpoint-public-7mksf 0/1 Completed 0 11h cinder-create-keystone-endpoint-publicv2-pqhms 0/1 Completed 0 11h cinder-create-keystone-endpoint-publicv3-8z6xg 0/1 Completed 0 11h cinder-create-keystone-service-4sbp6 0/1 Completed 0 11h cinder-create-keystone-servicev2-9h88v 0/1 Completed 0 11h cinder-create-keystone-servicev3-p89wk 0/1 Completed 0 11h cinder-create-keystone-user-4whfz 0/1 Completed 0 11h cinder-manage-db-hgppr 0/1 Completed 0 11h cinder-scheduler-0 1/1 Running 0 11h glance-api-6f649fbf8d-9hwzn 1/1 Running 0 11h glance-create-db-76lwc 0/2 Completed 0 11h glance-create-keystone-endpoint-admin-m4mxm 0/1 Completed 0 11h glance-create-keystone-endpoint-internal-q9whd 0/1 Completed 0 11h glance-create-keystone-endpoint-public-stszm 0/1 Completed 0 11h glance-create-keystone-service-hcznf 0/1 Completed 0 11h glance-create-keystone-user-9f2g7 0/1 Completed 0 11h glance-manage-db-ch6rp 0/1 Completed 0 11h glance-registry-684d9cc765-d5g5p 3/3 Running 0 11h horizon-7bc45d8df6-8ndt6 1/1 Running 0 11h keystone-b55d658-4bmpf 1/1 Running 0 12h keystone-create-db-rb9wq 0/2 Completed 0 12h keystone-create-endpoints-65m86 0/1 Completed 0 12h keystone-fernet-setup-job-knfm8 0/1 Completed 0 12h keystone-manage-db-x4m2n 0/1 Completed 0 12h mariadb-0 1/1 Running 0 12h mariadb-init-element-ndbxt 0/1 Completed 0 12h memcached-7b95fd6b69-v8f4v 2/2 Running 0 12h neutron-create-db-w2hqk 0/2 Completed 0 11h neutron-create-keystone-endpoint-admin-hkg8p 0/1 Completed 0 11h neutron-create-keystone-endpoint-internal-cwzrt 0/1 Completed 0 11h neutron-create-keystone-endpoint-public-bjzzk 0/1 Completed 0 11h neutron-create-keystone-service-q7ms9 0/1 Completed 0 11h neutron-create-keystone-user-zvqnw 0/1 Completed 0 11h neutron-dhcp-agent-l5qkg 1/1 Running 0 11h neutron-l3-agent-network-64v9x 1/1 Running 0 11h neutron-manage-db-5dqkn 0/1 Completed 0 11h neutron-metadata-agent-network-ttf5v 1/1 Running 0 11h neutron-openvswitch-agent-network-j6llm 1/1 Running 0 11h neutron-server-6d74c78c98-xzdd8 3/3 Running 0 11h nova-api-7d5cf595bc-rxg4k 3/3 Running 0 11h nova-api-create-cell-r288q 0/1 Completed 0 11h nova-api-create-db-5w2lg 0/2 Completed 0 11h nova-api-manage-db-wd4b8 0/1 Completed 0 11h nova-cell0-create-db-5bz6v 0/2 Completed 0 11h nova-compute-wn5lb 1/1 Running 0 11h nova-compute-xkv8r 1/1 Running 0 11h nova-conductor-0 1/1 Running 0 11h nova-consoleauth-0 1/1 Running 0 11h nova-create-db-476gl 0/2 Completed 0 11h nova-create-keystone-endpoint-admin-xbt8x 0/1 Completed 0 11h nova-create-keystone-endpoint-internal-58dvx 0/1 Completed 0 11h nova-create-keystone-endpoint-public-8c56c 0/1 Completed 0 11h nova-create-keystone-service-jngxg 0/1 Completed 0 11h nova-create-keystone-user-4gc62 0/1 Completed 0 11h nova-libvirt-kbcrl 1/1 Running 0 11h nova-libvirt-n2nnj 1/1 Running 0 11h nova-novncproxy-79bf74796f-9p7ct 3/3 Running 0 11h nova-scheduler-0 1/1 Running 0 11h openvswitch-ovsdb-network-rwwrz 1/1 Running 0 11h openvswitch-vswitchd-network-6q9w9 1/1 Running 0 11h placement-api-create-keystone-endpoint-admin-bg9ct 0/1 Completed 0 11h placement-api-create-keystone-endpoint-internal-v998h 0/1 Completed 0 11h placement-api-create-keystone-endpoint-public-p6mvf 0/1 Completed 0 11h placement-api-fc8f68544-rvhwc 1/1 Running 0 11h placement-create-keystone-service-blj57 0/1 Completed 0 11h placement-create-keystone-user-tw5k4 0/1 Completed 0 11h rabbitmq-0 1/1 Running 0 12h rabbitmq-init-element-gtvgw 0/1 Completed 0 12h   ä½¿ç”¨å®˜æ–¹çš„toolå»ºç«‹adminçš„openrc fileï¼Œå»ºç«‹å®Œæˆçš„æª”æ¡ˆæœƒå­˜åœ¨ç•¶å‰ä½¿ç”¨è€…çš„homeç›®éŒ„ä¸‹ã€‚\n1  $kolla-kubernetes/tools/build_local_admin_keystonerc.sh ext   æ¥è€…å®‰è£OpenStack clientså¥—ä»¶\n1 2 3  $sudo pip install \u0026#34;python-openstackclient\u0026#34; $sudo pip install \u0026#34;python-neutronclient\u0026#34; $sudo pip install \u0026#34;python-cinderclient\u0026#34;   ä½¿ç”¨openstackèªæ³•å»ç”¢ç”Ÿimage,network\u0026hellip;ç­‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  $source ~/keystonerc_admin $IMAGE_URL=http://download.cirros-cloud.net/0.3.5/ $IMAGE=cirros-0.3.5-x86_64-disk.img $IMAGE_NAME=cirros $IMAGE_TYPE=linux EXT_NET_CIDR=\u0026#39;172.24.10.1/24\u0026#39; EXT_NET_RANGE=\u0026#39;start=172.24.10.10,end=172.24.10.200\u0026#39; EXT_NET_GATEWAY=\u0026#39;172.24.10.1\u0026#39; $curl -L -o ./${IMAGE} ${IMAGE_URL}/${IMAGE} $openstack image create --disk-format qcow2 --container-format bare --public \\  --property os_type=${IMAGE_TYPE} --file ./${IMAGE} ${IMAGE_NAME} $openstack network create --external --provider-physical-network physnet1 \\  --provider-network-type flat public1 $openstack subnet create --no-dhcp \\  --allocation-pool ${EXT_NET_RANGE} --network public1 \\  --subnet-range ${EXT_NET_CIDR} --gateway ${EXT_NET_GATEWAY} public1-subnet openstack flavor create --id 1 --ram 512 --disk 1 --vcpus 1 m1.tiny openstack flavor create --id 2 --ram 2048 --disk 20 --vcpus 1 m1.small openstack flavor create --id 3 --ram 4096 --disk 40 --vcpus 2 m1.medium openstack flavor create --id 4 --ram 8192 --disk 80 --vcpus 4 m1.large openstack flavor create --id 5 --ram 16384 --disk 160 --vcpus 8 m1.xlarge   å¯ä»¥ä½¿ç”¨openstack horizonæ“ä½œopenstack dashboardï¼Œä½¿ç”¨admin userçš„å¸³è™Ÿã€å¯†ç¢¼é€²è¡Œç™»å…¥ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32  $kubectl get service -n kolla NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE cinder-api ClusterIP 10.3.3.125 10.0.0.182 8776/TCP 12h glance-api ClusterIP 10.3.3.141 10.0.0.182 9292/TCP 12h glance-registry ClusterIP 10.3.3.15 \u0026lt;none\u0026gt; 9191/TCP 12h horizon ClusterIP 10.3.3.11 10.0.0.182 80/TCP 12h keystone-admin ClusterIP 10.3.3.35 10.0.0.182 35357/TCP 12h keystone-internal ClusterIP 10.3.3.228 \u0026lt;none\u0026gt; 5000/TCP 12h keystone-public ClusterIP 10.3.3.124 10.0.0.182 5000/TCP 12h mariadb ClusterIP 10.3.3.98 \u0026lt;none\u0026gt; 3306/TCP 12h memcached ClusterIP 10.3.3.140 \u0026lt;none\u0026gt; 11211/TCP 12h neutron-server ClusterIP 10.3.3.21 10.0.0.182 9696/TCP 12h nova-api ClusterIP 10.3.3.150 10.0.0.182 8774/TCP 12h nova-metadata ClusterIP 10.3.3.217 \u0026lt;none\u0026gt; 8775/TCP 12h nova-novncproxy ClusterIP 10.3.3.4 10.0.0.182 6080/TCP 12h nova-placement-api ClusterIP 10.3.3.159 10.0.0.182 8780/TCP 12h rabbitmq ClusterIP 10.3.3.66 \u0026lt;none\u0026gt; 5672/TCP 12h rabbitmq-mgmt ClusterIP 10.3.3.37 \u0026lt;none\u0026gt; 15672/TCP 12h $cat keystonerc_admin unset OS_SERVICE_TOKEN export OS_USERNAME=admin export OS_PASSWORD=kQHEss3THBmHCQWdqNd2b51U8xRB3hKPH6KD4kx3 export OS_AUTH_URL=http://10.0.0.182:5000/v3 export PS1=\u0026#39;[\\u@\\h \\W(keystone_admin)]$ \u0026#39; export OS_PROJECT_NAME=admin export OS_USER_DOMAIN_NAME=Default export OS_PROJECT_DOMAIN_NAME=Default export OS_IDENTITY_API_VERSION=3 export OS_REGION_NAME=RegionOne export OS_VOLUME_API_VERSION=2    ç™»å…¥å³å¯çœ‹åˆ°openstackçš„æ“ä½œç•«é¢ã€‚\n  -- å¦‚æœéœ€è¦æ‹†é™¤ä½ çš„OpenStack Kolla Kubernetesç’°å¢ƒ åœ¨ä½ çš„masterä¸Šï¼Œä½¿ç”¨helmæ‹†é™¤OpenStackç›¸é—œå…ƒä»¶ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15  $helm install --debug ~/kolla-bringup/kolla-kubernetes/helm/service/nova-cleanup --namespace kolla --name nova-cleanup --values ~/kolla-bringup/cloud.yaml $helm delete mariadb --purge $helm delete mariadb --purge $helm delete rabbitmq --purge $helm delete memcached --purge $helm delete keystone --purge $helm delete glance --purge $helm delete cinder-control --purge $helm delete horizon --purge $helm delete openvswitch --purge $helm delete neutron --purge $helm delete nova-control --purge $helm delete nova-compute --purge $helm delete nova-cell0-create-db-job --purge $helm delete cinder-volume-lvm --purge   åœ¨æ¯å€‹ç¯€é»ä¸Šæ‹†é™¤ç›¸é—œçš„OpenStack volume\n1  $sudo rm -rf /var/lib/kolla/volumes/*   åœ¨æ¯å€‹ç¯€é»ä¸Šåˆªé™¤Kubernetes\n1 2 3 4  $sudo kubeadm reset $sudo rm -rf /etc/kolla $sudo rm -rf /etc/kubernetes $sudo rm -rf /etc/kolla-kubernetes   ","description":"","id":27,"section":"posts","tags":["openStack","kubernetes"],"title":"Kolla Kubernetes","uri":"https://blog.jjmengze.website/posts/openstack/kolla-kubernetes/"},{"content":"  TODO","description":"","id":28,"section":"posts","tags":["GRPC","proto"],"title":"GRPC èˆ‡ Proto buffer é™„èº«åˆé«”","uri":"https://blog.jjmengze.website/posts/protocol/grpc-server-client/"},{"content":"  ä»€éº¼æ˜¯Protocol Buffer Protocol Buffer æ˜¯ç”±æ˜¯ Google æ‰€æ¨å‡ºçš„ä¸€ç¨®è¼•é‡ä¸”é«˜æ•ˆçš„çµæ§‹åŒ–è³‡æ–™å­˜å„²æ ¼å¼ã€‚\nå°‡çµæ§‹åŒ–çš„è³‡æ–™é€²è¡Œåºåˆ—åŒ–ï¼Œå¯¦ç¾è³‡æ–™çš„å‚³è¼¸ä»¥åŠè³‡æ–™çš„å„²å­˜ã€‚\nProtocol Buffer æ¯” XMLã€Json æ›´å°ã€æ›´å¿«ã€ä½¿ç”¨åŠç¶­è­·ä¸Šæ›´åŠ çš„ç°¡å–®ï¼ˆå¯ä»¥å°‡ api speic ç›´æ¥è½‰æ›æˆé­æ‡‰çš„ç¨‹å¼èªè¨€ï¼‰ï¼\nå„ªé»  é«”ç©å° è·¨å¹³å° è·¨èªè¨€ å‚³è¼¸é€Ÿåº¦å¿« ç¶­è­·æˆæœ¬ä½ åºåˆ—åŒ–é€Ÿåº¦å¿«  å®šç¾©è³‡æ–™çµæ§‹ çµæ§‹çš„å®šç¾©å¾ˆç°¡å–®ï¼Œæª”æ¡ˆä»¥ .proto ä½œç‚ºå¾Œè¼Ÿã€‚\nCoding styleå¯ä»¥åƒè€ƒé€™è£¡ï¼šhttps://developers.google.com/protocol-buffers/docs/style\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18  syntax = \u0026#34;proto3\u0026#34;;package tutorial;message Employee { string name = 1; int32 id = 2; enum PhoneType { MOBILE = 0; HOME = 1; WORK = 2; } message PhoneNumber { string number = 1; PhoneType type = 2; } repeated PhoneNumber phones = 3;}  ç¬¬ä¸€è¡ŒæŒ‡å®šæ‚¨æ­£åœ¨ä½¿ç”¨proto3èªæ³•\næ¥ä¸‹ä¾†packageå®šç¾©åœ¨golangè£¡æ‰€å±¬æ–¼çš„package\nmessageå®šç¾©å‚³è¼¸çš„è¨Šæ¯\nè¨Šæ¯å…§å®¹æœ‰nameã€idã€æšèˆ‰ä»¥åŠä¸€çµ„å…§éƒ¨phone numberçš„message\nç·¨è­¯æ‰€æ’°å¯«å¥½çš„.proto å®‰è£ç·¨è­¯æ™‚æ‰€éœ€è¦ç”¨çš„å¥—ä»¶ï¼Œä¹Ÿå¯ä»¥åƒè€ƒå®˜æ–¹çš„æ–¹æ³•æ±ºå®šå®‰è£çš„æ–¹å¼ã€‚\n1  go get -u github.com/golang/protobuf/protoc-gen-go   \n\n  \n\næˆ‘å€‘ä½¿ç”¨å‰›å‰›å®‰è£çš„å¥—ä»¶é€²è¡Œç·¨è­¯æˆ go library æˆ–æ˜¯å¯ä»¥ç·¨æˆ java python \u0026hellip;. ç­‰çš„ library ä»¥é”åˆ°è·¨å¹³å°è·¨èªè¨€çš„æ”¯æŒï¼Œç”Ÿæˆçš„ library ç›´æ¥å¹«æˆ‘å€‘å¯«å¥½å£“ç¸®ä»¥åŠè§£å£“ç¸®çš„æ–¹æ³•é–‹ç™¼è€…åªè¦å°ˆå¿ƒæ’°å¯«è‡ªå·±çš„æ¥­å‹™é‚è¼¯å³å¯ï¼Œæœ¬ç¯‡æ–‡ç« ä»¥ go ä½œç‚ºç¯„ä¾‹ã€‚\n1  protoc --go_out=. *.proto   ç·¨è­¯å®Œæˆå¾Œçš„æª”æ¡ˆæœƒæ˜¯æ¨£çš„å‘½åæ–¹å¼ï¼šemployee.pb.go\næª”æ¡ˆå…§å®¹æœƒå¦‚åŒä¸‹é¢çš„ç¯„ä¾‹æ‰€ç¤ºã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170  // Code generated by protoc-gen-go. DO NOT EDIT. // source: employee.proto  package tutorial import proto \u0026#34;github.com/golang/protobuf/proto\u0026#34; import fmt \u0026#34;fmt\u0026#34; import math \u0026#34;math\u0026#34; // Reference imports to suppress errors if they are not otherwise used. var _ = proto.Marshal var _ = fmt.Errorf var _ = math.Inf // This is a compile-time assertion to ensure that this generated file // is compatible with the proto package it is being compiled against. // A compilation error at this line likely means your copy of the // proto package needs to be updated. const _ = proto.ProtoPackageIsVersion2 // please upgrade the proto package  type Employee_PhoneType int32 const ( Employee_MOBILE Employee_PhoneType = 0 Employee_HOME Employee_PhoneType = 1 Employee_WORK Employee_PhoneType = 2 ) var Employee_PhoneType_name = map[int32]string{ 0: \u0026#34;MOBILE\u0026#34;, 1: \u0026#34;HOME\u0026#34;, 2: \u0026#34;WORK\u0026#34;, } var Employee_PhoneType_value = map[string]int32{ \u0026#34;MOBILE\u0026#34;: 0, \u0026#34;HOME\u0026#34;: 1, \u0026#34;WORK\u0026#34;: 2, } func (x Employee_PhoneType) String() string { return proto.EnumName(Employee_PhoneType_name, int32(x)) } func (Employee_PhoneType) EnumDescriptor() ([]byte, []int) { return fileDescriptor_employee_7c804fd7a46a4aa3, []int{0, 0} } type Employee struct { Name string `protobuf:\u0026#34;bytes,1,opt,name=name\u0026#34; json:\u0026#34;name,omitempty\u0026#34;` Id int32 `protobuf:\u0026#34;varint,2,opt,name=id\u0026#34; json:\u0026#34;id,omitempty\u0026#34;` Phones []*Employee_PhoneNumber `protobuf:\u0026#34;bytes,3,rep,name=phones\u0026#34; json:\u0026#34;phones,omitempty\u0026#34;` XXX_NoUnkeyedLiteral struct{} `json:\u0026#34;-\u0026#34;` XXX_unrecognized []byte `json:\u0026#34;-\u0026#34;` XXX_sizecache int32 `json:\u0026#34;-\u0026#34;` } func (m *Employee) Reset() { *m = Employee{} } func (m *Employee) String() string { return proto.CompactTextString(m) } func (*Employee) ProtoMessage() {} func (*Employee) Descriptor() ([]byte, []int) { return fileDescriptor_employee_7c804fd7a46a4aa3, []int{0} } func (m *Employee) XXX_Unmarshal(b []byte) error { return xxx_messageInfo_Employee.Unmarshal(m, b) } func (m *Employee) XXX_Marshal(b []byte, deterministic bool) ([]byte, error) { return xxx_messageInfo_Employee.Marshal(b, m, deterministic) } func (dst *Employee) XXX_Merge(src proto.Message) { xxx_messageInfo_Employee.Merge(dst, src) } func (m *Employee) XXX_Size() int { return xxx_messageInfo_Employee.Size(m) } func (m *Employee) XXX_DiscardUnknown() { xxx_messageInfo_Employee.DiscardUnknown(m) } var xxx_messageInfo_Employee proto.InternalMessageInfo func (m *Employee) GetName() string { if m != nil { return m.Name } return \u0026#34;\u0026#34; } func (m *Employee) GetId() int32 { if m != nil { return m.Id } return 0 } func (m *Employee) GetPhones() []*Employee_PhoneNumber { if m != nil { return m.Phones } return nil } type Employee_PhoneNumber struct { Number string `protobuf:\u0026#34;bytes,1,opt,name=number\u0026#34; json:\u0026#34;number,omitempty\u0026#34;` Type Employee_PhoneType `protobuf:\u0026#34;varint,2,opt,name=type,enum=tutorial.Employee_PhoneType\u0026#34; json:\u0026#34;type,omitempty\u0026#34;` XXX_NoUnkeyedLiteral struct{} `json:\u0026#34;-\u0026#34;` XXX_unrecognized []byte `json:\u0026#34;-\u0026#34;` XXX_sizecache int32 `json:\u0026#34;-\u0026#34;` } func (m *Employee_PhoneNumber) Reset() { *m = Employee_PhoneNumber{} } func (m *Employee_PhoneNumber) String() string { return proto.CompactTextString(m) } func (*Employee_PhoneNumber) ProtoMessage() {} func (*Employee_PhoneNumber) Descriptor() ([]byte, []int) { return fileDescriptor_employee_7c804fd7a46a4aa3, []int{0, 0} } func (m *Employee_PhoneNumber) XXX_Unmarshal(b []byte) error { return xxx_messageInfo_Employee_PhoneNumber.Unmarshal(m, b) } func (m *Employee_PhoneNumber) XXX_Marshal(b []byte, deterministic bool) ([]byte, error) { return xxx_messageInfo_Employee_PhoneNumber.Marshal(b, m, deterministic) } func (dst *Employee_PhoneNumber) XXX_Merge(src proto.Message) { xxx_messageInfo_Employee_PhoneNumber.Merge(dst, src) } func (m *Employee_PhoneNumber) XXX_Size() int { return xxx_messageInfo_Employee_PhoneNumber.Size(m) } func (m *Employee_PhoneNumber) XXX_DiscardUnknown() { xxx_messageInfo_Employee_PhoneNumber.DiscardUnknown(m) } var xxx_messageInfo_Employee_PhoneNumber proto.InternalMessageInfo func (m *Employee_PhoneNumber) GetNumber() string { if m != nil { return m.Number } return \u0026#34;\u0026#34; } func (m *Employee_PhoneNumber) GetType() Employee_PhoneType { if m != nil { return m.Type } return Employee_MOBILE } func init() { proto.RegisterType((*Employee)(nil), \u0026#34;tutorial.Employee\u0026#34;) proto.RegisterType((*Employee_PhoneNumber)(nil), \u0026#34;tutorial.Employee.PhoneNumber\u0026#34;) proto.RegisterEnum(\u0026#34;tutorial.Employee_PhoneType\u0026#34;, Employee_PhoneType_name, Employee_PhoneType_value) } func init() { proto.RegisterFile(\u0026#34;employee.proto\u0026#34;, fileDescriptor_employee_7c804fd7a46a4aa3) } var fileDescriptor_employee_7c804fd7a46a4aa3 = []byte{ // 208 bytes of a gzipped FileDescriptorProto \t0x1f, 0x8b, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0xff, 0xe2, 0xe2, 0x4b, 0xcd, 0x2d, 0xc8, 0xc9, 0xaf, 0x4c, 0x4d, 0xd5, 0x2b, 0x28, 0xca, 0x2f, 0xc9, 0x17, 0xe2, 0x28, 0x29, 0x2d, 0xc9, 0x2f, 0xca, 0x4c, 0xcc, 0x51, 0x7a, 0xc3, 0xc8, 0xc5, 0xe1, 0x0a, 0x95, 0x14, 0x12, 0xe2, 0x62, 0xc9, 0x4b, 0xcc, 0x4d, 0x95, 0x60, 0x54, 0x60, 0xd4, 0xe0, 0x0c, 0x02, 0xb3, 0x85, 0xf8, 0xb8, 0x98, 0x32, 0x53, 0x24, 0x98, 0x14, 0x18, 0x35, 0x58, 0x83, 0x98, 0x32, 0x53, 0x84, 0xcc, 0xb8, 0xd8, 0x0a, 0x32, 0xf2, 0xf3, 0x52, 0x8b, 0x25, 0x98, 0x15, 0x98, 0x35, 0xb8, 0x8d, 0xe4, 0xf4, 0x60, 0x66, 0xe9, 0xc1, 0xcc, 0xd1, 0x0b, 0x00, 0x29, 0xf0, 0x2b, 0xcd, 0x4d, 0x4a, 0x2d, 0x0a, 0x82, 0xaa, 0x96, 0x0a, 0xe7, 0xe2, 0x46, 0x12, 0x16, 0x12, 0xe3, 0x62, 0xcb, 0x03, 0xb3, 0xa0, 0x96, 0x41, 0x79, 0x42, 0x06, 0x5c, 0x2c, 0x25, 0x95, 0x05, 0xa9, 0x60, 0x0b, 0xf9, 0x8c, 0x64, 0x70, 0x19, 0x1e, 0x52, 0x59, 0x90, 0x1a, 0x04, 0x56, 0xa9, 0xa4, 0xcd, 0xc5, 0x09, 0x17, 0x12, 0xe2, 0xe2, 0x62, 0xf3, 0xf5, 0x77, 0xf2, 0xf4, 0x71, 0x15, 0x60, 0x10, 0xe2, 0xe0, 0x62, 0xf1, 0xf0, 0xf7, 0x75, 0x15, 0x60, 0x04, 0xb1, 0xc2, 0xfd, 0x83, 0xbc, 0x05, 0x98, 0x92, 0xd8, 0xc0, 0xfe, 0x37, 0x06, 0x04, 0x00, 0x00, 0xff, 0xff, 0x5c, 0x1e, 0x53, 0x56, 0x11, 0x01, 0x00, 0x00, }   å°çµ ä¸‹ä¸€ç« ç¯€æœƒä½¿ç”¨æœ¬ç¯‡åŸºæ–¼ protobuffer å»ºç½®å‡ºä¾†çš„ go library å»æ’°å¯«ä¸€å€‹ç°¡å–®çš„ client serverï¼Œä¸¦ä¸”é€é GRPC å»å‚³è¼¸ protobufferã€‚\n","description":"","id":29,"section":"posts","tags":["GRPC","proto"],"title":"åˆåšProtocol Bufferå¥½æ»‹å‘³","uri":"https://blog.jjmengze.website/posts/protocol/grpc/"},{"content":"  è¨˜éŒ„ä¸€ä¸‹ï¼ŒOpen vSwitch (OVS)å¸¸ç”¨çš„æŒ‡ä»¤ã€‚\nåœ¨ubuntuä¸Šå®‰è£ovs\nsudo apt install openvswitch-switch -y æ–°å¢ä¸€å€‹bridge sudo ovs-vsctl add-br br0 é¡¯ç¤ºæ‰€æœ‰bridge sudo ovs-vsctl list-br çµ¦æŸå€‹bridgeæ–°å¢ä¸€å€‹port sudo ovs-vsctl add-port br0 veth1 é¡¯ç¤ºç¶å®šåˆ°è©²portçš„bridge sudo ovs-vsctl port-to-br veth1 é€£æ¥controlleråˆ°ovs br0ä¸Š sudo ovs-vsctl set-controller br0 tcp:\u0026lt;controller IP\u0026gt; é¡¯ç¤ºæ‰€æœ‰çš„bridgeã€é€£æ¥çš„portä»¥åŠcontroller sudo ovs-vsctl show ","description":"","id":30,"section":"posts","tags":["SDN"],"title":"OVS å¸¸ç”¨çš„æŒ‡ä»¤","uri":"https://blog.jjmengze.website/posts/sdn/ovs-commonly-command/"},{"content":"  kubernetes Controller Manager çš„é‚£äº›å…ƒä»¶ åœ¨ Kubernetes Master Node å¦å¤–ä¸€å€‹ç›¸ç•¶é‡è¦çš„å…ƒä»¶å¯è¦–ç‚ºæ•´é«” Kubernetes ç³»çµ±æ¶æ§‹çš„ç›£æ§ç‹€æ…‹ä¸­å¿ƒï¼Œä¹Ÿæ˜¯å°±æ˜¯ Controller Manager å…ƒä»¶ï¼Œä¸»è¦ç”±ä»¥ä¸‹å¹¾ç¨®æ§åˆ¶å™¨æ§åˆ¶ Kubernetes Container å¢é›†çš„ç‹€æ…‹ï¼š\n  Replication Controller ï¼šç›£æ§å¢é›†çš„å‰¯æœ¬ç‹€æ…‹ä¸¦ç›¡å¯èƒ½ä¿®æ­£å‰¯æœ¬ç‹€æ…‹ã€‚\n  Node Controller ï¼š ç›£æ§å¢é›†çš„ Node ç‹€æ…‹ä¸¦è² è²¬ Node ç‹€æ…‹çš„æ›´æ–°ã€‚\n  CronJob Controller ï¼šç›£æ§å¢é›†é€±æœŸæ€§ä»»å‹™çš„ç‹€æ…‹ä¸¦è² è²¬ä»»å‹™ç‹€æ…‹çš„æ›´æ–°ã€‚\n  DaemonSet Controller ï¼šç›£æ§å¢é›† Daemon è³‡æºå‹æ…‹çš„ç‹€æ…‹ä¸¦è² è²¬å…¶ç‹€æ…‹çš„æ›´æ–°ã€‚\n  Deployment Controller ï¼šç›£æ§å¢é›† Deployment è³‡æºå‹æ…‹çš„ç‹€æ…‹ä¸¦è² è²¬èˆ‡ Replication Controller é€²è¡Œäº¤äº’èˆ‡ç‹€æ…‹çš„æ›´æ–°ã€‚\n  Endpoint Controller ï¼šç›£æ§å¢é›† Pod çš„ IP ç‹€æ…‹ä¸¦è² è²¬èˆ‡ Service Controller é€²è¡Œè³‡æ–™çš„äº¤æ›ã€‚\n  Garbage Collector Controller ï¼šæ”¶é›†å·²è¢«å¢é›†åˆªé™¤çš„å…ƒä»¶ç¢ºèªæ˜¯å¦é‚„æœ‰ä¾è³´çš„è³‡æºæœªè¢«åˆªé™¤ã€‚\n  Namespace Controller ï¼šç¶­è­·ä¸¦ä¸”ç›£æ§å¢é›† Namespace è³‡æºå‹æ…‹å»ºç«‹èˆ‡åˆªé™¤çš„ç‹€æ…‹ã€‚\n  Job Controller ï¼šç›£æ§å¢é›†å–®æ¬¡ä»»å‹™çš„ç‹€æ…‹ä¸¦è² è²¬ä»»å‹™ç‹€æ…‹çš„æ›´æ–°ã€‚\n  Pod AutoScaler Controller ï¼šç›£æ§å¢é›† Pod æ°´å¹³æ“´å±•ä»¥åŠè² è²¬è©²æ“´å±•çš„ç‹€æ…‹ã€‚\n  RelicaSet Controller ï¼šç›£æ§å¢é›†å‰¯æœ¬å‡ç´šç‹€æ…‹ä»¥åŠç¶­è­·è©²å‡ç´šè³‡è¨Šã€‚\n  Service Controller ï¼šç›£æ§å¢é›†æœå‹™æš´éœ²è³‡è¨Šä¹‹ç‹€æ…‹ä¸¦èˆ‡ Endpoint Controller é€²è¡Œè³‡æ–™çš„äº¤äº’æ›´æ–°ã€‚\n  ServiceAccount Controller ï¼šè² è²¬ç›£æ§å¢é›†æœå‹™æ‡‰ç”¨çš„å¸³æˆ¶èªè­‰èˆ‡æ¬Šé™æ§ç®¡ã€‚\n  StatefulSet Controller ï¼šç›£æ§å¢é›†ç¾æœ‰ç‹€æ…‹æœå‹™çš„è®ŠåŒ–è² è²¬å…¶è³‡æºçš„å»ºç«‹èˆ‡åˆªé™¤ã€‚\n  Volume Controller ï¼šç›£æ§å¢é›†æ›è¼‰ volume è³‡è¨Šèˆ‡ç‹€æ…‹ä¸¦è² è²¬å³æ™‚æ›´æ–°ã€‚\n  Resource quota Controller ï¼šç›£æ§å¢é›† CPU èˆ‡ Memory è³‡æºè³‡è¨Šä¸¦å›é¥‹çµ¦ API-Server ç•¶å‰è³‡æºç‹€æ…‹ã€‚\n    åœ–å¼•ç”¨è‡ªsuperuser\n","description":"","id":31,"section":"posts","tags":["kubernetes"],"title":"Kubernetes Control Plane é€™ä»¶å°å°äº‹(controller-manger)","uri":"https://blog.jjmengze.website/posts/kubernetes/kubernetes-controller-manger-overview/"},{"content":"  kubernetes control plane çš„é‚£äº›å…ƒä»¶ å¦‚ä¸‹åœ–æ‰€ç¤ºï¼Œ Kubernektes æ•´é«”æ¶æ§‹æ˜¯ä¸»å¾å¼æ¶æ§‹( Clientâ€“server model )ç”± Master Node è² è²¬ Container å¢é›†ç®¡ç†èˆ‡èª¿åº¦ç›¸ç•¶æ–¼ Kubernetes çš„å¤§è…¦ï¼Œ Worker Node è² è²¬é‹è¡Œ Master Node æ‰€æ´¾é€éä¾†çš„ä»»å‹™ï¼Œä¸¦å°‡ä»»å‹™ç¢ºå¯¦åŸ·è¡Œä¸¦ä¸”å®šæœŸå›å ± Master Node ç›®å‰çš„ç¯€é»çš„ç‹€æ…‹ï¼Œæ‰€ä»¥äº†è§£ Kubernetes çš„å¤§è…¦æ˜¯ä¸€ä»¶ç›¸ç•¶é‡è¦çš„äº‹æƒ…ã€‚\n  åœ¨ Master Node ä¸»è¦ç”± API-Server ã€ Controller Manager ä»¥åŠ Scheduler ä¸‰å¤§åŸºç¤å…ƒä»¶æ‰€çµ„åˆè€Œæˆï¼Œå…¶ä¸­ API-Server å…ƒä»¶å¯è¦–ç‚ºæ•´é«” Kubernetes Container èª¿åº¦ç³»çµ±æ¶æ§‹çš„ç®¡ç†ä¸­å¿ƒï¼Œä¹Ÿæ˜¯ Kubernetes Container å¢é›†èª¿åº¦ç³»çµ±ä¸­å”¯ä¸€èƒ½èˆ‡å¾Œç«¯å„²å­˜ etcd å…ƒä»¶æºé€šçš„å…ƒä»¶ï¼Œä¸»è¦æä¾›ä»¥ä¸‹æœå‹™ï¼š\n  API-Server æä¾›å¢é›†å®‰å…¨ä¸”å¯é çš„ä½¿ç”¨æ©Ÿåˆ¶ï¼Œæ‰€æœ‰çš„ Client è«‹æ±‚éƒ½éœ€è¦ç¶“é API-Server çš„èªè­‰ã€‚ API-Server æ”¯æŒå¤šç¨®èªè­‰æ©Ÿåˆ¶å¦‚ WebSocket ã€ Keystone ã€ Token ç­‰ç­‰ï¼Œå¦‚æœ API-Server èªè­‰æˆåŠŸï¼Œ Client è«‹æ±‚å°‡æœƒå‚³å…¥ Kubernetes å¢é›†å…§é€²è¡Œè™•ç†ï¼›è€Œå°æ–¼èªè­‰å¤±æ•—çš„è«‹æ±‚å‰‡è¿”å› HTTP 401 çš„éŒ¯èª¤ã€‚\n HTTPS Certificate Authority ï¼ŒåŸºæ–¼ Certificate Authority (CA) è­‰æ›¸ç°½åçš„é›™å‘æ•¸å­—è­‰æ›¸èªè­‰æ–¹å¼ã€‚ HTTP Token Authority ï¼Œé€éç™¼æ”¾ Token çš„æ–¹å¼è­˜åˆ¥æ¯å€‹ä½¿ç”¨è€…çš„èº«ä»½ï¼Œä»¥åŠé€éè©² Token é™åˆ¶ä½¿ç”¨è€…èƒ½å­˜å–çš„ç¯„åœã€‚ HTTP Basic Authority ï¼Œç•¶ä½¿ç”¨è€…å‘ API Server ç™¼èµ· HTTP è«‹æ±‚æ™‚ï¼Œæœƒåœ¨è³‡æ–™ä¸­å¸¶å…¥ Username ã€ UID ã€ Groups ã€ Extra fields ä½œç‚ºä½¿ç”¨è€…çš„èº«ä»½é©—è­‰çš„ä¾æ“šã€‚    API-Server åŒæ™‚æä¾› REST API çš„å‘¼å«ä»‹é¢å¦‚ Create ã€ Read ã€ Update ã€ Delete ç­‰ä¸€ç³»åˆ—æ“ä½œå° Kubernetes çš„ Pod ã€ Service ã€ Deployment ç­‰å…ƒä»¶é€²è¡Œæ“ä½œï¼Œä¾‹å¦‚ä½¿ç”¨è€…å¯ä»¥é€é REST API å‘ API-Server è«‹æ±‚å»ºç«‹ã€åˆªé™¤ã€æ›´æ–°ä»¥åŠè®€å– Kubernetes çš„è³‡æºã€‚\n  API-Server å…ƒä»¶æä¾›å°ˆæœ‰çš„ç›£æ§ä»‹é¢çµ¦ Controller Manger å…ƒä»¶èˆ‡ Scheduler å…ƒä»¶ï¼Œå¯ä»¥é€éè©²å°ˆæœ‰ä»‹é¢è®€å–ç‰¹å®šè³‡æ–™ï¼Œä¾‹å¦‚ Controller Manger é€é API-Server æä¾›çš„ä»‹é¢è®€å– Pod çš„ç‹€æ…‹ä¸¦ä¸”åŠ ä»¥æ§åˆ¶ï¼Œ Scheduler é€éä»‹é¢è®€å– Kubernetes Node ç›®å‰çš„å£“åŠ›æƒ…æ³ä½œç‚ºæ’ç¨‹ Pod çš„åƒè€ƒä¾æ“šã€‚\n  å¤§è‡´ä¸Šæµç¨‹å¦‚ä¸‹åœ–æ‰€ç¤ºï¼Œç•¶è«‹æ±‚é€é€² kubernetes cluster æœƒé€šéApi serverçš„èªè­‰ï¼Œæ¥è‘—æª¢æŸ¥è©²æ¬¡è«‹æ±‚çš„å…§å®¹è«‹æ±‚ï¼Œæœ€å¾Œå†é€é€² etcd åšæ°¸ä¹…æ€§å„²å­˜ã€‚ï¼ˆä»¥å¾Œæœ‰æ©Ÿæœƒå†ä¾†è«‡è«‡Authoizationè·ŸAdmission control çš„ç´°ç¯€ï¼‰\nå¼•ç”¨giantswarm.io\n","description":"","id":32,"section":"posts","tags":["kubernetes"],"title":"Kubernetes Control Plane é€™ä»¶å°å°äº‹(api-server)","uri":"https://blog.jjmengze.website/posts/kubernetes/kubernetes-apiserver-overview/"},{"content":"  ä¾†èªªèªªetcd Kubernetes Container å¢é›†èª¿åº¦ç³»çµ±ä¸­å¾Œç«¯æ¡ç”¨ etcd ä½œç‚ºå¢é›†ç‹€æ…‹çš„å„²å­˜å…ƒä»¶ï¼Œè€Œè©² etcd å…ƒä»¶æ˜¯ç”± CoreOS å…¬å¸é–‹ç™¼ä¸¦ä¸”é–‹æºè²¢ç»çµ¦ CNCF çš„ key/value å„²å­˜å°ˆæ¡ˆã€‚ etcd ä¸»è¦è² è²¬å°‡ Kubernetes API-Server æ‰€è™•ç†éçš„è³‡æ–™é€²è¡ŒåŠ å¯†å„²å­˜ã€‚ etcd å…ƒä»¶å¤§å¤šæ•¸æœƒä½æ–¼ Kubernetes ç³»çµ±æ¶æ§‹ä¸­çš„ Master Node ä¸Šã€‚ API-Server è‹¥è¦å­˜å– etcd ä¸Šçš„è³‡æ–™å¿…é ˆå…ˆç¶“é etcd çš„èº«åˆ†é©—è­‰æµç¨‹ç¢ºèªä½¿ç”¨è€…å­˜å–çš„èº«ä»½èˆ‡ç¯„åœæ˜¯å¦åˆæ³•ï¼Œè‹¥èº«åˆ†ç¢ºèªç„¡èª¤èˆ‡å­˜å–ç¯„åœåˆæ³•å‰‡å°‡ä½¿ç”¨è€…æ‰€è«‹æ±‚çš„è³‡æ–™é€é REST API å›å‚³è³‡æ–™çµ¦ä½¿ç”¨è€…ã€‚\nKubernetes åœ¨é€šå¸¸æƒ…æ³ä¸‹åªæœƒæ›¿ç³»çµ±ç®¡ç†å“¡åœ¨ Master Node ä¸Šå»ºç«‹ä¸€å€‹ etcd å…ƒä»¶ï¼Œå¯èƒ½å› ç‚ºå¤–åœ¨å› ç´ æˆ–æ˜¯ etcd è«‹æ±‚è² è¼‰éæ–¼é¾å¤§ä½¿å¾— etcd å…ƒä»¶ç™¼ç”Ÿæ•…éšœï¼Œé€²è€Œå°è‡´æ•´é«” Kubernetesç™¼ç”ŸAPI-Server ç„¡æ³•å­˜å–å¾Œç«¯è³‡æ–™çš„å•é¡Œã€‚é‡å°æ­¤å•é¡Œç³»çµ±ç®¡ç†å“¡å¯ä»¥é€é Kubernetes Container å¢é›†èª¿åº¦æŠ€è¡“å»ºç«‹ä¸€å€‹é«˜å¯ç”¨çš„ etcd æœå‹™å¢é›†ï¼Œè‹¥å–®ä¸€å€‹ etcd å…ƒä»¶ç™¼ç”Ÿæ•…éšœæ™‚ä»æœ‰å…¶ä»– etcd å…ƒä»¶å¯ä»¥ç«‹å³åœ°è£œä¸Šä½œç‚ºå‚™æ´ä½¿ç”¨ã€‚\netcd æ€éº¼åœ¨åˆ†æ•£çš„ä¸–ç•Œä¿æŒä¸€è‡´ etcd å…ƒä»¶çµ„æˆ etcd å¢é›†æœå‹™æ™‚é¦–è¦ä»»å‹™å°±æ˜¯ç¢ºä¿å¾Œç«¯è³‡æ–™æ˜¯ä¸€åˆ¶æ€§çš„ï¼Œä»¥é˜²ä½¿ç”¨è€…å­˜å–åˆ°éŒ¯èª¤çš„è³‡æ–™ï¼Œ etcd æ¡ç”¨çš„æ˜¯ Raft ä¸€è‡³æ€§å…±è­˜æ¼”ç®—æ³•ã€‚\né€é Raft æ¼”ç®—æ³•ä½¿å¾—åœ¨åŒä¸€å€‹æ™‚é–“é»ä¸Šå¯ä»¥ç¶­æŒå¤šå€‹ etcd å…ƒä»¶å„²å­˜çš„ç‹€æ…‹ï¼Œé€™å°±ä¿è­‰äº†å¾Œç«¯å„²å­˜çš„è³‡æ–™æ˜¯ä¿æŒä¸€è‡´ï¼Œæ­¤å¤–è©²æ¼”ç®—æ³•ä¿è­‰äº†ç•¶å°‘æ•¸ etcd å…ƒä»¶å´©æ½°æˆ–å¤±æ•ˆæ™‚ä»ä¸å½±éŸ¿æ•´é«”å¢é›†çš„åŒæ­¥ã€‚\nRaft å°±æ˜¯ä¸€ç¨® leader-based çš„å…±è­˜ç®—æ³•ä¸¦ä¸”ä½¿ç”¨å¿ƒè·³æ©Ÿåˆ¶ (Heartbeat mechanism) è§¸ç™¼åŒæ­¥èˆ‡é¸èˆ‰ï¼Œåœ¨è©²æ¼”ç®—æ³•è£¡é¢åˆ†åˆ¥æœ‰ä¸‰ç¨®èº«ä»½ç¬¬ä¸€ç¨®æ˜¯ Leader ä¸»è¦æ˜¯å¢é›†çš„é ˜å°äººå…¶ä»–èº«ä»½éƒ½å¿…é ˆè·Ÿé ˜å°äººçš„è³‡æ–™åŒæ­¥ï¼Œç¬¬äºŒç¨®æ˜¯ Candidate æ˜¯ç•¶é ˜å°äººç„¡å›æ‡‰æ™‚æ¬²åƒåŠ è©²æ¬¡é¸èˆ‰çš„ç¯€é»ç¨±ç‚ºå€™é¸äººï¼Œæœ€å¾Œä¸€ç¨®ç‚º Follower åœ¨é¸èˆ‰æœŸé–“è² è²¬æŠ•ç¥¨çµ¦å€™é¸äººçš„ç¯€é»å¦‚åœ–æ‰€ç¤ºã€‚\né¸èˆ‰çš„éç¨‹   ä¸€é–‹å§‹å¢é›†å„å€‹ç¯€é»èº«ä»½éƒ½ç‚ºFollowerï¼Œä¸¦ä¸”ç¯€é»ä¸Šé è¨­çš„é¸èˆ‰é€¾æ™‚æ™‚é–“(Election Time Out)èˆ‡ä¸€èˆ¬ä½œæ¥­æ™‚é–“(Normal Operation)çš†ç‚ºç¯„åœéš¨æ©Ÿäº‚æ•¸ã€‚åœ¨ä¸€èˆ¬ä½œæ¥­æ™‚é–“å…§ç¯€é»æœƒæœŸå¾…è‡ªå·±æ”¶åˆ°Leaderé€±æœŸæ€§å‚³é€éä¾†çš„Heartbeatä¸¦ä¸”é‡ç½®ä¸€èˆ¬ä½œæ¥­æ™‚é–“ï¼Œè‹¥æ˜¯è¶…éä¸€èˆ¬ä½œæ¥­æ™‚é–“ç¯€é»éƒ½æ²’æœ‰æ”¶åˆ°Leaderæ‰€å‚³é€éä¾†çš„Heartbeatè©²ç¯€é»æœƒç•¶ä½œç›®å‰æ²’æœ‰Leaderçš„ç‹€æ…‹ï¼Œå°‡è§¸ç™¼Leaderçš„é‡é¸ã€‚\n  ç”±æ–¼ç¯€é»è§¸ç™¼Leaderçš„é‡é¸æ­¤æ™‚ç¯€é»å°‡å¾Followerèº«ä»½è½‰è®Šç‚ºCandidateèº«ä»½ä¸¦ä¸”ç´€éŒ„ç•¶å‰ä»»æœŸçš„è™Ÿç¢¼å‘å¢é›†å…§å…¶é¤˜ç¯€é»ç™¼é€æŠ•ç¥¨ä¹‹è«‹æ±‚ï¼Œåœ¨è§¸ç™¼é¸èˆ‰å¾Œæœƒæœ‰ä¸€æ®µé¸èˆ‰é€¾æ™‚æ™‚é–“åœ¨è©²æ™‚é–“å…§ï¼Œå°æ–¼åŒä¸€ä»»æœŸFolloweråªèƒ½é¸æŠ•ä¸€åCandidateï¼ŒCandidateæ”¶åˆ°å¤§æ–¼ç­‰æ–¼(2n+1) Followerçš„åŒæ„ç¥¨ï¼Œå‰‡è©²ç¯€é»å¾Candidateèº«ä»½è½‰è®Šç‚ºå¢é›†çš„æ–°Leaderã€‚è‹¥åœ¨é¸èˆ‰é€¾æ™‚æ™‚é–“çµæŸæ²’æœ‰æ”¶åˆ°(2n+1) Followerçš„åŒæ„ç¥¨å‰‡è¦–ç‚ºç•¶å‰é¸èˆ‰ç„¡æ•ˆï¼Œå†å¢åŠ ä¸€æ¬¡ç•¶å‰ä»»æœŸé‡æ–°ç™¼èµ·æ–°ä¸€è¼ªçš„é¸èˆ‰ã€‚è€Œæ–°çš„Leaderéœ€é€éé€±æœŸæ€§çš„ç™¼é€Heartbeatçµ¦å„å€‹ç¯€é»ä¾†ç¶­æŒè©²Leaderèº«ä»½ã€‚\n  ç•¶ç™¼ç”Ÿåœ¨é¸èˆ‰é€¾æ™‚æ™‚é–“çµæŸæ²’æœ‰æ”¶åˆ°(2n+1) Followerçš„åŒæ„ç¥¨ï¼Œç„¡æ³•é¸å‡ºLeaderçš„æƒ…æ³ï¼Œæ ¹æ“šRaftæ¼”ç®—æ³•æœƒè®“ç¯€é»ç¸®çŸ­é¸èˆ‰é€¾æ™‚æ™‚é–“åŠ é€Ÿé¸å‡ºå¢é›†çš„Leaderä»¥æ¸›å°‘å¢é›†ç„¡æ³•åŒæ­¥çš„æ™‚é–“ï¼Œå¦å¤–åœ¨é¸èˆ‰æœŸé–“ç¯€é»å¯èƒ½æœƒæ”¶åˆ°ä¾†è‡ªå…¶ä»–ç¯€é»å®£ç¨±è‡ªå·±æ˜¯Leaderçš„å¿ƒè·³ï¼Œè©²ç¯€é»æœƒç¢ºèªå¿ƒè·³è¨Šæ¯å…§çš„ä»»æœŸç·¨è™Ÿæ˜¯å¦å¤§æ–¼ç•¶å‰ä»»æœŸï¼Œè‹¥æ˜¯å¤§æ–¼ç•¶å‰ä»»æœŸæ‰€æœ‰ç¯€é»èº«ä»½è½‰è®Šç‚ºFollowerèº«ä»½ä¸¦ä¸”èˆ‡è©²LeaderåŒæ­¥è³‡æ–™ï¼Œè‹¥æ˜¯å¿ƒè·³è¨Šæ¯çš„ä»»æœŸç·¨è™Ÿå°æ–¼ç•¶å‰ä»»æœŸå‰‡ç„¡è¦–è©²ç¯€é»ï¼Œç¹¼çºŒä»»æœŸæŠ•ç¥¨å·¥ä½œã€‚\n  ç•¶å¢é›†çš„Leaderè¢«é¸å‡ºä¹‹å¾Œï¼ŒLeaderæœƒå°‡ä½¿ç”¨è€…çš„æ¯å€‹è«‹æ±‚éƒ½åŒ…è£æˆä¸€å€‹Commitä¸¦ä¸”é€éHeartbeaté€±æœŸæ€§çš„è¤‡è£½åˆ°å…¶ä»–ç¯€é»åšç‚ºå‰¯æœ¬ï¼Œç•¶ä¸€å€‹commitè¶…éåŠæ•¸çš„ç¯€é»éƒ½ä»¥è¤‡è£½ä¸¦å„²å­˜æ‰æœƒèƒ½ç®—è©²commitæˆåŠŸã€‚æ­¤å¤–è©²commitçš„å…ƒè³‡æ–™(metadata)æœƒè¨˜éŒ„ç•¶æ™‚commitçš„Leaderä»»æœŸè™Ÿç¢¼æ˜¯å¤šå°‘ï¼Œè©²ä»»æœŸè™Ÿç”¨ä¾†åˆ¤æ–·ç¯€é»ä¹‹é–“å‰¯æœ¬ä¸ä¸€è‡´æƒ…å½¢ä¸¦ä¸”åœ¨æ¯å€‹ä¸€å€‹ç¯€é»å„²å­˜Commitéƒ½æœƒæœ‰ä¸€å€‹æ•´æ•¸ç´¢å¼•å€¼ä¾†ç¢ºèªå…¶åœ¨Commitç›®å‰å·²ç¶“å„²å­˜åˆ°ç¬¬å¹¾å€‹ä½å€å¦‚åœ–æ‰€ç¤ºã€‚\n  å„å€‹ç¯€é»ç™¼ç”Ÿå„²å­˜å…§å®¹ä¸ä¸€è‡´çš„æƒ…æ³ï¼Œè‹¥ä»»æœŸä¸‰æ˜¯ç¬¬ä¸‰ç¯€é»ç¹¼çºŒç•¶Leaderï¼Œåœ¨Leaderç™¼é€Heartbeatçš„åŒæ™‚æœƒå°‡å…¶ä»–ç¯€é»çš„è³‡æ–™å¼·åˆ¶è¦†è“‹éå»ï¼Œåˆ©ç”¨Leaderçš„å¼·åˆ¶æ€§è§£æ±ºè³‡æ–™ä¸çµ±ä¸€çš„æƒ…æ³ã€‚ç¬¬ä¸‰ç¯€é»ç™¼é€ä¸€æ¬¡Heartbeatå¼·åˆ¶åŒæ­¥å€‹ç¯€é»çš„indexçš„Commitï¼Œå¦‚ä¸‹åœ–æ‰€ç¤ºã€‚\nå¾Œè©± æœƒç¹¼çºŒæ¥è‘—æŠŠ Kubernetes çš„å…¶ä»–å…ƒä»¶ç¹¼çºŒè¬›è§£ä¸€éï¼Œå¦‚æœæœ‰èª¤çš„åœ°æ–¹æ­¡è¿å¤§å®¶æŒ‡å‡ºè¬è¬ï½ï½\nREF  \u0026ldquo;Etcd | Coreos\u0026rdquo;. Coreos.Com, 2019, https://coreos.com/blog/etcd. Oliveira, Caio, et al. \u0026ldquo;Evaluating raft in docker on kubernetes.\u0026rdquo; International Conference on Systems Science. Springer, Cham, 2016. ","description":"","id":33,"section":"posts","tags":["kubernetes"],"title":"etcd é‚£å›äº‹","uri":"https://blog.jjmengze.website/posts/kubernetes/etcd/"},{"content":"  ä»€éº¼æ˜¯ Kubernetes Kubernetes æ˜¯ä¸€å€‹ä»¥ Apache æˆæ¬Šæ¢æ¬¾çš„é–‹æºå°ˆæ¡ˆä¸»è¦ä½œç‚º Container å¢é›†çš„ç³»çµ±ç®¡ç†å¹³å°ï¼Œå…¶ç³»çµ±å…·å‚™é«˜åº¦å¯æ“´å±•æ€§ï¼Œç”± Joe Bedaã€Brendan Burns å’Œ Craig McLuckie ç­‰ Google å·¥ç¨‹å¸«å»ºç«‹æ­¤å¥—ç³»çµ±ã€‚\nKubernetes v1.0æ–¼2015å¹´7æœˆ21æ—¥ç™¼å¸ƒã€‚éš¨è‘—v1.0ç‰ˆæœ¬ç™¼å¸ƒï¼ŒGoogleèˆ‡Linux åŸºé‡‘æœƒåˆä½œå»ºç«‹äº†Cloud Native Computing Foundation (CNCF)ï¼Œä¸¦æŠŠKubernetesä½œç‚ºç¨®å­æŠ€è¡“ä¾†æä¾›ã€‚\nä¾†çœ‹çœ‹æ¶æ§‹åœ– Kubernetes Container å¢é›†ç³»çµ±ç®¡ç†å¹³å°ï¼Œå°‡èƒ½å¤ é€éKubernetes çš„æ©Ÿåˆ¶æä¾›VNFæ“æœ‰æ›´å¥½çš„å¯é æ€§ã€è² è¼‰å¹³è¡¡ã€æ»¾å‹•æ›´æ–°ç­‰ç‰¹æ€§ã€‚ç„¶è€Œåœ¨ Kubernetes Container å¢é›†ç®¡ç†å¹³å°ç³»çµ±ä¸­ï¼Œæ“æœ‰ä¸åŒçš„ç¯€é»è§’è‰²èˆ‡åŸºç¤å…ƒä»¶ã€‚\nå¦‚ä¸‹åœ–æ‰€ç¤ºï¼Œ Kubernektes æ•´é«”æ¶æ§‹æ˜¯ä¸»å¾å¼æ¶æ§‹( Clientâ€“server model )ç”± Master Node è² è²¬ Container å¢é›†ç®¡ç†èˆ‡èª¿åº¦ç›¸ç•¶æ–¼ Kubernetes çš„å¤§è…¦ï¼Œ Worker Node è² è²¬é‹è¡Œ Master Node æ‰€æ´¾é€éä¾†çš„ä»»å‹™ï¼Œä¸¦å°‡ä»»å‹™ç¢ºå¯¦åŸ·è¡Œä¸¦ä¸”å®šæœŸå›å ± Master Node ç›®å‰çš„ç¯€é»çš„ç‹€æ…‹ã€‚\n  å°± Master Node è€Œè¨€ Kubernetes æä¾›äº†ä¸€ç¨®æ–¹ä¾¿æ“ä½œçš„ kubectl å‘½ä»¤åˆ—ä»‹é¢å·¥å…·ï¼Œå°æ–¼ç®¡ç†äººå“¡ä¾†èªªï¼Œåªè¦é€é kubectl å°±èƒ½å‘ Kubernetes Container å¢é›†ä¸‹é”æŒ‡ä»¤ä¸¦å¾—åˆ°ç•¶å‰å¢é›†æœå‹™é‹è¡Œçš„ç‹€æ…‹ã€‚ Kubernetes åŒæ™‚è€ƒé‡å®‰å…¨æ€§çš„å•é¡Œï¼Œç•¶ä»»ä½•äººå“¡æƒ³è¦å°å¢é›†é€²è¡Œæ“ä½œéƒ½å¿…é ˆå…ˆç¶“é Kubernetes çš„èº«ä»½é©—è­‰ï¼Œç•¶é©—è­‰æˆåŠŸå¢é›†æ‰æœƒæ¥æ”¶æ“ä½œå‘½ä»¤åä¹‹äº¦ç„¶ã€‚\nç•¶é©—è­‰æˆåŠŸå¾Œæ‰€æœ‰çš„æ“ä½œè¡Œç‚ºä¾‹å¦‚ï¼šéƒ¨ç½² Container æœå‹™ã€å­˜å– Container æœå‹™åŸ·è¡Œçš„ç‹€æ…‹ã€åˆªé™¤ Container æœå‹™ç­‰è¡Œç‚ºï¼Œéƒ½æœƒç¶“ç”± Kubernetes Master Node ä¸Šçš„ API-Server é€égRPCé€šè¨Šå”å®šå‘å…¶ä»–å…ƒä»¶é€²è¡Œæºé€šä¸¦å–å›è³‡æ–™ï¼Œæ­¤å¤–åœ¨ Kubernetes å¢é›†æ¯å€‹ç¯€é»ä¸Šéƒ½æœƒé‹è¡Œä¸€å€‹åç‚º kubelet å…ƒä»¶ï¼Œè©² kubelet å…ƒä»¶ä¸»è¦è² è²¬æ¥æ”¶ Master Node æ‰€æŒ‡æ´¾çš„ä»»å‹™ä¸¦åœ¨è©²ç¯€é»ä¸Šéƒ¨ç½² Container æœå‹™ä¸¦ä¸”æ™‚åˆ»çš„ç›£è¦– node ä¸Šçš„ Container æœå‹™çš„ç‹€æ…‹ï¼Œä¸¦ä¸”é€é gRPC é€šè¨Šå”å®šå›å ±çµ¦ Kubernetes Master Nodeä¸Šçš„API-Serverï¼Œç•¶ API-Server æ”¶åˆ°ç¯€é»è³‡è¨Šä¸¦å½™æ•´å¾Œå°‡å­˜å…¥å¾Œç«¯çš„ etcd key/value è³‡æ–™åº«ã€‚\nå¾Œè©± å¾ŒçºŒåŒ…å«Schedulerã€Controller Managerã€API-Serverã€etcdã€kube-proxyã€kubelet ç­‰å…ƒä»¶ï¼Œå°‡ä¸€ä¸€ä»‹ç´¹ Kubenetes æ¶æ§‹ä¸­çš„ä¸»è¦å…ƒä»¶èˆ‡ç›¸é—œçš„è³‡æºå‹æ…‹ã€‚\n","description":"","id":34,"section":"posts","tags":["kubernetes"],"title":"Kubernetes æ·ºå…¥æ·ºå‡º","uri":"https://blog.jjmengze.website/posts/kubernetes/kubernetes/"},{"content":"  VM èˆ‡ Container æ¶æ§‹åœ– èˆ‡ VM ç›¸æ¯”ä½¿ç”¨ Container å…·æœ‰å„ç¨®å„ªé»ï¼Œåœ¨è¦åŸ·è¡Œæ•¸ç™¾å€‹æ‡‰ç”¨ç¨‹å¼çš„ä½¿ç”¨æƒ…å¢ƒä¹‹ä¸‹ä½¿ç”¨åŸºæ–¼ Container çš„è§£æ±ºæ–¹æ¡ˆé¡¯å¾—ç›¸ç•¶é«˜æ•ˆï¼Œ Container æ‰€ä½”çš„ç©ºé–“ä»¥åŠæ•ˆèƒ½æå¤±éƒ½å„ªæ–¼ VM ã€‚åœ¨éœ€è¦å¿«é€Ÿå›æ”¶è³‡æºèˆ‡å•Ÿå‹•æœå‹™çš„æ‡‰ç”¨æƒ…å¢ƒä¸‹ï¼Œé€é Container æ‰¿è¼‰é€™äº›æœå‹™é æ¯”é¸æ“‡ VM çš„æ•ˆæœè¦å¥½ï¼Œç”±æ–¼ Container å•Ÿå‹•çš„é€Ÿåº¦åªéœ€è¦å¹¾åç§’çš„æ™‚é–“ï¼Œ VM å•Ÿå‹•æ‰€éœ€è¦çš„æ™‚é–“å»é«˜é”æ•¸åˆ†é˜ã€‚\nVM èˆ‡ Container æ¯”è¼ƒè¡¨     VM Container     Communication é€éEthernet Devices é€éIPCï¼šSocketã€pipesã€Signalsç­‰æ©Ÿåˆ¶   Guest OS ç¨ç«‹çš„Kernel å…±ç”¨å®¿ä¸»Kernel   Performance æ•ˆèƒ½æ¶ˆè€—è¼ƒå¤§ æ•ˆèƒ½æ¶ˆè€—è¼ƒå°   Isolation éš”é›¢æ€§è¼ƒå¥½ éš”é›¢æ€§è¼ƒå·®   Startup time æ•¸åˆ†é˜ å¹¾åç§’   Storage ä½”è¼ƒå¤§ç©ºé–“ ä½”è¼ƒå°ç©ºé–“    åƒ…é€é VM ï¼Œå°‡ç›¸é—œçš„ service éƒ¨ç½²åˆ° VM ä¸­ä»¥ç”¨ä¾†è™•ç†ä½¿ç”¨è€…è«‹æ±‚çš„æœå‹™ï¼Œç”±æ–¼ VM çš„æ•ˆèƒ½æå¤±ä»¥åŠå•Ÿå‹•æ™‚é–“çš„å•é¡Œï¼Œæ¡ç”¨ container çš„æ–¹å¼å¯ä»¥å¤§å¹…åº¦ç¯€çœæ•ˆèƒ½çš„æå¤±ä»¥åŠåŠ é€Ÿéƒ¨ç½²èˆ‡ç”¢å“ä¸Šé™çš„æ™‚é–“ã€‚\nä½†æ˜¯å°æ–¼éƒ¨ç½²è¦æ¨¡è¼ƒå¤§çš„é‹ç®—å¢é›†ä¾†èªªï¼ŒContainer æŠ€è¡“åƒ…èƒ½ç¸®çŸ­æœå‹™å•Ÿå‹•çš„æ™‚é–“ï¼Œä¸¦ä¸”æ²’æœ‰ä¸€å€‹æ–¹ä¾¿ç®¡ç† Container åŒ–å¢é›†çš„æ–¹å¼èˆ‡ç¢ºèªç•¶å‰ Container æœå‹™é‹è¡Œçš„ç‹€æ…‹ã€‚è‹¥ç®¡ç†äººå“¡ä¸å°å¿ƒåˆªé™¤å¢é›†çš„æŸä¸€æœå‹™å°‡é€ æˆç½é›£æ€§çš„å±å®³ã€‚å› æ­¤ï¼Œéœ€è¦å»ºç½®ä¸€å€‹ Container å¢é›†ç®¡ç†å¹³å°ç®¡ç† Container æœå‹™ã€‚\nGoogle ç´¯ç©å¤šå¹´ç®¡ç† Container å¢é›†ç¶“é©—ï¼Œé€²è€Œé–‹ç™¼ Kubernetes Container å¢é›†èª¿åº¦æŠ€è¡“çš„é–‹æºå°ˆæ¡ˆï¼ŒåŒæ™‚ä¹Ÿæ˜¯ç›®å‰æ¥­ç•Œå»£ç‚ºæ¡ç”¨çš„ Container å¢é›†ç®¡ç†ç³»çµ±å¦‚å…¬æœ‰é›²çš„ AWS çš„ EKS ã€ Google æä¾›çš„ GKE ä»¥åŠ Azure çš„ AKS ï¼Œå°æ–¼ç®¡ç†äººå“¡ä¾†èªªä½¿ç”¨ Kubernetes é™¤äº†èƒ½å¤§é‡æ¸›å°‘å»ºç½®å¢é›†çš„è¤‡é›œæµç¨‹å¤–ï¼Œä¹Ÿå¯ä»¥é€é Kubernetes å…§å»ºçš„å…ƒä»¶å»ºç½®æ‰€éœ€è¦ Container æœå‹™ï¼Œé€é Kubernetes å¯ä»¥æé«˜æœå‹™çš„å¯ç”¨æ€§ï¼Œå› æ­¤ä»¥ä¸‹å°‡é€²ä¸€æ­¥èªªæ˜ Kubernetes çš„ç³»çµ±æ¶æ§‹ä»¥åŠç›¸é—œå…ƒä»¶ã€‚\nREF  Xavier, Miguel G., et al. \u0026ldquo;Performance evaluation of container-based virtualization for high performance computing environments.\u0026rdquo; 2013 21st Euromicro International Conference on Parallel, Distributed, and Network-Based Processing. IEEE, 2013. Soltesz, Stephen, et al. \u0026ldquo;Container-based operating system virtualization: a scalable, high-performance alternative to hypervisors.\u0026rdquo; ACM SIGOPS Operating Systems Review. Vol. 41. No. 3. ACM, 2007. Burns, Brendan, et al. \u0026ldquo;Borg, omega, and kubernetes.\u0026rdquo; (2016). Cherrueau, Ronan-Alexandre, et al. \u0026ldquo;Edge computing resource management system: a critical building block! initiating the debate via openstack.\u0026rdquo; {USENIX} Workshop on Hot Topics in Edge Computing (HotEdge 18). 2018. Web.Kaust.Edu.Sa, 2019, http://web.kaust.edu.sa/Faculty/MarcoCanini/classes/CS240/F17/slides/L3-cloud-VM.pdf ","description":"","id":35,"section":"posts","tags":["kubernetes"],"title":"ä¾†çœ‹çœ‹Container","uri":"https://blog.jjmengze.website/posts/kubernetes/container/"}]